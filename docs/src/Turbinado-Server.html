<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://www.cs.york.ac.uk/fp/darcs/hscolour/ -->
<title>Haskell Code by HsColour</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="(line1)"></a><span class='keyword'>module</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Server</span> <span class='keyword'>where</span>
<a name="(line2)"></a>
<a name="(line3)"></a><span class='keyword'>import</span> <span class='conid'>Control</span><span class='varop'>.</span><span class='conid'>Concurrent</span>
<a name="(line4)"></a><span class='keyword'>import</span> <span class='conid'>Control</span><span class='varop'>.</span><span class='conid'>Monad</span>
<a name="(line5)"></a>
<a name="(line6)"></a><span class='keyword'>import</span> <span class='conid'>System</span><span class='varop'>.</span><span class='conid'>IO</span>
<a name="(line7)"></a><span class='keyword'>import</span> <span class='conid'>System</span><span class='varop'>.</span><span class='conid'>Directory</span>
<a name="(line8)"></a><span class='keyword'>import</span> <span class='conid'>System</span><span class='varop'>.</span><span class='conid'>Time</span>
<a name="(line9)"></a><span class='keyword'>import</span> <span class='conid'>System</span><span class='varop'>.</span><span class='conid'>Environment</span> <span class='layout'>(</span><span class='varid'>getArgs</span><span class='layout'>,</span> <span class='varid'>getEnvironment</span><span class='layout'>)</span>
<a name="(line10)"></a><span class='keyword'>import</span> <span class='conid'>System</span><span class='varop'>.</span><span class='conid'>Console</span><span class='varop'>.</span><span class='conid'>GetOpt</span>
<a name="(line11)"></a>
<a name="(line12)"></a><span class='keyword'>import</span> <span class='conid'>Network</span> <span class='varid'>hiding</span> <span class='layout'>(</span><span class='varid'>accept</span><span class='layout'>)</span>
<a name="(line13)"></a><span class='keyword'>import</span> <span class='conid'>Network</span><span class='varop'>.</span><span class='conid'>FastCGI</span>
<a name="(line14)"></a><span class='keyword'>import</span> <span class='conid'>Network</span><span class='varop'>.</span><span class='conid'>Socket</span>
<a name="(line15)"></a><span class='keyword'>import</span> <span class='conid'>Prelude</span> <span class='varid'>hiding</span> <span class='layout'>(</span><span class='varid'>catch</span><span class='layout'>)</span>
<a name="(line16)"></a><span class='keyword'>import</span> <span class='conid'>Data</span><span class='varop'>.</span><span class='conid'>Dynamic</span> <span class='layout'>(</span> <span class='varid'>fromDynamic</span> <span class='layout'>)</span>
<a name="(line17)"></a><span class='keyword'>import</span> <span class='conid'>Data</span><span class='varop'>.</span><span class='conid'>Maybe</span>
<a name="(line18)"></a><span class='keyword'>import</span> <span class='conid'>Data</span><span class='varop'>.</span><span class='conid'>Time</span>
<a name="(line19)"></a><span class='keyword'>import</span> <span class='conid'>Network</span><span class='varop'>.</span><span class='conid'>URI</span>
<a name="(line20)"></a>
<a name="(line21)"></a><span class='keyword'>import</span> <span class='keyword'>qualified</span> <span class='conid'>Network</span><span class='varop'>.</span><span class='conid'>HTTP</span> <span class='keyword'>as</span> <span class='conid'>HTTP</span>
<a name="(line22)"></a><span class='keyword'>import</span> <span class='keyword'>qualified</span> <span class='conid'>Network</span><span class='varop'>.</span><span class='conid'>URI</span> <span class='keyword'>as</span> <span class='conid'>URI</span>
<a name="(line23)"></a>
<a name="(line24)"></a><span class='keyword'>import</span> <span class='conid'>Config</span><span class='varop'>.</span><span class='conid'>App</span>
<a name="(line25)"></a><span class='keyword'>import</span> <span class='conid'>Config</span><span class='varop'>.</span><span class='conid'>Master</span>
<a name="(line26)"></a>
<a name="(line27)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Controller</span><span class='varop'>.</span><span class='conid'>Monad</span> <span class='varid'>hiding</span> <span class='layout'>(</span><span class='varid'>catch</span><span class='layout'>)</span>
<a name="(line28)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Environment</span><span class='varop'>.</span><span class='conid'>Database</span>
<a name="(line29)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Environment</span><span class='varop'>.</span><span class='conid'>Logger</span>
<a name="(line30)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Environment</span><span class='varop'>.</span><span class='conid'>MimeTypes</span>
<a name="(line31)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Environment</span><span class='varop'>.</span><span class='conid'>Request</span>
<a name="(line32)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Environment</span><span class='varop'>.</span><span class='conid'>Response</span>
<a name="(line33)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Environment</span><span class='varop'>.</span><span class='conid'>Routes</span>
<a name="(line34)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Environment</span><span class='varop'>.</span><span class='conid'>Settings</span>
<a name="(line35)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Environment</span><span class='varop'>.</span><span class='conid'>Types</span>
<a name="(line36)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Environment</span><span class='varop'>.</span><span class='conid'>ViewData</span>
<a name="(line37)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Environment</span><span class='varop'>.</span><span class='conid'>CodeStore</span> <span class='layout'>(</span><span class='varid'>addCodeStoreToEnvironment</span><span class='layout'>)</span>
<a name="(line38)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Server</span><span class='varop'>.</span><span class='conid'>Exception</span>
<a name="(line39)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Server</span><span class='varop'>.</span><span class='conid'>ErrorHandler</span> <span class='layout'>(</span><span class='varid'>handleCGIError</span><span class='layout'>,</span> <span class='varid'>handleCGITurbinado</span><span class='layout'>,</span> <span class='varid'>handleHTTPError</span><span class='layout'>,</span> <span class='varid'>handleHTTPTurbinado</span><span class='layout'>)</span>
<a name="(line40)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Server</span><span class='varop'>.</span><span class='conid'>RequestProcess</span> <span class='layout'>(</span><span class='varid'>processRequest</span><span class='layout'>)</span>
<a name="(line41)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Server</span><span class='varop'>.</span><span class='conid'>Network</span> <span class='layout'>(</span><span class='varid'>receiveCGIRequest</span><span class='layout'>,</span> <span class='varid'>sendCGIResponse</span><span class='layout'>,</span> <span class='varid'>receiveHTTPRequest</span><span class='layout'>,</span> <span class='varid'>sendHTTPResponse</span><span class='layout'>)</span>
<a name="(line42)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Server</span><span class='varop'>.</span><span class='conid'>StandardResponse</span> <span class='layout'>(</span><span class='varid'>addEmptyResponse</span><span class='layout'>,</span> <span class='varid'>pageResponse</span><span class='layout'>)</span>
<a name="(line43)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Server</span><span class='varop'>.</span><span class='conid'>StaticContent</span>
<a name="(line44)"></a>
<a name="(line45)"></a><a name="Flag"></a><span class='keyword'>data</span> <span class='conid'>Flag</span> 
<a name="(line46)"></a>     <span class='keyglyph'>=</span> <span class='conid'>UseHTTP</span> <span class='conid'>Integer</span>
<a name="(line47)"></a>     <span class='keyglyph'>|</span> <span class='conid'>UseCGI</span>
<a name="(line48)"></a>     <span class='keyglyph'>|</span> <span class='conid'>UseFCGI</span>
<a name="(line49)"></a>     <span class='keyglyph'>|</span> <span class='conid'>Help</span>
<a name="(line50)"></a>    <span class='keyword'>deriving</span> <span class='layout'>(</span><span class='conid'>Show</span><span class='layout'>,</span> <span class='conid'>Eq</span><span class='layout'>)</span>
<a name="(line51)"></a>
<a name="(line52)"></a><a name="options"></a><span class='varid'>options</span> <span class='keyglyph'>::</span> <span class='keyglyph'>[</span><span class='conid'>OptDescr</span> <span class='conid'>Flag</span><span class='keyglyph'>]</span>
<a name="(line53)"></a><span class='varid'>options</span> <span class='keyglyph'>=</span>
<a name="(line54)"></a>    <span class='keyglyph'>[</span> <span class='conid'>Option</span> <span class='keyglyph'>[</span><span class='chr'>'p'</span><span class='keyglyph'>]</span>     <span class='keyglyph'>[</span><span class='str'>"port"</span><span class='keyglyph'>]</span> <span class='layout'>(</span><span class='conid'>ReqArg</span> <span class='layout'>(</span><span class='conid'>UseHTTP</span> <span class='varop'>.</span> <span class='varid'>read</span><span class='layout'>)</span> <span class='str'>"PORTNUMBER"</span><span class='layout'>)</span> <span class='str'>"start hsp runtime on port PORTNUMBER"</span>
<a name="(line55)"></a>    <span class='layout'>,</span> <span class='conid'>Option</span> <span class='keyglyph'>[</span><span class='chr'>'c'</span><span class='keyglyph'>]</span>     <span class='keyglyph'>[</span><span class='str'>"eval"</span><span class='keyglyph'>]</span> <span class='layout'>(</span><span class='conid'>NoArg</span> <span class='conid'>UseCGI</span><span class='layout'>)</span>                      <span class='str'>"run as a CGI app"</span>
<a name="(line56)"></a>    <span class='layout'>,</span> <span class='conid'>Option</span> <span class='keyglyph'>[</span><span class='chr'>'f'</span><span class='keyglyph'>]</span>     <span class='keyglyph'>[</span><span class='str'>"eval"</span><span class='keyglyph'>]</span> <span class='layout'>(</span><span class='conid'>NoArg</span> <span class='conid'>UseFCGI</span><span class='layout'>)</span>                     <span class='str'>"run as an FCGI app"</span>
<a name="(line57)"></a>    <span class='layout'>,</span> <span class='conid'>Option</span> <span class='keyglyph'>[</span><span class='chr'>'h'</span><span class='layout'>,</span><span class='chr'>'?'</span><span class='keyglyph'>]</span> <span class='keyglyph'>[</span><span class='str'>"help"</span><span class='keyglyph'>]</span> <span class='layout'>(</span><span class='conid'>NoArg</span> <span class='conid'>Help</span><span class='layout'>)</span>                        <span class='str'>"show this message"</span>
<a name="(line58)"></a>    <span class='keyglyph'>]</span>
<a name="(line59)"></a>
<a name="(line60)"></a><a name="main"></a><span class='comment'>-- | Handle a few options, then kick off the server.</span>
<a name="(line61)"></a><span class='varid'>main</span> <span class='keyglyph'>::</span> <span class='conid'>IO</span> <span class='conid'>()</span>
<a name="(line62)"></a><span class='varid'>main</span> <span class='keyglyph'>=</span>
<a name="(line63)"></a>    <span class='keyword'>do</span> <span class='varid'>args</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>getArgs</span>
<a name="(line64)"></a>       <span class='keyword'>case</span> <span class='varid'>getOpt</span> <span class='conid'>Permute</span> <span class='varid'>options</span> <span class='varid'>args</span> <span class='keyword'>of</span>
<a name="(line65)"></a>          <span class='layout'>(</span><span class='keyglyph'>[</span><span class='conid'>UseHTTP</span> <span class='varid'>n</span><span class='keyglyph'>]</span><span class='layout'>,</span><span class='conid'>[]</span><span class='layout'>,</span><span class='conid'>[]</span><span class='layout'>)</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>startServer</span> <span class='layout'>(</span><span class='conid'>UseHTTP</span> <span class='varid'>n</span><span class='layout'>)</span>
<a name="(line66)"></a>          <span class='layout'>(</span><span class='keyglyph'>[</span><span class='conid'>UseFCGI</span><span class='keyglyph'>]</span><span class='layout'>,</span><span class='conid'>[]</span><span class='layout'>,</span><span class='conid'>[]</span><span class='layout'>)</span>   <span class='keyglyph'>-&gt;</span> <span class='varid'>startServer</span> <span class='layout'>(</span><span class='conid'>UseFCGI</span><span class='layout'>)</span>
<a name="(line67)"></a>          <span class='layout'>(</span><span class='keyglyph'>[</span><span class='conid'>UseCGI</span><span class='keyglyph'>]</span><span class='layout'>,</span><span class='conid'>[]</span><span class='layout'>,</span><span class='conid'>[]</span><span class='layout'>)</span>    <span class='keyglyph'>-&gt;</span> <span class='varid'>startServer</span> <span class='layout'>(</span><span class='conid'>UseCGI</span><span class='layout'>)</span>
<a name="(line68)"></a>          <span class='layout'>(</span><span class='varid'>opts</span><span class='layout'>,</span><span class='conid'>[]</span><span class='layout'>,</span><span class='conid'>[]</span><span class='layout'>)</span>        <span class='keyglyph'>-&gt;</span> <span class='varid'>putStr</span> <span class='varop'>$</span> <span class='str'>"ERROR: You may only specify one flag.\n\n"</span> <span class='varop'>++</span> <span class='varid'>usageInfo</span> <span class='varid'>header</span> <span class='varid'>options</span>
<a name="(line69)"></a>          <span class='layout'>(</span><span class='keyword'>_</span><span class='layout'>,</span><span class='keyword'>_</span><span class='layout'>,</span><span class='varid'>errs</span><span class='layout'>)</span>          <span class='keyglyph'>-&gt;</span> <span class='varid'>ioError</span> <span class='layout'>(</span><span class='varid'>userError</span> <span class='layout'>(</span><span class='varid'>concat</span> <span class='varid'>errs</span> <span class='varop'>++</span> <span class='varid'>usageInfo</span> <span class='varid'>header</span> <span class='varid'>options</span><span class='layout'>)</span><span class='layout'>)</span>
<a name="(line70)"></a>    <span class='keyword'>where</span>
<a name="(line71)"></a>     <span class='varid'>header</span> <span class='keyglyph'>=</span> <span class='str'>"Usage: turbinado [OPTION]"</span>
<a name="(line72)"></a>
<a name="(line73)"></a>
<a name="(line74)"></a><a name="startServer"></a><span class='comment'>-- | Starts the server, builds the basic 'Environment', builds the 'WorkerPool',</span>
<a name="(line75)"></a><span class='comment'>-- starts listening on the specified port.  As soon as a request is noticed, </span>
<a name="(line76)"></a><span class='comment'>-- it's handed off to a 'WorkerThread' to be handled.  Lather, Rinse, Repeat.</span>
<a name="(line77)"></a><span class='varid'>startServer</span> <span class='keyglyph'>::</span> <span class='conid'>Flag</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>IO</span> <span class='conid'>()</span>
<a name="(line78)"></a><span class='varid'>startServer</span> <span class='varid'>using</span>
<a name="(line79)"></a>    <span class='keyglyph'>=</span> <span class='varid'>withSocketsDo</span> <span class='varop'>$</span> 
<a name="(line80)"></a>      <span class='keyword'>do</span> <span class='varid'>e</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>runController</span> 
<a name="(line81)"></a>               <span class='layout'>(</span><span class='varid'>sequence_</span> <span class='varop'>$</span> <span class='keyglyph'>[</span> <span class='varid'>addLoggerToEnvironment</span>
<a name="(line82)"></a>                            <span class='layout'>,</span> <span class='varid'>addCodeStoreToEnvironment</span>
<a name="(line83)"></a>                            <span class='layout'>,</span> <span class='varid'>addMimeTypesToEnvironment</span> <span class='str'>"Config/mime.types"</span>
<a name="(line84)"></a>                            <span class='layout'>,</span> <span class='varid'>addRoutesToEnvironment</span>
<a name="(line85)"></a>                            <span class='layout'>,</span> <span class='varid'>addEmptyResponse</span>
<a name="(line86)"></a>                            <span class='layout'>,</span> <span class='varid'>addViewDataToEnvironment</span>
<a name="(line87)"></a>                            <span class='layout'>,</span> <span class='varid'>addSettingsToEnvironment</span>
<a name="(line88)"></a>                            <span class='keyglyph'>]</span>
<a name="(line89)"></a>                            <span class='varop'>++</span> <span class='varid'>customSetupFilters</span>
<a name="(line90)"></a>               <span class='layout'>)</span> 
<a name="(line91)"></a>               <span class='varid'>newEnvironment</span>
<a name="(line92)"></a>         <span class='keyword'>case</span> <span class='varid'>using</span> <span class='keyword'>of</span> 
<a name="(line93)"></a>           <span class='conid'>UseCGI</span>     <span class='keyglyph'>-&gt;</span> <span class='keyword'>do</span> <span class='varid'>processCGI</span> <span class='layout'>(</span><span class='conid'>Network</span><span class='varop'>.</span><span class='conid'>FastCGI</span><span class='varop'>.</span><span class='varid'>runCGI</span><span class='layout'>)</span> <span class='varid'>e</span>
<a name="(line94)"></a>           <span class='conid'>UseFCGI</span>    <span class='keyglyph'>-&gt;</span> <span class='keyword'>do</span> <span class='varid'>processCGI</span> <span class='layout'>(</span><span class='conid'>Network</span><span class='varop'>.</span><span class='conid'>FastCGI</span><span class='varop'>.</span><span class='varid'>runFastCGIConcurrent</span> <span class='varid'>maxFCGIThreads</span><span class='layout'>)</span> <span class='varid'>e</span>
<a name="(line95)"></a>           <span class='conid'>UseHTTP</span> <span class='varid'>p</span>  <span class='keyglyph'>-&gt;</span> <span class='keyword'>do</span> <span class='varid'>sock</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>listenOn</span> <span class='varop'>$</span> <span class='conid'>PortNumber</span> <span class='varop'>$</span> <span class='varid'>fromIntegral</span> <span class='varid'>p</span>
<a name="(line96)"></a>                            <span class='varid'>workerPoolMVar</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>newMVar</span> <span class='varop'>$</span> <span class='conid'>WorkerPool</span> <span class='num'>0</span> <span class='conid'>[]</span> <span class='conid'>[]</span>
<a name="(line97)"></a>                            <span class='varid'>httpLoop</span> <span class='varid'>sock</span> <span class='varid'>e</span> <span class='varid'>workerPoolMVar</span>
<a name="(line98)"></a>           <span class='varid'>f</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>error</span> <span class='varop'>$</span> <span class='str'>"Flag not supported: "</span> <span class='varop'>++</span> <span class='layout'>(</span><span class='varid'>show</span> <span class='varid'>f</span><span class='layout'>)</span>
<a name="(line99)"></a>    <span class='keyword'>where</span>
<a name="(line100)"></a>      <span class='varid'>httpLoop</span> <span class='varid'>sock</span> <span class='varid'>e</span> <span class='varid'>workerPoolMVar</span> <span class='keyglyph'>=</span> <span class='comment'>-- Run as Server</span>
<a name="(line101)"></a>          <span class='keyword'>do</span> <span class='layout'>(</span><span class='varid'>sock'</span><span class='layout'>,</span> <span class='varid'>sockAddr</span><span class='layout'>)</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>accept</span> <span class='varid'>sock</span>
<a name="(line102)"></a>             <span class='conid'>WorkerThread</span> <span class='keyword'>_</span> <span class='varid'>chan</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>getWorkerThread</span> <span class='varid'>workerPoolMVar</span> <span class='varid'>e</span>
<a name="(line103)"></a>             <span class='varid'>writeChan</span> <span class='varid'>chan</span> <span class='varid'>sock'</span>
<a name="(line104)"></a>             <span class='varid'>httpLoop</span> <span class='varid'>sock</span> <span class='varid'>e</span> <span class='varid'>workerPoolMVar</span>
<a name="(line105)"></a>
<a name="(line106)"></a>
<a name="(line107)"></a><a name="processCGI"></a><span class='varid'>processCGI</span> <span class='keyglyph'>::</span> <span class='layout'>(</span><span class='conid'>CGI</span> <span class='conid'>CGIResult</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>IO</span> <span class='conid'>()</span><span class='layout'>)</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>Environment</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>IO</span> <span class='conid'>()</span>
<a name="(line108)"></a><span class='varid'>processCGI</span> <span class='varid'>handler</span> <span class='varid'>e</span> <span class='keyglyph'>=</span> <span class='layout'>(</span><span class='varid'>handler</span> <span class='varop'>$</span> 
<a name="(line109)"></a>                           <span class='keyword'>do</span> <span class='varid'>body</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>getBody</span>
<a name="(line110)"></a>                              <span class='varid'>hdrs</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>getVars</span>
<a name="(line111)"></a>                              <span class='varid'>uri</span>  <span class='keyglyph'>&lt;-</span> <span class='varid'>requestURI</span>
<a name="(line112)"></a>                              <span class='varid'>method</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>requestMethod</span>
<a name="(line113)"></a>                              <span class='varid'>e'</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>liftIO</span> <span class='varop'>$</span> 
<a name="(line114)"></a>                                      <span class='varid'>runController</span> <span class='layout'>(</span><span class='varid'>sequence_</span> <span class='keyglyph'>[</span> <span class='varid'>addDatabaseToEnvironment</span>
<a name="(line115)"></a>                                                               <span class='layout'>,</span> <span class='varid'>receiveCGIRequest</span> <span class='varid'>uri</span> <span class='varid'>method</span> <span class='varid'>body</span> <span class='varid'>hdrs</span>
<a name="(line116)"></a>                                                               <span class='layout'>,</span> <span class='varid'>processRequest</span>
<a name="(line117)"></a>                                                               <span class='keyglyph'>]</span>
<a name="(line118)"></a>                                                    <span class='layout'>)</span> <span class='varid'>e</span>
<a name="(line119)"></a>                              <span class='varid'>sendCGIResponse</span> <span class='varid'>e'</span>
<a name="(line120)"></a>                       <span class='layout'>)</span> <span class='varop'>`catchTurbinado`</span> <span class='layout'>(</span><span class='keyglyph'>\</span><span class='varid'>ex</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>handleCGITurbinado</span> <span class='varid'>ex</span> <span class='varid'>e</span><span class='layout'>)</span>
<a name="(line121)"></a>                          <span class='varop'>`catch`</span> <span class='layout'>(</span><span class='keyglyph'>\</span><span class='varid'>ex</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>handleCGIError</span> <span class='varid'>ex</span> <span class='varid'>e</span><span class='layout'>)</span>
<a name="(line122)"></a>
<a name="(line123)"></a>
<a name="(line124)"></a>
<a name="(line125)"></a><span class='comment'>------------------------------------------------</span>
<a name="(line126)"></a><span class='comment'>-- | Worker stuff used for HTTP processing</span>
<a name="(line127)"></a><span class='comment'>------------------------------------------------</span>
<a name="(line128)"></a>
<a name="(line129)"></a><a name="workerLoop"></a><span class='comment'>-- | The basic loop for a 'WorkerThread': get the socket from the server mainloop,</span>
<a name="(line130)"></a><span class='comment'>-- receive a request, handle it, then put myself back into the 'WorkerPool'.</span>
<a name="(line131)"></a><span class='varid'>workerLoop</span> <span class='keyglyph'>::</span> <span class='conid'>MVar</span> <span class='conid'>WorkerPool</span> <span class='keyglyph'>-&gt;</span>
<a name="(line132)"></a>              <span class='conid'>Environment</span> <span class='keyglyph'>-&gt;</span>
<a name="(line133)"></a>              <span class='conid'>Chan</span> <span class='conid'>Socket</span> <span class='keyglyph'>-&gt;</span>
<a name="(line134)"></a>              <span class='conid'>IO</span> <span class='conid'>()</span>
<a name="(line135)"></a><span class='varid'>workerLoop</span> <span class='varid'>workerPoolMVar</span> <span class='varid'>e</span> <span class='varid'>chan</span>
<a name="(line136)"></a>         <span class='keyglyph'>=</span> <span class='keyword'>do</span> <span class='varid'>sock</span>      <span class='keyglyph'>&lt;-</span> <span class='varid'>readChan</span> <span class='varid'>chan</span>
<a name="(line137)"></a>              <span class='varid'>workerProcessRequest</span> <span class='varid'>sock</span> <span class='varid'>e</span>
<a name="(line138)"></a>              <span class='varid'>putWorkerThread</span> <span class='varid'>workerPoolMVar</span> <span class='varid'>chan</span>
<a name="(line139)"></a>              <span class='varid'>workerLoop</span> <span class='varid'>workerPoolMVar</span> <span class='varid'>e</span> <span class='varid'>chan</span>
<a name="(line140)"></a>
<a name="(line141)"></a><a name="workerProcessRequest"></a><span class='comment'>-- | Basic request handling: setup the 'Environment' for this request,</span>
<a name="(line142)"></a><span class='comment'>-- run the real requestHandler, then ship the response back to the client.</span>
<a name="(line143)"></a><span class='varid'>workerProcessRequest</span> <span class='keyglyph'>::</span> <span class='conid'>Socket</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>Environment</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>IO</span> <span class='conid'>()</span>
<a name="(line144)"></a><span class='varid'>workerProcessRequest</span> <span class='varid'>sock</span> <span class='varid'>e</span>
<a name="(line145)"></a>    <span class='keyglyph'>=</span> <span class='layout'>(</span><span class='keyword'>do</span> <span class='varid'>mytid</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>myThreadId</span>
<a name="(line146)"></a>          <span class='varid'>runController</span> 
<a name="(line147)"></a>                  <span class='layout'>(</span><span class='keyword'>do</span> <span class='varid'>receiveHTTPRequest</span> <span class='varid'>sock</span>
<a name="(line148)"></a>                      <span class='varid'>tryStaticContent</span>
<a name="(line149)"></a>                      <span class='varid'>processRequest</span>
<a name="(line150)"></a>                      <span class='varid'>sendHTTPResponse</span> <span class='varid'>sock</span>
<a name="(line151)"></a>                  <span class='layout'>)</span> <span class='varid'>e</span>
<a name="(line152)"></a>          <span class='varid'>return</span> <span class='conid'>()</span>
<a name="(line153)"></a>      <span class='layout'>)</span> 
<a name="(line154)"></a>        <span class='varop'>`catchTurbinado`</span> <span class='layout'>(</span><span class='keyglyph'>\</span><span class='varid'>ex</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>handleHTTPTurbinado</span> <span class='varid'>sock</span> <span class='varid'>ex</span> <span class='varid'>e</span><span class='layout'>)</span>
<a name="(line155)"></a>        <span class='varop'>`catch`</span> <span class='layout'>(</span><span class='keyglyph'>\</span><span class='varid'>ex</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>handleHTTPError</span> <span class='varid'>sock</span> <span class='varid'>ex</span> <span class='varid'>e</span><span class='layout'>)</span>
<a name="(line156)"></a>        <span class='varop'>`finally`</span> <span class='layout'>(</span><span class='varid'>sClose</span> <span class='varid'>sock</span><span class='layout'>)</span>
<a name="(line157)"></a>
<a name="(line158)"></a>
<a name="(line159)"></a><span class='comment'>------------------------------------------------</span>
<a name="(line160)"></a><span class='comment'>-- | Worker Pool stuff</span>
<a name="(line161)"></a><span class='comment'>------------------------------------------------</span>
<a name="(line162)"></a>
<a name="(line163)"></a><a name="WorkerPool"></a><span class='comment'>-- | The 'WorkerPool' holds each idle or busy 'WorkerThread'.</span>
<a name="(line164)"></a><a name="WorkerPool"></a><span class='comment'>-- When all 'WorkerThread's are busy, more are created by</span>
<a name="(line165)"></a><a name="WorkerPool"></a><span class='comment'>-- 'getWorkerThread' and added to the 'WorkerPool'.</span>
<a name="(line166)"></a><a name="WorkerPool"></a><span class='keyword'>data</span> <span class='conid'>WorkerPool</span> <span class='keyglyph'>=</span> <span class='conid'>WorkerPool</span> <span class='layout'>{</span> <span class='varid'>numWorkers</span> <span class='keyglyph'>::</span> <span class='conid'>Int</span><span class='layout'>,</span>
<a name="(line167)"></a>                               <span class='varid'>idleWorkers</span> <span class='keyglyph'>::</span> <span class='keyglyph'>[</span><span class='conid'>WorkerThread</span><span class='keyglyph'>]</span><span class='layout'>,</span>
<a name="(line168)"></a>                               <span class='varid'>busyWorkers</span> <span class='keyglyph'>::</span> <span class='keyglyph'>[</span><span class='layout'>(</span><span class='conid'>WorkerThread</span><span class='layout'>,</span> <span class='conid'>ExpiresTime</span><span class='layout'>)</span><span class='keyglyph'>]</span><span class='layout'>}</span>
<a name="(line169)"></a>
<a name="(line170)"></a><a name="WorkerThread"></a><span class='comment'>-- | Each 'WorkerThread' has a 'ThreadId' and a 'Channel' for communication.</span>
<a name="(line171)"></a><a name="WorkerThread"></a><span class='keyword'>data</span> <span class='conid'>WorkerThread</span> <span class='keyglyph'>=</span> <span class='conid'>WorkerThread</span> <span class='conid'>ThreadId</span> <span class='layout'>(</span><span class='conid'>Chan</span> <span class='conid'>Socket</span><span class='layout'>)</span>
<a name="(line172)"></a>
<a name="(line173)"></a><a name="ExpiresTime"></a><span class='comment'>-- | 'ExpiresTime' is the time at which a 'WorkerThread' will be killed if it</span>
<a name="(line174)"></a><a name="ExpiresTime"></a><span class='comment'>-- has not completed its 'Request'.</span>
<a name="(line175)"></a><a name="ExpiresTime"></a><span class='keyword'>type</span> <span class='conid'>ExpiresTime</span> <span class='keyglyph'>=</span> <span class='conid'>UTCTime</span>
<a name="(line176)"></a>
<a name="(line177)"></a><a name="getWorkerThread"></a><span class='comment'>-- | 'getWorkerThread' returns a 'WorkerThread'.  If all threads are busy,</span>
<a name="(line178)"></a><span class='comment'>-- a new WorkerThread is created and returned.</span>
<a name="(line179)"></a><span class='varid'>getWorkerThread</span> <span class='keyglyph'>::</span> <span class='conid'>MVar</span> <span class='conid'>WorkerPool</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>Environment</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>IO</span> <span class='conid'>WorkerThread</span>
<a name="(line180)"></a><span class='varid'>getWorkerThread</span> <span class='varid'>mv</span> <span class='varid'>e</span> <span class='keyglyph'>=</span> 
<a name="(line181)"></a>  <span class='keyword'>do</span> <span class='varid'>wp</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>takeMVar</span> <span class='varid'>mv</span>
<a name="(line182)"></a>     <span class='keyword'>case</span> <span class='varid'>wp</span> <span class='keyword'>of</span>
<a name="(line183)"></a>       <span class='conid'>WorkerPool</span> <span class='varid'>n</span> <span class='conid'>[]</span> <span class='varid'>bs</span> <span class='keyglyph'>-&gt;</span> 
<a name="(line184)"></a>         <span class='keyword'>do</span> <span class='varid'>chan</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>newChan</span>
<a name="(line185)"></a>            <span class='varid'>e'</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>runController</span> <span class='layout'>(</span><span class='varid'>addDatabaseToEnvironment</span><span class='layout'>)</span> <span class='varid'>e</span>
<a name="(line186)"></a>            <span class='varid'>tid</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>forkIO</span> <span class='varop'>$</span> <span class='varid'>workerLoop</span> <span class='varid'>mv</span> <span class='varid'>e'</span> <span class='varid'>chan</span>
<a name="(line187)"></a>            <span class='keyword'>let</span> <span class='varid'>workerThread</span> <span class='keyglyph'>=</span> <span class='conid'>WorkerThread</span> <span class='varid'>tid</span> <span class='varid'>chan</span> 
<a name="(line188)"></a>            <span class='varid'>expiresTime</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>getCurrentTime</span> <span class='varop'>&gt;&gt;=</span> <span class='keyglyph'>\</span><span class='varid'>utct</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>return</span> <span class='varop'>$</span> <span class='varid'>addUTCTime</span> <span class='layout'>(</span><span class='varid'>fromInteger</span> <span class='varid'>stdTimeOut</span><span class='layout'>)</span> <span class='varid'>utct</span>
<a name="(line189)"></a>            <span class='varid'>putMVar</span> <span class='varid'>mv</span> <span class='varop'>$</span> <span class='conid'>WorkerPool</span> <span class='layout'>(</span><span class='varid'>n</span><span class='varop'>+</span><span class='num'>1</span><span class='layout'>)</span> <span class='conid'>[]</span> <span class='layout'>(</span><span class='layout'>(</span><span class='varid'>workerThread</span><span class='layout'>,</span> <span class='varid'>expiresTime</span><span class='layout'>)</span><span class='conop'>:</span><span class='varid'>bs</span><span class='layout'>)</span>
<a name="(line190)"></a>            <span class='varid'>return</span> <span class='varid'>workerThread</span>
<a name="(line191)"></a>       <span class='conid'>WorkerPool</span> <span class='varid'>n</span> <span class='layout'>(</span><span class='varid'>idle</span><span class='conop'>:</span><span class='varid'>idles</span><span class='layout'>)</span> <span class='varid'>busies</span> <span class='keyglyph'>-&gt;</span>
<a name="(line192)"></a>         <span class='keyword'>do</span> <span class='varid'>expiresTime</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>getCurrentTime</span> <span class='varop'>&gt;&gt;=</span> <span class='keyglyph'>\</span><span class='varid'>utct</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>return</span> <span class='varop'>$</span> <span class='varid'>addUTCTime</span> <span class='layout'>(</span><span class='varid'>fromInteger</span> <span class='varid'>stdTimeOut</span><span class='layout'>)</span> <span class='varid'>utct</span>
<a name="(line193)"></a>            <span class='varid'>putMVar</span> <span class='varid'>mv</span> <span class='varop'>$</span> <span class='conid'>WorkerPool</span> <span class='varid'>n</span> <span class='varid'>idles</span> <span class='layout'>(</span><span class='layout'>(</span><span class='varid'>idle</span><span class='layout'>,</span> <span class='varid'>expiresTime</span><span class='layout'>)</span><span class='conop'>:</span><span class='varid'>busies</span><span class='layout'>)</span>
<a name="(line194)"></a>            <span class='varid'>return</span> <span class='varid'>idle</span>
<a name="(line195)"></a>
<a name="(line196)"></a><a name="putWorkerThread"></a><span class='comment'>-- | 'putWorkerThread' puts a 'WorkerThread' back into the 'WorkerPool'.  This function</span>
<a name="(line197)"></a><span class='comment'>-- is used by the thread to put *itself* back into the pool.</span>
<a name="(line198)"></a><span class='varid'>putWorkerThread</span> <span class='keyglyph'>::</span> <span class='conid'>MVar</span> <span class='conid'>WorkerPool</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>Chan</span> <span class='conid'>Socket</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>IO</span> <span class='conid'>()</span> 
<a name="(line199)"></a><span class='varid'>putWorkerThread</span> <span class='varid'>mv</span> <span class='varid'>chan</span> <span class='keyglyph'>=</span> <span class='keyword'>do</span>
<a name="(line200)"></a>               <span class='conid'>WorkerPool</span> <span class='varid'>n</span> <span class='varid'>is</span> <span class='varid'>bs</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>takeMVar</span> <span class='varid'>mv</span>
<a name="(line201)"></a>               <span class='varid'>mytid</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>myThreadId</span>
<a name="(line202)"></a>               <span class='keyword'>let</span> <span class='varid'>bs'</span> <span class='keyglyph'>=</span> <span class='varid'>filter</span> <span class='layout'>(</span><span class='keyglyph'>\</span><span class='layout'>(</span><span class='conid'>WorkerThread</span> <span class='varid'>tid</span> <span class='keyword'>_</span><span class='layout'>,</span> <span class='keyword'>_</span><span class='layout'>)</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>tid</span> <span class='varop'>/=</span> <span class='varid'>mytid</span><span class='layout'>)</span> <span class='varid'>bs</span>
<a name="(line203)"></a>               <span class='varid'>putMVar</span> <span class='varid'>mv</span> <span class='varop'>$</span> <span class='conid'>WorkerPool</span> <span class='varid'>n</span> <span class='layout'>(</span><span class='layout'>(</span><span class='conid'>WorkerThread</span> <span class='varid'>mytid</span> <span class='varid'>chan</span><span class='layout'>)</span><span class='conop'>:</span><span class='varid'>is</span><span class='layout'>)</span> <span class='varid'>bs'</span>
<a name="(line204)"></a>
<a name="(line205)"></a>
<a name="(line206)"></a><a name="stdTimeOut"></a><span class='varid'>stdTimeOut</span> <span class='keyglyph'>::</span> <span class='conid'>Integer</span>
<a name="(line207)"></a><span class='varid'>stdTimeOut</span> <span class='keyglyph'>=</span> <span class='num'>90</span>
<a name="(line208)"></a>
<a name="(line209)"></a>
</pre></body>
</html>
