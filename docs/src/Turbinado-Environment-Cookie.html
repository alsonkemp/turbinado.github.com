<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://www.cs.york.ac.uk/fp/darcs/hscolour/ -->
<title>Haskell Code by HsColour</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="(line1)"></a><span class='comment'>-----------------------------------------------------------------------------</span>
<a name="(line2)"></a><span class='comment'>-- |</span>
<a name="(line3)"></a><span class='comment'>-- Module      :  Turbinado.Environment.Cookie</span>
<a name="(line4)"></a><span class='comment'>-- Copyright   :  (c) Alson Kemp 2008-2009</span>
<a name="(line5)"></a><span class='comment'>--                (c) Bjorn Bringert 2004-2005</span>
<a name="(line6)"></a><span class='comment'>--                (c) Ian Lynagh 2005</span>
<a name="(line7)"></a><span class='comment'>-- License     :  BSD-style</span>
<a name="(line8)"></a><span class='comment'>--</span>
<a name="(line9)"></a><span class='comment'>-- Maintainer  :  alson@alsonkemp.com</span>
<a name="(line10)"></a><span class='comment'>-- Stability   :  experimental</span>
<a name="(line11)"></a><span class='comment'>-- Portability :  portable</span>
<a name="(line12)"></a><span class='comment'>--</span>
<a name="(line13)"></a><span class='comment'>--  General server side HTTP cookie library.</span>
<a name="(line14)"></a><span class='comment'>--  Based on &lt;<a href="http://wp.netscape.com/newsref/std/cookie_spec.html">http://wp.netscape.com/newsref/std/cookie_spec.html</a>&gt;</span>
<a name="(line15)"></a><span class='comment'>--  Lifted in near entirety from the CGI package (<a href="http://hackage.haskell.org/cgi-bin/hackage-scripts/package/cgi)">http://hackage.haskell.org/cgi-bin/hackage-scripts/package/cgi)</a></span>
<a name="(line16)"></a><span class='comment'>--</span>
<a name="(line17)"></a><span class='comment'>-----------------------------------------------------------------------------</span>
<a name="(line18)"></a>
<a name="(line19)"></a><span class='keyword'>module</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Environment</span><span class='varop'>.</span><span class='conid'>Cookie</span> 
<a name="(line20)"></a>  <span class='layout'>(</span> <span class='varid'>mkCookie</span>
<a name="(line21)"></a>  <span class='layout'>,</span> <span class='varid'>getCookie</span>
<a name="(line22)"></a>  <span class='layout'>,</span> <span class='varid'>setCookie</span>
<a name="(line23)"></a>  <span class='layout'>,</span> <span class='varid'>deleteCookie</span>
<a name="(line24)"></a>  <span class='layout'>,</span> <span class='varid'>showCookie</span>
<a name="(line25)"></a>  <span class='layout'>)</span> <span class='keyword'>where</span>
<a name="(line26)"></a>
<a name="(line27)"></a><span class='keyword'>import</span> <span class='conid'>Data</span><span class='varop'>.</span><span class='conid'>Char</span> <span class='layout'>(</span><span class='varid'>isSpace</span><span class='layout'>)</span>
<a name="(line28)"></a><span class='keyword'>import</span> <span class='conid'>Data</span><span class='varop'>.</span><span class='conid'>List</span> <span class='layout'>(</span><span class='varid'>intercalate</span><span class='layout'>)</span>
<a name="(line29)"></a><span class='keyword'>import</span> <span class='conid'>Data</span><span class='varop'>.</span><span class='conid'>Maybe</span> <span class='layout'>(</span><span class='varid'>catMaybes</span><span class='layout'>)</span>
<a name="(line30)"></a><span class='keyword'>import</span> <span class='conid'>System</span><span class='varop'>.</span><span class='conid'>Locale</span> <span class='layout'>(</span><span class='varid'>defaultTimeLocale</span><span class='layout'>,</span> <span class='varid'>rfc822DateFormat</span><span class='layout'>)</span>
<a name="(line31)"></a><span class='keyword'>import</span> <span class='conid'>Data</span><span class='varop'>.</span><span class='conid'>Time</span>
<a name="(line32)"></a><span class='keyword'>import</span> <span class='conid'>Network</span><span class='varop'>.</span><span class='conid'>HTTP</span><span class='varop'>.</span><span class='conid'>Headers</span>
<a name="(line33)"></a>
<a name="(line34)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Environment</span><span class='varop'>.</span><span class='conid'>Header</span>
<a name="(line35)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Environment</span><span class='varop'>.</span><span class='conid'>Response</span>
<a name="(line36)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Environment</span><span class='varop'>.</span><span class='conid'>Types</span>
<a name="(line37)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Utility</span><span class='varop'>.</span><span class='conid'>Data</span> <span class='layout'>(</span><span class='varid'>fromJust'</span><span class='layout'>)</span>
<a name="(line38)"></a><span class='comment'>--</span>
<a name="(line39)"></a><span class='comment'>-- * Getting cookies</span>
<a name="(line40)"></a><span class='comment'>--</span>
<a name="(line41)"></a>
<a name="(line42)"></a><a name="getCookie"></a><span class='comment'>-- | Get the value of a cookie from a string on the form</span>
<a name="(line43)"></a><span class='comment'>--   @\"cookieName1=cookieValue1;...;cookieName2=cookieValue2\"@.</span>
<a name="(line44)"></a><span class='comment'>--   This is the format of the @Cookie@ HTTP header.</span>
<a name="(line45)"></a><span class='varid'>getCookie</span> <span class='keyglyph'>::</span> <span class='conid'>HasEnvironment</span> <span class='varid'>m</span> <span class='keyglyph'>=&gt;</span>
<a name="(line46)"></a>                <span class='conid'>String</span> <span class='comment'>-- ^ Cookie name</span>
<a name="(line47)"></a>             <span class='keyglyph'>-&gt;</span> <span class='varid'>m</span> <span class='layout'>(</span><span class='conid'>Maybe</span> <span class='conid'>String</span><span class='layout'>)</span>  <span class='comment'>-- ^ Cookie value, if found</span>
<a name="(line48)"></a><span class='varid'>getCookie</span> <span class='varid'>name</span>   <span class='keyglyph'>=</span> <span class='keyword'>do</span> <span class='varid'>e</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>getEnvironment</span>
<a name="(line49)"></a>                      <span class='varid'>h</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>getHeader</span> <span class='conid'>HdrCookie</span>
<a name="(line50)"></a>                      <span class='keyword'>case</span> <span class='varid'>h</span> <span class='keyword'>of</span> 
<a name="(line51)"></a>                        <span class='conid'>Nothing</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>return</span> <span class='conid'>Nothing</span>
<a name="(line52)"></a>                        <span class='conid'>Just</span> <span class='varid'>h'</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>return</span> <span class='varop'>$</span> <span class='varid'>maybeLast</span> <span class='keyglyph'>[</span> <span class='varid'>cv</span> <span class='keyglyph'>|</span> <span class='layout'>(</span><span class='varid'>cn</span><span class='layout'>,</span><span class='varid'>cv</span><span class='layout'>)</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>readCookies</span> <span class='varid'>h'</span><span class='layout'>,</span> <span class='varid'>cn</span> <span class='varop'>==</span> <span class='varid'>name</span> <span class='keyglyph'>]</span>
<a name="(line53)"></a>
<a name="(line54)"></a><span class='comment'>-- </span>
<a name="(line55)"></a><span class='comment'>-- * Setting Cookies</span>
<a name="(line56)"></a><span class='comment'>--</span>
<a name="(line57)"></a>
<a name="(line58)"></a><a name="setCookie"></a><span class='comment'>-- | Set a cookie (which you should have created using something like 'mkCookie'</span>
<a name="(line59)"></a><span class='varid'>setCookie</span> <span class='keyglyph'>::</span> <span class='conid'>HasEnvironment</span> <span class='varid'>m</span> <span class='keyglyph'>=&gt;</span>
<a name="(line60)"></a>             <span class='conid'>Cookie</span> <span class='keyglyph'>-&gt;</span>
<a name="(line61)"></a>             <span class='varid'>m</span> <span class='conid'>()</span>
<a name="(line62)"></a><span class='varid'>setCookie</span> <span class='varid'>c</span> <span class='keyglyph'>=</span> <span class='keyword'>do</span> <span class='varid'>e</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>getEnvironment</span>
<a name="(line63)"></a>                 <span class='keyword'>let</span> <span class='varid'>r</span> <span class='keyglyph'>=</span> <span class='varid'>fromJust'</span> <span class='str'>"setCookie"</span> <span class='varop'>$</span> <span class='varid'>getResponse</span> <span class='varid'>e</span>
<a name="(line64)"></a>                 <span class='varid'>setResponse</span> <span class='varop'>$</span> <span class='varid'>insertHeaders</span> <span class='keyglyph'>[</span><span class='conid'>Header</span> <span class='conid'>HdrSetCookie</span> <span class='varop'>$</span> <span class='varid'>showCookie</span> <span class='varid'>c</span><span class='keyglyph'>]</span> <span class='varid'>r</span>
<a name="(line65)"></a>
<a name="(line66)"></a><a name="mkCookie"></a><span class='comment'>-- | Construct a cookie with only name and value set.</span>
<a name="(line67)"></a><span class='comment'>--   This client will expire when the browser sessions ends,</span>
<a name="(line68)"></a><span class='comment'>--   will only be sent to the server and path which set it</span>
<a name="(line69)"></a><span class='comment'>--   and may be sent using any means.</span>
<a name="(line70)"></a><span class='varid'>mkCookie</span> <span class='keyglyph'>::</span> <span class='conid'>String</span> <span class='comment'>-- ^ Name</span>
<a name="(line71)"></a>         <span class='keyglyph'>-&gt;</span> <span class='conid'>String</span> <span class='comment'>-- ^ Value</span>
<a name="(line72)"></a>         <span class='keyglyph'>-&gt;</span> <span class='conid'>Cookie</span> <span class='comment'>-- ^ Cookie</span>
<a name="(line73)"></a><span class='varid'>mkCookie</span> <span class='varid'>name</span> <span class='varid'>value</span> <span class='keyglyph'>=</span> <span class='conid'>Cookie</span> <span class='layout'>{</span> <span class='varid'>cookieName</span> <span class='keyglyph'>=</span> <span class='varid'>name</span><span class='layout'>,</span>
<a name="(line74)"></a>                               <span class='varid'>cookieValue</span> <span class='keyglyph'>=</span> <span class='varid'>value</span><span class='layout'>,</span>
<a name="(line75)"></a>                               <span class='varid'>cookieExpires</span> <span class='keyglyph'>=</span> <span class='conid'>Nothing</span><span class='layout'>,</span>
<a name="(line76)"></a>                               <span class='varid'>cookieDomain</span> <span class='keyglyph'>=</span> <span class='conid'>Nothing</span><span class='layout'>,</span>
<a name="(line77)"></a>                               <span class='varid'>cookiePath</span> <span class='keyglyph'>=</span> <span class='conid'>Nothing</span>
<a name="(line78)"></a>                              <span class='layout'>}</span>
<a name="(line79)"></a>
<a name="(line80)"></a><a name="deleteCookie"></a><span class='comment'>-- | Delete a cookie from the client by setting the cookie expiry date</span>
<a name="(line81)"></a><span class='comment'>--   to a date in the past.</span>
<a name="(line82)"></a><span class='varid'>deleteCookie</span> <span class='keyglyph'>::</span> <span class='conid'>HasEnvironment</span> <span class='varid'>m</span> <span class='keyglyph'>=&gt;</span> 
<a name="(line83)"></a>                <span class='conid'>String</span> <span class='comment'>-- ^ Cookie to delete.</span>
<a name="(line84)"></a>                <span class='keyglyph'>-&gt;</span> <span class='varid'>m</span> <span class='conid'>()</span>
<a name="(line85)"></a><span class='varid'>deleteCookie</span> <span class='varid'>c</span> <span class='keyglyph'>=</span> <span class='varid'>setCookie</span> <span class='varop'>$</span> <span class='varid'>c'</span> <span class='layout'>{</span> <span class='varid'>cookieExpires</span> <span class='keyglyph'>=</span> <span class='conid'>Just</span> <span class='varid'>epoch</span> <span class='layout'>}</span>
<a name="(line86)"></a>   <span class='keyword'>where</span>
<a name="(line87)"></a>    <span class='varid'>c'</span> <span class='keyglyph'>=</span> <span class='varid'>mkCookie</span> <span class='varid'>c</span> <span class='str'>""</span>
<a name="(line88)"></a>    <span class='varid'>epoch</span> <span class='keyglyph'>=</span> <span class='conid'>UTCTime</span> <span class='layout'>(</span><span class='conid'>ModifiedJulianDay</span> <span class='num'>100</span><span class='layout'>)</span> <span class='layout'>(</span><span class='varid'>secondsToDiffTime</span> <span class='num'>0</span><span class='layout'>)</span>
<a name="(line89)"></a><span class='comment'>--</span>
<a name="(line90)"></a><span class='comment'>-- * Showing cookies</span>
<a name="(line91)"></a><span class='comment'>--</span>
<a name="(line92)"></a>
<a name="(line93)"></a><a name="showCookie"></a><span class='comment'>-- | Show a cookie in the format used as the value of the Set-Cookie header.</span>
<a name="(line94)"></a><span class='varid'>showCookie</span> <span class='keyglyph'>::</span> <span class='conid'>Cookie</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>String</span>
<a name="(line95)"></a><span class='varid'>showCookie</span> <span class='varid'>c</span> <span class='keyglyph'>=</span> <span class='varid'>intercalate</span> <span class='str'>"; "</span> <span class='varop'>$</span>
<a name="(line96)"></a>                <span class='varid'>showPair</span> <span class='layout'>(</span><span class='varid'>cookieName</span> <span class='varid'>c</span><span class='layout'>)</span> <span class='layout'>(</span><span class='varid'>cookieValue</span> <span class='varid'>c</span><span class='layout'>)</span>
<a name="(line97)"></a>                 <span class='conop'>:</span> <span class='varid'>catMaybes</span> <span class='keyglyph'>[</span><span class='varid'>expires</span><span class='layout'>,</span> <span class='varid'>path</span><span class='layout'>,</span> <span class='varid'>domain</span><span class='keyglyph'>]</span>
<a name="(line98)"></a>    <span class='keyword'>where</span> <span class='varid'>expires</span> <span class='keyglyph'>=</span> <span class='varid'>fmap</span> <span class='layout'>(</span><span class='varid'>showPair</span> <span class='str'>"expires"</span> <span class='varop'>.</span> <span class='varid'>dateFmt</span><span class='layout'>)</span> <span class='layout'>(</span><span class='varid'>cookieExpires</span> <span class='varid'>c</span><span class='layout'>)</span>
<a name="(line99)"></a>          <span class='varid'>domain</span> <span class='keyglyph'>=</span> <span class='varid'>fmap</span> <span class='layout'>(</span><span class='varid'>showPair</span> <span class='str'>"domain"</span><span class='layout'>)</span> <span class='layout'>(</span><span class='varid'>cookieDomain</span> <span class='varid'>c</span><span class='layout'>)</span>
<a name="(line100)"></a>          <span class='varid'>path</span> <span class='keyglyph'>=</span> <span class='varid'>fmap</span> <span class='layout'>(</span><span class='varid'>showPair</span> <span class='str'>"path"</span><span class='layout'>)</span> <span class='layout'>(</span><span class='varid'>maybe</span> <span class='layout'>(</span><span class='conid'>Just</span> <span class='str'>"/"</span><span class='layout'>)</span> <span class='conid'>Just</span> <span class='layout'>(</span><span class='varid'>cookiePath</span> <span class='varid'>c</span><span class='layout'>)</span><span class='layout'>)</span>
<a name="(line101)"></a>          <span class='varid'>dateFmt</span> <span class='keyglyph'>=</span> <span class='varid'>formatTime</span> <span class='varid'>defaultTimeLocale</span> <span class='str'>"%a, %d-%b-%Y %H:%M:%S GMT"</span>
<a name="(line102)"></a>
<a name="(line103)"></a><span class='comment'>--</span>
<a name="(line104)"></a><span class='comment'>-- * Reading cookies</span>
<a name="(line105)"></a><span class='comment'>--</span>
<a name="(line106)"></a>
<a name="(line107)"></a><a name="readCookies"></a><span class='comment'>-- | Gets all the cookies from a Cookie: header value</span>
<a name="(line108)"></a><span class='varid'>readCookies</span> <span class='keyglyph'>::</span> <span class='conid'>String</span>             <span class='comment'>-- ^ String to parse</span>
<a name="(line109)"></a>            <span class='keyglyph'>-&gt;</span> <span class='keyglyph'>[</span><span class='layout'>(</span><span class='conid'>String</span><span class='layout'>,</span><span class='conid'>String</span><span class='layout'>)</span><span class='keyglyph'>]</span>  <span class='comment'>-- ^ Cookie name - cookie value pairs</span>
<a name="(line110)"></a><span class='varid'>readCookies</span> <span class='varid'>s</span> <span class='keyglyph'>=</span> 
<a name="(line111)"></a>    <span class='keyword'>let</span> <span class='layout'>(</span><span class='varid'>xs</span><span class='layout'>,</span><span class='varid'>ys</span><span class='layout'>)</span> <span class='keyglyph'>=</span> <span class='varid'>break</span> <span class='layout'>(</span><span class='varop'>==</span><span class='chr'>'='</span><span class='layout'>)</span> <span class='layout'>(</span><span class='varid'>dropWhile</span> <span class='varid'>isSpace</span> <span class='varid'>s</span><span class='layout'>)</span>
<a name="(line112)"></a>        <span class='layout'>(</span><span class='varid'>zs</span><span class='layout'>,</span><span class='varid'>ws</span><span class='layout'>)</span> <span class='keyglyph'>=</span> <span class='varid'>break</span> <span class='layout'>(</span><span class='varop'>==</span><span class='chr'>';'</span><span class='layout'>)</span> <span class='layout'>(</span><span class='varid'>dropWhile</span> <span class='varid'>isSpace</span> <span class='layout'>(</span><span class='varid'>drop</span> <span class='num'>1</span> <span class='varid'>ys</span><span class='layout'>)</span><span class='layout'>)</span>
<a name="(line113)"></a>     <span class='keyword'>in</span> <span class='keyword'>if</span> <span class='varid'>null</span> <span class='varid'>xs</span> <span class='keyword'>then</span> <span class='conid'>[]</span> <span class='keyword'>else</span> <span class='layout'>(</span><span class='varid'>xs</span><span class='layout'>,</span><span class='varid'>zs</span><span class='layout'>)</span><span class='conop'>:</span><span class='varid'>readCookies</span> <span class='layout'>(</span><span class='varid'>drop</span> <span class='num'>1</span> <span class='varid'>ws</span><span class='layout'>)</span>
<a name="(line114)"></a>
<a name="(line115)"></a><span class='comment'>--</span>
<a name="(line116)"></a><span class='comment'>-- * Utilities</span>
<a name="(line117)"></a><span class='comment'>--</span>
<a name="(line118)"></a>
<a name="(line119)"></a><a name="maybeLast"></a><span class='comment'>-- | Return 'Nothing' is the list is empty, otherwise return</span>
<a name="(line120)"></a><span class='comment'>--   the last element of the list.</span>
<a name="(line121)"></a><span class='varid'>maybeLast</span> <span class='keyglyph'>::</span> <span class='keyglyph'>[</span><span class='varid'>a</span><span class='keyglyph'>]</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>Maybe</span> <span class='varid'>a</span>
<a name="(line122)"></a><span class='varid'>maybeLast</span> <span class='conid'>[]</span> <span class='keyglyph'>=</span> <span class='conid'>Nothing</span>
<a name="(line123)"></a><span class='varid'>maybeLast</span> <span class='varid'>xs</span> <span class='keyglyph'>=</span> <span class='conid'>Just</span> <span class='layout'>(</span><span class='varid'>last</span> <span class='varid'>xs</span><span class='layout'>)</span>
<a name="(line124)"></a>
<a name="(line125)"></a><a name="showPair"></a><span class='comment'>-- | Show a name-value pair. FIXME: if the name or value</span>
<a name="(line126)"></a><span class='comment'>--   contains semicolons, this breaks. The problem</span>
<a name="(line127)"></a><span class='comment'>--   is that the original cookie spec does not mention</span>
<a name="(line128)"></a><span class='comment'>--   how to do escaping or quoting. </span>
<a name="(line129)"></a><span class='varid'>showPair</span> <span class='keyglyph'>::</span> <span class='conid'>String</span> <span class='comment'>-- ^ name</span>
<a name="(line130)"></a>         <span class='keyglyph'>-&gt;</span> <span class='conid'>String</span> <span class='comment'>-- ^ value</span>
<a name="(line131)"></a>         <span class='keyglyph'>-&gt;</span> <span class='conid'>String</span>
<a name="(line132)"></a><span class='varid'>showPair</span> <span class='varid'>name</span> <span class='varid'>value</span> <span class='keyglyph'>=</span> <span class='varid'>name</span> <span class='varop'>++</span> <span class='str'>"="</span> <span class='varop'>++</span> <span class='varid'>value</span>
<a name="(line133)"></a>
<a name="(line134)"></a>
<a name="(line135)"></a>
</pre></body>
</html>
