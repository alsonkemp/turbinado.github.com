<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://www.cs.york.ac.uk/fp/darcs/hscolour/ -->
<title>Haskell Code by HsColour</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="(line1)"></a><span class='keyword'>module</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Environment</span><span class='varop'>.</span><span class='conid'>Settings</span> <span class='layout'>(</span>
<a name="(line2)"></a>        <span class='varid'>addSettingsToEnvironment</span><span class='layout'>,</span>
<a name="(line3)"></a>        <span class='varid'>getSetting</span><span class='layout'>,</span>
<a name="(line4)"></a>        <span class='varid'>getSetting_u</span><span class='layout'>,</span>
<a name="(line5)"></a>        <span class='varid'>setSetting</span><span class='layout'>,</span>
<a name="(line6)"></a>        <span class='varid'>getController</span><span class='layout'>,</span>
<a name="(line7)"></a>        <span class='varid'>clearLayout</span><span class='layout'>,</span>
<a name="(line8)"></a>        <span class='varid'>setLayout</span><span class='layout'>,</span>
<a name="(line9)"></a>        <span class='varid'>getView</span>
<a name="(line10)"></a>        <span class='layout'>)</span><span class='keyword'>where</span>
<a name="(line11)"></a>
<a name="(line12)"></a><span class='keyword'>import</span> <span class='conid'>Data</span><span class='varop'>.</span><span class='conid'>Dynamic</span>
<a name="(line13)"></a><span class='keyword'>import</span> <span class='keyword'>qualified</span> <span class='conid'>Data</span><span class='varop'>.</span><span class='conid'>Map</span> <span class='keyword'>as</span> <span class='conid'>M</span>
<a name="(line14)"></a><span class='keyword'>import</span> <span class='conid'>Control</span><span class='varop'>.</span><span class='conid'>Monad</span>
<a name="(line15)"></a><span class='keyword'>import</span> <span class='conid'>Control</span><span class='varop'>.</span><span class='conid'>Monad</span><span class='varop'>.</span><span class='conid'>State</span>
<a name="(line16)"></a><span class='keyword'>import</span> <span class='conid'>Data</span><span class='varop'>.</span><span class='conid'>Maybe</span>
<a name="(line17)"></a><span class='keyword'>import</span> <span class='conid'>Data</span><span class='varop'>.</span><span class='conid'>Char</span>
<a name="(line18)"></a><span class='keyword'>import</span> <span class='conid'>System</span><span class='varop'>.</span><span class='conid'>FilePath</span>
<a name="(line19)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Environment</span><span class='varop'>.</span><span class='conid'>Logger</span>
<a name="(line20)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Environment</span><span class='varop'>.</span><span class='conid'>Types</span>
<a name="(line21)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Controller</span><span class='varop'>.</span><span class='conid'>Monad</span>
<a name="(line22)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Utility</span><span class='varop'>.</span><span class='conid'>Naming</span>
<a name="(line23)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Utility</span><span class='varop'>.</span><span class='conid'>Data</span>
<a name="(line24)"></a><span class='keyword'>import</span> <span class='keyword'>qualified</span> <span class='conid'>Config</span><span class='varop'>.</span><span class='conid'>Master</span> <span class='keyword'>as</span> <span class='conid'>Config</span>
<a name="(line25)"></a>
<a name="(line26)"></a><a name="addSettingsToEnvironment"></a><span class='comment'>-- | Used during request initialization to add the 'Settings' 'Map'</span>
<a name="(line27)"></a><span class='comment'>-- to the 'Environment'.</span>
<a name="(line28)"></a><span class='varid'>addSettingsToEnvironment</span> <span class='keyglyph'>::</span> <span class='layout'>(</span><span class='conid'>HasEnvironment</span> <span class='varid'>m</span><span class='layout'>)</span> <span class='keyglyph'>=&gt;</span> <span class='varid'>m</span> <span class='conid'>()</span>
<a name="(line29)"></a><span class='varid'>addSettingsToEnvironment</span>  <span class='keyglyph'>=</span> <span class='keyword'>do</span> <span class='varid'>e</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>getEnvironment</span>
<a name="(line30)"></a>                               <span class='varid'>setEnvironment</span> <span class='varop'>$</span> <span class='varid'>e</span> <span class='layout'>{</span><span class='varid'>getSettings</span> <span class='keyglyph'>=</span> <span class='conid'>Just</span> <span class='varop'>$</span> <span class='conid'>M</span><span class='varop'>.</span><span class='varid'>fromList</span> <span class='varid'>defaultSettings</span> <span class='layout'>}</span>
<a name="(line31)"></a>
<a name="(line32)"></a><span class='comment'>------------------------------------------------------------------</span>
<a name="(line33)"></a><span class='comment'>-- Set/Get an individual settting</span>
<a name="(line34)"></a><span class='comment'>------------------------------------------------------------------</span>
<a name="(line35)"></a>
<a name="(line36)"></a><a name="getSetting"></a><span class='comment'>-- | Attempts to pull a dynamically typed value out of the 'Settings' 'Map'.</span>
<a name="(line37)"></a><span class='comment'>-- Returns @Maybe a@ where @a@ is the type inferred from usage.</span>
<a name="(line38)"></a><span class='comment'>--</span>
<a name="(line39)"></a><span class='comment'>-- IMPORTANT: This function will return Nothing if the type inferred does not match</span>
<a name="(line40)"></a><span class='comment'>-- the type in the 'Map'.  So if @1 :: Int@ is stored with a key "number",</span>
<a name="(line41)"></a><span class='comment'>-- then @getSetting "number" :: 'Controller' Integer@ will return @'Controller' Nothing@.</span>
<a name="(line42)"></a><span class='varid'>getSetting</span> <span class='keyglyph'>::</span> <span class='layout'>(</span><span class='conid'>HasEnvironment</span> <span class='varid'>m</span><span class='layout'>,</span> <span class='conid'>Typeable</span> <span class='varid'>a</span><span class='layout'>)</span> <span class='keyglyph'>=&gt;</span> <span class='conid'>String</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>m</span> <span class='layout'>(</span><span class='conid'>Maybe</span> <span class='varid'>a</span><span class='layout'>)</span>
<a name="(line43)"></a><span class='varid'>getSetting</span> <span class='varid'>s</span> <span class='keyglyph'>=</span> <span class='keyword'>do</span> <span class='varid'>e</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>getEnvironment</span>
<a name="(line44)"></a>                  <span class='varid'>return</span> <span class='varop'>$</span> <span class='varid'>maybe</span> <span class='conid'>Nothing</span> <span class='layout'>(</span><span class='varid'>fromDynamic</span><span class='layout'>)</span> <span class='layout'>(</span> <span class='conid'>M</span><span class='varop'>.</span><span class='varid'>lookup</span> <span class='varid'>s</span> <span class='layout'>(</span><span class='varid'>fromJust'</span> <span class='str'>"Settings : getSetting"</span> <span class='varop'>$</span> <span class='varid'>getSettings</span> <span class='varid'>e</span><span class='layout'>)</span> <span class='layout'>)</span>
<a name="(line45)"></a>
<a name="(line46)"></a><a name="getSetting_u"></a><span class='comment'>-- | This function is an "unsafe" version of 'getSetting' in that this function assumes that the key</span>
<a name="(line47)"></a><span class='comment'>-- *does* exist in the map.  If no key exists or if the value type does not match the inferred</span>
<a name="(line48)"></a><span class='comment'>-- type, this function will throw an error.</span>
<a name="(line49)"></a><span class='varid'>getSetting_u</span> <span class='keyglyph'>::</span> <span class='layout'>(</span><span class='conid'>HasEnvironment</span> <span class='varid'>m</span><span class='layout'>)</span> <span class='keyglyph'>=&gt;</span> <span class='conid'>String</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>m</span> <span class='conid'>String</span>
<a name="(line50)"></a><span class='varid'>getSetting_u</span> <span class='varid'>s</span> <span class='keyglyph'>=</span> <span class='keyword'>do</span> <span class='varid'>v</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>getSetting</span> <span class='varid'>s</span>
<a name="(line51)"></a>                    <span class='varid'>maybe</span> <span class='layout'>(</span><span class='varid'>error</span> <span class='varop'>$</span> <span class='str'>"getSetting_u : key does not exist - \""</span> <span class='varop'>++</span> <span class='varid'>s</span> <span class='varop'>++</span> <span class='str'>"\""</span><span class='layout'>)</span>
<a name="(line52)"></a>                          <span class='varid'>return</span>
<a name="(line53)"></a>                          <span class='varid'>v</span>
<a name="(line54)"></a>                          
<a name="(line55)"></a><a name="setSetting"></a><span class='comment'>-- | Sets a key/value pair in the 'Settings' map.  </span>
<a name="(line56)"></a><span class='comment'>--</span>
<a name="(line57)"></a><span class='comment'>-- IMPORTANT: the value must be</span>
<a name="(line58)"></a><span class='comment'>-- Typeable.  If you cannot use a Typeable (e.g. you're using a type</span>
<a name="(line59)"></a><span class='comment'>-- from a library), then you can extract Typeable fields from your value</span>
<a name="(line60)"></a><span class='comment'>-- and set those or you can convert your type to a Typeable type (e.g. using</span>
<a name="(line61)"></a><span class='comment'>-- 'show' to convert to a String). </span>
<a name="(line62)"></a><span class='varid'>setSetting</span> <span class='keyglyph'>::</span> <span class='layout'>(</span><span class='conid'>HasEnvironment</span> <span class='varid'>m</span><span class='layout'>,</span> <span class='conid'>Typeable</span> <span class='varid'>a</span><span class='layout'>)</span> <span class='keyglyph'>=&gt;</span> <span class='conid'>String</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>a</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>m</span> <span class='conid'>()</span>
<a name="(line63)"></a><span class='varid'>setSetting</span> <span class='varid'>k</span> <span class='varid'>v</span> <span class='keyglyph'>=</span> <span class='keyword'>do</span> <span class='varid'>e</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>getEnvironment</span>
<a name="(line64)"></a>                    <span class='varid'>setEnvironment</span> <span class='varop'>$</span> <span class='varid'>e</span> <span class='layout'>{</span> <span class='varid'>getSettings</span> <span class='keyglyph'>=</span> <span class='conid'>Just</span> <span class='layout'>(</span><span class='conid'>M</span><span class='varop'>.</span><span class='varid'>insert</span> <span class='varid'>k</span> <span class='layout'>(</span><span class='varid'>toDyn</span> <span class='varid'>v</span><span class='layout'>)</span> <span class='layout'>(</span><span class='varid'>fromJust'</span> <span class='str'>"Settings : setSetting"</span> <span class='varop'>$</span> <span class='varid'>getSettings</span> <span class='varid'>e</span><span class='layout'>)</span><span class='layout'>)</span><span class='layout'>}</span>
<a name="(line65)"></a>
<a name="(line66)"></a><a name="unsetSetting"></a><span class='comment'>-- | Unsets a setting.  If the key does not exist, no error is thrown.</span>
<a name="(line67)"></a><span class='varid'>unsetSetting</span> <span class='keyglyph'>::</span> <span class='layout'>(</span><span class='conid'>HasEnvironment</span> <span class='varid'>m</span><span class='layout'>)</span> <span class='keyglyph'>=&gt;</span> <span class='conid'>String</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>m</span> <span class='conid'>()</span>
<a name="(line68)"></a><span class='varid'>unsetSetting</span> <span class='varid'>k</span> <span class='keyglyph'>=</span> <span class='keyword'>do</span> <span class='varid'>e</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>getEnvironment</span>
<a name="(line69)"></a>                    <span class='varid'>setEnvironment</span> <span class='varop'>$</span> <span class='varid'>e</span> <span class='layout'>{</span> <span class='varid'>getSettings</span> <span class='keyglyph'>=</span> <span class='conid'>Just</span> <span class='layout'>(</span><span class='conid'>M</span><span class='varop'>.</span><span class='varid'>delete</span> <span class='varid'>k</span> <span class='layout'>(</span><span class='varid'>fromJust'</span> <span class='str'>"Settings : unsetSetting"</span> <span class='varop'>$</span> <span class='varid'>getSettings</span> <span class='varid'>e</span><span class='layout'>)</span><span class='layout'>)</span><span class='layout'>}</span>
<a name="(line70)"></a>
<a name="(line71)"></a><a name="defaultSettings"></a><span class='comment'>-- ! The 'Settings' to use at the start of each request.</span>
<a name="(line72)"></a><span class='varid'>defaultSettings</span> <span class='keyglyph'>::</span> <span class='keyglyph'>[</span><span class='layout'>(</span><span class='conid'>String</span><span class='layout'>,</span> <span class='conid'>Dynamic</span><span class='layout'>)</span><span class='keyglyph'>]</span>
<a name="(line73)"></a><span class='varid'>defaultSettings</span> <span class='keyglyph'>=</span> <span class='keyglyph'>[</span> <span class='layout'>(</span><span class='str'>"layout"</span><span class='layout'>,</span> <span class='varid'>toDyn</span> <span class='str'>"Default"</span><span class='layout'>)</span> <span class='keyglyph'>]</span>
<a name="(line74)"></a>
<a name="(line75)"></a><a name="getController"></a><span class='comment'>------------------------------------------------------------------</span>
<a name="(line76)"></a><span class='comment'>-- Shorthands</span>
<a name="(line77)"></a><span class='comment'>------------------------------------------------------------------</span>
<a name="(line78)"></a><span class='comment'>-- | Returns the Controller FilePath and action/function name.</span>
<a name="(line79)"></a><span class='varid'>getController</span> <span class='keyglyph'>::</span> <span class='layout'>(</span><span class='conid'>HasEnvironment</span> <span class='varid'>m</span><span class='layout'>)</span> <span class='keyglyph'>=&gt;</span> <span class='varid'>m</span> <span class='layout'>(</span><span class='conid'>FilePath</span><span class='layout'>,</span> <span class='conid'>String</span><span class='layout'>)</span>
<a name="(line80)"></a><span class='varid'>getController</span> <span class='keyglyph'>=</span> <span class='keyword'>do</span> <span class='varid'>c</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>getSetting_u</span> <span class='str'>"controller"</span>
<a name="(line81)"></a>                   <span class='varid'>a</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>getSetting_u</span> <span class='str'>"action"</span>
<a name="(line82)"></a>                   <span class='keyword'>let</span> <span class='varid'>converter</span> <span class='keyglyph'>=</span> <span class='keyword'>if</span> <span class='conid'>Config</span><span class='varop'>.</span><span class='varid'>useLowerCasePaths</span>
<a name="(line83)"></a>                                        <span class='keyword'>then</span> <span class='varid'>fromUnderscore</span>
<a name="(line84)"></a>                                        <span class='keyword'>else</span> <span class='varid'>id</span>
<a name="(line85)"></a>                   <span class='varid'>return</span> <span class='varop'>$</span> <span class='layout'>(</span><span class='varid'>converter</span> <span class='varid'>c</span><span class='layout'>,</span>
<a name="(line86)"></a>                             <span class='varid'>actionName</span> <span class='varop'>$</span> <span class='varid'>converter</span> <span class='varid'>a</span><span class='layout'>)</span>
<a name="(line87)"></a>                               <span class='keyword'>where</span> <span class='varid'>actionName</span> <span class='varid'>s</span> <span class='keyglyph'>=</span> <span class='layout'>(</span><span class='varid'>toLower</span> <span class='varop'>$</span> <span class='varid'>head</span> <span class='varid'>s</span><span class='layout'>)</span> <span class='conop'>:</span> <span class='layout'>(</span><span class='varid'>tail</span> <span class='varid'>s</span><span class='layout'>)</span>
<a name="(line88)"></a>
<a name="(line89)"></a><a name="setLayout"></a><span class='comment'>-- | Tells the 'Controller' to use a particular 'Layout' for the 'View'.</span>
<a name="(line90)"></a><span class='varid'>setLayout</span> <span class='keyglyph'>::</span> <span class='layout'>(</span><span class='conid'>HasEnvironment</span> <span class='varid'>m</span><span class='layout'>)</span> <span class='keyglyph'>=&gt;</span> <span class='conid'>String</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>m</span> <span class='conid'>()</span>
<a name="(line91)"></a><span class='varid'>setLayout</span> <span class='varid'>l</span> <span class='keyglyph'>=</span> <span class='varid'>setSetting</span> <span class='str'>"layout"</span> <span class='varid'>l</span>
<a name="(line92)"></a>
<a name="(line93)"></a><a name="clearLayout"></a><span class='comment'>-- | Tells the 'Controller' not to use a 'Layout' for the 'View'.</span>
<a name="(line94)"></a><span class='varid'>clearLayout</span> <span class='keyglyph'>::</span> <span class='layout'>(</span><span class='conid'>HasEnvironment</span> <span class='varid'>m</span><span class='layout'>)</span> <span class='keyglyph'>=&gt;</span> <span class='varid'>m</span> <span class='conid'>()</span>
<a name="(line95)"></a><span class='varid'>clearLayout</span> <span class='keyglyph'>=</span> <span class='varid'>unsetSetting</span> <span class='str'>"layout"</span>
<a name="(line96)"></a>
<a name="(line97)"></a><a name="getView"></a><span class='comment'>-- | Helper function used by the request handler.</span>
<a name="(line98)"></a><span class='varid'>getView</span> <span class='keyglyph'>::</span> <span class='layout'>(</span><span class='conid'>HasEnvironment</span> <span class='varid'>m</span><span class='layout'>)</span> <span class='keyglyph'>=&gt;</span> <span class='varid'>m</span> <span class='layout'>(</span><span class='conid'>FilePath</span><span class='layout'>,</span> <span class='conid'>String</span><span class='layout'>)</span>
<a name="(line99)"></a><span class='varid'>getView</span> <span class='keyglyph'>=</span> <span class='keyword'>do</span> <span class='varid'>c</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>getSetting_u</span> <span class='str'>"controller"</span>
<a name="(line100)"></a>             <span class='varid'>a</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>getSetting_u</span> <span class='str'>"action"</span>
<a name="(line101)"></a>             <span class='keyword'>let</span> <span class='varid'>converter</span> <span class='keyglyph'>=</span> <span class='keyword'>if</span> <span class='conid'>Config</span><span class='varop'>.</span><span class='varid'>useLowerCasePaths</span>
<a name="(line102)"></a>                                  <span class='keyword'>then</span> <span class='varid'>fromUnderscore</span>
<a name="(line103)"></a>                                  <span class='keyword'>else</span> <span class='varid'>id</span>
<a name="(line104)"></a>             <span class='varid'>return</span> <span class='layout'>(</span><span class='varid'>joinPath</span> <span class='varop'>$</span> <span class='varid'>map</span> <span class='varid'>normalise</span> <span class='keyglyph'>[</span><span class='varid'>converter</span> <span class='varid'>c</span><span class='layout'>,</span> <span class='varid'>converter</span> <span class='varid'>a</span><span class='keyglyph'>]</span><span class='layout'>,</span> <span class='str'>"markup"</span><span class='layout'>)</span>
<a name="(line105)"></a>
</pre></body>
</html>
