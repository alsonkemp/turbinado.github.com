<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://www.cs.york.ac.uk/fp/darcs/hscolour/ -->
<title>Haskell Code by HsColour</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="(line1)"></a><span class='comment'>-- -----------------------------------------------------------------------------</span>
<a name="(line2)"></a><span class='comment'>-- Copyright 2002, Simon Marlow.</span>
<a name="(line3)"></a><span class='comment'>-- Copyright 2006, Bjorn Bringert.</span>
<a name="(line4)"></a><span class='comment'>-- All rights reserved.</span>
<a name="(line5)"></a><span class='comment'>--</span>
<a name="(line6)"></a><span class='comment'>-- Redistribution and use in source and binary forms, with or without</span>
<a name="(line7)"></a><span class='comment'>-- modification, are permitted provided that the following conditions are</span>
<a name="(line8)"></a><span class='comment'>-- met:</span>
<a name="(line9)"></a><span class='comment'>--</span>
<a name="(line10)"></a><span class='comment'>--  * Redistributions of source code must retain the above copyright notice,</span>
<a name="(line11)"></a><span class='comment'>--    this list of conditions and the following disclaimer.</span>
<a name="(line12)"></a><span class='comment'>--</span>
<a name="(line13)"></a><span class='comment'>--  * Redistributions in binary form must reproduce the above copyright</span>
<a name="(line14)"></a><span class='comment'>--    notice, this list of conditions and the following disclaimer in the</span>
<a name="(line15)"></a><span class='comment'>--    documentation and/or other materials provided with the distribution.</span>
<a name="(line16)"></a><span class='comment'>--</span>
<a name="(line17)"></a><span class='comment'>--  * Neither the name of the copyright holder(s) nor the names of</span>
<a name="(line18)"></a><span class='comment'>--    contributors may be used to endorse or promote products derived from</span>
<a name="(line19)"></a><span class='comment'>--    this software without specific prior written permission.</span>
<a name="(line20)"></a><span class='comment'>--</span>
<a name="(line21)"></a><span class='comment'>-- THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span>
<a name="(line22)"></a><span class='comment'>-- "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span>
<a name="(line23)"></a><span class='comment'>-- LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR</span>
<a name="(line24)"></a><span class='comment'>-- A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT</span>
<a name="(line25)"></a><span class='comment'>-- OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,</span>
<a name="(line26)"></a><span class='comment'>-- SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT</span>
<a name="(line27)"></a><span class='comment'>-- LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,</span>
<a name="(line28)"></a><span class='comment'>-- DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY</span>
<a name="(line29)"></a><span class='comment'>-- THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span>
<a name="(line30)"></a><span class='comment'>-- (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span>
<a name="(line31)"></a><span class='comment'>-- OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<a name="(line32)"></a><span class='comment'>-- -----------------------------------------------------------------------------</span>
<a name="(line33)"></a>
<a name="(line34)"></a><span class='keyword'>module</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Environment</span><span class='varop'>.</span><span class='conid'>MimeTypes</span> <span class='layout'>(</span>
<a name="(line35)"></a>    <span class='varid'>setMimeTypes</span><span class='layout'>,</span>
<a name="(line36)"></a>    <span class='varid'>mimeTypeOf</span><span class='layout'>,</span>
<a name="(line37)"></a>    <span class='varid'>addMimeTypesToEnvironment</span>
<a name="(line38)"></a>    <span class='layout'>)</span> <span class='keyword'>where</span>
<a name="(line39)"></a>
<a name="(line40)"></a><span class='keyword'>import</span> <span class='conid'>Data</span><span class='varop'>.</span><span class='conid'>List</span>
<a name="(line41)"></a><span class='keyword'>import</span> <span class='conid'>Data</span><span class='varop'>.</span><span class='conid'>Map</span> <span class='layout'>(</span><span class='conid'>Map</span><span class='layout'>)</span>
<a name="(line42)"></a><span class='keyword'>import</span> <span class='conid'>Data</span><span class='varop'>.</span><span class='conid'>Typeable</span>
<a name="(line43)"></a><span class='keyword'>import</span> <span class='keyword'>qualified</span> <span class='conid'>Data</span><span class='varop'>.</span><span class='conid'>Map</span> <span class='keyword'>as</span> <span class='conid'>Map</span> <span class='varid'>hiding</span> <span class='layout'>(</span><span class='conid'>Map</span><span class='layout'>)</span>
<a name="(line44)"></a><span class='keyword'>import</span> <span class='conid'>Text</span><span class='varop'>.</span><span class='conid'>ParserCombinators</span><span class='varop'>.</span><span class='conid'>Parsec</span>
<a name="(line45)"></a><span class='keyword'>import</span> <span class='conid'>Control</span><span class='varop'>.</span><span class='conid'>Monad</span><span class='varop'>.</span><span class='conid'>State</span>
<a name="(line46)"></a><span class='keyword'>import</span> <span class='conid'>Control</span><span class='varop'>.</span><span class='conid'>Monad</span><span class='varop'>.</span><span class='conid'>Trans</span>
<a name="(line47)"></a>
<a name="(line48)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Environment</span><span class='varop'>.</span><span class='conid'>Types</span>
<a name="(line49)"></a>
<a name="(line50)"></a><a name="setMimeTypes"></a><span class='varid'>setMimeTypes</span> <span class='keyglyph'>::</span> <span class='layout'>(</span><span class='conid'>HasEnvironment</span> <span class='varid'>m</span><span class='layout'>)</span> <span class='keyglyph'>=&gt;</span> <span class='conid'>MimeTypes</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>m</span> <span class='conid'>()</span>
<a name="(line51)"></a><span class='varid'>setMimeTypes</span> <span class='varid'>mi</span> <span class='keyglyph'>=</span> <span class='keyword'>do</span> <span class='varid'>e</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>getEnvironment</span>
<a name="(line52)"></a>                     <span class='varid'>setEnvironment</span> <span class='varop'>$</span> <span class='varid'>e</span> <span class='layout'>{</span><span class='varid'>getMimeTypes</span> <span class='keyglyph'>=</span> <span class='conid'>Just</span> <span class='varid'>mi</span><span class='layout'>}</span>
<a name="(line53)"></a>
<a name="(line54)"></a><a name="addMimeTypesToEnvironment"></a><span class='varid'>addMimeTypesToEnvironment</span> <span class='keyglyph'>::</span> <span class='layout'>(</span><span class='conid'>HasEnvironment</span> <span class='varid'>m</span><span class='layout'>)</span> <span class='keyglyph'>=&gt;</span> <span class='conid'>FilePath</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>m</span> <span class='conid'>()</span>
<a name="(line55)"></a><span class='varid'>addMimeTypesToEnvironment</span> <span class='varid'>mime_types_file</span> <span class='keyglyph'>=</span>
<a name="(line56)"></a>    <span class='keyword'>do</span> <span class='varid'>stuff</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>liftIO</span> <span class='varop'>$</span> <span class='varid'>readFile</span> <span class='varid'>mime_types_file</span>
<a name="(line57)"></a>       <span class='varid'>setMimeTypes</span> <span class='layout'>(</span><span class='conid'>MimeTypes</span> <span class='varop'>$</span> <span class='conid'>Map</span><span class='varop'>.</span><span class='varid'>fromList</span> <span class='layout'>(</span><span class='varid'>parseMimeTypes</span> <span class='varid'>stuff</span><span class='layout'>)</span><span class='layout'>)</span>
<a name="(line58)"></a>
<a name="(line59)"></a>
<a name="(line60)"></a><a name="mimeTypeOf"></a><span class='varid'>mimeTypeOf</span> <span class='keyglyph'>::</span> <span class='conid'>MimeTypes</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>FilePath</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>Maybe</span> <span class='conid'>MimeType</span>
<a name="(line61)"></a><span class='varid'>mimeTypeOf</span> <span class='layout'>(</span><span class='conid'>MimeTypes</span> <span class='varid'>mime_types</span><span class='layout'>)</span> <span class='varid'>filename</span> <span class='keyglyph'>=</span>
<a name="(line62)"></a>    <span class='keyword'>do</span> <span class='keyword'>let</span> <span class='varid'>ext</span> <span class='keyglyph'>=</span> <span class='varid'>extension</span> <span class='varid'>filename</span>
<a name="(line63)"></a>       <span class='keyword'>if</span> <span class='varid'>null</span> <span class='varid'>ext</span>
<a name="(line64)"></a>         <span class='keyword'>then</span> <span class='conid'>Nothing</span>
<a name="(line65)"></a>         <span class='keyword'>else</span> <span class='conid'>Map</span><span class='varop'>.</span><span class='varid'>lookup</span> <span class='varid'>ext</span> <span class='varid'>mime_types</span>
<a name="(line66)"></a>
<a name="(line67)"></a><a name="extension"></a><span class='varid'>extension</span> <span class='keyglyph'>::</span> <span class='conid'>String</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>String</span>
<a name="(line68)"></a><span class='varid'>extension</span> <span class='varid'>fn</span> <span class='keyglyph'>=</span> <span class='varid'>go</span> <span class='layout'>(</span><span class='varid'>reverse</span> <span class='varid'>fn</span><span class='layout'>)</span> <span class='str'>""</span>
<a name="(line69)"></a>  <span class='keyword'>where</span> <span class='varid'>go</span> <span class='conid'>[]</span>      <span class='keyword'>_</span>   <span class='keyglyph'>=</span> <span class='str'>""</span>
<a name="(line70)"></a>        <span class='varid'>go</span> <span class='layout'>(</span><span class='chr'>'.'</span><span class='conop'>:</span><span class='keyword'>_</span><span class='layout'>)</span> <span class='varid'>ext</span> <span class='keyglyph'>=</span> <span class='varid'>ext</span>
<a name="(line71)"></a>        <span class='varid'>go</span> <span class='layout'>(</span><span class='varid'>x</span><span class='conop'>:</span><span class='varid'>s</span><span class='layout'>)</span>   <span class='varid'>ext</span> <span class='keyglyph'>=</span> <span class='varid'>go</span> <span class='varid'>s</span> <span class='layout'>(</span><span class='varid'>x</span><span class='conop'>:</span><span class='varid'>ext</span><span class='layout'>)</span>
<a name="(line72)"></a>
<a name="(line73)"></a><a name="parseMimeTypes"></a><span class='varid'>parseMimeTypes</span> <span class='keyglyph'>::</span> <span class='conid'>String</span> <span class='keyglyph'>-&gt;</span> <span class='keyglyph'>[</span><span class='layout'>(</span><span class='conid'>String</span><span class='layout'>,</span><span class='conid'>MimeType</span><span class='layout'>)</span><span class='keyglyph'>]</span>
<a name="(line74)"></a><span class='varid'>parseMimeTypes</span> <span class='varid'>file</span> <span class='keyglyph'>=</span>
<a name="(line75)"></a>  <span class='keyglyph'>[</span> <span class='layout'>(</span><span class='varid'>ext</span><span class='layout'>,</span><span class='varid'>val</span><span class='layout'>)</span>
<a name="(line76)"></a>  <span class='keyglyph'>|</span> <span class='conid'>Just</span> <span class='layout'>(</span><span class='varid'>val</span><span class='layout'>,</span><span class='varid'>exts</span><span class='layout'>)</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>map</span> <span class='layout'>(</span><span class='varid'>parseMimeLine</span> <span class='varop'>.</span> <span class='varid'>takeWhile</span> <span class='layout'>(</span><span class='varop'>/=</span> <span class='chr'>'#'</span><span class='layout'>)</span><span class='layout'>)</span> <span class='layout'>(</span><span class='varid'>lines</span> <span class='varid'>file</span><span class='layout'>)</span>
<a name="(line77)"></a>  <span class='layout'>,</span> <span class='varid'>ext</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>exts</span>
<a name="(line78)"></a>  <span class='keyglyph'>]</span>
<a name="(line79)"></a>
<a name="(line80)"></a><a name="parseMimeLine"></a><span class='varid'>parseMimeLine</span> <span class='keyglyph'>::</span> <span class='conid'>String</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>Maybe</span> <span class='layout'>(</span><span class='conid'>MimeType</span><span class='layout'>,</span> <span class='keyglyph'>[</span><span class='conid'>String</span><span class='keyglyph'>]</span><span class='layout'>)</span>
<a name="(line81)"></a><span class='varid'>parseMimeLine</span> <span class='varid'>l</span> <span class='keyglyph'>=</span> <span class='keyword'>case</span> <span class='varid'>parse</span> <span class='varid'>pMimeLine</span> <span class='str'>"MIME line"</span> <span class='varid'>l</span> <span class='keyword'>of</span>
<a name="(line82)"></a>                    <span class='conid'>Left</span> <span class='keyword'>_</span>  <span class='keyglyph'>-&gt;</span> <span class='conid'>Nothing</span>
<a name="(line83)"></a>                    <span class='conid'>Right</span> <span class='varid'>m</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>Just</span> <span class='varid'>m</span>
<a name="(line84)"></a>
<a name="(line85)"></a><a name="pMimeLine"></a><span class='varid'>pMimeLine</span> <span class='keyglyph'>::</span> <span class='conid'>Parser</span> <span class='layout'>(</span><span class='conid'>MimeType</span><span class='layout'>,</span> <span class='keyglyph'>[</span><span class='conid'>String</span><span class='keyglyph'>]</span><span class='layout'>)</span>
<a name="(line86)"></a><span class='varid'>pMimeLine</span> <span class='keyglyph'>=</span> <span class='keyword'>do</span> <span class='varid'>t</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>pMimeType</span>
<a name="(line87)"></a>               <span class='varid'>es</span> <span class='keyglyph'>&lt;-</span> <span class='layout'>(</span><span class='varid'>spaces</span> <span class='varop'>&gt;&gt;</span> <span class='varid'>sepBy</span> <span class='varid'>pToken</span> <span class='varid'>spaces</span><span class='layout'>)</span>
<a name="(line88)"></a>               <span class='varid'>return</span> <span class='layout'>(</span><span class='varid'>t</span><span class='layout'>,</span> <span class='varid'>es</span><span class='layout'>)</span>
<a name="(line89)"></a>
<a name="(line90)"></a><a name="pMimeType"></a><span class='varid'>pMimeType</span> <span class='keyglyph'>::</span> <span class='conid'>Parser</span> <span class='conid'>MimeType</span>
<a name="(line91)"></a><span class='varid'>pMimeType</span> <span class='keyglyph'>=</span> <span class='keyword'>do</span> <span class='varid'>part1</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>pToken</span>
<a name="(line92)"></a>               <span class='varid'>char</span> <span class='chr'>'/'</span>
<a name="(line93)"></a>               <span class='varid'>part2</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>pToken</span>
<a name="(line94)"></a>               <span class='varid'>return</span> <span class='varop'>$</span> <span class='conid'>MimeType</span> <span class='varid'>part1</span> <span class='varid'>part2</span>
<a name="(line95)"></a>
<a name="(line96)"></a><a name="especials"></a><span class='varid'>especials</span><span class='layout'>,</span> <span class='varid'>tokenchar</span> <span class='keyglyph'>::</span> <span class='keyglyph'>[</span><span class='conid'>Char</span><span class='keyglyph'>]</span>
<a name="(line97)"></a><span class='varid'>especials</span> <span class='keyglyph'>=</span> <span class='str'>"()&lt;&gt;@,;:\\\"/[]?.="</span>
<a name="(line98)"></a><a name="tokenchar"></a><span class='varid'>tokenchar</span> <span class='keyglyph'>=</span> <span class='str'>"!\"#$%&amp;'()*+,-./0123456789:;&lt;=&gt;?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~"</span> <span class='varop'>\\</span> <span class='varid'>especials</span>
<a name="(line99)"></a>
<a name="(line100)"></a><a name="pToken"></a><span class='varid'>pToken</span> <span class='keyglyph'>::</span> <span class='conid'>Parser</span> <span class='conid'>String</span>
<a name="(line101)"></a><span class='varid'>pToken</span> <span class='keyglyph'>=</span> <span class='varid'>many1</span> <span class='layout'>(</span><span class='varid'>oneOf</span> <span class='varid'>tokenchar</span><span class='layout'>)</span>
<a name="(line102)"></a>
</pre></body>
</html>
