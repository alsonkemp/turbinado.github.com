<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://www.cs.york.ac.uk/fp/darcs/hscolour/ -->
<title>Haskell Code by HsColour</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="(line1)"></a><span class='comment'>-----------------------------------------------------------------------------</span>
<a name="(line2)"></a><span class='comment'>-- |</span>
<a name="(line3)"></a><span class='comment'>-- Module      :  Turbinado.Server.StandardResponse</span>
<a name="(line4)"></a><span class='comment'>-- Copyright   :  (c) Alson Kemp 2008, Andreas Farre, Niklas Broberg, 2004</span>
<a name="(line5)"></a><span class='comment'>-- License     :  BSD-style (see the file LICENSE)</span>
<a name="(line6)"></a><span class='comment'>-- </span>
<a name="(line7)"></a><span class='comment'>-- Maintainer  :  Alson Kemp (Alson@AlsonKemp.com)</span>
<a name="(line8)"></a><span class='comment'>-- Stability   :  experimental</span>
<a name="(line9)"></a><span class='comment'>-- Portability :  portable</span>
<a name="(line10)"></a><span class='comment'>--</span>
<a name="(line11)"></a><span class='comment'>-- A set of functions to create standard HTTP responses.</span>
<a name="(line12)"></a><span class='comment'>-----------------------------------------------------------------------------</span>
<a name="(line13)"></a><span class='keyword'>module</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Server</span><span class='varop'>.</span><span class='conid'>StandardResponse</span> <span class='keyword'>where</span>
<a name="(line14)"></a>
<a name="(line15)"></a><span class='keyword'>import</span> <span class='conid'>Data</span><span class='varop'>.</span><span class='conid'>List</span>
<a name="(line16)"></a><span class='keyword'>import</span> <span class='conid'>Data</span><span class='varop'>.</span><span class='conid'>Maybe</span>
<a name="(line17)"></a><span class='keyword'>import</span> <span class='conid'>Network</span><span class='varop'>.</span><span class='conid'>HTTP</span> <span class='layout'>(</span><span class='conid'>Response</span><span class='layout'>(</span><span class='keyglyph'>..</span><span class='layout'>)</span><span class='layout'>,</span> <span class='varid'>rspHeaders</span><span class='layout'>)</span>
<a name="(line18)"></a><span class='keyword'>import</span> <span class='conid'>Network</span><span class='varop'>.</span><span class='conid'>HTTP</span><span class='varop'>.</span><span class='conid'>Stream</span>
<a name="(line19)"></a><span class='keyword'>import</span> <span class='conid'>Network</span><span class='varop'>.</span><span class='conid'>HTTP</span><span class='varop'>.</span><span class='conid'>Headers</span>
<a name="(line20)"></a><span class='keyword'>import</span> <span class='conid'>System</span><span class='varop'>.</span><span class='conid'>Locale</span>
<a name="(line21)"></a><span class='keyword'>import</span> <span class='conid'>System</span><span class='varop'>.</span><span class='conid'>Time</span>
<a name="(line22)"></a>
<a name="(line23)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Environment</span><span class='varop'>.</span><span class='conid'>Types</span>
<a name="(line24)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Environment</span><span class='varop'>.</span><span class='conid'>Response</span>
<a name="(line25)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Controller</span><span class='varop'>.</span><span class='conid'>Monad</span>
<a name="(line26)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Utility</span><span class='varop'>.</span><span class='conid'>Data</span>
<a name="(line27)"></a>
<a name="(line28)"></a><span class='comment'>-- import HSP.Data</span>
<a name="(line29)"></a><span class='keyword'>instance</span> <span class='conid'>Eq</span> <span class='conid'>Header</span> <span class='keyword'>where</span>
<a name="(line30)"></a>  <span class='layout'>(</span><span class='varop'>==</span><span class='layout'>)</span> <span class='layout'>(</span><span class='conid'>Header</span> <span class='varid'>hn1</span> <span class='keyword'>_</span><span class='layout'>)</span> <span class='layout'>(</span><span class='conid'>Header</span> <span class='varid'>hn2</span> <span class='keyword'>_</span><span class='layout'>)</span> <span class='keyglyph'>=</span> <span class='varid'>hn1</span> <span class='varop'>==</span> <span class='varid'>hn2</span>
<a name="(line31)"></a>
<a name="(line32)"></a><a name="addEmptyResponse"></a><span class='varid'>addEmptyResponse</span> <span class='keyglyph'>::</span> <span class='layout'>(</span><span class='conid'>HasEnvironment</span> <span class='varid'>m</span><span class='layout'>)</span> <span class='keyglyph'>=&gt;</span> <span class='varid'>m</span> <span class='conid'>()</span>
<a name="(line33)"></a><span class='varid'>addEmptyResponse</span> <span class='keyglyph'>=</span> 
<a name="(line34)"></a>     <span class='keyword'>do</span> <span class='varid'>t</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>liftIO</span> <span class='varop'>$</span> <span class='varid'>getClockTime</span>
<a name="(line35)"></a>        <span class='varid'>setResponse</span> <span class='layout'>(</span><span class='conid'>Response</span> <span class='layout'>(</span><span class='num'>0</span><span class='layout'>,</span><span class='num'>0</span><span class='layout'>,</span><span class='num'>0</span><span class='layout'>)</span> 
<a name="(line36)"></a>                      <span class='str'>""</span> 
<a name="(line37)"></a>                      <span class='layout'>(</span><span class='varid'>startingHeaders</span> <span class='varid'>t</span><span class='layout'>)</span> 
<a name="(line38)"></a>                      <span class='str'>""</span>
<a name="(line39)"></a>                    <span class='layout'>)</span>
<a name="(line40)"></a>
<a name="(line41)"></a><a name="fileNotFoundResponse"></a><span class='varid'>fileNotFoundResponse</span> <span class='keyglyph'>::</span> <span class='layout'>(</span><span class='conid'>HasEnvironment</span> <span class='varid'>m</span><span class='layout'>)</span> <span class='keyglyph'>=&gt;</span> <span class='conid'>FilePath</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>m</span> <span class='conid'>()</span>
<a name="(line42)"></a><span class='varid'>fileNotFoundResponse</span> <span class='varid'>fp</span> <span class='keyglyph'>=</span> 
<a name="(line43)"></a>     <span class='keyword'>do</span> <span class='varid'>t</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>liftIO</span> <span class='varop'>$</span> <span class='varid'>getClockTime</span>
<a name="(line44)"></a>        <span class='varid'>setResponse</span> <span class='layout'>(</span><span class='conid'>Response</span> <span class='layout'>(</span><span class='num'>4</span><span class='layout'>,</span><span class='num'>0</span><span class='layout'>,</span><span class='num'>4</span><span class='layout'>)</span> 
<a name="(line45)"></a>                              <span class='str'>"File Not Found"</span> 
<a name="(line46)"></a>                              <span class='layout'>(</span><span class='varid'>startingHeaders</span> <span class='varid'>t</span> <span class='varop'>++</span> <span class='keyglyph'>[</span><span class='conid'>Header</span> <span class='conid'>HdrContentLength</span> <span class='varop'>$</span> <span class='varid'>show</span> <span class='varop'>$</span> <span class='varid'>length</span> <span class='varid'>body</span><span class='keyglyph'>]</span><span class='layout'>)</span>
<a name="(line47)"></a>                              <span class='layout'>(</span><span class='varid'>body</span><span class='layout'>)</span><span class='layout'>)</span>
<a name="(line48)"></a>            <span class='keyword'>where</span> <span class='varid'>body</span> <span class='keyglyph'>=</span> <span class='str'>"&lt;html&gt;&lt;body&gt;\n &lt;p&gt;&lt;big&gt;404 File Not Found&lt;/big&gt;&lt;/p&gt;\n &lt;p&gt;Requested resource: "</span><span class='varop'>++</span> <span class='varid'>fp</span> <span class='varop'>++</span> <span class='str'>"&lt;/p&gt;\n &lt;/body&gt;&lt;/html&gt;"</span>
<a name="(line49)"></a>
<a name="(line50)"></a><a name="cachedContentResponse"></a><span class='varid'>cachedContentResponse</span> <span class='keyglyph'>::</span> <span class='layout'>(</span><span class='conid'>HasEnvironment</span> <span class='varid'>m</span><span class='layout'>)</span> <span class='keyglyph'>=&gt;</span> <span class='conid'>Int</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>String</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>String</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>m</span> <span class='conid'>()</span>
<a name="(line51)"></a><span class='varid'>cachedContentResponse</span> <span class='varid'>age</span> <span class='varid'>ct</span> <span class='varid'>body</span> <span class='keyglyph'>=</span>
<a name="(line52)"></a>     <span class='keyword'>do</span> <span class='varid'>pageResponse</span> <span class='keyglyph'>[</span> <span class='conid'>Header</span> <span class='conid'>HdrCacheControl</span> <span class='varop'>$</span> <span class='str'>"max-age="</span> <span class='varop'>++</span> <span class='layout'>(</span><span class='varid'>show</span> <span class='varid'>age</span><span class='layout'>)</span> <span class='varop'>++</span> <span class='str'>", public"</span>
<a name="(line53)"></a>                     <span class='layout'>,</span> <span class='conid'>Header</span> <span class='conid'>HdrContentType</span> <span class='varid'>ct</span><span class='keyglyph'>]</span>
<a name="(line54)"></a>                     <span class='varid'>body</span>
<a name="(line55)"></a>
<a name="(line56)"></a><a name="pageResponse"></a><span class='varid'>pageResponse</span> <span class='keyglyph'>::</span> <span class='layout'>(</span><span class='conid'>HasEnvironment</span> <span class='varid'>m</span><span class='layout'>)</span> <span class='keyglyph'>=&gt;</span> <span class='keyglyph'>[</span><span class='conid'>Header</span><span class='keyglyph'>]</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>String</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>m</span> <span class='conid'>()</span>
<a name="(line57)"></a><span class='varid'>pageResponse</span> <span class='varid'>hds</span> <span class='varid'>body</span> <span class='keyglyph'>=</span>
<a name="(line58)"></a>     <span class='keyword'>do</span> <span class='varid'>t</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>liftIO</span> <span class='varop'>$</span> <span class='varid'>getClockTime</span>
<a name="(line59)"></a>        <span class='varid'>r</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>getEnvironment</span> <span class='varop'>&gt;&gt;=</span> <span class='layout'>(</span><span class='varid'>return</span> <span class='varop'>.</span> <span class='varid'>fromJust'</span> <span class='str'>"StandardResponse : pageResponse"</span> <span class='varop'>.</span> <span class='varid'>getResponse</span><span class='layout'>)</span>
<a name="(line60)"></a>        <span class='varid'>setResponse</span> <span class='varop'>$</span> <span class='varid'>foldl</span>
<a name="(line61)"></a>                        <span class='layout'>(</span><span class='keyglyph'>\</span><span class='varid'>rs</span> <span class='layout'>(</span><span class='conid'>Header</span> <span class='varid'>hn</span> <span class='varid'>s</span><span class='layout'>)</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>replaceHeader</span> <span class='varid'>hn</span> <span class='varid'>s</span> <span class='varid'>rs</span><span class='layout'>)</span>
<a name="(line62)"></a>                        <span class='layout'>(</span><span class='conid'>Response</span> 
<a name="(line63)"></a>                          <span class='layout'>(</span><span class='num'>2</span><span class='layout'>,</span><span class='num'>0</span><span class='layout'>,</span><span class='num'>0</span><span class='layout'>)</span> 
<a name="(line64)"></a>                          <span class='str'>"OK"</span>
<a name="(line65)"></a>                          <span class='layout'>(</span><span class='varid'>rspHeaders</span> <span class='varid'>r</span> <span class='varop'>++</span> <span class='keyglyph'>[</span><span class='conid'>Header</span> <span class='conid'>HdrContentLength</span> <span class='varop'>$</span> <span class='varid'>show</span> <span class='varop'>$</span> <span class='varid'>length</span> <span class='varid'>body</span><span class='keyglyph'>]</span><span class='layout'>)</span>
<a name="(line66)"></a>                          <span class='varid'>body</span>
<a name="(line67)"></a>                        <span class='layout'>)</span>
<a name="(line68)"></a>                        <span class='varid'>hds</span>
<a name="(line69)"></a>
<a name="(line70)"></a><a name="redirectResponse"></a><span class='varid'>redirectResponse</span> <span class='keyglyph'>::</span> <span class='layout'>(</span><span class='conid'>HasEnvironment</span> <span class='varid'>m</span><span class='layout'>)</span> <span class='keyglyph'>=&gt;</span> <span class='conid'>String</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>m</span> <span class='conid'>()</span>
<a name="(line71)"></a><span class='varid'>redirectResponse</span> <span class='varid'>l</span> <span class='keyglyph'>=</span>
<a name="(line72)"></a>     <span class='keyword'>do</span> <span class='varid'>t</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>liftIO</span> <span class='varop'>$</span> <span class='varid'>getClockTime</span>
<a name="(line73)"></a>        <span class='varid'>r</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>getEnvironment</span> <span class='varop'>&gt;&gt;=</span> <span class='layout'>(</span><span class='varid'>return</span> <span class='varop'>.</span> <span class='varid'>fromJust'</span> <span class='str'>"StandardResponse : redirectResponse"</span> <span class='varop'>.</span> <span class='varid'>getResponse</span><span class='layout'>)</span>
<a name="(line74)"></a>        <span class='varid'>setResponse</span> <span class='layout'>(</span><span class='conid'>Response</span> <span class='layout'>(</span><span class='num'>3</span><span class='layout'>,</span><span class='num'>0</span><span class='layout'>,</span><span class='num'>2</span><span class='layout'>)</span> <span class='str'>"OK"</span> <span class='layout'>(</span><span class='varid'>rspHeaders</span> <span class='varid'>r</span> <span class='varop'>++</span> <span class='keyglyph'>[</span><span class='conid'>Header</span> <span class='conid'>HdrLocation</span> <span class='varid'>l</span><span class='keyglyph'>]</span><span class='layout'>)</span> <span class='str'>""</span><span class='layout'>)</span>
<a name="(line75)"></a>
<a name="(line76)"></a><a name="errorResponse"></a><span class='varid'>errorResponse</span> <span class='keyglyph'>::</span> <span class='layout'>(</span><span class='conid'>HasEnvironment</span> <span class='varid'>m</span><span class='layout'>)</span> <span class='keyglyph'>=&gt;</span> <span class='conid'>String</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>m</span> <span class='conid'>()</span>
<a name="(line77)"></a><span class='varid'>errorResponse</span> <span class='varid'>err</span> <span class='keyglyph'>=</span> 
<a name="(line78)"></a>     <span class='keyword'>do</span> <span class='varid'>t</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>liftIO</span> <span class='varop'>$</span> <span class='varid'>getClockTime</span>
<a name="(line79)"></a>        <span class='varid'>setResponse</span> <span class='layout'>(</span><span class='conid'>Response</span> <span class='layout'>(</span><span class='num'>5</span><span class='layout'>,</span><span class='num'>0</span><span class='layout'>,</span><span class='num'>0</span><span class='layout'>)</span> <span class='str'>"Internal Server Error"</span>
<a name="(line80)"></a>         	<span class='layout'>(</span><span class='varid'>startingHeaders</span> <span class='varid'>t</span>  <span class='varop'>++</span> <span class='keyglyph'>[</span><span class='conid'>Header</span> <span class='conid'>HdrContentLength</span> <span class='varop'>$</span> <span class='varid'>show</span> <span class='varop'>$</span> <span class='varid'>length</span> <span class='varid'>body</span><span class='keyglyph'>]</span><span class='layout'>)</span> <span class='varid'>body</span><span class='layout'>)</span>
<a name="(line81)"></a>  <span class='keyword'>where</span> <span class='varid'>body</span> <span class='keyglyph'>=</span> <span class='str'>"&lt;html&gt;&lt;body&gt;\n &lt;p&gt;&lt;big&gt;500 Internal Server Error&lt;/big&gt;&lt;/p&gt;\n &lt;p&gt;Error specification:&lt;br/&gt;\n"</span> <span class='varop'>++</span> <span class='varid'>err</span> <span class='varop'>++</span> <span class='str'>"&lt;/p&gt;\n &lt;/body&gt;&lt;/html&gt;"</span>
<a name="(line82)"></a>
<a name="(line83)"></a><a name="badReqResponse"></a><span class='varid'>badReqResponse</span> <span class='keyglyph'>::</span> <span class='layout'>(</span><span class='conid'>HasEnvironment</span> <span class='varid'>m</span><span class='layout'>)</span> <span class='keyglyph'>=&gt;</span> <span class='varid'>m</span> <span class='conid'>()</span>
<a name="(line84)"></a><span class='varid'>badReqResponse</span> <span class='keyglyph'>=</span>
<a name="(line85)"></a>     <span class='keyword'>do</span> <span class='varid'>t</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>liftIO</span> <span class='varop'>$</span> <span class='varid'>getClockTime</span>
<a name="(line86)"></a>        <span class='varid'>setResponse</span> <span class='layout'>(</span><span class='conid'>Response</span> <span class='layout'>(</span><span class='num'>4</span><span class='layout'>,</span><span class='num'>0</span><span class='layout'>,</span><span class='num'>0</span><span class='layout'>)</span> <span class='str'>"Bad Request"</span>
<a name="(line87)"></a>        	<span class='layout'>(</span><span class='varid'>startingHeaders</span> <span class='varid'>t</span> <span class='varop'>++</span> <span class='keyglyph'>[</span><span class='conid'>Header</span> <span class='conid'>HdrContentLength</span> <span class='varop'>$</span> <span class='varid'>show</span> <span class='varop'>$</span> <span class='varid'>length</span> <span class='varid'>body</span><span class='keyglyph'>]</span><span class='layout'>)</span> <span class='varid'>body</span><span class='layout'>)</span>
<a name="(line88)"></a>  <span class='keyword'>where</span> <span class='varid'>body</span> <span class='keyglyph'>=</span> <span class='str'>"&lt;html&gt;&lt;body&gt;\n  &lt;p&gt;&lt;big&gt;400 Bad Request&lt;/big&gt;&lt;/p&gt;\n  &lt;/body&gt;&lt;/html&gt;"</span>
<a name="(line89)"></a>
<a name="(line90)"></a>
<a name="(line91)"></a><a name="startingHeaders"></a><span class='varid'>startingHeaders</span> <span class='varid'>t</span> <span class='keyglyph'>=</span> <span class='keyglyph'>[</span> <span class='conid'>Header</span> <span class='conid'>HdrServer</span> <span class='str'>"Turbinado www.turbinado.org"</span>
<a name="(line92)"></a>                    <span class='layout'>,</span> <span class='conid'>Header</span> <span class='conid'>HdrContentType</span> <span class='str'>"text/html; charset=UTF-8"</span>
<a name="(line93)"></a>                    <span class='layout'>,</span> <span class='conid'>Header</span> <span class='conid'>HdrDate</span> <span class='varop'>$</span> <span class='varid'>formatCalendarTime</span> <span class='varid'>defaultTimeLocale</span> <span class='varid'>rfc822DateFormat</span> <span class='varop'>$</span> <span class='varid'>toUTCTime</span> <span class='varid'>t</span>
<a name="(line94)"></a>                    <span class='keyglyph'>]</span>
<a name="(line95)"></a>
</pre></body>
</html>
