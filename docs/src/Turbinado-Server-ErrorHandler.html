<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://www.cs.york.ac.uk/fp/darcs/hscolour/ -->
<title>Haskell Code by HsColour</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="(line1)"></a><span class='keyword'>module</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Server</span><span class='varop'>.</span><span class='conid'>ErrorHandler</span> <span class='keyword'>where</span>
<a name="(line2)"></a>
<a name="(line3)"></a><span class='keyword'>import</span> <span class='conid'>System</span><span class='varop'>.</span><span class='conid'>IO</span>
<a name="(line4)"></a><span class='keyword'>import</span> <span class='conid'>Prelude</span> <span class='varid'>hiding</span> <span class='layout'>(</span><span class='varid'>catch</span><span class='layout'>)</span>
<a name="(line5)"></a><span class='keyword'>import</span> <span class='conid'>Data</span><span class='varop'>.</span><span class='conid'>Dynamic</span> <span class='layout'>(</span> <span class='varid'>fromDynamic</span> <span class='layout'>)</span>
<a name="(line6)"></a><span class='keyword'>import</span> <span class='conid'>Network</span><span class='varop'>.</span><span class='conid'>FastCGI</span>
<a name="(line7)"></a><span class='keyword'>import</span> <span class='conid'>Network</span><span class='varop'>.</span><span class='conid'>Socket</span>
<a name="(line8)"></a>
<a name="(line9)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Controller</span><span class='varop'>.</span><span class='conid'>Monad</span>
<a name="(line10)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Environment</span><span class='varop'>.</span><span class='conid'>Types</span>
<a name="(line11)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Environment</span><span class='varop'>.</span><span class='conid'>Response</span>
<a name="(line12)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Server</span><span class='varop'>.</span><span class='conid'>Exception</span>
<a name="(line13)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Server</span><span class='varop'>.</span><span class='conid'>Network</span>
<a name="(line14)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Server</span><span class='varop'>.</span><span class='conid'>StandardResponse</span>
<a name="(line15)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Utility</span><span class='varop'>.</span><span class='conid'>Data</span>
<a name="(line16)"></a>
<a name="(line17)"></a><a name="handleHTTPError"></a><span class='varid'>handleHTTPError</span> <span class='keyglyph'>::</span> <span class='conid'>Socket</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>Exception</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>Environment</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>IO</span> <span class='conid'>()</span>
<a name="(line18)"></a><span class='varid'>handleHTTPError</span> <span class='varid'>s</span> <span class='varid'>ex</span> <span class='varid'>e</span> <span class='keyglyph'>=</span> 
<a name="(line19)"></a>               <span class='keyword'>do</span> <span class='varid'>runController</span> <span class='layout'>(</span><span class='varid'>errorResponse</span> <span class='varid'>err</span> <span class='varop'>&gt;&gt;</span> <span class='varid'>sendHTTPResponse</span> <span class='varid'>s</span><span class='layout'>)</span> <span class='varid'>e</span>
<a name="(line20)"></a>                  <span class='varid'>return</span> <span class='conid'>()</span>
<a name="(line21)"></a>               <span class='keyword'>where</span> <span class='varid'>err</span> <span class='keyglyph'>=</span> <span class='varid'>unlines</span> <span class='keyglyph'>[</span> <span class='str'>"Error in server: "</span> <span class='varop'>++</span> <span class='varid'>show</span> <span class='varid'>ex</span>
<a name="(line22)"></a>                                   <span class='layout'>,</span><span class='str'>" please report as a bug to alson@alsonkemp.com"</span><span class='keyglyph'>]</span>
<a name="(line23)"></a>
<a name="(line24)"></a>
<a name="(line25)"></a><a name="handleCGIError"></a><span class='varid'>handleCGIError</span> <span class='keyglyph'>::</span> <span class='conid'>Exception</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>Environment</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>IO</span> <span class='conid'>()</span>
<a name="(line26)"></a><span class='varid'>handleCGIError</span> <span class='varid'>ex</span> <span class='varid'>e</span> <span class='keyglyph'>=</span> 
<a name="(line27)"></a>            <span class='keyword'>do</span> <span class='varid'>e'</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>liftIO</span> <span class='varop'>$</span> <span class='varid'>runController</span> <span class='layout'>(</span><span class='varid'>errorResponse</span> <span class='varid'>err</span><span class='layout'>)</span> <span class='varid'>e</span>
<a name="(line28)"></a>               <span class='varid'>runFastCGIorCGI</span> <span class='varop'>$</span> <span class='varid'>sendCGIResponse</span> <span class='varid'>e'</span>
<a name="(line29)"></a>               <span class='keyword'>where</span> <span class='varid'>err</span> <span class='keyglyph'>=</span> <span class='varid'>unlines</span> <span class='keyglyph'>[</span> <span class='str'>"Error in server: "</span> <span class='varop'>++</span> <span class='varid'>show</span> <span class='varid'>ex</span>
<a name="(line30)"></a>                                   <span class='layout'>,</span><span class='str'>" please report as a bug to alson@alsonkemp.com"</span><span class='keyglyph'>]</span>
<a name="(line31)"></a>
<a name="(line32)"></a>
<a name="(line33)"></a><a name="handleHTTPTurbinado"></a><span class='varid'>handleHTTPTurbinado</span> <span class='keyglyph'>::</span> <span class='conid'>Socket</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>TurbinadoException</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>Environment</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>IO</span> <span class='conid'>()</span>
<a name="(line34)"></a><span class='varid'>handleHTTPTurbinado</span> <span class='varid'>s</span> <span class='varid'>he</span> <span class='varid'>e</span> <span class='keyglyph'>=</span> <span class='keyword'>do</span>
<a name="(line35)"></a>    <span class='varid'>e'</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>buildResponse</span> <span class='varid'>he</span> <span class='varid'>e</span>
<a name="(line36)"></a>    <span class='varid'>runController</span> <span class='layout'>(</span><span class='varid'>sendHTTPResponse</span> <span class='varid'>s</span><span class='layout'>)</span> <span class='varid'>e'</span>
<a name="(line37)"></a>    <span class='varid'>return</span> <span class='conid'>()</span>
<a name="(line38)"></a>
<a name="(line39)"></a><a name="handleCGITurbinado"></a><span class='varid'>handleCGITurbinado</span> <span class='keyglyph'>::</span> <span class='conid'>TurbinadoException</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>Environment</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>IO</span> <span class='conid'>()</span>
<a name="(line40)"></a><span class='varid'>handleCGITurbinado</span> <span class='varid'>he</span> <span class='varid'>e</span> <span class='keyglyph'>=</span> <span class='keyword'>do</span>
<a name="(line41)"></a>    <span class='varid'>e'</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>liftIO</span> <span class='varop'>$</span> <span class='varid'>buildResponse</span> <span class='varid'>he</span> <span class='varid'>e</span>
<a name="(line42)"></a>    <span class='varid'>runFastCGIorCGI</span> <span class='varop'>$</span> <span class='varid'>sendCGIResponse</span> <span class='varid'>e'</span>
<a name="(line43)"></a>
<a name="(line44)"></a><a name="buildResponse"></a><span class='varid'>buildResponse</span> <span class='varid'>he</span> <span class='varid'>e</span> <span class='keyglyph'>=</span> <span class='varid'>runController</span> <span class='layout'>(</span>
<a name="(line45)"></a>                        <span class='keyword'>case</span> <span class='varid'>he</span> <span class='keyword'>of</span>
<a name="(line46)"></a>                           <span class='conid'>CompilationFailed</span> <span class='varid'>errs</span>    <span class='keyglyph'>-&gt;</span> <span class='varid'>errorResponse</span> <span class='varid'>err</span>
<a name="(line47)"></a>                             <span class='keyword'>where</span> <span class='varid'>err</span> <span class='keyglyph'>=</span> <span class='varid'>unlines</span> <span class='varop'>$</span> <span class='str'>"File did not compile:"</span> <span class='conop'>:</span> <span class='varid'>errs</span>
<a name="(line48)"></a>                           <span class='conid'>FileNotFound</span> <span class='varid'>file</span>         <span class='keyglyph'>-&gt;</span> <span class='varid'>fileNotFoundResponse</span> <span class='varid'>file</span>
<a name="(line49)"></a>                           <span class='conid'>LoadApplicationFailed</span> <span class='varid'>dir</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>errorResponse</span> <span class='varid'>err</span>
<a name="(line50)"></a>                             <span class='keyword'>where</span> <span class='varid'>err</span> <span class='keyglyph'>=</span> <span class='str'>"Failed to load application file in directory "</span> <span class='varop'>++</span> <span class='varid'>dir</span>
<a name="(line51)"></a>                           <span class='conid'>AppCompilationFailed</span> <span class='varid'>errs</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>errorResponse</span> <span class='varid'>err</span>
<a name="(line52)"></a>                             <span class='keyword'>where</span> <span class='varid'>err</span> <span class='keyglyph'>=</span> <span class='varid'>unlines</span> <span class='varop'>$</span> <span class='str'>"Application file did not compile:"</span> <span class='conop'>:</span> <span class='varid'>errs</span>
<a name="(line53)"></a>                           <span class='conid'>NoURISpecified</span>            <span class='keyglyph'>-&gt;</span> <span class='varid'>badReqResponse</span>
<a name="(line54)"></a>                           <span class='conid'>TimedOut</span>                  <span class='keyglyph'>-&gt;</span> <span class='varid'>errorResponse</span> <span class='varid'>err</span>
<a name="(line55)"></a>                             <span class='keyword'>where</span> <span class='varid'>err</span> <span class='keyglyph'>=</span> <span class='str'>"Evaluation timed out"</span>
<a name="(line56)"></a>                           <span class='conid'>BadRequest</span> <span class='keyword'>_</span>              <span class='keyglyph'>-&gt;</span> <span class='varid'>badReqResponse</span>
<a name="(line57)"></a>                           <span class='conid'>PageEvalFailed</span> <span class='varid'>ex</span>         <span class='keyglyph'>-&gt;</span> <span class='varid'>errorResponse</span> <span class='varid'>err</span>
<a name="(line58)"></a>                             <span class='keyword'>where</span> <span class='varid'>err</span> <span class='keyglyph'>=</span> <span class='str'>"An exception occured during page evaluation\n:"</span> <span class='varop'>++</span>
<a name="(line59)"></a>                                     <span class='keyword'>case</span> <span class='varid'>ex</span> <span class='keyword'>of</span>
<a name="(line60)"></a>                                       <span class='conid'>DynException</span> <span class='varid'>dyn</span> <span class='keyglyph'>-&gt;</span> 
<a name="(line61)"></a>                                         <span class='keyword'>case</span> <span class='layout'>(</span><span class='varid'>fromDynamic</span> <span class='varid'>dyn</span> <span class='keyglyph'>::</span> <span class='conid'>Maybe</span> <span class='conid'>Exception</span><span class='layout'>)</span> <span class='keyword'>of</span>
<a name="(line62)"></a>                                           <span class='conid'>Nothing</span>   <span class='keyglyph'>-&gt;</span> <span class='varid'>show</span> <span class='varid'>ex</span>
<a name="(line63)"></a>                                           <span class='conid'>Just</span> <span class='varid'>hspe</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>show</span> <span class='varid'>hspe</span>
<a name="(line64)"></a>                                       <span class='keyword'>_</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>show</span> <span class='varid'>ex</span><span class='layout'>)</span> <span class='varid'>e</span>
<a name="(line65)"></a>
</pre></body>
</html>
