<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://www.cs.york.ac.uk/fp/darcs/hscolour/ -->
<title>Haskell Code by HsColour</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="(line1)"></a><span class='comment'>-----------------------------------------------------------------------------</span>
<a name="(line2)"></a><span class='comment'>-- |</span>
<a name="(line3)"></a><span class='comment'>-- Module      :  Turbinado.Environment.Session.CookieSession</span>
<a name="(line4)"></a><span class='comment'>-- Copyright   :  (c) Niklas Broberg 2004, Michael Snoyman 2008-2009, Alson Kemp 2009</span>
<a name="(line5)"></a><span class='comment'>-- License     :  BSD-style (see the file LICENSE)</span>
<a name="(line6)"></a><span class='comment'>-- </span>
<a name="(line7)"></a><span class='comment'>-- Maintainer  :  Alson Kemp, alson@alsonkemp.com</span>
<a name="(line8)"></a><span class='comment'>-- Stability   :  experimental</span>
<a name="(line9)"></a><span class='comment'>-- Portability :  requires undecidable and overlapping instances</span>
<a name="(line10)"></a><span class='comment'>--</span>
<a name="(line11)"></a><span class='comment'>-- Much of this code is lifted/derived from Niklas' HSP and from Michael's HWeb.</span>
<a name="(line12)"></a><span class='comment'>-----------------------------------------------------------------------------</span>
<a name="(line13)"></a><span class='keyword'>module</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Environment</span><span class='varop'>.</span><span class='conid'>Session</span><span class='varop'>.</span><span class='conid'>CookieSession</span> <span class='keyword'>where</span>
<a name="(line14)"></a>
<a name="(line15)"></a><span class='keyword'>import</span> <span class='conid'>Control</span><span class='varop'>.</span><span class='conid'>Monad</span><span class='varop'>.</span><span class='conid'>Trans</span>
<a name="(line16)"></a><span class='keyword'>import</span> <span class='conid'>Data</span><span class='varop'>.</span><span class='conid'>List</span>
<a name="(line17)"></a><span class='keyword'>import</span> <span class='conid'>Data</span><span class='varop'>.</span><span class='conid'>Maybe</span>
<a name="(line18)"></a><span class='keyword'>import</span> <span class='keyword'>qualified</span> <span class='conid'>Data</span><span class='varop'>.</span><span class='conid'>Map</span> <span class='keyword'>as</span> <span class='conid'>M</span>
<a name="(line19)"></a><span class='keyword'>import</span> <span class='conid'>Data</span><span class='varop'>.</span><span class='conid'>Time</span>
<a name="(line20)"></a><span class='keyword'>import</span> <span class='conid'>System</span><span class='varop'>.</span><span class='conid'>IO</span>
<a name="(line21)"></a>
<a name="(line22)"></a><span class='keyword'>import</span> <span class='keyword'>qualified</span> <span class='conid'>Data</span><span class='varop'>.</span><span class='conid'>Digest</span><span class='varop'>.</span><span class='conid'>MD5</span> <span class='keyword'>as</span> <span class='conid'>MD5</span>
<a name="(line23)"></a><span class='keyword'>import</span> <span class='conid'>Data</span><span class='varop'>.</span><span class='conid'>LargeWord</span> <span class='layout'>(</span><span class='conid'>Word128</span><span class='layout'>)</span>
<a name="(line24)"></a><span class='keyword'>import</span> <span class='conid'>Data</span><span class='varop'>.</span><span class='conid'>Word</span> <span class='layout'>(</span><span class='conid'>Word8</span><span class='layout'>)</span>
<a name="(line25)"></a><span class='keyword'>import</span> <span class='conid'>Codec</span><span class='varop'>.</span><span class='conid'>Encryption</span><span class='varop'>.</span><span class='conid'>Modes</span>
<a name="(line26)"></a><span class='keyword'>import</span> <span class='keyword'>qualified</span> <span class='conid'>Codec</span><span class='varop'>.</span><span class='conid'>Encryption</span><span class='varop'>.</span><span class='conid'>AES</span> <span class='keyword'>as</span> <span class='conid'>AES</span>
<a name="(line27)"></a><span class='keyword'>import</span> <span class='keyword'>qualified</span> <span class='conid'>Codec</span><span class='varop'>.</span><span class='conid'>Binary</span><span class='varop'>.</span><span class='conid'>Base64</span> <span class='keyword'>as</span> <span class='conid'>Base64</span>
<a name="(line28)"></a><span class='keyword'>import</span> <span class='conid'>Codec</span><span class='varop'>.</span><span class='conid'>Utils</span>
<a name="(line29)"></a><span class='keyword'>import</span> <span class='keyword'>qualified</span> <span class='conid'>Network</span><span class='varop'>.</span><span class='conid'>HTTP</span><span class='varop'>.</span><span class='conid'>Headers</span> <span class='keyword'>as</span> <span class='conid'>Headers</span>
<a name="(line30)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Environment</span><span class='varop'>.</span><span class='conid'>Cookie</span>
<a name="(line31)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Environment</span><span class='varop'>.</span><span class='conid'>Types</span>
<a name="(line32)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Utility</span><span class='varop'>.</span><span class='conid'>Data</span>
<a name="(line33)"></a>
<a name="(line34)"></a><a name="Key"></a><span class='keyword'>type</span> <span class='conid'>Key</span> <span class='keyglyph'>=</span> <span class='conid'>String</span>
<a name="(line35)"></a><a name="Value"></a><span class='keyword'>type</span> <span class='conid'>Value</span> <span class='keyglyph'>=</span> <span class='conid'>String</span>
<a name="(line36)"></a>
<a name="(line37)"></a>
<a name="(line38)"></a><span class='keyword'>instance</span> <span class='layout'>(</span><span class='conid'>HasEnvironment</span> <span class='varid'>m</span><span class='layout'>)</span> <span class='keyglyph'>=&gt;</span> <span class='conid'>HasSession</span> <span class='varid'>m</span> <span class='keyword'>where</span>
<a name="(line39)"></a>  <span class='varid'>newSession</span> <span class='varid'>opts</span> <span class='keyglyph'>=</span> <span class='keyword'>let</span> <span class='varid'>n</span> <span class='keyglyph'>=</span> <span class='varid'>maybe</span>
<a name="(line40)"></a>                              <span class='layout'>(</span><span class='varid'>error</span> <span class='str'>"'cookie-name' didn't exist in options passed to newSession"</span><span class='layout'>)</span>
<a name="(line41)"></a>                              <span class='varid'>id</span>
<a name="(line42)"></a>                              <span class='layout'>(</span><span class='varid'>lookup</span> <span class='str'>"cookie-name"</span> <span class='varid'>opts</span><span class='layout'>)</span>
<a name="(line43)"></a>                    <span class='keyword'>in</span> <span class='sel'>_setSession</span> <span class='varop'>$</span> <span class='varid'>emptySession</span> <span class='layout'>{</span> <span class='varid'>sessionName</span> <span class='keyglyph'>=</span> <span class='conid'>Just</span> <span class='varid'>n</span> <span class='layout'>}</span>
<a name="(line44)"></a>  <span class='varid'>hasValidSession</span> <span class='keyglyph'>=</span> <span class='keyword'>do</span> <span class='varid'>e</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>getEnvironment</span>
<a name="(line45)"></a>                       <span class='keyword'>case</span> <span class='varid'>getSession</span> <span class='varid'>e</span> <span class='keyword'>of</span>
<a name="(line46)"></a>                        <span class='conid'>Nothing</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>return</span> <span class='conid'>False</span>
<a name="(line47)"></a>                        <span class='conid'>Just</span> <span class='varid'>s</span> <span class='keyglyph'>-&gt;</span> <span class='keyword'>case</span> <span class='varid'>expires</span> <span class='varid'>s</span> <span class='keyword'>of</span>
<a name="(line48)"></a>                                    <span class='conid'>Nothing</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>return</span> <span class='conid'>True</span>
<a name="(line49)"></a>                                    <span class='conid'>Just</span> <span class='varid'>t</span>  <span class='keyglyph'>-&gt;</span> <span class='keyword'>do</span> <span class='varid'>now</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>liftIO</span> <span class='varop'>$</span> <span class='varid'>getCurrentTime</span>
<a name="(line50)"></a>                                                  <span class='varid'>return</span> <span class='varop'>$</span> <span class='varid'>t</span> <span class='varop'>&gt;</span> <span class='varid'>now</span>
<a name="(line51)"></a>  <span class='varid'>retrieveSession</span> <span class='varid'>opts</span> <span class='keyglyph'>=</span> <span class='keyword'>do</span> <span class='keyword'>let</span> <span class='varid'>c</span> <span class='keyglyph'>=</span> <span class='varid'>maybe</span>
<a name="(line52)"></a>                                     <span class='layout'>(</span><span class='varid'>error</span> <span class='str'>"'cipher-key' didn't exist in options passed to retrieveSession"</span><span class='layout'>)</span>
<a name="(line53)"></a>                                     <span class='varid'>id</span>
<a name="(line54)"></a>                                     <span class='layout'>(</span><span class='varid'>lookup</span> <span class='str'>"cipher-key"</span> <span class='varid'>opts</span><span class='layout'>)</span>
<a name="(line55)"></a>                                <span class='varid'>n</span> <span class='keyglyph'>=</span> <span class='varid'>maybe</span>
<a name="(line56)"></a>                                     <span class='layout'>(</span><span class='varid'>error</span> <span class='str'>"'cookie-name' didn't exist in options passed to retrieveSession"</span><span class='layout'>)</span>
<a name="(line57)"></a>                                     <span class='varid'>id</span>
<a name="(line58)"></a>                                     <span class='layout'>(</span><span class='varid'>lookup</span> <span class='str'>"cookie-name"</span> <span class='varid'>opts</span><span class='layout'>)</span>
<a name="(line59)"></a>                            <span class='varid'>message''</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>getCookie</span> <span class='varid'>n</span>
<a name="(line60)"></a>                            <span class='varid'>e</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>getEnvironment</span>
<a name="(line61)"></a>                            <span class='keyword'>case</span> <span class='varid'>message''</span> <span class='keyword'>of</span>
<a name="(line62)"></a>                              <span class='conid'>Nothing</span>  <span class='keyglyph'>-&gt;</span> <span class='varid'>newSession</span> <span class='varid'>opts</span>
<a name="(line63)"></a>                              <span class='conid'>Just</span> <span class='varid'>m''</span> <span class='keyglyph'>-&gt;</span> <span class='keyword'>let</span> <span class='varid'>message'</span> <span class='keyglyph'>=</span> <span class='varid'>maybeRead</span> <span class='varid'>m''</span> <span class='keyword'>in</span>
<a name="(line64)"></a>                                          <span class='keyword'>case</span> <span class='varid'>message'</span> <span class='keyword'>of</span>
<a name="(line65)"></a>                                            <span class='conid'>Nothing</span>     <span class='keyglyph'>-&gt;</span> <span class='varid'>newSession</span> <span class='varid'>opts</span>
<a name="(line66)"></a>                                            <span class='conid'>Just</span> <span class='layout'>(</span><span class='varid'>m</span><span class='layout'>,</span> <span class='varid'>h</span><span class='layout'>)</span> <span class='keyglyph'>-&gt;</span> <span class='keyword'>do</span> <span class='keyword'>let</span> <span class='varid'>messageBlocks</span> <span class='keyglyph'>=</span> <span class='varid'>unCbc</span> <span class='conid'>AES</span><span class='varop'>.</span><span class='varid'>decrypt</span> <span class='num'>0</span> <span class='layout'>(</span><span class='varid'>w8ToKey</span> <span class='varop'>$</span> <span class='conid'>MD5</span><span class='varop'>.</span><span class='varid'>hash</span> <span class='varop'>$</span> <span class='varid'>stringToW8</span> <span class='varid'>c</span><span class='layout'>)</span> <span class='layout'>(</span><span class='varid'>w8ToBlocks</span> <span class='varop'>$</span> <span class='varid'>fromJust'</span> <span class='str'>"CookieSession : retrieveSession"</span> <span class='varop'>$</span> <span class='conid'>Base64</span><span class='varop'>.</span><span class='varid'>decode</span> <span class='varid'>m</span><span class='layout'>)</span>
<a name="(line67)"></a>                                                                  <span class='varid'>hashCode</span> <span class='keyglyph'>=</span> <span class='varid'>fromJust'</span> <span class='str'>"CookieSession : retreiveSession(2)"</span> <span class='varop'>$</span> <span class='conid'>Base64</span><span class='varop'>.</span><span class='varid'>decode</span> <span class='varid'>h</span>
<a name="(line68)"></a>                                                                  <span class='varid'>hashCheck</span> <span class='keyglyph'>=</span> <span class='conid'>MD5</span><span class='varop'>.</span><span class='varid'>hash</span> <span class='varop'>$</span> <span class='varid'>blocksToW8</span> <span class='varid'>messageBlocks</span>
<a name="(line69)"></a>                                                              <span class='keyword'>if</span> <span class='layout'>(</span><span class='varid'>hashCode</span> <span class='varop'>==</span> <span class='varid'>hashCheck</span><span class='layout'>)</span>
<a name="(line70)"></a>                                                                <span class='keyword'>then</span> <span class='keyword'>let</span> <span class='varid'>s</span> <span class='keyglyph'>=</span> <span class='varid'>read</span> <span class='layout'>(</span><span class='varid'>w8ToString</span> <span class='varop'>$</span> <span class='varid'>blocksToW8</span> <span class='varid'>messageBlocks</span><span class='layout'>)</span> <span class='keyword'>in</span>
<a name="(line71)"></a>                                                                     <span class='keyword'>case</span> <span class='layout'>(</span><span class='varid'>expires</span> <span class='varid'>s</span><span class='layout'>)</span> <span class='keyword'>of</span>
<a name="(line72)"></a>                                                                       <span class='conid'>Nothing</span> <span class='keyglyph'>-&gt;</span> <span class='keyword'>do</span> <span class='sel'>_setSession</span> <span class='varid'>s</span>
<a name="(line73)"></a>                                                                       <span class='conid'>Just</span> <span class='varid'>t</span> <span class='keyglyph'>-&gt;</span> <span class='keyword'>do</span> <span class='varid'>t'</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>liftIO</span> <span class='varop'>$</span> <span class='varid'>getCurrentTime</span>
<a name="(line74)"></a>                                                                                    <span class='keyword'>if</span> <span class='layout'>(</span><span class='varid'>t</span> <span class='varop'>&gt;</span> <span class='varid'>t'</span><span class='layout'>)</span>
<a name="(line75)"></a>                                                                                     <span class='keyword'>then</span> <span class='sel'>_setSession</span> <span class='varid'>s</span>
<a name="(line76)"></a>                                                                                     <span class='keyword'>else</span> <span class='varid'>newSession</span> <span class='varid'>opts</span>
<a name="(line77)"></a>                                                                <span class='keyword'>else</span> <span class='varid'>newSession</span> <span class='varid'>opts</span>
<a name="(line78)"></a>  <span class='varid'>persistSession</span> <span class='varid'>opts</span>  <span class='keyglyph'>=</span> <span class='keyword'>do</span> <span class='varid'>e</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>getEnvironment</span>
<a name="(line79)"></a>                            <span class='keyword'>let</span> <span class='varid'>s'</span> <span class='keyglyph'>=</span> <span class='varid'>getSession</span> <span class='varid'>e</span>
<a name="(line80)"></a>                            <span class='keyword'>case</span> <span class='varid'>s'</span> <span class='keyword'>of</span>
<a name="(line81)"></a>                              <span class='conid'>Nothing</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>return</span> <span class='conid'>()</span>
<a name="(line82)"></a>                              <span class='conid'>Just</span> <span class='varid'>s</span> <span class='keyglyph'>-&gt;</span> <span class='keyword'>do</span> <span class='keyword'>let</span> <span class='varid'>c</span> <span class='keyglyph'>=</span> <span class='varid'>maybe</span>
<a name="(line83)"></a>                                                    <span class='layout'>(</span><span class='varid'>error</span> <span class='str'>"'cipher-key' didn't exist in options passed to persistSession"</span><span class='layout'>)</span>
<a name="(line84)"></a>                                                    <span class='varid'>id</span>
<a name="(line85)"></a>                                                    <span class='layout'>(</span><span class='varid'>lookup</span> <span class='str'>"cipher-key"</span> <span class='varid'>opts</span><span class='layout'>)</span>
<a name="(line86)"></a>                                               <span class='varid'>ex</span> <span class='keyglyph'>=</span> <span class='varid'>maybe</span>
<a name="(line87)"></a>                                                      <span class='conid'>Nothing</span>
<a name="(line88)"></a>                                                      <span class='varid'>maybeReadUTC</span>
<a name="(line89)"></a>                                                      <span class='layout'>(</span><span class='varid'>lookup</span> <span class='str'>"session-expires"</span> <span class='varid'>opts</span><span class='layout'>)</span>
<a name="(line90)"></a>                                               <span class='varid'>message</span> <span class='keyglyph'>=</span> <span class='varid'>stringToW8</span> <span class='varop'>$</span> <span class='varid'>show</span> <span class='varid'>s</span>
<a name="(line91)"></a>                                               <span class='varid'>cipheredMessage</span> <span class='keyglyph'>=</span> <span class='conid'>Base64</span><span class='varop'>.</span><span class='varid'>encode</span> <span class='varop'>$</span> <span class='varid'>blocksToW8</span> <span class='varop'>$</span> <span class='varid'>cbc</span> <span class='conid'>AES</span><span class='varop'>.</span><span class='varid'>encrypt</span> <span class='num'>0</span> <span class='layout'>(</span><span class='varid'>w8ToKey</span> <span class='varop'>$</span> <span class='conid'>MD5</span><span class='varop'>.</span><span class='varid'>hash</span> <span class='varop'>$</span> <span class='varid'>stringToW8</span> <span class='varid'>c</span><span class='layout'>)</span> <span class='layout'>(</span><span class='varid'>w8ToBlocks</span> <span class='varid'>message</span><span class='layout'>)</span>
<a name="(line92)"></a>                                               <span class='varid'>hashCode</span> <span class='keyglyph'>=</span> <span class='conid'>Base64</span><span class='varop'>.</span><span class='varid'>encode</span> <span class='varop'>$</span> <span class='conid'>MD5</span><span class='varop'>.</span><span class='varid'>hash</span> <span class='varid'>message</span>
<a name="(line93)"></a>                                           <span class='varid'>setCookie</span> 
<a name="(line94)"></a>                                             <span class='layout'>(</span><span class='conid'>Cookie</span> <span class='layout'>{</span><span class='varid'>cookieName</span> <span class='keyglyph'>=</span> <span class='varid'>fromJust'</span> <span class='str'>"CookieSession : persistSession"</span> <span class='varop'>$</span> <span class='varid'>sessionName</span> <span class='varid'>s</span>
<a name="(line95)"></a>                                                     <span class='layout'>,</span><span class='varid'>cookieValue</span> <span class='keyglyph'>=</span> <span class='layout'>(</span><span class='varid'>show</span> <span class='varop'>$</span> <span class='layout'>(</span><span class='varid'>cipheredMessage</span><span class='layout'>,</span> <span class='varid'>hashCode</span><span class='layout'>)</span><span class='layout'>)</span>
<a name="(line96)"></a>                                                     <span class='layout'>,</span><span class='varid'>cookieExpires</span> <span class='keyglyph'>=</span> <span class='varid'>ex</span>
<a name="(line97)"></a>                                                     <span class='layout'>,</span><span class='varid'>cookieDomain</span> <span class='keyglyph'>=</span> <span class='conid'>Nothing</span>
<a name="(line98)"></a>                                                     <span class='layout'>,</span><span class='varid'>cookiePath</span> <span class='keyglyph'>=</span> <span class='conid'>Nothing</span>
<a name="(line99)"></a>                                                     <span class='layout'>}</span>
<a name="(line100)"></a>                                             <span class='layout'>)</span>
<a name="(line101)"></a>  <span class='varid'>abandonSession</span> <span class='keyglyph'>=</span> <span class='keyword'>do</span> <span class='varid'>e</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>getEnvironment</span>
<a name="(line102)"></a>                      <span class='keyword'>let</span> <span class='varid'>s</span> <span class='keyglyph'>=</span> <span class='varid'>getSession</span> <span class='varid'>e</span>
<a name="(line103)"></a>                      <span class='varid'>setEnvironment</span> <span class='varop'>$</span> <span class='varid'>e</span> <span class='layout'>{</span><span class='varid'>getSession</span> <span class='keyglyph'>=</span> <span class='conid'>Nothing</span><span class='layout'>}</span>
<a name="(line104)"></a>                      <span class='keyword'>case</span> <span class='varid'>s</span> <span class='keyword'>of</span>
<a name="(line105)"></a>                        <span class='conid'>Nothing</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>return</span> <span class='conid'>()</span>
<a name="(line106)"></a>                        <span class='conid'>Just</span> <span class='varid'>s'</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>deleteCookie</span> <span class='layout'>(</span><span class='varid'>fromJust'</span> <span class='str'>"CookieSession : abandonSession"</span> <span class='varop'>$</span> <span class='varid'>sessionName</span> <span class='varid'>s'</span><span class='layout'>)</span>
<a name="(line107)"></a>  <span class='varid'>getSessionValue</span> <span class='varid'>k</span> <span class='keyglyph'>=</span> <span class='keyword'>do</span> <span class='varid'>s</span> <span class='keyglyph'>&lt;-</span> <span class='sel'>_getSession</span>
<a name="(line108)"></a>                         <span class='varid'>return</span> <span class='varop'>$</span> <span class='conid'>M</span><span class='varop'>.</span><span class='varid'>lookup</span> <span class='varid'>k</span> <span class='varop'>$</span> <span class='varid'>dataRep</span> <span class='varid'>s</span>
<a name="(line109)"></a>  <span class='varid'>setSessionValue</span> <span class='varid'>k</span> <span class='varid'>v</span> <span class='keyglyph'>=</span> <span class='keyword'>do</span> <span class='varid'>s</span> <span class='keyglyph'>&lt;-</span> <span class='sel'>_getSession</span>
<a name="(line110)"></a>                           <span class='keyword'>let</span> <span class='varid'>s'</span> <span class='keyglyph'>=</span> <span class='varid'>s</span> <span class='layout'>{</span><span class='varid'>dataRep</span> <span class='keyglyph'>=</span> <span class='conid'>M</span><span class='varop'>.</span><span class='varid'>insert</span> <span class='varid'>k</span> <span class='varid'>v</span> <span class='layout'>(</span><span class='varid'>dataRep</span> <span class='varid'>s</span><span class='layout'>)</span><span class='layout'>}</span>
<a name="(line111)"></a>                           <span class='sel'>_setSession</span> <span class='varid'>s'</span>
<a name="(line112)"></a>  <span class='varid'>deleteSessionKey</span> <span class='varid'>k</span> <span class='keyglyph'>=</span> <span class='keyword'>do</span> <span class='varid'>s</span> <span class='keyglyph'>&lt;-</span> <span class='sel'>_getSession</span>
<a name="(line113)"></a>                          <span class='keyword'>let</span> <span class='varid'>s'</span> <span class='keyglyph'>=</span> <span class='varid'>s</span> <span class='layout'>{</span><span class='varid'>dataRep</span> <span class='keyglyph'>=</span> <span class='conid'>M</span><span class='varop'>.</span><span class='varid'>delete</span> <span class='varid'>k</span> <span class='layout'>(</span><span class='varid'>dataRep</span> <span class='varid'>s</span><span class='layout'>)</span><span class='layout'>}</span>
<a name="(line114)"></a>                          <span class='sel'>_setSession</span> <span class='varid'>s'</span>
<a name="(line115)"></a>  <span class='varid'>getSessionExpires</span> <span class='keyglyph'>=</span> <span class='layout'>(</span><span class='varid'>return</span> <span class='varop'>.</span> <span class='varid'>expires</span><span class='layout'>)</span> <span class='varop'>=&lt;&lt;</span> <span class='sel'>_getSession</span>
<a name="(line116)"></a>  <span class='varid'>setSessionExpires</span> <span class='varid'>ct</span> <span class='keyglyph'>=</span> <span class='keyword'>do</span> <span class='varid'>s</span> <span class='keyglyph'>&lt;-</span> <span class='sel'>_getSession</span>
<a name="(line117)"></a>                            <span class='keyword'>let</span> <span class='varid'>s'</span> <span class='keyglyph'>=</span> <span class='varid'>s</span> <span class='layout'>{</span><span class='varid'>expires</span> <span class='keyglyph'>=</span> <span class='varid'>ct</span><span class='layout'>}</span>
<a name="(line118)"></a>                            <span class='sel'>_setSession</span> <span class='varid'>s'</span>
<a name="(line119)"></a>  <span class='varid'>setSessionId</span> <span class='varid'>sid</span> <span class='keyglyph'>=</span> <span class='keyword'>do</span> <span class='varid'>s</span> <span class='keyglyph'>&lt;-</span> <span class='sel'>_getSession</span>
<a name="(line120)"></a>                        <span class='keyword'>let</span> <span class='varid'>s'</span> <span class='keyglyph'>=</span> <span class='varid'>s</span> <span class='layout'>{</span><span class='varid'>sessionId</span> <span class='keyglyph'>=</span> <span class='varid'>sid</span><span class='layout'>}</span>
<a name="(line121)"></a>                        <span class='sel'>_setSession</span> <span class='varid'>s'</span>
<a name="(line122)"></a>  <span class='varid'>getSessionId</span>  <span class='keyglyph'>=</span> <span class='layout'>(</span><span class='varid'>return</span> <span class='varop'>.</span> <span class='varid'>sessionId</span><span class='layout'>)</span> <span class='varop'>=&lt;&lt;</span> <span class='sel'>_getSession</span>
<a name="(line123)"></a>
<a name="(line124)"></a>
<a name="(line125)"></a><a name="stringToW8"></a><span class='comment'>--</span>
<a name="(line126)"></a><span class='comment'>-- * Helpers </span>
<a name="(line127)"></a><span class='comment'>--</span>
<a name="(line128)"></a><span class='varid'>stringToW8</span> <span class='keyglyph'>::</span> <span class='conid'>String</span> <span class='keyglyph'>-&gt;</span> <span class='keyglyph'>[</span><span class='conid'>Word8</span><span class='keyglyph'>]</span>
<a name="(line129)"></a><span class='varid'>stringToW8</span> <span class='keyglyph'>=</span> <span class='varid'>map</span> <span class='layout'>(</span><span class='varid'>fromInteger</span> <span class='varop'>.</span> <span class='varid'>toInteger</span> <span class='varop'>.</span> <span class='varid'>fromEnum</span><span class='layout'>)</span>
<a name="(line130)"></a>
<a name="(line131)"></a><a name="w128ToW8"></a><span class='varid'>w128ToW8</span> <span class='keyglyph'>::</span> <span class='conid'>Word128</span> <span class='keyglyph'>-&gt;</span> <span class='keyglyph'>[</span><span class='conid'>Word8</span><span class='keyglyph'>]</span>
<a name="(line132)"></a><span class='varid'>w128ToW8</span> <span class='varid'>w128</span> <span class='keyglyph'>=</span> <span class='varid'>toOctets</span> <span class='num'>256</span> <span class='varid'>w128</span>
<a name="(line133)"></a>
<a name="(line134)"></a><a name="w8ToString"></a><span class='varid'>w8ToString</span> <span class='keyglyph'>::</span> <span class='keyglyph'>[</span><span class='conid'>Word8</span><span class='keyglyph'>]</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>String</span>
<a name="(line135)"></a><span class='varid'>w8ToString</span> <span class='keyglyph'>=</span> <span class='varid'>map</span> <span class='layout'>(</span><span class='varid'>toEnum</span> <span class='varop'>.</span> <span class='varid'>fromInteger</span> <span class='varop'>.</span> <span class='varid'>toInteger</span><span class='layout'>)</span>
<a name="(line136)"></a>
<a name="(line137)"></a><a name="blocksToString"></a><span class='varid'>blocksToString</span> <span class='keyglyph'>::</span> <span class='keyglyph'>[</span><span class='keyglyph'>[</span><span class='conid'>Word8</span><span class='keyglyph'>]</span><span class='keyglyph'>]</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>String</span>
<a name="(line138)"></a><span class='varid'>blocksToString</span> <span class='varid'>ws</span> <span class='keyglyph'>=</span> <span class='varid'>concat</span> <span class='varop'>$</span> <span class='varid'>map</span> <span class='varid'>w8ToString</span> <span class='varid'>ws</span>
<a name="(line139)"></a>
<a name="(line140)"></a><a name="blocksToW8"></a><span class='varid'>blocksToW8</span> <span class='keyglyph'>::</span> <span class='keyglyph'>[</span><span class='conid'>Word128</span><span class='keyglyph'>]</span> <span class='keyglyph'>-&gt;</span> <span class='keyglyph'>[</span><span class='conid'>Word8</span><span class='keyglyph'>]</span>
<a name="(line141)"></a><span class='varid'>blocksToW8</span> <span class='varid'>ws</span> <span class='keyglyph'>=</span> <span class='varid'>concat</span> <span class='varop'>$</span> <span class='varid'>map</span> <span class='varid'>w128ToW8</span> <span class='varid'>ws</span>
<a name="(line142)"></a>
<a name="(line143)"></a><a name="w8ToKey"></a><span class='varid'>w8ToKey</span> <span class='keyglyph'>::</span> <span class='keyglyph'>[</span><span class='conid'>Word8</span><span class='keyglyph'>]</span> <span class='keyglyph'>-&gt;</span>  <span class='conid'>Word128</span>
<a name="(line144)"></a><span class='varid'>w8ToKey</span> <span class='varid'>ws</span> <span class='keyglyph'>=</span> <span class='varid'>fromInteger</span> <span class='varop'>$</span> <span class='varid'>foldl</span> <span class='layout'>(</span><span class='keyglyph'>\</span><span class='varid'>acc</span> <span class='varid'>i</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>acc</span><span class='varop'>*</span><span class='num'>256</span> <span class='varop'>+</span> <span class='varid'>toInteger</span> <span class='varid'>i</span><span class='layout'>)</span> <span class='layout'>(</span><span class='num'>0</span><span class='keyglyph'>::</span><span class='conid'>Integer</span><span class='layout'>)</span> <span class='varid'>ws</span>
<a name="(line145)"></a>
<a name="(line146)"></a><a name="w8ToBlocks"></a><span class='varid'>w8ToBlocks</span> <span class='keyglyph'>::</span> <span class='keyglyph'>[</span><span class='conid'>Word8</span><span class='keyglyph'>]</span> <span class='keyglyph'>-&gt;</span> <span class='keyglyph'>[</span><span class='conid'>Word128</span><span class='keyglyph'>]</span>
<a name="(line147)"></a><span class='varid'>w8ToBlocks</span> <span class='varid'>ws</span> <span class='keyglyph'>=</span> <span class='varid'>map</span> <span class='varid'>w8ToKey</span> <span class='varop'>$</span> <span class='varid'>breakup</span> <span class='varid'>ws</span>
<a name="(line148)"></a>  <span class='keyword'>where</span> <span class='varid'>breakup</span> <span class='conid'>[]</span> <span class='keyglyph'>=</span> <span class='conid'>[]</span>
<a name="(line149)"></a>        <span class='varid'>breakup</span> <span class='varid'>ws</span> <span class='keyglyph'>=</span> <span class='layout'>(</span><span class='varid'>take</span> <span class='num'>16</span> <span class='varid'>ws</span><span class='layout'>)</span> <span class='conop'>:</span> <span class='layout'>(</span><span class='varid'>breakup</span> <span class='varop'>$</span> <span class='varid'>drop</span> <span class='num'>16</span> <span class='varid'>ws</span><span class='layout'>)</span>
<a name="(line150)"></a>
<a name="(line151)"></a><a name="maybeRead"></a><span class='varid'>maybeRead</span> <span class='keyglyph'>=</span> <span class='varid'>listToMaybe</span> <span class='varop'>.</span> <span class='varid'>map</span> <span class='varid'>fst</span> <span class='varop'>.</span> <span class='varid'>filter</span> <span class='layout'>(</span><span class='varid'>null</span> <span class='varop'>.</span> <span class='varid'>snd</span><span class='layout'>)</span> <span class='varop'>.</span> <span class='varid'>reads</span>
<a name="(line152)"></a><a name="maybeReadUTC"></a><span class='varid'>maybeReadUTC</span> <span class='keyglyph'>::</span> <span class='conid'>String</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>Maybe</span> <span class='conid'>UTCTime</span>
<a name="(line153)"></a><span class='varid'>maybeReadUTC</span> <span class='keyglyph'>=</span> <span class='varid'>listToMaybe</span> <span class='varop'>.</span> <span class='varid'>map</span> <span class='varid'>fst</span> <span class='varop'>.</span> <span class='varid'>filter</span> <span class='layout'>(</span><span class='varid'>null</span> <span class='varop'>.</span> <span class='varid'>snd</span><span class='layout'>)</span> <span class='varop'>.</span> <span class='varid'>reads</span>
<a name="(line154)"></a>
<a name="(line155)"></a><span class='sel'>_getSession</span>   <span class='keyglyph'>::</span> <span class='layout'>(</span><span class='conid'>HasEnvironment</span> <span class='varid'>m</span><span class='layout'>)</span> <span class='keyglyph'>=&gt;</span> <span class='varid'>m</span> <span class='conid'>Session</span>
<a name="(line156)"></a><span class='sel'>_getSession</span>   <span class='keyglyph'>=</span> <span class='varid'>getEnvironment</span> <span class='varop'>&gt;&gt;=</span> <span class='layout'>(</span><span class='varid'>return</span> <span class='varop'>.</span> <span class='varid'>fromJust'</span> <span class='str'>"CookieSession : _getSession"</span> <span class='varop'>.</span> <span class='varid'>getSession</span><span class='layout'>)</span>
<a name="(line157)"></a>
<a name="(line158)"></a><span class='sel'>_setSession</span>   <span class='keyglyph'>::</span> <span class='layout'>(</span><span class='conid'>HasEnvironment</span> <span class='varid'>m</span><span class='layout'>)</span> <span class='keyglyph'>=&gt;</span> <span class='conid'>Session</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>m</span> <span class='conid'>()</span>
<a name="(line159)"></a><span class='sel'>_setSession</span> <span class='varid'>s</span> <span class='keyglyph'>=</span> <span class='varid'>getEnvironment</span> <span class='varop'>&gt;&gt;=</span> <span class='layout'>(</span><span class='keyglyph'>\</span><span class='varid'>e</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>setEnvironment</span> <span class='varop'>$</span> <span class='varid'>e</span> <span class='layout'>{</span><span class='varid'>getSession</span> <span class='keyglyph'>=</span> <span class='conid'>Just</span> <span class='varid'>s</span><span class='layout'>}</span><span class='layout'>)</span>
<a name="(line160)"></a>
<a name="(line161)"></a>
</pre></body>
</html>
