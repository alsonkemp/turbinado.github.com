<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://www.cs.york.ac.uk/fp/darcs/hscolour/ -->
<title>Haskell Code by HsColour</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="(line1)"></a><span class='keyword'>module</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Database</span><span class='varop'>.</span><span class='conid'>ORM</span><span class='varop'>.</span><span class='conid'>Adapters</span><span class='varop'>.</span><span class='conid'>PostgreSQL</span> <span class='keyword'>where</span>
<a name="(line2)"></a>
<a name="(line3)"></a><span class='keyword'>import</span> <span class='conid'>Data</span><span class='varop'>.</span><span class='conid'>List</span>
<a name="(line4)"></a><span class='keyword'>import</span> <span class='conid'>Database</span><span class='varop'>.</span><span class='conid'>HDBC</span>
<a name="(line5)"></a>
<a name="(line6)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Database</span><span class='varop'>.</span><span class='conid'>ORM</span><span class='varop'>.</span><span class='conid'>Types</span>
<a name="(line7)"></a><span class='keyword'>import</span> <span class='keyword'>qualified</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Database</span><span class='varop'>.</span><span class='conid'>ORM</span><span class='varop'>.</span><span class='conid'>Adapters</span><span class='varop'>.</span><span class='conid'>Types</span> <span class='keyword'>as</span> <span class='conid'>T</span>
<a name="(line8)"></a>
<a name="(line9)"></a><a name="ormAdapter"></a><span class='varid'>ormAdapter</span> <span class='keyglyph'>=</span> <span class='conid'>T</span><span class='varop'>.</span><span class='varid'>baseAdapter</span> <span class='layout'>{</span>
<a name="(line10)"></a>               <span class='conid'>T</span><span class='varop'>.</span><span class='varid'>getPrimaryKeys</span> <span class='keyglyph'>=</span> <span class='varid'>getPrimaryKeys</span><span class='layout'>,</span>
<a name="(line11)"></a>               <span class='conid'>T</span><span class='varop'>.</span><span class='varid'>getForeignKeyReferences</span> <span class='keyglyph'>=</span> <span class='varid'>getForeignKeyReferences</span><span class='layout'>,</span>
<a name="(line12)"></a>               <span class='conid'>T</span><span class='varop'>.</span><span class='varid'>getDefaultColumns</span> <span class='keyglyph'>=</span> <span class='varid'>getDefaultColumns</span>
<a name="(line13)"></a>             <span class='layout'>}</span>
<a name="(line14)"></a>
<a name="(line15)"></a><span class='comment'>--</span>
<a name="(line16)"></a><span class='comment'>-- * Functions for extracting information from the database</span>
<a name="(line17)"></a><span class='comment'>--</span>
<a name="(line18)"></a>
<a name="(line19)"></a><a name="getPrimaryKeys"></a><span class='varid'>getPrimaryKeys</span> <span class='keyglyph'>::</span> <span class='conid'>IConnection</span> <span class='varid'>conn</span> <span class='keyglyph'>=&gt;</span> <span class='varid'>conn</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>String</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>IO</span> <span class='keyglyph'>[</span><span class='conid'>String</span><span class='keyglyph'>]</span>
<a name="(line20)"></a><span class='varid'>getPrimaryKeys</span> <span class='varid'>conn</span> <span class='varid'>t</span> <span class='keyglyph'>=</span> 
<a name="(line21)"></a>   <span class='keyword'>do</span> <span class='varid'>rs</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>quickQuery</span> <span class='varid'>conn</span> <span class='layout'>(</span><span class='varid'>concat</span>
<a name="(line22)"></a>              <span class='keyglyph'>[</span> <span class='str'>"select a.attname as column_name"</span>
<a name="(line23)"></a>              <span class='layout'>,</span> <span class='str'>"    from pg_constraint con"</span>
<a name="(line24)"></a>              <span class='layout'>,</span> <span class='str'>"    join pg_namespace n on (n.oid = con.connamespace)"</span>
<a name="(line25)"></a>              <span class='layout'>,</span> <span class='str'>"    join pg_class c on (c.oid = con.conrelid)"</span>
<a name="(line26)"></a>              <span class='layout'>,</span> <span class='str'>"    join (select g.s"</span>
<a name="(line27)"></a>              <span class='layout'>,</span> <span class='str'>"            from generate_series(1,current_setting('max_index_keys')::int,1) as g(s)"</span>
<a name="(line28)"></a>              <span class='layout'>,</span> <span class='str'>"            ) s(i) on (s.i &lt;= array_upper(con.conkey,1))"</span>
<a name="(line29)"></a>              <span class='layout'>,</span> <span class='str'>"    join pg_attribute a on (a.attrelid = c.oid"</span>
<a name="(line30)"></a>              <span class='layout'>,</span> <span class='str'>"                            and a.attnum = con.conkey[i])"</span>
<a name="(line31)"></a>              <span class='layout'>,</span> <span class='str'>"  where con.conrelid != 0"</span>
<a name="(line32)"></a>              <span class='layout'>,</span> <span class='str'>"    and con.contype in ('p','u')"</span>
<a name="(line33)"></a>              <span class='layout'>,</span> <span class='str'>"    and c.relname = ?;"</span><span class='keyglyph'>]</span><span class='layout'>)</span> <span class='keyglyph'>[</span><span class='varid'>toSql</span> <span class='varid'>t</span><span class='keyglyph'>]</span>
<a name="(line34)"></a>      <span class='varid'>return</span> <span class='varop'>$</span> <span class='varid'>map</span> <span class='layout'>(</span><span class='keyglyph'>\</span><span class='varid'>r</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>fromSql</span> <span class='varop'>$</span> <span class='varid'>r</span> <span class='varop'>!!</span> <span class='num'>0</span><span class='layout'>)</span> <span class='varid'>rs</span> 
<a name="(line35)"></a>
<a name="(line36)"></a><a name="getForeignKeyReferences"></a><span class='varid'>getForeignKeyReferences</span> <span class='keyglyph'>::</span> <span class='conid'>IConnection</span> <span class='varid'>conn</span> <span class='keyglyph'>=&gt;</span> <span class='varid'>conn</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>String</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>IO</span> <span class='keyglyph'>[</span><span class='layout'>(</span><span class='conid'>String</span><span class='layout'>,</span> <span class='conid'>String</span><span class='layout'>,</span> <span class='conid'>String</span><span class='layout'>)</span><span class='keyglyph'>]</span>
<a name="(line37)"></a><span class='varid'>getForeignKeyReferences</span> <span class='varid'>conn</span> <span class='varid'>t</span> <span class='keyglyph'>=</span> 
<a name="(line38)"></a>    <span class='keyword'>do</span> <span class='varid'>rs</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>quickQuery</span> <span class='varid'>conn</span> <span class='layout'>(</span><span class='varid'>concat</span>
<a name="(line39)"></a>               <span class='keyglyph'>[</span> <span class='str'>"select a2.attname as key_column,"</span>
<a name="(line40)"></a>               <span class='layout'>,</span> <span class='str'>"       c1.relname as foreign_key_table_name,"</span>
<a name="(line41)"></a>               <span class='layout'>,</span> <span class='str'>"       a1.attname as foreign_key_column"</span>
<a name="(line42)"></a>               <span class='layout'>,</span> <span class='str'>"       from pg_constraint k1"</span>
<a name="(line43)"></a>               <span class='layout'>,</span> <span class='str'>"         join pg_namespace n1 on (n1.oid = k1.connamespace)"</span>
<a name="(line44)"></a>               <span class='layout'>,</span> <span class='str'>"         join pg_class c1 on (c1.oid = k1.conrelid)"</span>
<a name="(line45)"></a>               <span class='layout'>,</span> <span class='str'>"         join pg_class c2 on (c2.oid = k1.confrelid)"</span>
<a name="(line46)"></a>               <span class='layout'>,</span> <span class='str'>"         join pg_namespace n2 on (n2.oid = c2.relnamespace)"</span>
<a name="(line47)"></a>               <span class='layout'>,</span> <span class='str'>"         join (select g.s"</span>
<a name="(line48)"></a>               <span class='layout'>,</span> <span class='str'>"                 from generate_series(1,current_setting('max_index_keys')::int,1) as g(s)"</span>
<a name="(line49)"></a>               <span class='layout'>,</span> <span class='str'>"              )s(i) on (s.i &lt;= array_upper(k1.conkey,1))"</span>
<a name="(line50)"></a>               <span class='layout'>,</span> <span class='str'>"         join pg_attribute a1"</span>
<a name="(line51)"></a>               <span class='layout'>,</span> <span class='str'>"           on (a1.attrelid = c1.oid and a1.attnum = k1.conkey[s.i])"</span>
<a name="(line52)"></a>               <span class='layout'>,</span> <span class='str'>"         join pg_attribute a2"</span>
<a name="(line53)"></a>               <span class='layout'>,</span> <span class='str'>"           on (a2.attrelid = c2.oid and a2.attnum = k1.confkey[s.i])"</span>
<a name="(line54)"></a>               <span class='layout'>,</span> <span class='str'>"       where k1.conrelid != 0"</span>
<a name="(line55)"></a>               <span class='layout'>,</span> <span class='str'>"         and k1.confrelid != 0"</span>
<a name="(line56)"></a>               <span class='layout'>,</span> <span class='str'>"         and k1.contype = 'f'"</span>
<a name="(line57)"></a>               <span class='layout'>,</span> <span class='str'>"         and c2.relname = ?;"</span>
<a name="(line58)"></a>               <span class='keyglyph'>]</span><span class='layout'>)</span> <span class='keyglyph'>[</span><span class='varid'>toSql</span> <span class='varid'>t</span><span class='keyglyph'>]</span>
<a name="(line59)"></a>       <span class='varid'>return</span> <span class='varop'>$</span> <span class='varid'>map</span> <span class='layout'>(</span><span class='keyglyph'>\</span><span class='varid'>r</span> <span class='keyglyph'>-&gt;</span> <span class='layout'>(</span><span class='varid'>fromSql</span> <span class='varop'>$</span> <span class='varid'>r</span> <span class='varop'>!!</span> <span class='num'>0</span><span class='layout'>,</span> <span class='varid'>fromSql</span> <span class='varop'>$</span> <span class='varid'>r</span> <span class='varop'>!!</span> <span class='num'>1</span><span class='layout'>,</span> <span class='varid'>fromSql</span> <span class='varop'>$</span> <span class='varid'>r</span> <span class='varop'>!!</span> <span class='num'>2</span><span class='layout'>)</span><span class='layout'>)</span> <span class='varid'>rs</span>
<a name="(line60)"></a>   
<a name="(line61)"></a>
<a name="(line62)"></a><a name="getDefaultColumns"></a><span class='varid'>getDefaultColumns</span><span class='keyglyph'>::</span> <span class='conid'>IConnection</span> <span class='varid'>conn</span> <span class='keyglyph'>=&gt;</span> <span class='varid'>conn</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>String</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>IO</span> <span class='keyglyph'>[</span><span class='conid'>String</span><span class='keyglyph'>]</span>
<a name="(line63)"></a><span class='varid'>getDefaultColumns</span> <span class='varid'>conn</span> <span class='varid'>t</span> <span class='keyglyph'>=</span> 
<a name="(line64)"></a>    <span class='keyword'>do</span> <span class='varid'>rs</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>quickQuery</span> <span class='varid'>conn</span> <span class='layout'>(</span><span class='varid'>concat</span>
<a name="(line65)"></a>               <span class='keyglyph'>[</span> <span class='str'>"select   a.attname as column_name"</span>
<a name="(line66)"></a>               <span class='layout'>,</span> <span class='str'>"    from pg_class c"</span>
<a name="(line67)"></a>               <span class='layout'>,</span> <span class='str'>"      join pg_namespace n on (n.oid = c.relnamespace)"</span>
<a name="(line68)"></a>               <span class='layout'>,</span> <span class='str'>"      join pg_attribute a on (a.attrelid = c.oid"</span>
<a name="(line69)"></a>               <span class='layout'>,</span> <span class='str'>"                              and not a.attisdropped"</span>
<a name="(line70)"></a>               <span class='layout'>,</span> <span class='str'>"                              and a.attnum &gt; 0)"</span>
<a name="(line71)"></a>               <span class='layout'>,</span> <span class='str'>"      left join pg_attrdef ad on (a.attrelid = ad.adrelid"</span>
<a name="(line72)"></a>               <span class='layout'>,</span> <span class='str'>"                                  and a.attnum = ad.adnum)"</span>
<a name="(line73)"></a>               <span class='layout'>,</span> <span class='str'>"    where n.nspname = 'public'"</span>
<a name="(line74)"></a>               <span class='layout'>,</span> <span class='str'>"      and c.relname = ?"</span>
<a name="(line75)"></a>               <span class='layout'>,</span> <span class='str'>"      and (ad.adsrc IS NOT NULL);"</span><span class='keyglyph'>]</span><span class='layout'>)</span> <span class='keyglyph'>[</span><span class='varid'>toSql</span> <span class='varid'>t</span><span class='keyglyph'>]</span>
<a name="(line76)"></a>       <span class='varid'>return</span> <span class='varop'>$</span> <span class='varid'>map</span> <span class='layout'>(</span><span class='keyglyph'>\</span><span class='varid'>r</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>fromSql</span> <span class='varop'>$</span> <span class='varid'>r</span> <span class='varop'>!!</span> <span class='num'>0</span><span class='layout'>)</span> <span class='varid'>rs</span>
<a name="(line77)"></a>
<a name="(line78)"></a><span class='comment'>{-
<a name="(line79)"></a>
<a name="(line80)"></a>INDEX COLUMNS
<a name="(line81)"></a>
<a name="(line82)"></a>  select n.nspname as schema_name,
<a name="(line83)"></a>         ct.relname as table_name,
<a name="(line84)"></a>         ci.relname as index_name,
<a name="(line85)"></a>         a.attname as column_name,
<a name="(line86)"></a>         s.i as column_position,
<a name="(line87)"></a>         n2.nspname as opclass_schema,
<a name="(line88)"></a>         o.opcname as opclass_name,
<a name="(line89)"></a>         pg_get_indexdef(ci.oid,s.i,true) as definition
<a name="(line90)"></a>    from pg_index x
<a name="(line91)"></a>         join pg_class ct on (ct.oid = x.indrelid)
<a name="(line92)"></a>         join pg_class ci on (ci.oid = x.indexrelid)
<a name="(line93)"></a>         join pg_namespace n on (n.oid = ct.relnamespace)
<a name="(line94)"></a>         join _pg_sv_keypositions() s(i) on (s.i &lt;= x.indnatts)
<a name="(line95)"></a>         join pg_opclass o on (o.oid = x.indclass[i-1])
<a name="(line96)"></a>         r
<a name="(line97)"></a>         join pg_namespace n2 on (n2.oid = o.opcnamespace)
<a name="(line98)"></a>         left join pg_attribute a on (a.attrelid = ct.oid
<a name="(line99)"></a>                                      and a.attnum = x.indkey[i-1])
<a name="(line100)"></a>   where _pg_sv_table_accessible(n.oid,ct.oid)
<a name="(line101)"></a>     and ct.relkind = 'r' and ci.relkind = 'i';
<a name="(line102)"></a>
<a name="(line103)"></a>PRIMARY KEY
<a name="(line104)"></a>
<a name="(line105)"></a>  select n.nspname as schema_name,
<a name="(line106)"></a>         c.relname as table_name,
<a name="(line107)"></a>         con.conname as constraint_name,
<a name="(line108)"></a>         con.contype = 'p' as is_primary_key,
<a name="(line109)"></a>         a.attname as column_name,
<a name="(line110)"></a>         s.i as column_position,
<a name="(line111)"></a>         c.oid as table_oid
<a name="(line112)"></a>    from pg_constraint con
<a name="(line113)"></a>         join pg_namespace n on (n.oid = con.connamespace)
<a name="(line114)"></a>         join pg_class c on (c.oid = con.conrelid)
<a name="(line115)"></a>         join _pg_sv_keypositions() s(i)
<a name="(line116)"></a>           on (s.i &lt;= array_upper(con.conkey,1))
<a name="(line117)"></a>         join pg_attribute a on (a.attrelid = c.oid
<a name="(line118)"></a>                                 and a.attnum = con.conkey[i])
<a name="(line119)"></a>   where con.conrelid != 0
<a name="(line120)"></a>     and con.contype in ('p','u')
<a name="(line121)"></a>     and _pg_sv_table_accessible(n.oid,c.oid);
<a name="(line122)"></a>
<a name="(line123)"></a>
<a name="(line124)"></a>FOREIGN KEYS
<a name="(line125)"></a>
<a name="(line126)"></a>  select n1.nspname as foreign_key_schema_name,
<a name="(line127)"></a>         c1.relname as foreign_key_table_name,
<a name="(line128)"></a>         k1.conname as foreign_key_constraint_name,
<a name="(line129)"></a>         c1.oid as foreign_key_table_oid,
<a name="(line130)"></a>         a1.attname as foreign_key_column,
<a name="(line131)"></a>         s.i as column_position,
<a name="(line132)"></a>         n2.nspname as key_schema_name,
<a name="(line133)"></a>         c2.relname as key_table_name,
<a name="(line134)"></a>         c2.oid as key_table_oid,
<a name="(line135)"></a>         a2.attname as key_column
<a name="(line136)"></a>    from pg_constraint k1
<a name="(line137)"></a>         join pg_namespace n1 on (n1.oid = k1.connamespace)
<a name="(line138)"></a>         join pg_class c1 on (c1.oid = k1.conrelid)
<a name="(line139)"></a>         join pg_class c2 on (c2.oid = k1.confrelid)
<a name="(line140)"></a>         join pg_namespace n2 on (n2.oid = c2.relnamespace)
<a name="(line141)"></a>         join _pg_sv_keypositions() s(i)
<a name="(line142)"></a>           on (s.i &lt;= array_upper(k1.conkey,1))
<a name="(line143)"></a>         join pg_attribute a1
<a name="(line144)"></a>           on (a1.attrelid = c1.oid and a1.attnum = k1.conkey[s.i])
<a name="(line145)"></a>         join pg_attribute a2
<a name="(line146)"></a>           on (a2.attrelid = c2.oid and a2.attnum = k1.confkey[s.i])
<a name="(line147)"></a>   where k1.conrelid != 0
<a name="(line148)"></a>     and k1.confrelid != 0
<a name="(line149)"></a>     and k1.contype = 'f'
<a name="(line150)"></a>     and _pg_sv_table_accessible(n1.oid,c1.oid);
<a name="(line151)"></a>
<a name="(line152)"></a>-}</span>
</pre></body>
</html>
