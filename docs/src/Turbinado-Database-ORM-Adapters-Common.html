<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://www.cs.york.ac.uk/fp/darcs/hscolour/ -->
<title>Haskell Code by HsColour</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="(line1)"></a><span class='keyword'>module</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Database</span><span class='varop'>.</span><span class='conid'>ORM</span><span class='varop'>.</span><span class='conid'>Adapters</span><span class='varop'>.</span><span class='conid'>Common</span> <span class='keyword'>where</span>
<a name="(line2)"></a>
<a name="(line3)"></a><span class='keyword'>import</span> <span class='keyword'>qualified</span> <span class='conid'>Data</span><span class='varop'>.</span><span class='conid'>Char</span>
<a name="(line4)"></a><span class='keyword'>import</span> <span class='conid'>Control</span><span class='varop'>.</span><span class='conid'>Monad</span>
<a name="(line5)"></a><span class='keyword'>import</span> <span class='conid'>Data</span><span class='varop'>.</span><span class='conid'>Dynamic</span>
<a name="(line6)"></a><span class='keyword'>import</span> <span class='keyword'>qualified</span> <span class='conid'>Data</span><span class='varop'>.</span><span class='conid'>Map</span> <span class='keyword'>as</span> <span class='conid'>M</span>
<a name="(line7)"></a><span class='keyword'>import</span> <span class='conid'>Data</span><span class='varop'>.</span><span class='conid'>Maybe</span>
<a name="(line8)"></a><span class='keyword'>import</span> <span class='conid'>Data</span><span class='varop'>.</span><span class='conid'>List</span>
<a name="(line9)"></a><span class='keyword'>import</span> <span class='conid'>Database</span><span class='varop'>.</span><span class='conid'>HDBC</span>
<a name="(line10)"></a><span class='keyword'>import</span> <span class='conid'>System</span><span class='varop'>.</span><span class='conid'>Directory</span>
<a name="(line11)"></a><span class='keyword'>import</span> <span class='conid'>System</span><span class='varop'>.</span><span class='conid'>FilePath</span>
<a name="(line12)"></a>
<a name="(line13)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Database</span><span class='varop'>.</span><span class='conid'>ORM</span><span class='varop'>.</span><span class='conid'>Common</span>
<a name="(line14)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Database</span><span class='varop'>.</span><span class='conid'>ORM</span><span class='varop'>.</span><span class='conid'>Types</span>
<a name="(line15)"></a>
<a name="(line16)"></a>
<a name="(line17)"></a><span class='comment'>---------------------------------------------------------------------------</span>
<a name="(line18)"></a><span class='comment'>--  File templates                                                       --</span>
<a name="(line19)"></a><span class='comment'>---------------------------------------------------------------------------</span>
<a name="(line20)"></a>
<a name="(line21)"></a><a name="generateType"></a><span class='varid'>generateType</span> <span class='keyglyph'>::</span>   <span class='conid'>TableName</span> <span class='keyglyph'>-&gt;</span>
<a name="(line22)"></a>                  <span class='conid'>TypeName</span> <span class='keyglyph'>-&gt;</span>
<a name="(line23)"></a>                  <span class='conid'>PrimaryKey</span> <span class='keyglyph'>-&gt;</span> 
<a name="(line24)"></a>                  <span class='conid'>Tables</span> <span class='keyglyph'>-&gt;</span> 
<a name="(line25)"></a>                  <span class='conid'>Columns</span> <span class='keyglyph'>-&gt;</span> 
<a name="(line26)"></a>                  <span class='conid'>String</span>
<a name="(line27)"></a><span class='varid'>generateType</span> <span class='varid'>t</span> <span class='varid'>typeName</span> <span class='varid'>pk</span> <span class='varid'>ts</span> <span class='varid'>cs</span> <span class='keyglyph'>=</span> 
<a name="(line28)"></a>  <span class='varid'>unlines</span> <span class='varop'>$</span>
<a name="(line29)"></a>  <span class='keyglyph'>[</span><span class='str'>"{- DO NOT EDIT THIS FILE"</span>
<a name="(line30)"></a>  <span class='layout'>,</span><span class='str'>"   THIS FILE IS AUTOMAGICALLY GENERATED AND YOUR CHANGES WILL BE EATEN BY THE GENERATOR OVERLORD"</span>
<a name="(line31)"></a>  <span class='layout'>,</span><span class='str'>""</span>
<a name="(line32)"></a>  <span class='layout'>,</span><span class='str'>"   All changes should go into the Model file (e.g. App/Models/ExampleModel.hs)"</span>
<a name="(line33)"></a>  <span class='layout'>,</span><span class='str'>"-}"</span>
<a name="(line34)"></a>  <span class='layout'>,</span><span class='str'>""</span>
<a name="(line35)"></a>  <span class='layout'>,</span><span class='str'>"module App.Models.Bases."</span> <span class='varop'>++</span> <span class='varid'>typeName</span> <span class='varop'>++</span> <span class='str'>"Type where"</span>
<a name="(line36)"></a>  <span class='layout'>,</span> <span class='str'>""</span>
<a name="(line37)"></a>  <span class='layout'>,</span> <span class='str'>"import App.Models.Bases.Common"</span>
<a name="(line38)"></a>  <span class='layout'>,</span> <span class='str'>"import Data.Maybe"</span>
<a name="(line39)"></a>  <span class='layout'>,</span> <span class='str'>"import Data.Time"</span>
<a name="(line40)"></a>  <span class='layout'>,</span> <span class='str'>"import Data.Typeable"</span>
<a name="(line41)"></a>  <span class='layout'>,</span> <span class='str'>""</span>
<a name="(line42)"></a>  <span class='keyglyph'>]</span> <span class='varop'>++</span>
<a name="(line43)"></a>  <span class='keyglyph'>[</span><span class='str'>"-- The data type for this model"</span><span class='keyglyph'>]</span> <span class='varop'>++</span>
<a name="(line44)"></a>  <span class='keyglyph'>[</span> <span class='str'>"data "</span> <span class='varop'>++</span> <span class='varid'>typeName</span> <span class='varop'>++</span> <span class='str'>" = "</span> <span class='varop'>++</span> <span class='varid'>typeName</span> <span class='varop'>++</span> <span class='str'>" {"</span>
<a name="(line45)"></a>  <span class='keyglyph'>]</span> <span class='varop'>++</span>
<a name="(line46)"></a>  <span class='keyglyph'>[</span><span class='varid'>intercalate</span> <span class='str'>",\n"</span> <span class='layout'>(</span><span class='varid'>map</span> <span class='varid'>columnToFieldLabel</span> <span class='layout'>(</span><span class='conid'>M</span><span class='varop'>.</span><span class='varid'>toList</span> <span class='varid'>cs</span><span class='layout'>)</span><span class='layout'>)</span><span class='keyglyph'>]</span> <span class='varop'>++</span>
<a name="(line47)"></a>  <span class='keyglyph'>[</span> <span class='str'>"    } deriving (Show, Typeable)"</span>
<a name="(line48)"></a>  <span class='layout'>,</span> <span class='str'>""</span>
<a name="(line49)"></a>  <span class='layout'>,</span> <span class='str'>"instance DatabaseModel "</span> <span class='varop'>++</span> <span class='varid'>typeName</span> <span class='varop'>++</span> <span class='str'>" where"</span>
<a name="(line50)"></a>  <span class='layout'>,</span> <span class='str'>"    tableName _ = \""</span> <span class='varop'>++</span> <span class='varid'>t</span> <span class='varop'>++</span> <span class='str'>"\""</span>
<a name="(line51)"></a>  <span class='layout'>,</span> <span class='str'>""</span>
<a name="(line52)"></a>  <span class='keyglyph'>]</span>
<a name="(line53)"></a>
<a name="(line54)"></a><a name="generateFunctions"></a><span class='varid'>generateFunctions</span> <span class='keyglyph'>::</span>  <span class='conid'>TableName</span> <span class='keyglyph'>-&gt;</span>
<a name="(line55)"></a>                      <span class='conid'>TypeName</span> <span class='keyglyph'>-&gt;</span>
<a name="(line56)"></a>                      <span class='conid'>PrimaryKey</span> <span class='keyglyph'>-&gt;</span> 
<a name="(line57)"></a>                      <span class='conid'>Tables</span> <span class='keyglyph'>-&gt;</span> 
<a name="(line58)"></a>                      <span class='conid'>Columns</span> <span class='keyglyph'>-&gt;</span> 
<a name="(line59)"></a>                      <span class='conid'>String</span>
<a name="(line60)"></a><span class='varid'>generateFunctions</span> <span class='varid'>t</span> <span class='varid'>typeName</span> <span class='varid'>pk</span> <span class='varid'>ts</span> <span class='varid'>cs</span> <span class='keyglyph'>=</span> 
<a name="(line61)"></a>  <span class='varid'>unlines</span> <span class='varop'>$</span>
<a name="(line62)"></a>  <span class='keyglyph'>[</span><span class='str'>"{- DO NOT EDIT THIS FILE"</span>
<a name="(line63)"></a>  <span class='layout'>,</span><span class='str'>"   THIS FILE IS AUTOMAGICALLY GENERATED AND YOUR CHANGES WILL BE EATEN BY THE GENERATOR OVERLORD"</span>
<a name="(line64)"></a>  <span class='layout'>,</span><span class='str'>""</span>
<a name="(line65)"></a>  <span class='layout'>,</span><span class='str'>"   All changes should go into the Model file (e.g. App/Models/ExampleModel.hs)"</span>
<a name="(line66)"></a>  <span class='layout'>,</span><span class='str'>"-}"</span>
<a name="(line67)"></a>  <span class='layout'>,</span><span class='str'>""</span>
<a name="(line68)"></a>  <span class='layout'>,</span><span class='str'>"module App.Models.Bases."</span> <span class='varop'>++</span> <span class='varid'>typeName</span> <span class='varop'>++</span> <span class='str'>"Functions where"</span>
<a name="(line69)"></a>  <span class='layout'>,</span> <span class='str'>""</span>
<a name="(line70)"></a>  <span class='layout'>,</span> <span class='str'>"import App.Models.Bases.Common"</span>
<a name="(line71)"></a>  <span class='layout'>,</span> <span class='str'>"import qualified Database.HDBC as HDBC"</span>
<a name="(line72)"></a>  <span class='layout'>,</span> <span class='str'>"import Data.Maybe"</span>
<a name="(line73)"></a>  <span class='layout'>,</span> <span class='str'>"import Data.Time"</span>
<a name="(line74)"></a>  <span class='layout'>,</span> <span class='str'>""</span>
<a name="(line75)"></a>  <span class='layout'>,</span> <span class='str'>" -- My type"</span>
<a name="(line76)"></a>  <span class='layout'>,</span> <span class='str'>"import App.Models.Bases."</span> <span class='varop'>++</span> <span class='varid'>typeName</span> <span class='varop'>++</span> <span class='str'>"Type"</span>
<a name="(line77)"></a>  <span class='layout'>,</span> <span class='str'>""</span>
<a name="(line78)"></a>  <span class='layout'>,</span> <span class='str'>"import Turbinado.Environment.Types"</span>
<a name="(line79)"></a>  <span class='layout'>,</span> <span class='str'>"import Turbinado.Environment.Database"</span>
<a name="(line80)"></a>  <span class='layout'>,</span> <span class='str'>""</span>
<a name="(line81)"></a>  <span class='keyglyph'>]</span> <span class='varop'>++</span>
<a name="(line82)"></a>  <span class='keyglyph'>[</span><span class='str'>""</span><span class='keyglyph'>]</span> <span class='varop'>++</span>
<a name="(line83)"></a>  <span class='varid'>generateHasFindByPrimaryKey</span> <span class='varid'>t</span> <span class='varid'>cs</span> <span class='varid'>typeName</span> <span class='varid'>pk</span> <span class='varop'>++</span>
<a name="(line84)"></a>  <span class='keyglyph'>[</span><span class='str'>""</span><span class='keyglyph'>]</span> <span class='varop'>++</span>
<a name="(line85)"></a>  <span class='varid'>generateIsModel</span> <span class='varid'>t</span> <span class='varid'>cs</span> <span class='varid'>typeName</span>
<a name="(line86)"></a>  <span class='varop'>++</span>
<a name="(line87)"></a>  <span class='keyglyph'>[</span><span class='str'>""</span>
<a name="(line88)"></a>  <span class='layout'>,</span><span class='str'>"deleteWhere :: (HasEnvironment m) =&gt; SelectString -&gt; SelectParams -&gt; m Integer"</span>
<a name="(line89)"></a>  <span class='layout'>,</span><span class='str'>"deleteWhere ss sp = do "</span>
<a name="(line90)"></a>  <span class='layout'>,</span><span class='str'>"        conn &lt;- getEnvironment &gt;&gt;= (return . fromJust . getDatabase )"</span>
<a name="(line91)"></a>  <span class='layout'>,</span><span class='str'>"        catchDBErrors conn $ do"</span>
<a name="(line92)"></a>  <span class='layout'>,</span><span class='str'>"          res &lt;- liftIO $ HDBC.handleSqlError $ HDBC.run conn (\"DELETE FROM \\\""</span> <span class='varop'>++</span> <span class='varid'>t</span> <span class='varop'>++</span> <span class='str'>"\\\" WHERE (\" ++ ss ++ \") \")  sp"</span>
<a name="(line93)"></a>  <span class='layout'>,</span><span class='str'>"          return res"</span>
<a name="(line94)"></a>  <span class='keyglyph'>]</span>
<a name="(line95)"></a><a name="generateRelations"></a><span class='varid'>generateRelations</span> <span class='keyglyph'>::</span>  <span class='conid'>TableName</span> <span class='keyglyph'>-&gt;</span>
<a name="(line96)"></a>                      <span class='conid'>TypeName</span> <span class='keyglyph'>-&gt;</span>
<a name="(line97)"></a>                      <span class='conid'>PrimaryKey</span> <span class='keyglyph'>-&gt;</span> 
<a name="(line98)"></a>                      <span class='conid'>Tables</span> <span class='keyglyph'>-&gt;</span> 
<a name="(line99)"></a>                      <span class='conid'>Columns</span> <span class='keyglyph'>-&gt;</span> 
<a name="(line100)"></a>                      <span class='conid'>String</span>
<a name="(line101)"></a><span class='varid'>generateRelations</span> <span class='varid'>t</span> <span class='varid'>typeName</span> <span class='varid'>pk</span> <span class='varid'>ts</span> <span class='varid'>cs</span> <span class='keyglyph'>=</span> 
<a name="(line102)"></a>  <span class='varid'>unlines</span> <span class='varop'>$</span>
<a name="(line103)"></a>  <span class='keyglyph'>[</span><span class='str'>"{- DO NOT EDIT THIS FILE"</span>
<a name="(line104)"></a>  <span class='layout'>,</span><span class='str'>"   THIS FILE IS AUTOMAGICALLY GENERATED AND YOUR CHANGES WILL BE EATEN BY THE GENERATOR OVERLORD"</span>
<a name="(line105)"></a>  <span class='layout'>,</span><span class='str'>""</span>
<a name="(line106)"></a>  <span class='layout'>,</span><span class='str'>"   All changes should go into the Model file (e.g. App/Models/ExampleModel.hs)"</span>
<a name="(line107)"></a>  <span class='layout'>,</span><span class='str'>"-}"</span>
<a name="(line108)"></a>  <span class='layout'>,</span><span class='str'>""</span>
<a name="(line109)"></a>  <span class='layout'>,</span><span class='str'>"module App.Models.Bases."</span> <span class='varop'>++</span> <span class='varid'>typeName</span> <span class='varop'>++</span> <span class='str'>"Relations where"</span>
<a name="(line110)"></a>  <span class='layout'>,</span> <span class='str'>""</span>
<a name="(line111)"></a>  <span class='layout'>,</span> <span class='str'>"import App.Models.Bases.Common"</span>
<a name="(line112)"></a>  <span class='layout'>,</span> <span class='str'>"import qualified Database.HDBC as HDBC"</span>
<a name="(line113)"></a>  <span class='layout'>,</span> <span class='str'>"import Data.Maybe"</span>
<a name="(line114)"></a>  <span class='layout'>,</span> <span class='str'>"import Data.Time"</span>
<a name="(line115)"></a>  <span class='layout'>,</span> <span class='str'>""</span>
<a name="(line116)"></a>  <span class='layout'>,</span> <span class='str'>" -- Model imports"</span>
<a name="(line117)"></a>  <span class='layout'>,</span> <span class='str'>"import App.Models.Bases."</span> <span class='varop'>++</span> <span class='varid'>typeName</span> <span class='varop'>++</span> <span class='str'>"Type"</span>
<a name="(line118)"></a>  <span class='layout'>,</span> <span class='varid'>unlines</span> <span class='varop'>$</span> <span class='varid'>generateChildModelImports</span> <span class='varid'>cs</span> 
<a name="(line119)"></a>  <span class='layout'>,</span> <span class='varid'>unlines</span> <span class='varop'>$</span> <span class='varid'>generateParentModelImports</span> <span class='varid'>t</span> <span class='varid'>ts</span>
<a name="(line120)"></a>  <span class='layout'>,</span> <span class='str'>""</span>
<a name="(line121)"></a>  <span class='layout'>,</span> <span class='str'>"import Turbinado.Environment.Types"</span>
<a name="(line122)"></a>  <span class='layout'>,</span> <span class='str'>"import Turbinado.Environment.Database"</span>
<a name="(line123)"></a>  <span class='layout'>,</span> <span class='str'>""</span>
<a name="(line124)"></a>  <span class='keyglyph'>]</span> <span class='varop'>++</span>
<a name="(line125)"></a>  <span class='keyglyph'>[</span><span class='str'>""</span><span class='keyglyph'>]</span> <span class='varop'>++</span>
<a name="(line126)"></a>  <span class='keyglyph'>[</span><span class='str'>""</span><span class='keyglyph'>]</span> <span class='varop'>++</span>
<a name="(line127)"></a>  <span class='varid'>generateHasChildren</span> <span class='varid'>t</span> <span class='varid'>cs</span> <span class='varid'>typeName</span> <span class='varop'>++</span>
<a name="(line128)"></a>  <span class='keyglyph'>[</span><span class='str'>""</span><span class='keyglyph'>]</span> <span class='varop'>++</span>
<a name="(line129)"></a>  <span class='keyglyph'>[</span><span class='str'>""</span><span class='keyglyph'>]</span> <span class='varop'>++</span>
<a name="(line130)"></a>  <span class='varid'>generateHasParents</span> <span class='varid'>t</span> <span class='varid'>ts</span>
<a name="(line131)"></a>
<a name="(line132)"></a><a name="generateChildModelImports"></a><span class='varid'>generateChildModelImports</span> <span class='varid'>cs</span> <span class='keyglyph'>=</span> 
<a name="(line133)"></a>    <span class='varid'>map</span> <span class='layout'>(</span><span class='keyglyph'>\</span><span class='varid'>ctn</span> <span class='keyglyph'>-&gt;</span> <span class='str'>"import qualified App.Models.Bases."</span> <span class='varop'>++</span> <span class='varid'>toType</span> <span class='varid'>ctn</span> <span class='varop'>++</span> <span class='str'>"Type as "</span> <span class='varop'>++</span> <span class='varid'>toType</span> <span class='varid'>ctn</span> <span class='varop'>++</span> <span class='str'>"Type\nimport qualified App.Models.Bases."</span> <span class='varop'>++</span> <span class='varid'>toType</span> <span class='varid'>ctn</span> <span class='varop'>++</span> <span class='str'>"Functions as "</span> <span class='varop'>++</span> <span class='varid'>toType</span> <span class='varid'>ctn</span> <span class='varop'>++</span> <span class='str'>"Functions"</span><span class='layout'>)</span> <span class='varop'>$</span> 
<a name="(line134)"></a>      <span class='varid'>nub</span> <span class='varop'>$</span>
<a name="(line135)"></a>        <span class='varid'>map</span> <span class='varid'>fst</span> <span class='varop'>$</span> <span class='varid'>concat</span> <span class='varop'>$</span>
<a name="(line136)"></a>          <span class='varid'>map</span> <span class='layout'>(</span><span class='keyglyph'>\</span><span class='layout'>(</span><span class='keyword'>_</span><span class='layout'>,</span> <span class='varid'>fks</span><span class='layout'>,</span> <span class='keyword'>_</span><span class='layout'>)</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>fks</span><span class='layout'>)</span> <span class='varop'>$</span> <span class='conid'>M</span><span class='varop'>.</span><span class='varid'>elems</span> <span class='varid'>cs</span>
<a name="(line137)"></a>
<a name="(line138)"></a><a name="generateParentModelImports"></a><span class='varid'>generateParentModelImports</span> <span class='varid'>t</span> <span class='varid'>ts</span> <span class='keyglyph'>=</span> 
<a name="(line139)"></a>    <span class='varid'>map</span> <span class='layout'>(</span><span class='keyglyph'>\</span><span class='varid'>ptn</span> <span class='keyglyph'>-&gt;</span> <span class='str'>"import qualified App.Models.Bases."</span> <span class='varop'>++</span> <span class='varid'>toType</span> <span class='varid'>ptn</span> <span class='varop'>++</span> <span class='str'>"Type as "</span> <span class='varop'>++</span> <span class='varid'>toType</span> <span class='varid'>ptn</span> <span class='varop'>++</span> <span class='str'>"Type\nimport qualified App.Models.Bases."</span> <span class='varop'>++</span> <span class='varid'>toType</span> <span class='varid'>ptn</span> <span class='varop'>++</span> <span class='str'>"Functions as "</span> <span class='varop'>++</span> <span class='varid'>toType</span> <span class='varid'>ptn</span> <span class='varop'>++</span> <span class='str'>"Functions"</span><span class='layout'>)</span> <span class='varop'>$</span> 
<a name="(line140)"></a>      <span class='varid'>nub</span> <span class='varop'>$</span> <span class='varid'>filter</span> <span class='layout'>(</span><span class='varid'>not</span> <span class='varop'>.</span> <span class='varid'>null</span><span class='layout'>)</span> <span class='varop'>$</span> 
<a name="(line141)"></a>        <span class='varid'>map</span> <span class='varid'>parentFilter</span> <span class='varop'>$</span> <span class='conid'>M</span><span class='varop'>.</span><span class='varid'>assocs</span> <span class='varid'>ts</span>
<a name="(line142)"></a>    <span class='keyword'>where</span> <span class='varid'>parentFilter</span> <span class='layout'>(</span><span class='varid'>ptn</span><span class='layout'>,</span> <span class='layout'>(</span><span class='varid'>cs</span><span class='layout'>,</span> <span class='keyword'>_</span><span class='layout'>)</span><span class='layout'>)</span> <span class='keyglyph'>=</span> 
<a name="(line143)"></a>             <span class='keyword'>case</span> <span class='layout'>(</span><span class='varid'>filter</span> <span class='layout'>(</span><span class='keyglyph'>\</span><span class='layout'>(</span><span class='varid'>tn</span><span class='layout'>,</span> <span class='keyword'>_</span><span class='layout'>)</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>t</span> <span class='varop'>==</span> <span class='varid'>tn</span><span class='layout'>)</span> <span class='varop'>$</span> <span class='varid'>concat</span> <span class='varop'>$</span> <span class='varid'>map</span> <span class='layout'>(</span><span class='keyglyph'>\</span><span class='layout'>(</span><span class='keyword'>_</span><span class='layout'>,</span> <span class='varid'>fks</span><span class='layout'>,</span> <span class='keyword'>_</span><span class='layout'>)</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>fks</span><span class='layout'>)</span> <span class='varop'>$</span> <span class='conid'>M</span><span class='varop'>.</span><span class='varid'>elems</span> <span class='varid'>cs</span><span class='layout'>)</span> <span class='keyword'>of</span>
<a name="(line144)"></a>               <span class='conid'>[]</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>[]</span>
<a name="(line145)"></a>               <span class='keyword'>_</span>  <span class='keyglyph'>-&gt;</span> <span class='varid'>ptn</span>
<a name="(line146)"></a>
<a name="(line147)"></a><a name="generateModelFile"></a><span class='varid'>generateModelFile</span> <span class='varid'>typeName</span> <span class='keyglyph'>=</span>
<a name="(line148)"></a>  <span class='varid'>unlines</span> <span class='varop'>$</span>
<a name="(line149)"></a>  <span class='keyglyph'>[</span><span class='str'>"module App.Models."</span> <span class='varop'>++</span> <span class='varid'>typeName</span>
<a name="(line150)"></a>  <span class='layout'>,</span><span class='str'>"  ( module App.Models."</span> <span class='varop'>++</span> <span class='varid'>typeName</span>
<a name="(line151)"></a>  <span class='layout'>,</span><span class='str'>"  , module App.Models.Bases."</span> <span class='varop'>++</span> <span class='varid'>typeName</span> <span class='varop'>++</span> <span class='str'>"Type"</span>
<a name="(line152)"></a>  <span class='layout'>,</span><span class='str'>"  , module App.Models.Bases."</span> <span class='varop'>++</span> <span class='varid'>typeName</span> <span class='varop'>++</span> <span class='str'>"Functions"</span>
<a name="(line153)"></a>  <span class='layout'>,</span><span class='str'>"  , module App.Models.Bases."</span> <span class='varop'>++</span> <span class='varid'>typeName</span> <span class='varop'>++</span> <span class='str'>"Relations"</span>
<a name="(line154)"></a>  <span class='layout'>,</span><span class='str'>"  , module App.Models.Bases.Common"</span>
<a name="(line155)"></a>  <span class='layout'>,</span><span class='str'>"  ) where"</span>
<a name="(line156)"></a>  <span class='layout'>,</span><span class='str'>"import App.Models.Bases."</span> <span class='varop'>++</span> <span class='varid'>typeName</span> <span class='varop'>++</span> <span class='str'>"Type"</span>
<a name="(line157)"></a>  <span class='layout'>,</span><span class='str'>"import App.Models.Bases."</span> <span class='varop'>++</span> <span class='varid'>typeName</span> <span class='varop'>++</span> <span class='str'>"Functions"</span>
<a name="(line158)"></a>  <span class='layout'>,</span><span class='str'>"import App.Models.Bases."</span> <span class='varop'>++</span> <span class='varid'>typeName</span> <span class='varop'>++</span> <span class='str'>"Relations"</span>
<a name="(line159)"></a>  <span class='layout'>,</span><span class='str'>"import App.Models.Bases.Common"</span>
<a name="(line160)"></a>  <span class='keyglyph'>]</span>
<a name="(line161)"></a>
<a name="(line162)"></a><a name="generateCommon"></a><span class='varid'>generateCommon</span><span class='keyglyph'>::</span> <span class='conid'>String</span>
<a name="(line163)"></a><span class='varid'>generateCommon</span> <span class='keyglyph'>=</span> <span class='varid'>unlines</span> <span class='varop'>$</span>
<a name="(line164)"></a>  <span class='keyglyph'>[</span><span class='str'>"{- DO NOT EDIT THIS FILE"</span>
<a name="(line165)"></a>  <span class='layout'>,</span><span class='str'>"   THIS FILE IS AUTOMAGICALLY GENERATED AND YOUR CHANGES WILL BE EATEN BY THE GENERATOR OVERLORD -}"</span>
<a name="(line166)"></a>  <span class='layout'>,</span><span class='str'>""</span>
<a name="(line167)"></a>  <span class='layout'>,</span><span class='str'>"module App.Models.Bases.Common("</span>
<a name="(line168)"></a>  <span class='layout'>,</span><span class='str'>"  module App.Models.Bases.Common,"</span>
<a name="(line169)"></a>  <span class='layout'>,</span><span class='str'>"  module Control.OldException,"</span>
<a name="(line170)"></a>  <span class='layout'>,</span><span class='str'>"  module Control.Monad.Trans,"</span>
<a name="(line171)"></a>  <span class='layout'>,</span><span class='str'>"  module Data.Int"</span>
<a name="(line172)"></a>  <span class='layout'>,</span><span class='str'>"  ) where"</span>
<a name="(line173)"></a>  <span class='layout'>,</span><span class='str'>""</span>
<a name="(line174)"></a>  <span class='layout'>,</span><span class='str'>"import Control.Monad.Trans"</span>
<a name="(line175)"></a>  <span class='layout'>,</span><span class='str'>"import Control.OldException"</span>
<a name="(line176)"></a>  <span class='layout'>,</span><span class='str'>"import Database.HDBC"</span>
<a name="(line177)"></a>  <span class='layout'>,</span><span class='str'>"import Data.Int"</span>
<a name="(line178)"></a>  <span class='layout'>,</span><span class='str'>""</span>
<a name="(line179)"></a>  <span class='layout'>,</span><span class='str'>"import Turbinado.Environment.Types"</span>
<a name="(line180)"></a>  <span class='layout'>,</span><span class='str'>""</span>
<a name="(line181)"></a>  <span class='layout'>,</span><span class='str'>"-- Using phantom types here "</span>
<a name="(line182)"></a>  <span class='layout'>,</span><span class='str'>"class DatabaseModel m where"</span>
<a name="(line183)"></a>  <span class='layout'>,</span><span class='str'>"  tableName :: m -&gt; String"</span>
<a name="(line184)"></a>  <span class='layout'>,</span><span class='str'>""</span>
<a name="(line185)"></a>  <span class='layout'>,</span><span class='str'>"type SelectString = String"</span>
<a name="(line186)"></a>  <span class='layout'>,</span><span class='str'>"type SelectParams = [SqlValue]"</span>
<a name="(line187)"></a>  <span class='layout'>,</span><span class='str'>"type OrderByParams  = String"</span>
<a name="(line188)"></a>  <span class='layout'>,</span><span class='str'>""</span>
<a name="(line189)"></a>  <span class='layout'>,</span><span class='str'>"-- Exception handling"</span>
<a name="(line190)"></a>  <span class='layout'>,</span><span class='str'>""</span>
<a name="(line191)"></a>  <span class='layout'>,</span><span class='str'>"catchDBErrors :: (HasEnvironment m) =&gt; ConnWrapper -&gt; IO a -&gt; m a"</span>
<a name="(line192)"></a>  <span class='layout'>,</span><span class='str'>"catchDBErrors c fdb = liftIO $ catchSql fdb (\\e-&gt; (handleSqlError $ rollback c) &gt;&gt;"</span>
<a name="(line193)"></a>  <span class='layout'>,</span><span class='str'>"                                                   (throwDyn $ e))"</span>
<a name="(line194)"></a>  <span class='layout'>,</span><span class='str'>""</span>
<a name="(line195)"></a>  <span class='layout'>,</span><span class='str'>"class (DatabaseModel model) =&gt;"</span>
<a name="(line196)"></a>  <span class='layout'>,</span><span class='str'>"        IsModel model where"</span>
<a name="(line197)"></a>  <span class='layout'>,</span><span class='str'>"        insert    :: (HasEnvironment m) =&gt; model -&gt; Bool -&gt; m (Maybe Integer)"</span>
<a name="(line198)"></a>  <span class='layout'>,</span><span class='str'>"        findAll   :: (HasEnvironment m) =&gt; m [model]"</span>
<a name="(line199)"></a>  <span class='layout'>,</span><span class='str'>"        findAllWhere :: (HasEnvironment m) =&gt; SelectString -&gt; SelectParams -&gt; m [model]"</span>
<a name="(line200)"></a>  <span class='layout'>,</span><span class='str'>"        findAllOrderBy :: (HasEnvironment m) =&gt; OrderByParams -&gt; m [model]"</span>
<a name="(line201)"></a>  <span class='layout'>,</span><span class='str'>"        findAllWhereOrderBy :: (HasEnvironment m) =&gt; SelectString -&gt; SelectParams -&gt; OrderByParams -&gt; m [model]"</span>
<a name="(line202)"></a>  <span class='layout'>,</span><span class='str'>"        findOneWhere :: (HasEnvironment m) =&gt; SelectString -&gt; SelectParams -&gt; m model"</span>
<a name="(line203)"></a>  <span class='layout'>,</span><span class='str'>"        findOneOrderBy :: (HasEnvironment m) =&gt; OrderByParams -&gt; m model"</span>
<a name="(line204)"></a>  <span class='layout'>,</span><span class='str'>"        findOneWhereOrderBy :: (HasEnvironment m) =&gt; SelectString -&gt; SelectParams -&gt; OrderByParams -&gt; m model"</span>
<a name="(line205)"></a>  <span class='layout'>,</span><span class='str'>""</span>
<a name="(line206)"></a>  <span class='layout'>,</span><span class='str'>"class (DatabaseModel model) =&gt;"</span>
<a name="(line207)"></a>  <span class='layout'>,</span><span class='str'>"        HasFindByPrimaryKey model primaryKey | model -&gt; primaryKey where"</span>
<a name="(line208)"></a>  <span class='layout'>,</span><span class='str'>"    find   :: (HasEnvironment m) =&gt; primaryKey -&gt; m model"</span>
<a name="(line209)"></a>  <span class='layout'>,</span><span class='str'>"    delete :: (HasEnvironment m) =&gt; primaryKey -&gt; m ()"</span>
<a name="(line210)"></a>  <span class='layout'>,</span><span class='str'>"    update :: (HasEnvironment m) =&gt; model      -&gt; m ()"</span>
<a name="(line211)"></a>  <span class='layout'>,</span><span class='str'>""</span>
<a name="(line212)"></a>  <span class='keyglyph'>]</span>
<a name="(line213)"></a>
<a name="(line214)"></a><span class='comment'>---------------------------------------------------------------------------</span>
<a name="(line215)"></a><span class='comment'>--  Generator templates                                                  --</span>
<a name="(line216)"></a><span class='comment'>---------------------------------------------------------------------------</span>
<a name="(line217)"></a>
<a name="(line218)"></a><a name="generateIsModel"></a><span class='varid'>generateIsModel</span> <span class='keyglyph'>::</span> <span class='conid'>TableName</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>Columns</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>TypeName</span> <span class='keyglyph'>-&gt;</span> <span class='keyglyph'>[</span><span class='conid'>String</span><span class='keyglyph'>]</span>
<a name="(line219)"></a><span class='varid'>generateIsModel</span> <span class='varid'>t</span> <span class='varid'>cs</span> <span class='varid'>typeName</span> <span class='keyglyph'>=</span>
<a name="(line220)"></a>    <span class='keyglyph'>[</span><span class='str'>"instance IsModel "</span> <span class='varop'>++</span> <span class='varid'>typeName</span> <span class='varop'>++</span> <span class='str'>" where"</span>
<a name="(line221)"></a>    <span class='layout'>,</span><span class='str'>"    insert m returnId = do"</span>
<a name="(line222)"></a>    <span class='layout'>,</span><span class='str'>"        conn &lt;- getEnvironment &gt;&gt;= (return . fromJust . getDatabase )"</span>
<a name="(line223)"></a>    <span class='layout'>,</span><span class='str'>"        catchDBErrors conn $ do"</span>
<a name="(line224)"></a>    <span class='layout'>,</span><span class='str'>"          res  &lt;- HDBC.run conn (\" INSERT INTO \\\""</span> <span class='varop'>++</span> <span class='varid'>t</span> <span class='varop'>++</span> <span class='str'>"\\\" ("</span> <span class='varop'>++</span> <span class='layout'>(</span><span class='varid'>cols</span> <span class='varid'>cs</span><span class='layout'>)</span> <span class='varop'>++</span><span class='str'>") VALUES ("</span> <span class='varop'>++</span> <span class='layout'>(</span><span class='varid'>intercalate</span> <span class='str'>","</span> <span class='varop'>$</span> <span class='varid'>map</span> <span class='varid'>generateQs</span> <span class='layout'>(</span><span class='conid'>M</span><span class='varop'>.</span><span class='varid'>assocs</span> <span class='varid'>cs</span><span class='layout'>)</span> <span class='layout'>)</span> <span class='varop'>++</span> <span class='str'>")\")  ( "</span> <span class='varop'>++</span> <span class='layout'>(</span><span class='varid'>intercalate</span> <span class='str'>" ++ "</span> <span class='varop'>$</span> <span class='varid'>filter</span> <span class='layout'>(</span><span class='varid'>not</span> <span class='varop'>.</span> <span class='varid'>null</span><span class='layout'>)</span> <span class='varop'>$</span> <span class='varid'>map</span> <span class='varid'>generateArgs</span> <span class='layout'>(</span><span class='conid'>M</span><span class='varop'>.</span><span class='varid'>assocs</span> <span class='varid'>cs</span><span class='layout'>)</span> <span class='layout'>)</span> <span class='varop'>++</span> <span class='str'>")"</span>
<a name="(line225)"></a>    <span class='layout'>,</span><span class='str'>"          case res of"</span>
<a name="(line226)"></a>    <span class='layout'>,</span><span class='str'>"            0 -&gt; (HDBC.handleSqlError $ HDBC.rollback conn) &gt;&gt;"</span>
<a name="(line227)"></a>    <span class='layout'>,</span><span class='str'>"                 (throwDyn $ HDBC.SqlError"</span>
<a name="(line228)"></a>    <span class='layout'>,</span><span class='str'>"                             {HDBC.seState = \"\","</span>
<a name="(line229)"></a>    <span class='layout'>,</span><span class='str'>"                              HDBC.seNativeError = (-1),"</span>
<a name="(line230)"></a>    <span class='layout'>,</span><span class='str'>"                              HDBC.seErrorMsg = \"Rolling back.  No record inserted :"</span> <span class='varop'>++</span> <span class='varid'>t</span> <span class='varop'>++</span> <span class='str'>" : \" ++ (show m)"</span>
<a name="(line231)"></a>    <span class='layout'>,</span><span class='str'>"                             })"</span>
<a name="(line232)"></a>    <span class='layout'>,</span><span class='str'>"            1 -&gt; HDBC.handleSqlError $ HDBC.commit conn &gt;&gt;"</span>
<a name="(line233)"></a>    <span class='layout'>,</span><span class='str'>"                 if returnId"</span>
<a name="(line234)"></a>    <span class='layout'>,</span><span class='str'>"                   then do i &lt;- HDBC.catchSql (HDBC.handleSqlError $ HDBC.quickQuery' conn \"SELECT lastval()\" []) (\\_ -&gt; HDBC.commit conn &gt;&gt; (return $ [[HDBC.toSql (0 :: Integer)]]) ) "</span>
<a name="(line235)"></a>    <span class='layout'>,</span><span class='str'>"                           return $ HDBC.fromSql $ head $ head i"</span>
<a name="(line236)"></a>    <span class='layout'>,</span><span class='str'>"                 else return Nothing"</span>
<a name="(line237)"></a>    <span class='layout'>,</span><span class='str'>"    findAll = do"</span>
<a name="(line238)"></a>    <span class='layout'>,</span><span class='str'>"        conn &lt;- getEnvironment &gt;&gt;= (return . fromJust . getDatabase )"</span>
<a name="(line239)"></a>    <span class='layout'>,</span><span class='str'>"        res &lt;- liftIO $ HDBC.handleSqlError $ HDBC.quickQuery' conn \"SELECT "</span> <span class='varop'>++</span> <span class='varid'>cols</span> <span class='varid'>cs</span> <span class='varop'>++</span> <span class='str'>" FROM \\\""</span> <span class='varop'>++</span> <span class='varid'>t</span> <span class='varop'>++</span> <span class='str'>"\\\" \" []"</span>
<a name="(line240)"></a>    <span class='layout'>,</span><span class='str'>"        return $ map (\\r -&gt; "</span> <span class='varop'>++</span> <span class='varid'>generateConstructor</span> <span class='varid'>cs</span> <span class='varid'>typeName</span> <span class='varop'>++</span> <span class='str'>") res"</span>
<a name="(line241)"></a>    <span class='layout'>,</span><span class='str'>"    findAllWhere ss sp = do"</span>
<a name="(line242)"></a>    <span class='layout'>,</span><span class='str'>"        conn &lt;- getEnvironment &gt;&gt;= (return . fromJust . getDatabase )"</span>
<a name="(line243)"></a>    <span class='layout'>,</span><span class='str'>"        res &lt;- liftIO $ HDBC.handleSqlError $ HDBC.quickQuery' conn (\"SELECT "</span> <span class='varop'>++</span> <span class='varid'>cols</span> <span class='varid'>cs</span> <span class='varop'>++</span> <span class='str'>" FROM \\\""</span> <span class='varop'>++</span> <span class='varid'>t</span><span class='varop'>++</span> <span class='str'>"\\\" WHERE (\" ++ ss ++ \") \")  sp"</span>
<a name="(line244)"></a>    <span class='layout'>,</span><span class='str'>"        return $ map (\\r -&gt; "</span> <span class='varop'>++</span> <span class='varid'>generateConstructor</span> <span class='varid'>cs</span> <span class='varid'>typeName</span> <span class='varop'>++</span> <span class='str'>") res"</span>
<a name="(line245)"></a>    <span class='layout'>,</span><span class='str'>"    findAllOrderBy op = do"</span>
<a name="(line246)"></a>    <span class='layout'>,</span><span class='str'>"        conn &lt;- getEnvironment &gt;&gt;= (return . fromJust . getDatabase )"</span>
<a name="(line247)"></a>    <span class='layout'>,</span><span class='str'>"        res &lt;- liftIO $ HDBC.handleSqlError $ HDBC.quickQuery' conn (\"SELECT "</span> <span class='varop'>++</span> <span class='varid'>cols</span> <span class='varid'>cs</span> <span class='varop'>++</span> <span class='str'>" FROM \\\""</span> <span class='varop'>++</span> <span class='varid'>t</span><span class='varop'>++</span> <span class='str'>"\\\" ORDER BY \" ++ op) []"</span>
<a name="(line248)"></a>    <span class='layout'>,</span><span class='str'>"        return $ map (\\r -&gt; "</span> <span class='varop'>++</span> <span class='varid'>generateConstructor</span> <span class='varid'>cs</span> <span class='varid'>typeName</span> <span class='varop'>++</span> <span class='str'>") res"</span>
<a name="(line249)"></a>    <span class='layout'>,</span><span class='str'>"    findAllWhereOrderBy ss sp op = do"</span>
<a name="(line250)"></a>    <span class='layout'>,</span><span class='str'>"        conn &lt;- getEnvironment &gt;&gt;= (return . fromJust . getDatabase )"</span>
<a name="(line251)"></a>    <span class='layout'>,</span><span class='str'>"        res &lt;- liftIO $ HDBC.handleSqlError $ HDBC.quickQuery' conn (\"SELECT "</span> <span class='varop'>++</span> <span class='varid'>cols</span> <span class='varid'>cs</span> <span class='varop'>++</span> <span class='str'>" FROM \\\""</span> <span class='varop'>++</span> <span class='varid'>t</span><span class='varop'>++</span> <span class='str'>"\\\" WHERE (\" ++ ss ++ \") ORDER BY \" ++ op) sp"</span>
<a name="(line252)"></a>    <span class='layout'>,</span><span class='str'>"        return $ map (\\r -&gt; "</span> <span class='varop'>++</span> <span class='varid'>generateConstructor</span> <span class='varid'>cs</span> <span class='varid'>typeName</span> <span class='varop'>++</span> <span class='str'>") res"</span>
<a name="(line253)"></a>    <span class='layout'>,</span><span class='str'>"    findOneWhere ss sp = do"</span>
<a name="(line254)"></a>    <span class='layout'>,</span><span class='str'>"        conn &lt;- getEnvironment &gt;&gt;= (return . fromJust . getDatabase )"</span>
<a name="(line255)"></a>    <span class='layout'>,</span><span class='str'>"        res &lt;- liftIO $ HDBC.handleSqlError $ HDBC.quickQuery' conn (\"SELECT "</span> <span class='varop'>++</span> <span class='varid'>cols</span> <span class='varid'>cs</span> <span class='varop'>++</span> <span class='str'>" FROM \\\""</span> <span class='varop'>++</span> <span class='varid'>t</span><span class='varop'>++</span> <span class='str'>"\\\" WHERE (\" ++ ss ++ \") LIMIT 1\") sp"</span>
<a name="(line256)"></a>    <span class='layout'>,</span><span class='str'>"        return $ (\\r -&gt; "</span> <span class='varop'>++</span> <span class='varid'>generateConstructor</span> <span class='varid'>cs</span> <span class='varid'>typeName</span> <span class='varop'>++</span> <span class='str'>") (head res)"</span>
<a name="(line257)"></a>    <span class='layout'>,</span><span class='str'>"    findOneOrderBy op = do"</span>
<a name="(line258)"></a>    <span class='layout'>,</span><span class='str'>"        conn &lt;- getEnvironment &gt;&gt;= (return . fromJust . getDatabase )"</span>
<a name="(line259)"></a>    <span class='layout'>,</span><span class='str'>"        res &lt;- liftIO $ HDBC.handleSqlError $ HDBC.quickQuery' conn (\"SELECT "</span> <span class='varop'>++</span> <span class='varid'>cols</span> <span class='varid'>cs</span> <span class='varop'>++</span> <span class='str'>" FROM \\\""</span> <span class='varop'>++</span> <span class='varid'>t</span><span class='varop'>++</span> <span class='str'>"\\\" ORDER BY \" ++ op ++ \" LIMIT 1\")  []"</span>
<a name="(line260)"></a>    <span class='layout'>,</span><span class='str'>"        return $ (\\r -&gt; "</span> <span class='varop'>++</span> <span class='varid'>generateConstructor</span> <span class='varid'>cs</span> <span class='varid'>typeName</span> <span class='varop'>++</span> <span class='str'>") (head res)"</span>
<a name="(line261)"></a>    <span class='layout'>,</span><span class='str'>"    findOneWhereOrderBy ss sp op = do"</span>
<a name="(line262)"></a>    <span class='layout'>,</span><span class='str'>"        conn &lt;- getEnvironment &gt;&gt;= (return . fromJust . getDatabase )"</span>
<a name="(line263)"></a>    <span class='layout'>,</span><span class='str'>"        res &lt;- liftIO $ HDBC.handleSqlError $ HDBC.quickQuery' conn (\"SELECT "</span> <span class='varop'>++</span> <span class='varid'>cols</span> <span class='varid'>cs</span> <span class='varop'>++</span> <span class='str'>" FROM \\\""</span> <span class='varop'>++</span> <span class='varid'>t</span><span class='varop'>++</span> <span class='str'>"\\\" WHERE (\" ++ ss ++ \") ORDER BY \" ++ op ++\" LIMIT 1\")  sp"</span>
<a name="(line264)"></a>    <span class='layout'>,</span><span class='str'>"        return $ (\\r -&gt; "</span> <span class='varop'>++</span> <span class='varid'>generateConstructor</span> <span class='varid'>cs</span> <span class='varid'>typeName</span> <span class='varop'>++</span> <span class='str'>") (head res)"</span>
<a name="(line265)"></a>     <span class='keyglyph'>]</span>
<a name="(line266)"></a>       <span class='keyword'>where</span> <span class='varid'>generateQs</span>   <span class='keyglyph'>::</span> <span class='layout'>(</span><span class='conid'>String</span><span class='layout'>,</span> <span class='layout'>(</span><span class='conid'>SqlColDesc</span><span class='layout'>,</span> <span class='conid'>ForeignKeyReferences</span><span class='layout'>,</span> <span class='conid'>HasDefault</span><span class='layout'>)</span><span class='layout'>)</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>String</span>
<a name="(line267)"></a>             <span class='varid'>generateQs</span> <span class='layout'>(</span><span class='varid'>c</span><span class='layout'>,</span> <span class='layout'>(</span><span class='varid'>desc</span><span class='layout'>,</span> <span class='keyword'>_</span><span class='layout'>,</span> <span class='conid'>False</span><span class='layout'>)</span><span class='layout'>)</span> <span class='keyglyph'>=</span> <span class='keyword'>if</span> <span class='layout'>(</span><span class='layout'>(</span><span class='varid'>colNullable</span> <span class='varid'>desc</span><span class='layout'>)</span> <span class='varop'>==</span> <span class='conid'>Just</span> <span class='conid'>True</span><span class='layout'>)</span> <span class='keyword'>then</span> <span class='layout'>(</span><span class='str'>"\" ++ (case ("</span> <span class='varop'>++</span> <span class='varid'>toFunction</span> <span class='varid'>c</span> <span class='varop'>++</span> <span class='str'>" m) of Nothing -&gt; \"DEFAULT\"; Just x -&gt; \"?\") ++ \""</span><span class='layout'>)</span> <span class='keyword'>else</span> <span class='str'>"?"</span>
<a name="(line268)"></a>             <span class='varid'>generateQs</span> <span class='layout'>(</span><span class='varid'>c</span><span class='layout'>,</span> <span class='layout'>(</span><span class='keyword'>_</span><span class='layout'>,</span> <span class='keyword'>_</span><span class='layout'>,</span> <span class='conid'>True</span><span class='layout'>)</span><span class='layout'>)</span> <span class='keyglyph'>=</span> <span class='str'>"\" ++ (case ("</span> <span class='varop'>++</span> <span class='varid'>toFunction</span> <span class='varid'>c</span> <span class='varop'>++</span> <span class='str'>" m) of Nothing -&gt; \"DEFAULT\"; Just x -&gt; \"?\") ++ \""</span> 
<a name="(line269)"></a>             <span class='varid'>generateArgs</span> <span class='keyglyph'>::</span> <span class='layout'>(</span><span class='conid'>String</span><span class='layout'>,</span> <span class='layout'>(</span><span class='conid'>SqlColDesc</span><span class='layout'>,</span> <span class='conid'>ForeignKeyReferences</span><span class='layout'>,</span> <span class='conid'>HasDefault</span><span class='layout'>)</span><span class='layout'>)</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>String</span>
<a name="(line270)"></a>             <span class='varid'>generateArgs</span> <span class='layout'>(</span><span class='varid'>c</span><span class='layout'>,</span> <span class='layout'>(</span><span class='varid'>desc</span><span class='layout'>,</span> <span class='keyword'>_</span><span class='layout'>,</span> <span class='conid'>False</span><span class='layout'>)</span><span class='layout'>)</span> <span class='keyglyph'>=</span> <span class='keyword'>if</span> <span class='layout'>(</span><span class='layout'>(</span><span class='varid'>colNullable</span> <span class='varid'>desc</span><span class='layout'>)</span> <span class='varop'>==</span> <span class='conid'>Just</span> <span class='conid'>True</span><span class='layout'>)</span> <span class='keyword'>then</span> <span class='layout'>(</span><span class='str'>"(case ("</span> <span class='varop'>++</span> <span class='varid'>toFunction</span> <span class='varid'>c</span> <span class='varop'>++</span> <span class='str'>" m) of Nothing -&gt; []; Just x -&gt; [HDBC.toSql x])"</span><span class='layout'>)</span> <span class='keyword'>else</span> <span class='layout'>(</span><span class='str'>"[HDBC.toSql $ "</span> <span class='varop'>++</span> <span class='varid'>toFunction</span> <span class='varid'>c</span> <span class='varop'>++</span> <span class='str'>" m]"</span><span class='layout'>)</span>
<a name="(line271)"></a>             <span class='varid'>generateArgs</span> <span class='layout'>(</span><span class='varid'>c</span><span class='layout'>,</span> <span class='layout'>(</span><span class='keyword'>_</span><span class='layout'>,</span> <span class='keyword'>_</span><span class='layout'>,</span> <span class='conid'>True</span><span class='layout'>)</span><span class='layout'>)</span> <span class='keyglyph'>=</span> <span class='str'>"(case ("</span> <span class='varop'>++</span> <span class='varid'>toFunction</span> <span class='varid'>c</span> <span class='varop'>++</span> <span class='str'>" m) of Nothing -&gt; []; Just x -&gt; [HDBC.toSql x])"</span> 
<a name="(line272)"></a>
<a name="(line273)"></a><a name="generateHasFindByPrimaryKey"></a><span class='varid'>generateHasFindByPrimaryKey</span> <span class='keyglyph'>::</span> <span class='conid'>TableName</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>Columns</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>TypeName</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>PrimaryKey</span> <span class='keyglyph'>-&gt;</span> <span class='keyglyph'>[</span><span class='conid'>String</span><span class='keyglyph'>]</span>
<a name="(line274)"></a><span class='varid'>generateHasFindByPrimaryKey</span> <span class='varid'>t</span> <span class='varid'>cs</span> <span class='varid'>typeName</span> <span class='varid'>pk</span> <span class='keyglyph'>=</span>
<a name="(line275)"></a>  <span class='keyword'>case</span> <span class='layout'>(</span><span class='varid'>length</span>  <span class='varid'>pk</span><span class='layout'>)</span> <span class='keyword'>of</span>
<a name="(line276)"></a>    <span class='num'>0</span> <span class='keyglyph'>-&gt;</span> <span class='keyglyph'>[</span><span class='str'>""</span><span class='keyglyph'>]</span>
<a name="(line277)"></a>    <span class='keyword'>_</span> <span class='keyglyph'>-&gt;</span> <span class='keyglyph'>[</span><span class='str'>"instance HasFindByPrimaryKey "</span> <span class='varop'>++</span> <span class='varid'>typeName</span> <span class='varop'>++</span> <span class='str'>" "</span> <span class='varop'>++</span> <span class='str'>" ("</span> <span class='varop'>++</span> <span class='varid'>unwords</span> <span class='layout'>(</span><span class='varid'>intersperse</span> <span class='str'>","</span> <span class='layout'>(</span><span class='varid'>map</span> <span class='layout'>(</span><span class='keyglyph'>\</span><span class='varid'>c</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>getHaskellTypeString</span> <span class='varop'>$</span> <span class='varid'>colType</span> <span class='varop'>$</span> <span class='layout'>(</span><span class='keyglyph'>\</span><span class='layout'>(</span><span class='varid'>c'</span><span class='layout'>,</span><span class='keyword'>_</span><span class='layout'>,</span><span class='keyword'>_</span><span class='layout'>)</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>c'</span><span class='layout'>)</span> <span class='varop'>$</span> <span class='varid'>fromJust</span> <span class='varop'>$</span> <span class='conid'>M</span><span class='varop'>.</span><span class='varid'>lookup</span> <span class='varid'>c</span> <span class='varid'>cs</span><span class='layout'>)</span> <span class='varid'>pk</span><span class='layout'>)</span><span class='layout'>)</span> <span class='varop'>++</span> <span class='str'>") "</span> <span class='varop'>++</span> <span class='str'>" where"</span>
<a name="(line278)"></a>         <span class='layout'>,</span><span class='str'>"    find pk@("</span> <span class='varop'>++</span> <span class='layout'>(</span><span class='varid'>concat</span> <span class='varop'>$</span> <span class='varid'>intersperse</span> <span class='str'>", "</span> <span class='varop'>$</span> <span class='varid'>map</span> <span class='layout'>(</span><span class='keyglyph'>\</span><span class='varid'>i</span> <span class='keyglyph'>-&gt;</span> <span class='str'>"pk"</span><span class='varop'>++</span><span class='layout'>(</span><span class='varid'>show</span> <span class='varid'>i</span><span class='layout'>)</span><span class='layout'>)</span> <span class='keyglyph'>[</span><span class='num'>1</span><span class='keyglyph'>..</span><span class='layout'>(</span><span class='varid'>length</span> <span class='varid'>pk</span><span class='layout'>)</span><span class='keyglyph'>]</span><span class='layout'>)</span> <span class='varop'>++</span> <span class='str'>") = do"</span>
<a name="(line279)"></a>         <span class='layout'>,</span><span class='str'>"        conn &lt;- getEnvironment &gt;&gt;= (return . fromJust . getDatabase )"</span>
<a name="(line280)"></a>         <span class='layout'>,</span><span class='str'>"        res &lt;- liftIO $ HDBC.handleSqlError $ HDBC.quickQuery' conn (\"SELECT "</span> <span class='varop'>++</span> <span class='varid'>cols</span> <span class='varid'>cs</span> <span class='varop'>++</span> <span class='str'>" FROM \\\""</span> <span class='varop'>++</span> <span class='varid'>t</span> <span class='varop'>++</span> <span class='str'>"\\\" WHERE ("</span> <span class='varop'>++</span> <span class='layout'>(</span><span class='varid'>generatePrimaryKeyWhere</span> <span class='varid'>pk</span><span class='layout'>)</span> <span class='varop'>++</span> <span class='str'>")\") ["</span> <span class='varop'>++</span> <span class='layout'>(</span><span class='varid'>unwords</span> <span class='varop'>$</span> <span class='varid'>intersperse</span> <span class='str'>","</span> <span class='varop'>$</span> <span class='varid'>map</span> <span class='layout'>(</span><span class='keyglyph'>\</span><span class='layout'>(</span><span class='varid'>c</span><span class='layout'>,</span><span class='varid'>i</span><span class='layout'>)</span> <span class='keyglyph'>-&gt;</span> <span class='str'>"HDBC.toSql pk"</span> <span class='varop'>++</span> <span class='layout'>(</span><span class='varid'>show</span> <span class='varid'>i</span><span class='layout'>)</span><span class='layout'>)</span> <span class='layout'>(</span><span class='varid'>zip</span> <span class='varid'>pk</span> <span class='keyglyph'>[</span><span class='num'>1</span><span class='keyglyph'>..</span><span class='keyglyph'>]</span><span class='layout'>)</span><span class='layout'>)</span> <span class='varop'>++</span> <span class='str'>"]"</span>
<a name="(line281)"></a>         <span class='layout'>,</span><span class='str'>"        case res of"</span>
<a name="(line282)"></a>         <span class='layout'>,</span><span class='str'>"          [] -&gt; throwDyn $ HDBC.SqlError"</span>
<a name="(line283)"></a>         <span class='layout'>,</span><span class='str'>"                           {HDBC.seState = \"\","</span>
<a name="(line284)"></a>         <span class='layout'>,</span><span class='str'>"                            HDBC.seNativeError = (-1),"</span>
<a name="(line285)"></a>         <span class='layout'>,</span><span class='str'>"                            HDBC.seErrorMsg = \"No record found when finding by Primary Key:"</span> <span class='varop'>++</span> <span class='varid'>t</span> <span class='varop'>++</span> <span class='str'>" : \" ++ (show pk)"</span>
<a name="(line286)"></a>         <span class='layout'>,</span><span class='str'>"                           }"</span>
<a name="(line287)"></a>         <span class='layout'>,</span><span class='str'>"          r:[] -&gt; return $ "</span> <span class='varop'>++</span> <span class='layout'>(</span><span class='varid'>generateConstructor</span> <span class='varid'>cs</span> <span class='varid'>typeName</span><span class='layout'>)</span>
<a name="(line288)"></a>         <span class='layout'>,</span><span class='str'>"          _ -&gt; throwDyn $ HDBC.SqlError"</span>
<a name="(line289)"></a>         <span class='layout'>,</span><span class='str'>"                           {HDBC.seState = \"\","</span>
<a name="(line290)"></a>         <span class='layout'>,</span><span class='str'>"                            HDBC.seNativeError = (-1),"</span>
<a name="(line291)"></a>         <span class='layout'>,</span><span class='str'>"                            HDBC.seErrorMsg = \"Too many records found when finding by Primary Key:"</span> <span class='varop'>++</span> <span class='varid'>t</span> <span class='varop'>++</span> <span class='str'>" : \" ++ (show pk)"</span>
<a name="(line292)"></a>         <span class='layout'>,</span><span class='str'>"                           }"</span>
<a name="(line293)"></a>         <span class='layout'>,</span><span class='str'>""</span>
<a name="(line294)"></a>         <span class='layout'>,</span><span class='str'>"    delete pk@("</span> <span class='varop'>++</span> <span class='layout'>(</span><span class='varid'>concat</span> <span class='varop'>$</span> <span class='varid'>intersperse</span> <span class='str'>", "</span> <span class='varop'>$</span> <span class='varid'>map</span> <span class='layout'>(</span><span class='keyglyph'>\</span><span class='varid'>i</span> <span class='keyglyph'>-&gt;</span> <span class='str'>"pk"</span><span class='varop'>++</span><span class='layout'>(</span><span class='varid'>show</span> <span class='varid'>i</span><span class='layout'>)</span><span class='layout'>)</span> <span class='keyglyph'>[</span><span class='num'>1</span><span class='keyglyph'>..</span><span class='layout'>(</span><span class='varid'>length</span> <span class='varid'>pk</span><span class='layout'>)</span><span class='keyglyph'>]</span><span class='layout'>)</span> <span class='varop'>++</span> <span class='str'>") = do"</span>
<a name="(line295)"></a>         <span class='layout'>,</span><span class='str'>"        conn &lt;- getEnvironment &gt;&gt;= (return . fromJust . getDatabase )"</span>
<a name="(line296)"></a>         <span class='layout'>,</span><span class='str'>"        catchDBErrors conn $ do"</span>
<a name="(line297)"></a>         <span class='layout'>,</span><span class='str'>"          res &lt;- HDBC.run conn (\"DELETE FROM \\\""</span> <span class='varop'>++</span> <span class='varid'>t</span> <span class='varop'>++</span> <span class='str'>"\\\" WHERE ("</span> <span class='varop'>++</span> <span class='layout'>(</span><span class='varid'>generatePrimaryKeyWhere</span> <span class='varid'>pk</span><span class='layout'>)</span> <span class='varop'>++</span> <span class='str'>")\") ["</span> <span class='varop'>++</span> <span class='layout'>(</span><span class='varid'>unwords</span> <span class='varop'>$</span> <span class='varid'>intersperse</span> <span class='str'>","</span> <span class='varop'>$</span> <span class='varid'>map</span> <span class='layout'>(</span><span class='keyglyph'>\</span><span class='layout'>(</span><span class='varid'>c</span><span class='layout'>,</span><span class='varid'>i</span><span class='layout'>)</span> <span class='keyglyph'>-&gt;</span> <span class='str'>"HDBC.toSql pk"</span> <span class='varop'>++</span> <span class='layout'>(</span><span class='varid'>show</span> <span class='varid'>i</span><span class='layout'>)</span><span class='layout'>)</span> <span class='layout'>(</span><span class='varid'>zip</span> <span class='varid'>pk</span> <span class='keyglyph'>[</span><span class='num'>1</span><span class='keyglyph'>..</span><span class='keyglyph'>]</span><span class='layout'>)</span><span class='layout'>)</span> <span class='varop'>++</span> <span class='str'>"]"</span>
<a name="(line298)"></a>         <span class='layout'>,</span><span class='str'>"          case res of"</span>
<a name="(line299)"></a>         <span class='layout'>,</span><span class='str'>"            0 -&gt; (HDBC.handleSqlError $ HDBC.rollback conn) &gt;&gt;"</span>
<a name="(line300)"></a>         <span class='layout'>,</span><span class='str'>"                 (throwDyn $ HDBC.SqlError"</span>
<a name="(line301)"></a>         <span class='layout'>,</span><span class='str'>"                             {HDBC.seState = \"\","</span>
<a name="(line302)"></a>         <span class='layout'>,</span><span class='str'>"                              HDBC.seNativeError = (-1),"</span>
<a name="(line303)"></a>         <span class='layout'>,</span><span class='str'>"                              HDBC.seErrorMsg = \"Rolling back.  No record found when deleting by Primary Key:"</span> <span class='varop'>++</span> <span class='varid'>t</span> <span class='varop'>++</span> <span class='str'>" : \" ++ (show pk)"</span>
<a name="(line304)"></a>         <span class='layout'>,</span><span class='str'>"                             })"</span>
<a name="(line305)"></a>         <span class='layout'>,</span><span class='str'>"            1 -&gt; (HDBC.handleSqlError $ HDBC.commit conn) &gt;&gt; return ()"</span>
<a name="(line306)"></a>         <span class='layout'>,</span><span class='str'>"            _ -&gt; (HDBC.handleSqlError $ HDBC.rollback conn) &gt;&gt;"</span>
<a name="(line307)"></a>         <span class='layout'>,</span><span class='str'>"                 (throwDyn $ HDBC.SqlError"</span>
<a name="(line308)"></a>         <span class='layout'>,</span><span class='str'>"                             {HDBC.seState = \"\","</span>
<a name="(line309)"></a>         <span class='layout'>,</span><span class='str'>"                              HDBC.seNativeError = (-1),"</span>
<a name="(line310)"></a>         <span class='layout'>,</span><span class='str'>"                              HDBC.seErrorMsg = \"Rolling back.  Too many records deleted when deleting by Primary Key:"</span> <span class='varop'>++</span> <span class='varid'>t</span> <span class='varop'>++</span> <span class='str'>" : \" ++ (show pk)"</span>
<a name="(line311)"></a>         <span class='layout'>,</span><span class='str'>"                             })"</span>
<a name="(line312)"></a>         <span class='layout'>,</span><span class='str'>""</span>
<a name="(line313)"></a>         <span class='layout'>,</span><span class='str'>"    update m = do"</span>
<a name="(line314)"></a>         <span class='layout'>,</span><span class='str'>"        conn &lt;- getEnvironment &gt;&gt;= (return . fromJust . getDatabase )"</span>
<a name="(line315)"></a>         <span class='layout'>,</span><span class='str'>"        catchDBErrors conn $ do"</span>
<a name="(line316)"></a>         <span class='layout'>,</span><span class='str'>"          res &lt;- HDBC.run conn \"UPDATE \\\""</span> <span class='varop'>++</span> <span class='varid'>t</span> <span class='varop'>++</span> <span class='str'>"\\\" SET ("</span> <span class='varop'>++</span> <span class='layout'>(</span><span class='varid'>cols</span> <span class='varid'>cs</span><span class='layout'>)</span> <span class='varop'>++</span> <span class='str'>") = ("</span> <span class='varop'>++</span> <span class='layout'>(</span><span class='varid'>intercalate</span> <span class='str'>","</span> <span class='varop'>$</span> <span class='layout'>(</span><span class='varid'>take</span> <span class='layout'>(</span><span class='conid'>M</span><span class='varop'>.</span><span class='varid'>size</span> <span class='varid'>cs</span><span class='layout'>)</span> <span class='layout'>(</span><span class='varid'>repeat</span> <span class='str'>"?"</span><span class='layout'>)</span><span class='layout'>)</span><span class='layout'>)</span> <span class='varop'>++</span> <span class='str'>") WHERE ("</span> <span class='varop'>++</span> <span class='layout'>(</span><span class='varid'>generatePrimaryKeyWhere</span> <span class='varid'>pk</span><span class='layout'>)</span>  <span class='varop'>++</span><span class='str'>")\""</span>
<a name="(line317)"></a>         <span class='layout'>,</span><span class='str'>"                    ["</span> <span class='varop'>++</span> <span class='layout'>(</span><span class='varid'>unwords</span> <span class='varop'>$</span> <span class='varid'>intersperse</span> <span class='str'>","</span> <span class='varop'>$</span> <span class='varid'>map</span> <span class='layout'>(</span><span class='keyglyph'>\</span><span class='varid'>c</span> <span class='keyglyph'>-&gt;</span> <span class='str'>"HDBC.toSql $ "</span> <span class='varop'>++</span> <span class='varid'>toFunction</span> <span class='varid'>c</span> <span class='varop'>++</span> <span class='str'>" m"</span><span class='layout'>)</span> <span class='layout'>(</span><span class='conid'>M</span><span class='varop'>.</span><span class='varid'>keys</span> <span class='varid'>cs</span><span class='layout'>)</span> <span class='layout'>)</span> <span class='varop'>++</span> <span class='str'>", "</span> <span class='varop'>++</span> <span class='layout'>(</span><span class='varid'>unwords</span> <span class='varop'>$</span> <span class='varid'>intersperse</span> <span class='str'>","</span> <span class='varop'>$</span> <span class='varid'>map</span> <span class='layout'>(</span><span class='keyglyph'>\</span><span class='varid'>c</span> <span class='keyglyph'>-&gt;</span> <span class='str'>"HDBC.toSql $ "</span> <span class='varop'>++</span> <span class='varid'>toFunction</span> <span class='varid'>c</span> <span class='varop'>++</span> <span class='str'>" m"</span><span class='layout'>)</span> <span class='varid'>pk</span> <span class='layout'>)</span> <span class='varop'>++</span> <span class='str'>"]"</span>
<a name="(line318)"></a>         <span class='layout'>,</span><span class='str'>"          HDBC.handleSqlError $ HDBC.commit conn"</span>
<a name="(line319)"></a>         <span class='layout'>,</span><span class='str'>"          return ()"</span>
<a name="(line320)"></a>         <span class='keyglyph'>]</span>
<a name="(line321)"></a>
<a name="(line322)"></a><a name="generateHasChildren"></a><span class='varid'>generateHasChildren</span> <span class='keyglyph'>::</span> <span class='conid'>TableName</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>Columns</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>TypeName</span> <span class='keyglyph'>-&gt;</span> <span class='keyglyph'>[</span><span class='conid'>String</span><span class='keyglyph'>]</span>
<a name="(line323)"></a><span class='varid'>generateHasChildren</span> <span class='varid'>t</span> <span class='varid'>cs</span> <span class='varid'>typeName</span> <span class='keyglyph'>=</span> <span class='varid'>map</span> <span class='layout'>(</span><span class='keyglyph'>\</span><span class='layout'>(</span><span class='varid'>cn</span><span class='layout'>,</span> <span class='varid'>cd</span><span class='layout'>)</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>generateHasChildren_t</span> <span class='varid'>t</span> <span class='varid'>cn</span> <span class='varid'>cd</span> <span class='varid'>typeName</span><span class='layout'>)</span> <span class='varop'>$</span> <span class='conid'>M</span><span class='varop'>.</span><span class='varid'>assocs</span> <span class='varid'>cs</span>
<a name="(line324)"></a>
<a name="(line325)"></a><a name="generateHasChildren_t"></a><span class='varid'>generateHasChildren_t</span> <span class='keyglyph'>::</span> <span class='conid'>TableName</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>ColumnName</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>ColumnDesc</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>TypeName</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>String</span>
<a name="(line326)"></a><span class='varid'>generateHasChildren_t</span> <span class='varid'>t</span> <span class='varid'>cn</span> <span class='layout'>(</span><span class='keyword'>_</span><span class='layout'>,</span> <span class='varid'>fks</span><span class='layout'>,</span> <span class='keyword'>_</span><span class='layout'>)</span> <span class='varid'>typeName</span> <span class='keyglyph'>=</span> <span class='varid'>unlines</span> <span class='varop'>$</span> <span class='varid'>map</span> <span class='layout'>(</span><span class='keyglyph'>\</span><span class='layout'>(</span><span class='varid'>fkt</span><span class='layout'>,</span> <span class='varid'>fkc</span><span class='layout'>)</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>generateHasChildren_t_k</span> <span class='varid'>t</span> <span class='varid'>cn</span> <span class='varid'>fkt</span> <span class='varid'>fkc</span> <span class='varid'>typeName</span><span class='layout'>)</span> <span class='varid'>fks</span>
<a name="(line327)"></a>
<a name="(line328)"></a><a name="generateHasChildren_t_k"></a><span class='varid'>generateHasChildren_t_k</span> <span class='keyglyph'>::</span> <span class='conid'>TableName</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>ColumnName</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>TableName</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>ColumnName</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>TypeName</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>String</span>
<a name="(line329)"></a><span class='varid'>generateHasChildren_t_k</span> <span class='varid'>t</span> <span class='varid'>cn</span> <span class='varid'>fkt</span> <span class='varid'>fkc</span> <span class='varid'>typeName</span> <span class='keyglyph'>=</span> 
<a name="(line330)"></a>  <span class='varid'>unlines</span> <span class='varop'>$</span>
<a name="(line331)"></a>    <span class='keyglyph'>[</span><span class='str'>"findAllChild"</span> <span class='varop'>++</span> <span class='varid'>toType</span> <span class='varid'>fkt</span>  <span class='varop'>++</span> <span class='str'>" :: (HasEnvironment m) =&gt; "</span> <span class='varop'>++</span> <span class='varid'>toType</span> <span class='varid'>t</span> <span class='varop'>++</span> <span class='str'>" -&gt; m ["</span> <span class='varop'>++</span> <span class='varid'>toType</span> <span class='varid'>fkt</span> <span class='varop'>++</span> <span class='str'>"Type."</span> <span class='varop'>++</span> <span class='varid'>toType</span> <span class='varid'>fkt</span> <span class='varop'>++</span> <span class='str'>"]"</span>
<a name="(line332)"></a>    <span class='layout'>,</span><span class='str'>"findAllChild"</span> <span class='varop'>++</span> <span class='varid'>toType</span> <span class='varid'>fkt</span> <span class='varop'>++</span> <span class='str'>" p = findAllWhere \""</span> <span class='varop'>++</span> <span class='varid'>fkc</span> <span class='varop'>++</span> <span class='str'>" = ?\" [HDBC.toSql $ "</span> <span class='varop'>++</span> <span class='varid'>toFunction</span> <span class='varid'>cn</span> <span class='varop'>++</span> <span class='str'>" p]"</span>
<a name="(line333)"></a>    <span class='keyglyph'>]</span>
<a name="(line334)"></a>
<a name="(line335)"></a>
<a name="(line336)"></a><a name="generateHasParents"></a><span class='varid'>generateHasParents</span> <span class='keyglyph'>::</span> <span class='conid'>TableName</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>Tables</span> <span class='keyglyph'>-&gt;</span> <span class='keyglyph'>[</span><span class='conid'>String</span><span class='keyglyph'>]</span>
<a name="(line337)"></a><span class='varid'>generateHasParents</span> <span class='varid'>ctn</span> <span class='varid'>ts</span> <span class='keyglyph'>=</span>
<a name="(line338)"></a>    <span class='varid'>map</span> <span class='layout'>(</span><span class='keyglyph'>\</span><span class='layout'>(</span><span class='varid'>tname</span><span class='layout'>,</span> <span class='varid'>cname</span><span class='layout'>,</span> <span class='varid'>ptname</span><span class='layout'>,</span> <span class='varid'>pcname</span><span class='layout'>)</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>generateHasParent_t</span> <span class='varid'>tname</span> <span class='varid'>cname</span> <span class='varid'>ptname</span> <span class='varid'>pcname</span><span class='layout'>)</span> <span class='varop'>$</span> 
<a name="(line339)"></a>      <span class='varid'>nub</span> <span class='varop'>$</span> <span class='varid'>concat</span> <span class='varop'>$</span> 
<a name="(line340)"></a>        <span class='varid'>map</span> <span class='varid'>parentFilter</span> <span class='varop'>$</span> <span class='conid'>M</span><span class='varop'>.</span><span class='varid'>assocs</span> <span class='varid'>ts</span>
<a name="(line341)"></a>    <span class='keyword'>where</span> <span class='varid'>parentFilter</span> <span class='layout'>(</span><span class='varid'>tn</span><span class='layout'>,</span> <span class='layout'>(</span><span class='varid'>cs'</span><span class='layout'>,</span> <span class='keyword'>_</span><span class='layout'>)</span><span class='layout'>)</span> <span class='keyglyph'>=</span> <span class='varid'>filter</span> <span class='layout'>(</span><span class='keyglyph'>\</span><span class='layout'>(</span><span class='keyword'>_</span><span class='layout'>,</span> <span class='keyword'>_</span><span class='layout'>,</span> <span class='varid'>tn'</span><span class='layout'>,</span> <span class='keyword'>_</span><span class='layout'>)</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>ctn</span> <span class='varop'>==</span> <span class='varid'>tn'</span><span class='layout'>)</span> <span class='varop'>$</span> <span class='varid'>concat</span> <span class='varop'>$</span> <span class='varid'>map</span> <span class='layout'>(</span><span class='keyglyph'>\</span><span class='layout'>(</span><span class='varid'>cn</span><span class='layout'>,</span> <span class='layout'>(</span><span class='keyword'>_</span><span class='layout'>,</span> <span class='varid'>fks</span><span class='layout'>,</span> <span class='keyword'>_</span><span class='layout'>)</span><span class='layout'>)</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>map</span> <span class='layout'>(</span><span class='keyglyph'>\</span><span class='layout'>(</span><span class='varid'>ptn</span><span class='layout'>,</span> <span class='varid'>pcn</span><span class='layout'>)</span> <span class='keyglyph'>-&gt;</span> <span class='layout'>(</span><span class='varid'>tn</span><span class='layout'>,</span> <span class='varid'>cn</span><span class='layout'>,</span> <span class='varid'>ptn</span><span class='layout'>,</span> <span class='varid'>pcn</span><span class='layout'>)</span><span class='layout'>)</span> <span class='varid'>fks</span><span class='layout'>)</span> <span class='varop'>$</span> <span class='conid'>M</span><span class='varop'>.</span><span class='varid'>assocs</span> <span class='varid'>cs'</span>
<a name="(line342)"></a>
<a name="(line343)"></a>
<a name="(line344)"></a>
<a name="(line345)"></a><a name="generateHasParent_t"></a><span class='varid'>generateHasParent_t</span> <span class='keyglyph'>::</span> <span class='conid'>TableName</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>ColumnName</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>TableName</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>ColumnName</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>String</span>
<a name="(line346)"></a><span class='varid'>generateHasParent_t</span> <span class='varid'>ptn</span> <span class='varid'>pcn</span> <span class='varid'>ctn</span> <span class='varid'>ccn</span> <span class='keyglyph'>=</span> 
<a name="(line347)"></a>  <span class='varid'>unlines</span> <span class='varop'>$</span>
<a name="(line348)"></a>    <span class='keyglyph'>[</span><span class='str'>"parent"</span> <span class='varop'>++</span> <span class='varid'>toType</span> <span class='varid'>ptn</span> <span class='varop'>++</span> <span class='str'>" :: (HasEnvironment m) =&gt; "</span> <span class='varop'>++</span> <span class='varid'>toType</span> <span class='varid'>ctn</span> <span class='varop'>++</span> <span class='str'>" -&gt; m "</span> <span class='varop'>++</span> <span class='varid'>toType</span> <span class='varid'>ptn</span> <span class='varop'>++</span> <span class='str'>"Type."</span> <span class='varop'>++</span> <span class='varid'>toType</span> <span class='varid'>ptn</span>
<a name="(line349)"></a>    <span class='layout'>,</span><span class='str'>"parent"</span> <span class='varop'>++</span> <span class='varid'>toType</span> <span class='varid'>ptn</span> <span class='varop'>++</span> <span class='str'>" self = findOneWhere \""</span> <span class='varop'>++</span> <span class='varid'>pcn</span> <span class='varop'>++</span> <span class='str'>" = ?\" [HDBC.toSql $ "</span> <span class='varop'>++</span> <span class='varid'>toFunction</span> <span class='varid'>ccn</span> <span class='varop'>++</span> <span class='str'>" self]"</span>
<a name="(line350)"></a>    <span class='keyglyph'>]</span>
<a name="(line351)"></a>
<a name="(line352)"></a>
<a name="(line353)"></a><span class='comment'>{-----------------------------------------------------------------------}</span>
<a name="(line354)"></a>
<a name="(line355)"></a><a name="generatePrimaryKeyWhere"></a><span class='varid'>generatePrimaryKeyWhere</span> <span class='varid'>pk</span> <span class='keyglyph'>=</span>
<a name="(line356)"></a>  <span class='varid'>unwords</span> <span class='varop'>$</span>
<a name="(line357)"></a>    <span class='varid'>intersperse</span> <span class='str'>" AND "</span> <span class='varop'>$</span>
<a name="(line358)"></a>      <span class='varid'>map</span> <span class='layout'>(</span><span class='keyglyph'>\</span><span class='layout'>(</span><span class='varid'>c</span><span class='layout'>,</span><span class='varid'>i</span><span class='layout'>)</span> <span class='keyglyph'>-&gt;</span> <span class='str'>"\\\""</span> <span class='varop'>++</span> <span class='varid'>c</span> <span class='varop'>++</span> <span class='str'>"\\\" = ? "</span><span class='layout'>)</span> <span class='layout'>(</span><span class='varid'>zip</span> <span class='varid'>pk</span> <span class='keyglyph'>[</span><span class='num'>1</span><span class='keyglyph'>..</span><span class='keyglyph'>]</span><span class='layout'>)</span>
<a name="(line359)"></a>
<a name="(line360)"></a>
<a name="(line361)"></a><a name="generateConstructor"></a><span class='varid'>generateConstructor</span> <span class='varid'>cs</span> <span class='varid'>typeName</span> <span class='keyglyph'>=</span>
<a name="(line362)"></a>  <span class='varid'>typeName</span> <span class='varop'>++</span> <span class='str'>" "</span> <span class='varop'>++</span> <span class='layout'>(</span><span class='varid'>unwords</span> <span class='varop'>$</span>
<a name="(line363)"></a>  <span class='varid'>map</span> <span class='layout'>(</span><span class='keyglyph'>\</span><span class='varid'>i</span> <span class='keyglyph'>-&gt;</span> <span class='str'>"(HDBC.fromSql (r !! "</span> <span class='varop'>++</span> <span class='layout'>(</span><span class='varid'>show</span> <span class='varid'>i</span><span class='layout'>)</span> <span class='varop'>++</span> <span class='str'>"))"</span><span class='layout'>)</span> <span class='keyglyph'>[</span><span class='num'>0</span><span class='keyglyph'>..</span><span class='layout'>(</span><span class='layout'>(</span><span class='conid'>M</span><span class='varop'>.</span><span class='varid'>size</span> <span class='varid'>cs</span><span class='layout'>)</span> <span class='comment'>-</span> <span class='num'>1</span><span class='layout'>)</span><span class='keyglyph'>]</span><span class='layout'>)</span>
<a name="(line364)"></a>
</pre></body>
</html>
