<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://www.cs.york.ac.uk/fp/darcs/hscolour/ -->
<title>Haskell Code by HsColour</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="(line1)"></a><span class='keyword'>module</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Environment</span><span class='varop'>.</span><span class='conid'>CodeStore</span> <span class='layout'>(</span>
<a name="(line2)"></a>    <span class='varid'>addCodeStoreToEnvironment</span><span class='layout'>,</span>
<a name="(line3)"></a>    <span class='varid'>retrieveCode</span><span class='layout'>,</span>
<a name="(line4)"></a>    <span class='layout'>)</span> <span class='keyword'>where</span>
<a name="(line5)"></a>
<a name="(line6)"></a><span class='keyword'>import</span> <span class='conid'>Control</span><span class='varop'>.</span><span class='conid'>Concurrent</span><span class='varop'>.</span><span class='conid'>MVar</span>
<a name="(line7)"></a><span class='keyword'>import</span> <span class='conid'>Control</span><span class='varop'>.</span><span class='conid'>Exception</span> <span class='layout'>(</span> <span class='varid'>catch</span><span class='layout'>,</span> <span class='varid'>throwIO</span><span class='layout'>)</span>
<a name="(line8)"></a><span class='keyword'>import</span> <span class='conid'>Control</span><span class='varop'>.</span><span class='conid'>Monad</span> <span class='layout'>(</span> <span class='varid'>when</span><span class='layout'>,</span> <span class='varid'>foldM</span><span class='layout'>)</span>
<a name="(line9)"></a><span class='keyword'>import</span> <span class='conid'>Data</span><span class='varop'>.</span><span class='conid'>Map</span> <span class='varid'>hiding</span> <span class='layout'>(</span><span class='varid'>map</span><span class='layout'>)</span>
<a name="(line10)"></a><span class='keyword'>import</span> <span class='conid'>Data</span><span class='varop'>.</span><span class='conid'>List</span> <span class='layout'>(</span><span class='varid'>isPrefixOf</span><span class='layout'>,</span> <span class='varid'>intersperse</span><span class='layout'>)</span>
<a name="(line11)"></a><span class='keyword'>import</span> <span class='conid'>Data</span><span class='varop'>.</span><span class='conid'>Maybe</span>
<a name="(line12)"></a><span class='keyword'>import</span> <span class='conid'>Data</span><span class='varop'>.</span><span class='conid'>Time</span>
<a name="(line13)"></a><span class='keyword'>import</span> <span class='conid'>Data</span><span class='varop'>.</span><span class='conid'>Time</span><span class='varop'>.</span><span class='conid'>Clock</span><span class='varop'>.</span><span class='conid'>POSIX</span>
<a name="(line14)"></a><span class='keyword'>import</span> <span class='conid'>Data</span><span class='varop'>.</span><span class='conid'>Typeable</span>
<a name="(line15)"></a><span class='keyword'>import</span> <span class='keyword'>qualified</span> <span class='conid'>Network</span><span class='varop'>.</span><span class='conid'>HTTP</span> <span class='keyword'>as</span> <span class='conid'>HTTP</span>
<a name="(line16)"></a><span class='keyword'>import</span> <span class='conid'>Prelude</span> <span class='varid'>hiding</span> <span class='layout'>(</span><span class='varid'>lookup</span><span class='layout'>,</span><span class='varid'>catch</span><span class='layout'>)</span>
<a name="(line17)"></a><span class='keyword'>import</span> <span class='conid'>System</span><span class='varop'>.</span><span class='conid'>Directory</span>
<a name="(line18)"></a><span class='keyword'>import</span> <span class='conid'>System</span><span class='varop'>.</span><span class='conid'>FilePath</span>
<a name="(line19)"></a><span class='keyword'>import</span> <span class='conid'>System</span><span class='varop'>.</span><span class='conid'>IO</span>
<a name="(line20)"></a><span class='keyword'>import</span> <span class='conid'>System</span><span class='varop'>.</span><span class='conid'>Plugins</span>
<a name="(line21)"></a><span class='keyword'>import</span> <span class='conid'>System</span><span class='varop'>.</span><span class='conid'>Plugins</span><span class='varop'>.</span><span class='conid'>Utils</span>
<a name="(line22)"></a><span class='keyword'>import</span> <span class='conid'>System</span><span class='varop'>.</span><span class='conid'>Time</span>
<a name="(line23)"></a>
<a name="(line24)"></a><span class='keyword'>import</span> <span class='conid'>Config</span><span class='varop'>.</span><span class='conid'>Master</span>
<a name="(line25)"></a>
<a name="(line26)"></a><span class='keyword'>import</span> <span class='keyword'>qualified</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Server</span><span class='varop'>.</span><span class='conid'>Exception</span> <span class='keyword'>as</span> <span class='conid'>Ex</span>
<a name="(line27)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Environment</span><span class='varop'>.</span><span class='conid'>Logger</span>
<a name="(line28)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Environment</span><span class='varop'>.</span><span class='conid'>Types</span>
<a name="(line29)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Environment</span><span class='varop'>.</span><span class='conid'>Request</span>
<a name="(line30)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Environment</span><span class='varop'>.</span><span class='conid'>Response</span>
<a name="(line31)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Utility</span><span class='varop'>.</span><span class='conid'>Data</span>
<a name="(line32)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>View</span><span class='varop'>.</span><span class='conid'>Monad</span> <span class='varid'>hiding</span> <span class='layout'>(</span><span class='varid'>liftIO</span><span class='layout'>)</span>
<a name="(line33)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>View</span><span class='varop'>.</span><span class='conid'>HTML</span>
<a name="(line34)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Controller</span><span class='varop'>.</span><span class='conid'>Monad</span>
<a name="(line35)"></a>
<a name="(line36)"></a><a name="addCodeStoreToEnvironment"></a><span class='comment'>-- | Create a new store for Code data</span>
<a name="(line37)"></a><span class='varid'>addCodeStoreToEnvironment</span> <span class='keyglyph'>::</span> <span class='layout'>(</span><span class='conid'>HasEnvironment</span> <span class='varid'>m</span><span class='layout'>)</span> <span class='keyglyph'>=&gt;</span> <span class='varid'>m</span> <span class='conid'>()</span>
<a name="(line38)"></a><span class='varid'>addCodeStoreToEnvironment</span> <span class='keyglyph'>=</span> <span class='keyword'>do</span> <span class='varid'>e</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>getEnvironment</span>
<a name="(line39)"></a>                               <span class='keyword'>let</span> <span class='varid'>cm</span> <span class='keyglyph'>=</span> <span class='varid'>empty</span>
<a name="(line40)"></a>                               <span class='varid'>mv</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>liftIO</span> <span class='varop'>$</span> <span class='varid'>newMVar</span> <span class='varid'>cm</span>
<a name="(line41)"></a>                               <span class='varid'>setEnvironment</span> <span class='varop'>$</span> <span class='varid'>e</span> <span class='layout'>{</span><span class='varid'>getCodeStore</span> <span class='keyglyph'>=</span> <span class='conid'>Just</span> <span class='varop'>$</span> <span class='conid'>CodeStore</span> <span class='varid'>mv</span><span class='layout'>}</span>
<a name="(line42)"></a>
<a name="(line43)"></a><a name="retrieveCode"></a><span class='comment'>-- | This function attempts to pull a function from a pre-loaded cache or, if</span>
<a name="(line44)"></a><span class='comment'>-- the function doesn't exist or is out-of-date, loads the code from disk.</span>
<a name="(line45)"></a><span class='varid'>retrieveCode</span> <span class='keyglyph'>::</span> <span class='layout'>(</span><span class='conid'>HasEnvironment</span> <span class='varid'>m</span><span class='layout'>)</span> <span class='keyglyph'>=&gt;</span> <span class='conid'>CodeType</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>CodeLocation</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>m</span> <span class='conid'>CodeStatus</span>
<a name="(line46)"></a><span class='varid'>retrieveCode</span> <span class='varid'>ct</span> <span class='varid'>cl'</span> <span class='keyglyph'>=</span> <span class='keyword'>do</span>
<a name="(line47)"></a>    <span class='varid'>e</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>getEnvironment</span>
<a name="(line48)"></a>    <span class='keyword'>let</span> <span class='layout'>(</span><span class='conid'>CodeStore</span> <span class='varid'>mv</span><span class='layout'>)</span> <span class='keyglyph'>=</span> <span class='varid'>fromJust'</span> <span class='str'>"CodeStore: retrieveCode"</span> <span class='varop'>$</span> <span class='varid'>getCodeStore</span> <span class='varid'>e</span>
<a name="(line49)"></a>        <span class='varid'>path</span>  <span class='keyglyph'>=</span> <span class='varid'>getDir</span> <span class='varid'>ct</span>
<a name="(line50)"></a>    <span class='varid'>cl</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>return</span> <span class='layout'>(</span><span class='varid'>addExtension</span> <span class='layout'>(</span><span class='varid'>joinPath</span> <span class='varop'>$</span> <span class='varid'>map</span> <span class='varid'>normalise</span> <span class='keyglyph'>[</span><span class='varid'>path</span><span class='layout'>,</span> <span class='varid'>dropExtension</span> <span class='varop'>$</span> <span class='varid'>fst</span> <span class='varid'>cl'</span><span class='keyglyph'>]</span><span class='layout'>)</span> <span class='str'>"hs"</span><span class='layout'>,</span> <span class='varid'>snd</span> <span class='varid'>cl'</span><span class='layout'>)</span>
<a name="(line51)"></a>    <span class='varid'>debugM</span> <span class='varop'>$</span> <span class='str'>"  CodeStore : retrieveCode : loading   "</span> <span class='varop'>++</span> <span class='layout'>(</span><span class='varid'>fst</span> <span class='varid'>cl</span><span class='layout'>)</span> <span class='varop'>++</span> <span class='str'>" - "</span> <span class='varop'>++</span> <span class='layout'>(</span><span class='varid'>snd</span> <span class='varid'>cl</span><span class='layout'>)</span>
<a name="(line52)"></a>    <span class='varid'>cmap</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>liftIO</span> <span class='varop'>$</span> <span class='varid'>takeMVar</span> <span class='varid'>mv</span>
<a name="(line53)"></a>    <span class='keyword'>let</span> <span class='varid'>c</span><span class='keyglyph'>=</span> <span class='varid'>lookup</span> <span class='varid'>cl</span> <span class='varid'>cmap</span>
<a name="(line54)"></a>    <span class='varid'>cmap'</span> <span class='keyglyph'>&lt;-</span> <span class='keyword'>case</span> <span class='varid'>c</span> <span class='keyword'>of</span>
<a name="(line55)"></a>               <span class='conid'>Nothing</span>                  <span class='keyglyph'>-&gt;</span> <span class='keyword'>do</span> <span class='varid'>debugM</span> <span class='layout'>(</span><span class='layout'>(</span><span class='varid'>fst</span> <span class='varid'>cl</span><span class='layout'>)</span> <span class='varop'>++</span> <span class='str'>" : "</span> <span class='varop'>++</span> <span class='layout'>(</span><span class='varid'>snd</span> <span class='varid'>cl</span><span class='layout'>)</span> <span class='varop'>++</span> <span class='str'>" : fresh load"</span><span class='layout'>)</span>
<a name="(line56)"></a>                                              <span class='varid'>loadCode</span> <span class='varid'>ct</span> <span class='varid'>cmap</span> <span class='varid'>cl</span>
<a name="(line57)"></a>               <span class='conid'>Just</span> <span class='layout'>(</span><span class='conid'>CodeLoadFailure</span> <span class='keyword'>_</span><span class='layout'>)</span> <span class='keyglyph'>-&gt;</span> <span class='keyword'>do</span> <span class='varid'>debugM</span> <span class='layout'>(</span><span class='layout'>(</span><span class='varid'>fst</span> <span class='varid'>cl</span><span class='layout'>)</span> <span class='varop'>++</span> <span class='str'>" : "</span> <span class='varop'>++</span> <span class='layout'>(</span><span class='varid'>snd</span> <span class='varid'>cl</span><span class='layout'>)</span> <span class='varop'>++</span> <span class='str'>" : previous failure; try load"</span><span class='layout'>)</span> 
<a name="(line58)"></a>                                              <span class='varid'>loadCode</span> <span class='varid'>ct</span> <span class='varid'>cmap</span> <span class='varid'>cl</span>
<a name="(line59)"></a>               <span class='keyword'>_</span>                        <span class='keyglyph'>-&gt;</span> <span class='keyword'>do</span> <span class='varid'>debugM</span> <span class='layout'>(</span><span class='layout'>(</span><span class='varid'>fst</span> <span class='varid'>cl</span><span class='layout'>)</span> <span class='varop'>++</span> <span class='str'>" : "</span> <span class='varop'>++</span> <span class='layout'>(</span><span class='varid'>snd</span> <span class='varid'>cl</span><span class='layout'>)</span> <span class='varop'>++</span> <span class='str'>" : checking reload"</span><span class='layout'>)</span> 
<a name="(line60)"></a>                                              <span class='varid'>checkReloadCode</span> <span class='varid'>ct</span> <span class='varid'>cmap</span> <span class='layout'>(</span><span class='varid'>fromJust'</span> <span class='str'>"CodeStore: retrieveCode2"</span> <span class='varid'>c</span><span class='layout'>)</span> <span class='varid'>cl</span>
<a name="(line61)"></a>    <span class='varid'>liftIO</span> <span class='varop'>$</span> <span class='varid'>putMVar</span> <span class='varid'>mv</span> <span class='varid'>cmap'</span>
<a name="(line62)"></a>    <span class='comment'>-- We _definitely_ have a code entry now, though it may have a MakeFailure</span>
<a name="(line63)"></a>    <span class='keyword'>let</span> <span class='varid'>c'</span> <span class='keyglyph'>=</span> <span class='varid'>lookup</span> <span class='varid'>cl</span> <span class='varid'>cmap'</span>
<a name="(line64)"></a>    <span class='keyword'>case</span> <span class='varid'>c'</span> <span class='keyword'>of</span>
<a name="(line65)"></a>        <span class='conid'>Nothing</span>                             <span class='keyglyph'>-&gt;</span> <span class='keyword'>do</span> <span class='varid'>debugM</span> <span class='layout'>(</span><span class='varid'>fst</span> <span class='varid'>cl</span> <span class='varop'>++</span> <span class='str'>" : Not found in CodeStore"</span><span class='layout'>)</span> 
<a name="(line66)"></a>                                                  <span class='varid'>return</span>  <span class='conid'>CodeLoadMissing</span>
<a name="(line67)"></a>        <span class='conid'>Just</span> <span class='conid'>CodeLoadMissing</span>                <span class='keyglyph'>-&gt;</span> <span class='keyword'>do</span> <span class='varid'>debugM</span> <span class='layout'>(</span><span class='varid'>fst</span> <span class='varid'>cl</span> <span class='varop'>++</span> <span class='str'>" : Not found in CodeStore"</span><span class='layout'>)</span> 
<a name="(line68)"></a>                                                  <span class='varid'>return</span>  <span class='conid'>CodeLoadMissing</span>
<a name="(line69)"></a>        <span class='conid'>Just</span> <span class='layout'>(</span><span class='conid'>CodeLoadFailure</span> <span class='varid'>e</span><span class='layout'>)</span>            <span class='keyglyph'>-&gt;</span> <span class='keyword'>do</span> <span class='varid'>debugM</span> <span class='layout'>(</span><span class='varid'>fst</span> <span class='varid'>cl</span> <span class='varop'>++</span> <span class='str'>" : CodeLoadFailure "</span> <span class='layout'>)</span> 
<a name="(line70)"></a>                                                  <span class='varid'>return</span> <span class='layout'>(</span><span class='conid'>CodeLoadFailure</span> <span class='varid'>e</span><span class='layout'>)</span>
<a name="(line71)"></a>        <span class='conid'>Just</span> <span class='varid'>clc</span><span class='keyglyph'>@</span><span class='layout'>(</span><span class='conid'>CodeLoadController</span>   <span class='keyword'>_</span> <span class='keyword'>_</span><span class='layout'>)</span> <span class='keyglyph'>-&gt;</span> <span class='keyword'>do</span> <span class='varid'>debugM</span> <span class='layout'>(</span><span class='varid'>fst</span> <span class='varid'>cl</span> <span class='varop'>++</span> <span class='str'>" : CodeLoadController "</span> <span class='layout'>)</span> 
<a name="(line72)"></a>                                                  <span class='varid'>return</span> <span class='varid'>clc</span>  
<a name="(line73)"></a>        <span class='conid'>Just</span> <span class='varid'>clv</span><span class='keyglyph'>@</span><span class='layout'>(</span><span class='conid'>CodeLoadView</span>         <span class='keyword'>_</span> <span class='keyword'>_</span><span class='layout'>)</span> <span class='keyglyph'>-&gt;</span> <span class='keyword'>do</span> <span class='varid'>debugM</span> <span class='layout'>(</span><span class='varid'>fst</span> <span class='varid'>cl</span> <span class='varop'>++</span> <span class='str'>" : CodeLoadView"</span> <span class='layout'>)</span> 
<a name="(line74)"></a>                                                  <span class='varid'>return</span> <span class='varid'>clv</span>
<a name="(line75)"></a>        <span class='conid'>Just</span> <span class='varid'>clc</span><span class='keyglyph'>@</span><span class='layout'>(</span><span class='conid'>CodeLoadComponentController</span>   <span class='keyword'>_</span> <span class='keyword'>_</span><span class='layout'>)</span> <span class='keyglyph'>-&gt;</span> <span class='keyword'>do</span> <span class='varid'>debugM</span> <span class='layout'>(</span><span class='varid'>fst</span> <span class='varid'>cl</span> <span class='varop'>++</span> <span class='str'>" : CodeLoadComponentController "</span> <span class='layout'>)</span> 
<a name="(line76)"></a>                                                           <span class='varid'>return</span> <span class='varid'>clc</span>  
<a name="(line77)"></a>        <span class='conid'>Just</span> <span class='varid'>clv</span><span class='keyglyph'>@</span><span class='layout'>(</span><span class='conid'>CodeLoadComponentView</span>         <span class='keyword'>_</span> <span class='keyword'>_</span><span class='layout'>)</span> <span class='keyglyph'>-&gt;</span> <span class='keyword'>do</span> <span class='varid'>debugM</span> <span class='layout'>(</span><span class='varid'>fst</span> <span class='varid'>cl</span> <span class='varop'>++</span> <span class='str'>" : CodeLoadComponentView"</span> <span class='layout'>)</span> 
<a name="(line78)"></a>                                                           <span class='varid'>return</span> <span class='varid'>clv</span>
<a name="(line79)"></a>        
<a name="(line80)"></a><a name="checkReloadCode"></a><span class='comment'>-- | Checks to see if the file exists and if the file is newer than the loaded function.  If the </span>
<a name="(line81)"></a><span class='comment'>-- code needs to be reloaded, then 'loadCode' will be called.</span>
<a name="(line82)"></a><span class='varid'>checkReloadCode</span> <span class='keyglyph'>::</span> <span class='layout'>(</span><span class='conid'>HasEnvironment</span> <span class='varid'>m</span><span class='layout'>)</span> <span class='keyglyph'>=&gt;</span> <span class='conid'>CodeType</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>CodeMap</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>CodeStatus</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>CodeLocation</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>m</span> <span class='conid'>CodeMap</span>
<a name="(line83)"></a><span class='varid'>checkReloadCode</span> <span class='varid'>ct</span> <span class='varid'>cmap</span> <span class='layout'>(</span><span class='conid'>CodeLoadFailure</span> <span class='varid'>e</span><span class='layout'>)</span> <span class='varid'>cl</span> <span class='keyglyph'>=</span> <span class='varid'>error</span> <span class='str'>"ERROR: checkReloadCode was called with a CodeLoadFailure"</span>
<a name="(line84)"></a><span class='varid'>checkReloadCode</span> <span class='varid'>ct</span> <span class='varid'>cmap</span> <span class='varid'>cstat</span> <span class='varid'>cl</span> <span class='keyglyph'>=</span> <span class='keyword'>do</span>
<a name="(line85)"></a>    <span class='varid'>debugM</span> <span class='varop'>$</span> <span class='str'>"    CodeStore : checkReloadCode : loading   "</span> <span class='varop'>++</span> <span class='layout'>(</span><span class='varid'>fst</span> <span class='varid'>cl</span><span class='layout'>)</span> <span class='varop'>++</span> <span class='str'>" - "</span> <span class='varop'>++</span> <span class='layout'>(</span><span class='varid'>snd</span> <span class='varid'>cl</span><span class='layout'>)</span>
<a name="(line86)"></a>    <span class='layout'>(</span><span class='varid'>exists</span><span class='layout'>,</span> <span class='varid'>reload</span><span class='layout'>)</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>needReloadCode</span> <span class='layout'>(</span><span class='varid'>fst</span> <span class='varid'>cl</span><span class='layout'>)</span> <span class='layout'>(</span><span class='varid'>getDate</span> <span class='varid'>cstat</span><span class='layout'>)</span>
<a name="(line87)"></a>    <span class='keyword'>case</span> <span class='layout'>(</span><span class='varid'>exists</span><span class='layout'>,</span> <span class='varid'>reload</span><span class='layout'>)</span> <span class='keyword'>of</span>
<a name="(line88)"></a>        <span class='layout'>(</span><span class='conid'>False</span><span class='layout'>,</span> <span class='keyword'>_</span><span class='layout'>)</span>    <span class='keyglyph'>-&gt;</span> <span class='keyword'>do</span> <span class='varid'>debugM</span> <span class='varop'>$</span> <span class='str'>"    CodeStore : checkReloadCode : Code missing"</span>
<a name="(line89)"></a>                            <span class='varid'>return</span> <span class='varop'>$</span> <span class='varid'>insert</span> <span class='varid'>cl</span> <span class='conid'>CodeLoadMissing</span> <span class='varid'>cmap</span>
<a name="(line90)"></a>        <span class='layout'>(</span><span class='conid'>True</span><span class='layout'>,</span> <span class='conid'>False</span><span class='layout'>)</span> <span class='keyglyph'>-&gt;</span> <span class='keyword'>do</span> <span class='varid'>debugM</span> <span class='varop'>$</span> <span class='str'>"    CodeStore : checkReloadCode : No reload neeeded"</span>
<a name="(line91)"></a>                            <span class='varid'>return</span> <span class='varid'>cmap</span>
<a name="(line92)"></a>        <span class='layout'>(</span><span class='conid'>True</span><span class='layout'>,</span> <span class='conid'>True</span><span class='layout'>)</span>  <span class='keyglyph'>-&gt;</span> <span class='keyword'>do</span> <span class='varid'>debugM</span> <span class='varop'>$</span> <span class='str'>"    CodeStore : checkReloadCode : Need reload"</span>
<a name="(line93)"></a>                            <span class='varid'>loadCode</span> <span class='varid'>ct</span> <span class='varid'>cmap</span> <span class='varid'>cl</span>
<a name="(line94)"></a>  <span class='keyword'>where</span> <span class='varid'>needReloadCode</span> <span class='keyglyph'>::</span> <span class='layout'>(</span><span class='conid'>HasEnvironment</span> <span class='varid'>m</span><span class='layout'>)</span> <span class='keyglyph'>=&gt;</span> <span class='conid'>FilePath</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>CodeDate</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>m</span> <span class='layout'>(</span><span class='conid'>Bool</span><span class='layout'>,</span> <span class='conid'>Bool</span><span class='layout'>)</span>
<a name="(line95)"></a>        <span class='varid'>needReloadCode</span> <span class='varid'>fp</span> <span class='varid'>fd</span> <span class='keyglyph'>=</span> <span class='keyword'>do</span>
<a name="(line96)"></a>            <span class='varid'>fe</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>liftIO</span> <span class='varop'>$</span> <span class='varid'>doesFileExist</span> <span class='varid'>fp</span>
<a name="(line97)"></a>            <span class='keyword'>case</span> <span class='varid'>fe</span> <span class='keyword'>of</span>
<a name="(line98)"></a>                <span class='conid'>True</span> <span class='keyglyph'>-&gt;</span> <span class='keyword'>do</span> <span class='conid'>TOD</span> <span class='varid'>mt</span> <span class='keyword'>_</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>liftIO</span> <span class='varop'>$</span> <span class='varid'>getModificationTime</span> <span class='varid'>fp</span>    
<a name="(line99)"></a>                           <span class='varid'>return</span> <span class='varop'>$</span> <span class='layout'>(</span><span class='conid'>True</span><span class='layout'>,</span> <span class='varid'>fromIntegral</span> <span class='varid'>mt</span> <span class='varop'>&gt;</span> <span class='varid'>utcTimeToPOSIXSeconds</span> <span class='varid'>fd</span><span class='layout'>)</span>
<a name="(line100)"></a>                <span class='conid'>False</span><span class='keyglyph'>-&gt;</span> <span class='varid'>return</span> <span class='layout'>(</span><span class='conid'>False</span><span class='layout'>,</span> <span class='conid'>True</span><span class='layout'>)</span>
<a name="(line101)"></a>
<a name="(line102)"></a>        
<a name="(line103)"></a><span class='comment'>--------------------------------------------------------------------------</span>
<a name="(line104)"></a><span class='comment'>-- The beast</span>
<a name="(line105)"></a><span class='comment'>--------------------------------------------------------------------------</span>
<a name="(line106)"></a>       
<a name="(line107)"></a><a name="loadCode"></a><span class='comment'>-- | Begins the code load process, which comprises merging the code with</span>
<a name="(line108)"></a><span class='comment'>-- the appropriate Stub (in Turbinado/Stubs) to the tmp/compiled directory,</span>
<a name="(line109)"></a><span class='comment'>-- making the code, and loading it. </span>
<a name="(line110)"></a><span class='varid'>loadCode</span> <span class='keyglyph'>::</span> <span class='layout'>(</span><span class='conid'>HasEnvironment</span> <span class='varid'>m</span><span class='layout'>)</span> <span class='keyglyph'>=&gt;</span> <span class='conid'>CodeType</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>CodeMap</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>CodeLocation</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>m</span> <span class='conid'>CodeMap</span>
<a name="(line111)"></a><span class='varid'>loadCode</span> <span class='varid'>ct</span> <span class='varid'>cmap</span> <span class='varid'>cl</span> <span class='keyglyph'>=</span> <span class='keyword'>do</span>
<a name="(line112)"></a>    <span class='varid'>debugM</span> <span class='varop'>$</span> <span class='str'>"\tCodeStore : loadCode : loading   "</span> <span class='varop'>++</span> <span class='layout'>(</span><span class='varid'>fst</span> <span class='varid'>cl</span><span class='layout'>)</span> <span class='varop'>++</span> <span class='str'>" - "</span> <span class='varop'>++</span> <span class='layout'>(</span><span class='varid'>snd</span> <span class='varid'>cl</span><span class='layout'>)</span>
<a name="(line113)"></a>    <span class='varid'>mergeCode</span> <span class='varid'>ct</span> <span class='varid'>cmap</span> <span class='varid'>cl</span>
<a name="(line114)"></a>        
<a name="(line115)"></a><a name="mergeCode"></a><span class='comment'>-- | Merges the application code with the appropriate Stub, places the merged</span>
<a name="(line116)"></a><span class='comment'>-- file into @tmp/compiled@, then calls 'makeCode'.</span>
<a name="(line117)"></a><span class='varid'>mergeCode</span> <span class='keyglyph'>::</span> <span class='layout'>(</span><span class='conid'>HasEnvironment</span> <span class='varid'>m</span><span class='layout'>)</span> <span class='keyglyph'>=&gt;</span> <span class='conid'>CodeType</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>CodeMap</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>CodeLocation</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>m</span> <span class='conid'>CodeMap</span>
<a name="(line118)"></a><span class='varid'>mergeCode</span> <span class='varid'>ct</span> <span class='varid'>cmap</span> <span class='varid'>cl</span> <span class='keyglyph'>=</span> <span class='keyword'>do</span>
<a name="(line119)"></a>    <span class='varid'>debugM</span> <span class='varop'>$</span> <span class='str'>"\tMerging "</span> <span class='varop'>++</span> <span class='layout'>(</span><span class='varid'>fst</span> <span class='varid'>cl</span><span class='layout'>)</span>
<a name="(line120)"></a>    <span class='keyword'>let</span> <span class='varid'>stub</span> <span class='keyglyph'>=</span> <span class='layout'>(</span><span class='varid'>joinPath</span> <span class='keyglyph'>[</span><span class='varid'>normalise</span> <span class='varop'>$</span> <span class='varid'>getStub</span> <span class='varid'>ct</span><span class='keyglyph'>]</span><span class='layout'>)</span>
<a name="(line121)"></a>    <span class='varid'>ms</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>customMergeToDir</span>  <span class='varid'>stub</span> <span class='layout'>(</span><span class='varid'>fst</span> <span class='varid'>cl</span><span class='layout'>)</span> <span class='varid'>compiledDir</span>
<a name="(line122)"></a>    <span class='keyword'>case</span> <span class='varid'>ms</span> <span class='keyword'>of</span>
<a name="(line123)"></a>        <span class='conid'>MergeFailure</span> <span class='varid'>err</span>            <span class='keyglyph'>-&gt;</span> <span class='keyword'>do</span> <span class='varid'>debugM</span> <span class='layout'>(</span><span class='str'>"\tMerge error : "</span> <span class='varop'>++</span> <span class='layout'>(</span><span class='varid'>show</span> <span class='varid'>err</span><span class='layout'>)</span><span class='layout'>)</span>
<a name="(line124)"></a>                                          <span class='varid'>return</span> <span class='varop'>$</span> <span class='varid'>insert</span> <span class='varid'>cl</span> <span class='layout'>(</span><span class='conid'>CodeLoadFailure</span> <span class='varop'>$</span> <span class='varid'>unlines</span> <span class='varid'>err</span><span class='layout'>)</span> <span class='varid'>cmap</span>
<a name="(line125)"></a>        <span class='conid'>MergeSuccess</span> <span class='conid'>NotReq</span> <span class='keyword'>_</span>    <span class='keyword'>_</span>  <span class='keyglyph'>-&gt;</span> <span class='keyword'>do</span> <span class='varid'>debugM</span> <span class='layout'>(</span><span class='str'>"\tMerge success (No recompilation required) : "</span> <span class='varop'>++</span> <span class='layout'>(</span><span class='varid'>fst</span> <span class='varid'>cl</span><span class='layout'>)</span><span class='layout'>)</span> 
<a name="(line126)"></a>                                          <span class='varid'>return</span> <span class='varid'>cmap</span>
<a name="(line127)"></a>        <span class='conid'>MergeSuccess</span> <span class='keyword'>_</span>      <span class='varid'>args</span> <span class='varid'>fp</span> <span class='keyglyph'>-&gt;</span> <span class='keyword'>do</span> <span class='varid'>debugM</span> <span class='layout'>(</span><span class='str'>"\tMerge success : "</span> <span class='varop'>++</span> <span class='layout'>(</span><span class='varid'>fst</span> <span class='varid'>cl</span><span class='layout'>)</span><span class='layout'>)</span> 
<a name="(line128)"></a>                                          <span class='varid'>makeCode</span> <span class='varid'>ct</span> <span class='varid'>cmap</span> <span class='varid'>cl</span> <span class='varid'>args</span> <span class='varid'>fp</span>
<a name="(line129)"></a>
<a name="(line130)"></a>
<a name="(line131)"></a><a name="makeCode"></a><span class='comment'>-- | Attempt to make the code, then call the loader appropriate for the 'CodeType' (e.g. @View@ -&gt; '_loadView').</span>
<a name="(line132)"></a><span class='varid'>makeCode</span> <span class='keyglyph'>::</span> <span class='layout'>(</span><span class='conid'>HasEnvironment</span> <span class='varid'>m</span><span class='layout'>)</span> <span class='keyglyph'>=&gt;</span> <span class='conid'>CodeType</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>CodeMap</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>CodeLocation</span> <span class='keyglyph'>-&gt;</span> <span class='keyglyph'>[</span><span class='conid'>Arg</span><span class='keyglyph'>]</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>FilePath</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>m</span> <span class='conid'>CodeMap</span>
<a name="(line133)"></a><span class='varid'>makeCode</span> <span class='varid'>ct</span> <span class='varid'>cmap</span> <span class='varid'>cl</span> <span class='varid'>args</span> <span class='varid'>fp</span> <span class='keyglyph'>=</span> <span class='keyword'>do</span>
<a name="(line134)"></a>    <span class='varid'>ms</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>liftIO</span> <span class='varop'>$</span> <span class='varid'>makeAll</span> <span class='varid'>fp</span> <span class='layout'>(</span><span class='varid'>compileArgs</span><span class='varop'>++</span><span class='varid'>args</span><span class='layout'>)</span>
<a name="(line135)"></a>    <span class='keyword'>case</span> <span class='varid'>ms</span> <span class='keyword'>of</span>
<a name="(line136)"></a>            <span class='conid'>MakeFailure</span> <span class='varid'>err</span>       <span class='keyglyph'>-&gt;</span> <span class='keyword'>do</span> <span class='varid'>debugM</span> <span class='layout'>(</span><span class='str'>"\tMake error : "</span> <span class='varop'>++</span> <span class='layout'>(</span><span class='varid'>show</span> <span class='varid'>err</span><span class='layout'>)</span><span class='layout'>)</span>
<a name="(line137)"></a>                                        <span class='varid'>return</span> <span class='layout'>(</span><span class='varid'>insert</span> <span class='varid'>cl</span> <span class='layout'>(</span><span class='conid'>CodeLoadFailure</span> <span class='varop'>$</span> <span class='varid'>unlines</span> <span class='varid'>err</span><span class='layout'>)</span> <span class='varid'>cmap</span><span class='layout'>)</span>
<a name="(line138)"></a>            <span class='conid'>MakeSuccess</span> <span class='conid'>NotReq</span> <span class='keyword'>_</span>  <span class='keyglyph'>-&gt;</span> <span class='keyword'>do</span> <span class='varid'>debugM</span> <span class='layout'>(</span><span class='str'>"\tMake success : No recomp required"</span><span class='layout'>)</span>
<a name="(line139)"></a>                                        <span class='varid'>return</span> <span class='varid'>cmap</span>
<a name="(line140)"></a>            <span class='conid'>MakeSuccess</span> <span class='keyword'>_</span>      <span class='varid'>fp</span> <span class='keyglyph'>-&gt;</span> <span class='keyword'>do</span> <span class='varid'>debugM</span> <span class='layout'>(</span><span class='str'>"\tMake success : "</span> <span class='varop'>++</span> <span class='varid'>fp</span><span class='layout'>)</span>
<a name="(line141)"></a>                                        <span class='keyword'>case</span> <span class='varid'>ct</span> <span class='keyword'>of</span>
<a name="(line142)"></a>                                          <span class='conid'>CTLayout</span>                <span class='keyglyph'>-&gt;</span> <span class='sel'>_loadView</span> <span class='varid'>ct</span> <span class='varid'>cmap</span> <span class='varid'>cl</span> <span class='varid'>args</span> <span class='varid'>fp</span>
<a name="(line143)"></a>                                          <span class='conid'>CTView</span>                  <span class='keyglyph'>-&gt;</span> <span class='sel'>_loadView</span> <span class='varid'>ct</span> <span class='varid'>cmap</span> <span class='varid'>cl</span> <span class='varid'>args</span> <span class='varid'>fp</span>
<a name="(line144)"></a>                                          <span class='conid'>CTComponentView</span>         <span class='keyglyph'>-&gt;</span> <span class='sel'>_loadView</span> <span class='varid'>ct</span> <span class='varid'>cmap</span> <span class='varid'>cl</span> <span class='varid'>args</span> <span class='varid'>fp</span>
<a name="(line145)"></a>                                          <span class='conid'>CTController</span>            <span class='keyglyph'>-&gt;</span> <span class='sel'>_loadController</span> <span class='varid'>ct</span> <span class='varid'>cmap</span> <span class='varid'>cl</span> <span class='varid'>args</span> <span class='varid'>fp</span>
<a name="(line146)"></a>                                          <span class='conid'>CTComponentController</span>   <span class='keyglyph'>-&gt;</span> <span class='sel'>_loadController</span> <span class='varid'>ct</span> <span class='varid'>cmap</span> <span class='varid'>cl</span> <span class='varid'>args</span> <span class='varid'>fp</span>
<a name="(line147)"></a>
<a name="(line148)"></a><span class='comment'>-- | Attempt to load the code and return the 'CodeMap' with the newly loaded code in it.  This</span>
<a name="(line149)"></a><span class='comment'>-- function is specialized for Views.</span>
<a name="(line150)"></a><span class='sel'>_loadView</span> <span class='keyglyph'>::</span> <span class='layout'>(</span><span class='conid'>HasEnvironment</span> <span class='varid'>m</span><span class='layout'>)</span> <span class='keyglyph'>=&gt;</span> <span class='conid'>CodeType</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>CodeMap</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>CodeLocation</span> <span class='keyglyph'>-&gt;</span> <span class='keyglyph'>[</span><span class='conid'>Arg</span><span class='keyglyph'>]</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>FilePath</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>m</span> <span class='conid'>CodeMap</span>
<a name="(line151)"></a><span class='sel'>_loadView</span> <span class='varid'>ct</span> <span class='varid'>cmap</span> <span class='varid'>cl</span> <span class='varid'>args</span> <span class='varid'>fp</span> <span class='keyglyph'>=</span> <span class='keyword'>do</span>
<a name="(line152)"></a>    <span class='varid'>debugM</span> <span class='layout'>(</span><span class='str'>"_load : "</span> <span class='varop'>++</span> <span class='layout'>(</span><span class='varid'>show</span> <span class='varid'>ct</span><span class='layout'>)</span> <span class='varop'>++</span> <span class='str'>" : "</span> <span class='varop'>++</span> <span class='layout'>(</span><span class='varid'>fst</span> <span class='varid'>cl</span><span class='layout'>)</span> <span class='varop'>++</span> <span class='str'>" : "</span> <span class='varop'>++</span> <span class='layout'>(</span><span class='varid'>snd</span> <span class='varid'>cl</span><span class='layout'>)</span><span class='layout'>)</span>
<a name="(line153)"></a>    <span class='varid'>ls</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>liftIO</span> <span class='varop'>$</span> <span class='varid'>load_</span> <span class='varid'>fp</span> <span class='keyglyph'>[</span><span class='varid'>compiledDir</span><span class='keyglyph'>]</span> <span class='layout'>(</span><span class='varid'>snd</span> <span class='varid'>cl</span><span class='layout'>)</span>
<a name="(line154)"></a>    <span class='keyword'>case</span> <span class='varid'>ls</span> <span class='keyword'>of</span> 
<a name="(line155)"></a>                <span class='conid'>LoadFailure</span> <span class='varid'>err</span> <span class='keyglyph'>-&gt;</span> <span class='keyword'>do</span> <span class='varid'>debugM</span> <span class='layout'>(</span><span class='str'>"LoadFailure : "</span> <span class='varop'>++</span> <span class='layout'>(</span><span class='varid'>show</span> <span class='varid'>err</span><span class='layout'>)</span><span class='layout'>)</span>
<a name="(line156)"></a>                                      <span class='varid'>return</span> <span class='layout'>(</span><span class='varid'>insert</span> <span class='varid'>cl</span> <span class='layout'>(</span><span class='conid'>CodeLoadFailure</span> <span class='varop'>$</span> <span class='varid'>unlines</span> <span class='varid'>err</span><span class='layout'>)</span> <span class='varid'>cmap</span><span class='layout'>)</span>
<a name="(line157)"></a>                <span class='conid'>LoadSuccess</span> <span class='varid'>m</span> <span class='varid'>f</span> <span class='keyglyph'>-&gt;</span> <span class='keyword'>do</span> <span class='varid'>debugM</span> <span class='layout'>(</span><span class='str'>"LoadSuccess : "</span> <span class='varop'>++</span> <span class='varid'>fst</span> <span class='varid'>cl</span> <span class='layout'>)</span>
<a name="(line158)"></a>                                      <span class='varid'>liftIO</span> <span class='varop'>$</span> <span class='varid'>unload</span> <span class='varid'>m</span>
<a name="(line159)"></a>                                      <span class='varid'>t</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>liftIO</span> <span class='varop'>$</span> <span class='varid'>getCurrentTime</span>
<a name="(line160)"></a>                                      <span class='keyword'>case</span> <span class='varid'>ct</span> <span class='keyword'>of</span>
<a name="(line161)"></a>                                        <span class='conid'>CTLayout</span>              <span class='keyglyph'>-&gt;</span> <span class='varid'>return</span> <span class='layout'>(</span><span class='varid'>insert</span> <span class='varid'>cl</span> <span class='layout'>(</span><span class='conid'>CodeLoadView</span> <span class='varid'>f</span> <span class='varid'>t</span><span class='layout'>)</span> <span class='varid'>cmap</span><span class='layout'>)</span>
<a name="(line162)"></a>                                        <span class='conid'>CTView</span>                <span class='keyglyph'>-&gt;</span> <span class='varid'>return</span> <span class='layout'>(</span><span class='varid'>insert</span> <span class='varid'>cl</span> <span class='layout'>(</span><span class='conid'>CodeLoadView</span> <span class='varid'>f</span> <span class='varid'>t</span><span class='layout'>)</span> <span class='varid'>cmap</span><span class='layout'>)</span>
<a name="(line163)"></a>                                        <span class='conid'>CTComponentView</span>       <span class='keyglyph'>-&gt;</span> <span class='varid'>return</span> <span class='layout'>(</span><span class='varid'>insert</span> <span class='varid'>cl</span> <span class='layout'>(</span><span class='conid'>CodeLoadComponentView</span> <span class='varid'>f</span> <span class='varid'>t</span><span class='layout'>)</span> <span class='varid'>cmap</span><span class='layout'>)</span>
<a name="(line164)"></a>                                        <span class='keyword'>_</span>                     <span class='keyglyph'>-&gt;</span> <span class='varid'>error</span> <span class='varop'>$</span> <span class='str'>"_loadView: passed an invalid CodeType ("</span> <span class='varop'>++</span> <span class='layout'>(</span><span class='varid'>show</span> <span class='varid'>ct</span><span class='layout'>)</span>
<a name="(line165)"></a>
<a name="(line166)"></a><span class='comment'>-- | Attempt to load the code and return the 'CodeMap' with the newly loaded code in it.  This</span>
<a name="(line167)"></a><span class='comment'>-- function is specialized for Controllers.</span>
<a name="(line168)"></a><span class='sel'>_loadController</span> <span class='keyglyph'>::</span> <span class='layout'>(</span><span class='conid'>HasEnvironment</span> <span class='varid'>m</span><span class='layout'>)</span> <span class='keyglyph'>=&gt;</span> <span class='conid'>CodeType</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>CodeMap</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>CodeLocation</span> <span class='keyglyph'>-&gt;</span> <span class='keyglyph'>[</span><span class='conid'>Arg</span><span class='keyglyph'>]</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>FilePath</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>m</span> <span class='conid'>CodeMap</span>
<a name="(line169)"></a><span class='sel'>_loadController</span> <span class='varid'>ct</span> <span class='varid'>cmap</span> <span class='varid'>cl</span> <span class='varid'>args</span> <span class='varid'>fp</span> <span class='keyglyph'>=</span> <span class='keyword'>do</span>
<a name="(line170)"></a>    <span class='varid'>debugM</span> <span class='layout'>(</span><span class='str'>"_load : "</span> <span class='varop'>++</span> <span class='layout'>(</span><span class='varid'>show</span> <span class='varid'>ct</span><span class='layout'>)</span> <span class='varop'>++</span> <span class='str'>" : "</span> <span class='varop'>++</span> <span class='layout'>(</span><span class='varid'>fst</span> <span class='varid'>cl</span><span class='layout'>)</span> <span class='varop'>++</span> <span class='str'>" : "</span> <span class='varop'>++</span> <span class='layout'>(</span><span class='varid'>snd</span> <span class='varid'>cl</span><span class='layout'>)</span><span class='layout'>)</span>
<a name="(line171)"></a>    <span class='varid'>ls</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>liftIO</span> <span class='varop'>$</span> <span class='varid'>load_</span> <span class='varid'>fp</span> <span class='keyglyph'>[</span><span class='varid'>compiledDir</span><span class='keyglyph'>]</span> <span class='layout'>(</span><span class='varid'>snd</span> <span class='varid'>cl</span><span class='layout'>)</span>
<a name="(line172)"></a>    <span class='keyword'>case</span> <span class='varid'>ls</span> <span class='keyword'>of</span>
<a name="(line173)"></a>            <span class='conid'>LoadFailure</span> <span class='varid'>err</span> <span class='keyglyph'>-&gt;</span> <span class='keyword'>do</span> <span class='varid'>debugM</span> <span class='layout'>(</span><span class='str'>"LoadFailure : "</span> <span class='varop'>++</span> <span class='layout'>(</span><span class='varid'>show</span> <span class='varid'>err</span><span class='layout'>)</span><span class='layout'>)</span>
<a name="(line174)"></a>                                  <span class='varid'>return</span> <span class='layout'>(</span><span class='varid'>insert</span> <span class='varid'>cl</span> <span class='layout'>(</span><span class='conid'>CodeLoadFailure</span> <span class='varop'>$</span> <span class='varid'>unlines</span> <span class='varid'>err</span><span class='layout'>)</span> <span class='varid'>cmap</span><span class='layout'>)</span>
<a name="(line175)"></a>            <span class='conid'>LoadSuccess</span> <span class='varid'>m</span> <span class='varid'>f</span> <span class='keyglyph'>-&gt;</span> <span class='keyword'>do</span> <span class='varid'>debugM</span> <span class='layout'>(</span><span class='str'>"LoadSuccess : "</span> <span class='varop'>++</span> <span class='varid'>fst</span> <span class='varid'>cl</span> <span class='layout'>)</span>
<a name="(line176)"></a>                                  <span class='varid'>liftIO</span> <span class='varop'>$</span> <span class='varid'>unload</span> <span class='varid'>m</span>
<a name="(line177)"></a>                                  <span class='varid'>t</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>liftIO</span> <span class='varop'>$</span> <span class='varid'>getCurrentTime</span>
<a name="(line178)"></a>                                  <span class='keyword'>case</span> <span class='varid'>ct</span> <span class='keyword'>of</span>
<a name="(line179)"></a>                                    <span class='conid'>CTController</span>          <span class='keyglyph'>-&gt;</span> <span class='varid'>return</span> <span class='layout'>(</span><span class='varid'>insert</span> <span class='varid'>cl</span> <span class='layout'>(</span><span class='conid'>CodeLoadController</span> <span class='varid'>f</span> <span class='varid'>t</span><span class='layout'>)</span> <span class='varid'>cmap</span><span class='layout'>)</span>
<a name="(line180)"></a>                                    <span class='conid'>CTComponentController</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>return</span> <span class='layout'>(</span><span class='varid'>insert</span> <span class='varid'>cl</span> <span class='layout'>(</span><span class='conid'>CodeLoadComponentController</span> <span class='varid'>f</span> <span class='varid'>t</span><span class='layout'>)</span> <span class='varid'>cmap</span><span class='layout'>)</span>
<a name="(line181)"></a>                                    <span class='keyword'>_</span>                     <span class='keyglyph'>-&gt;</span> <span class='varid'>error</span> <span class='varop'>$</span> <span class='str'>"_loadController: passed an invalid CodeType ("</span> <span class='varop'>++</span> <span class='layout'>(</span><span class='varid'>show</span> <span class='varid'>ct</span><span class='layout'>)</span> <span class='varop'>++</span> <span class='str'>")"</span>
<a name="(line182)"></a>
<a name="(line183)"></a>
<a name="(line184)"></a><a name="customMergeToDir"></a><span class='comment'>-------------------------------------------------------------------------------------------------</span>
<a name="(line185)"></a><span class='comment'>-- Utility functions</span>
<a name="(line186)"></a><span class='comment'>-------------------------------------------------------------------------------------------------</span>
<a name="(line187)"></a><span class='comment'>-- | Custom merge function because I don't want to have to use a custom</span>
<a name="(line188)"></a><span class='comment'>-- version of Plugins (with HSX enabled)</span>
<a name="(line189)"></a><span class='varid'>customMergeToDir</span> <span class='keyglyph'>::</span> <span class='layout'>(</span><span class='conid'>HasEnvironment</span> <span class='varid'>m</span><span class='layout'>)</span> <span class='keyglyph'>=&gt;</span> <span class='conid'>FilePath</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>FilePath</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>FilePath</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>m</span> <span class='conid'>MergeStatus</span>
<a name="(line190)"></a><span class='varid'>customMergeToDir</span> <span class='varid'>stb</span> <span class='varid'>src</span> <span class='varid'>dir</span> <span class='keyglyph'>=</span> <span class='keyword'>do</span>
<a name="(line191)"></a>    <span class='varid'>src_exists</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>liftIO</span> <span class='varop'>$</span> <span class='varid'>doesFileExist</span> <span class='varid'>src</span>
<a name="(line192)"></a>    <span class='varid'>stb_exists</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>liftIO</span> <span class='varop'>$</span> <span class='varid'>doesFileExist</span> <span class='varid'>stb</span>
<a name="(line193)"></a>    <span class='keyword'>let</span> <span class='varid'>outFile</span> <span class='keyglyph'>=</span> <span class='varid'>joinPath</span> <span class='keyglyph'>[</span><span class='varid'>dir</span><span class='layout'>,</span> <span class='varid'>src</span><span class='keyglyph'>]</span>
<a name="(line194)"></a>        <span class='varid'>outDir</span>  <span class='keyglyph'>=</span> <span class='varid'>joinPath</span> <span class='varop'>$</span> <span class='varid'>init</span> <span class='varop'>$</span> <span class='varid'>splitDirectories</span> <span class='varid'>outFile</span>
<a name="(line195)"></a>        <span class='varid'>outMod</span>  <span class='keyglyph'>=</span> <span class='varid'>concat</span> <span class='varop'>$</span> <span class='varid'>intersperse</span> <span class='str'>"."</span> <span class='varop'>$</span> <span class='varid'>splitDirectories</span> <span class='varop'>$</span> <span class='varid'>dropExtension</span> <span class='varid'>src</span>
<a name="(line196)"></a>        <span class='varid'>outTitle</span> <span class='keyglyph'>=</span> <span class='str'>"module "</span> <span class='varop'>++</span> <span class='varid'>outMod</span> <span class='varop'>++</span> <span class='str'>" where \n\n"</span>
<a name="(line197)"></a>    <span class='keyword'>case</span> <span class='layout'>(</span><span class='varid'>src_exists</span><span class='layout'>,</span> <span class='varid'>stb_exists</span><span class='layout'>)</span> <span class='keyword'>of</span>
<a name="(line198)"></a>        <span class='layout'>(</span><span class='conid'>False</span><span class='layout'>,</span> <span class='keyword'>_</span><span class='layout'>)</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>return</span> <span class='varop'>$</span> 
<a name="(line199)"></a>                <span class='conid'>MergeFailure</span> <span class='keyglyph'>[</span><span class='str'>"Source file does not exist : "</span><span class='varop'>++</span><span class='varid'>src</span><span class='keyglyph'>]</span>
<a name="(line200)"></a>        <span class='layout'>(</span><span class='keyword'>_</span><span class='layout'>,</span> <span class='conid'>False</span><span class='layout'>)</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>return</span> <span class='varop'>$</span> 
<a name="(line201)"></a>                <span class='conid'>MergeFailure</span> <span class='keyglyph'>[</span><span class='str'>"Source file does not exist : "</span><span class='varop'>++</span><span class='varid'>stb</span><span class='keyglyph'>]</span>
<a name="(line202)"></a>        <span class='keyword'>_</span>          <span class='keyglyph'>-&gt;</span> <span class='keyword'>do</span>
<a name="(line203)"></a>                <span class='varid'>src_str</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>liftIO</span> <span class='varop'>$</span> <span class='varid'>readFile</span> <span class='varid'>src</span>
<a name="(line204)"></a>                <span class='varid'>stb_str</span>  <span class='keyglyph'>&lt;-</span> <span class='varid'>liftIO</span> <span class='varop'>$</span> <span class='varid'>readFile</span> <span class='varid'>stb</span>
<a name="(line205)"></a>                <span class='comment'>-- Check to see whether the file start with "module ".  If so, the user</span>
<a name="(line206)"></a>                <span class='comment'>-- should already have added the require preamble.  Otherwise, merge the stub.</span>
<a name="(line207)"></a>                <span class='keyword'>let</span> <span class='varid'>mrg_str</span> <span class='keyglyph'>=</span> <span class='keyword'>case</span> <span class='varid'>src_str</span> <span class='keyword'>of</span>
<a name="(line208)"></a>                                <span class='layout'>(</span><span class='chr'>'m'</span><span class='conop'>:</span><span class='chr'>'o'</span><span class='conop'>:</span><span class='chr'>'d'</span><span class='conop'>:</span><span class='chr'>'u'</span><span class='conop'>:</span><span class='chr'>'l'</span><span class='conop'>:</span><span class='chr'>'e'</span><span class='conop'>:</span><span class='chr'>' '</span><span class='conop'>:</span><span class='keyword'>_</span><span class='layout'>)</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>src_str</span>
<a name="(line209)"></a>                                <span class='keyword'>_</span> <span class='keyglyph'>-&gt;</span> <span class='keyword'>let</span> <span class='layout'>(</span><span class='varid'>stbimps</span><span class='layout'>,</span> <span class='varid'>stbdecls</span><span class='layout'>)</span> <span class='keyglyph'>=</span> <span class='varid'>span</span> <span class='layout'>(</span> <span class='varid'>not</span> <span class='varop'>.</span> <span class='varid'>isPrefixOf</span> <span class='str'>"-- SPLIT HERE"</span><span class='layout'>)</span> <span class='varop'>$</span> <span class='varid'>lines</span> <span class='varid'>stb_str</span>
<a name="(line210)"></a>                                     <span class='keyword'>in</span> <span class='varid'>outTitle</span> <span class='varop'>++</span> <span class='layout'>(</span><span class='varid'>unlines</span> <span class='varid'>stbimps</span><span class='layout'>)</span> <span class='varop'>++</span> <span class='varid'>src_str</span> <span class='varop'>++</span> <span class='layout'>(</span><span class='varid'>unlines</span> <span class='varid'>stbdecls</span><span class='layout'>)</span>
<a name="(line211)"></a>                <span class='varid'>liftIO</span> <span class='varop'>$</span> <span class='varid'>createDirectoryIfMissing</span> <span class='conid'>True</span> <span class='varid'>outDir</span>
<a name="(line212)"></a>                <span class='varid'>hdl</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>liftIO</span> <span class='varop'>$</span> <span class='varid'>openFile</span> <span class='varid'>outFile</span> <span class='conid'>WriteMode</span>  <span class='comment'>-- overwrite!</span>
<a name="(line213)"></a>                <span class='varid'>liftIO</span> <span class='varop'>$</span> <span class='varid'>hPutStr</span> <span class='varid'>hdl</span> <span class='varid'>mrg_str</span> 
<a name="(line214)"></a>                <span class='varid'>liftIO</span> <span class='varop'>$</span> <span class='varid'>hClose</span> <span class='varid'>hdl</span>
<a name="(line215)"></a>                <span class='varid'>return</span> <span class='varop'>$</span> <span class='conid'>MergeSuccess</span> <span class='conid'>ReComp</span> <span class='conid'>[]</span> <span class='varid'>outFile</span> <span class='comment'>-- must have recreated file</span>
<a name="(line216)"></a> 
<a name="(line217)"></a>
<a name="(line218)"></a>
<a name="(line219)"></a><a name="getDir"></a><span class='comment'>-- | Given a 'CodeType', return the base path to the code (e.g. @CTController@ -&gt; @App/Controllers@).</span>
<a name="(line220)"></a><span class='varid'>getDir</span> <span class='keyglyph'>::</span> <span class='conid'>CodeType</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>FilePath</span>
<a name="(line221)"></a><span class='varid'>getDir</span> <span class='varid'>ct</span> <span class='keyglyph'>=</span> <span class='keyword'>case</span> <span class='varid'>ct</span> <span class='keyword'>of</span>
<a name="(line222)"></a>  <span class='conid'>CTLayout</span>         <span class='keyglyph'>-&gt;</span> <span class='varid'>layoutDir</span>
<a name="(line223)"></a>  <span class='conid'>CTController</span>     <span class='keyglyph'>-&gt;</span> <span class='varid'>controllerDir</span>
<a name="(line224)"></a>  <span class='conid'>CTView</span>           <span class='keyglyph'>-&gt;</span> <span class='varid'>viewDir</span>
<a name="(line225)"></a>  <span class='conid'>CTComponentController</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>componentControllerDir</span>
<a name="(line226)"></a>  <span class='conid'>CTComponentView</span>       <span class='keyglyph'>-&gt;</span> <span class='varid'>componentViewDir</span>
<a name="(line227)"></a>
<a name="(line228)"></a><a name="getStub"></a><span class='varid'>getStub</span> <span class='keyglyph'>::</span> <span class='conid'>CodeType</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>FilePath</span>
<a name="(line229)"></a><span class='varid'>getStub</span> <span class='varid'>ct</span> <span class='keyglyph'>=</span> <span class='keyword'>case</span> <span class='varid'>ct</span> <span class='keyword'>of</span>
<a name="(line230)"></a>  <span class='conid'>CTLayout</span>         <span class='keyglyph'>-&gt;</span> <span class='varid'>layoutStub</span>
<a name="(line231)"></a>  <span class='conid'>CTController</span>     <span class='keyglyph'>-&gt;</span> <span class='varid'>controllerStub</span>
<a name="(line232)"></a>  <span class='conid'>CTView</span>           <span class='keyglyph'>-&gt;</span> <span class='varid'>viewStub</span>
<a name="(line233)"></a>  <span class='conid'>CTComponentController</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>controllerStub</span>
<a name="(line234)"></a>  <span class='conid'>CTComponentView</span>       <span class='keyglyph'>-&gt;</span> <span class='varid'>viewStub</span>
<a name="(line235)"></a>
<a name="(line236)"></a><a name="getDate"></a><span class='varid'>getDate</span> <span class='layout'>(</span><span class='conid'>CodeLoadMissing</span><span class='layout'>)</span> <span class='keyglyph'>=</span> <span class='varid'>error</span> <span class='str'>"getDate called with CodeLoadMissing"</span>
<a name="(line237)"></a><span class='varid'>getDate</span> <span class='layout'>(</span><span class='conid'>CodeLoadFailure</span> <span class='varid'>e</span><span class='layout'>)</span> <span class='keyglyph'>=</span> <span class='varid'>error</span> <span class='str'>"getDate called with CodeLoadFailure"</span>
<a name="(line238)"></a><span class='varid'>getDate</span> <span class='layout'>(</span><span class='conid'>CodeLoadView</span>       <span class='keyword'>_</span> <span class='varid'>d</span><span class='layout'>)</span> <span class='keyglyph'>=</span> <span class='varid'>d</span>
<a name="(line239)"></a><span class='varid'>getDate</span> <span class='layout'>(</span><span class='conid'>CodeLoadController</span> <span class='keyword'>_</span> <span class='varid'>d</span><span class='layout'>)</span> <span class='keyglyph'>=</span> <span class='varid'>d</span>
<a name="(line240)"></a><span class='varid'>getDate</span> <span class='layout'>(</span><span class='conid'>CodeLoadComponentView</span>       <span class='keyword'>_</span> <span class='varid'>d</span><span class='layout'>)</span> <span class='keyglyph'>=</span> <span class='varid'>d</span>
<a name="(line241)"></a><span class='varid'>getDate</span> <span class='layout'>(</span><span class='conid'>CodeLoadComponentController</span> <span class='keyword'>_</span> <span class='varid'>d</span><span class='layout'>)</span> <span class='keyglyph'>=</span> <span class='varid'>d</span>
</pre></body>
</html>
