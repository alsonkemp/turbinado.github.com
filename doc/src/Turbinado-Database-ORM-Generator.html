<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://www.cs.york.ac.uk/fp/darcs/hscolour/ -->
<title>Haskell Code by HsColour</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="(line1)"></a><span class='keyword'>module</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Database</span><span class='varop'>.</span><span class='conid'>ORM</span><span class='varop'>.</span><span class='conid'>Generator</span> <span class='layout'>(</span>
<a name="(line2)"></a>  <span class='varid'>generateModels</span>
<a name="(line3)"></a><span class='layout'>)</span> <span class='keyword'>where</span>
<a name="(line4)"></a>
<a name="(line5)"></a><span class='keyword'>import</span> <span class='conid'>Control</span><span class='varop'>.</span><span class='conid'>Monad</span>
<a name="(line6)"></a><span class='keyword'>import</span> <span class='conid'>Data</span><span class='varop'>.</span><span class='conid'>List</span>
<a name="(line7)"></a><span class='keyword'>import</span> <span class='keyword'>qualified</span> <span class='conid'>Data</span><span class='varop'>.</span><span class='conid'>Map</span> <span class='keyword'>as</span> <span class='conid'>M</span>
<a name="(line8)"></a><span class='keyword'>import</span> <span class='conid'>Data</span><span class='varop'>.</span><span class='conid'>Maybe</span>
<a name="(line9)"></a><span class='keyword'>import</span> <span class='conid'>Database</span><span class='varop'>.</span><span class='conid'>HDBC</span>
<a name="(line10)"></a><span class='keyword'>import</span> <span class='conid'>System</span><span class='varop'>.</span><span class='conid'>Directory</span>
<a name="(line11)"></a><span class='keyword'>import</span> <span class='conid'>System</span><span class='varop'>.</span><span class='conid'>FilePath</span>
<a name="(line12)"></a>
<a name="(line13)"></a><span class='keyword'>import</span> <span class='conid'>Config</span><span class='varop'>.</span><span class='conid'>Database</span>
<a name="(line14)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Database</span><span class='varop'>.</span><span class='conid'>ORM</span><span class='varop'>.</span><span class='conid'>Common</span>
<a name="(line15)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Database</span><span class='varop'>.</span><span class='conid'>ORM</span><span class='varop'>.</span><span class='conid'>Types</span>
<a name="(line16)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Database</span><span class='varop'>.</span><span class='conid'>ORM</span><span class='varop'>.</span><span class='conid'>Adapters</span><span class='varop'>.</span><span class='conid'>Types</span>
<a name="(line17)"></a>
<a name="(line18)"></a><a name="generateModels"></a><span class='comment'>-- | Outputs ORM models to App/Models.  User configurable files</span>
<a name="(line19)"></a><span class='comment'>-- are in App/Models.  Machine generated files are in App/Models/Bases.</span>
<a name="(line20)"></a><span class='varid'>generateModels</span> <span class='keyglyph'>::</span>  <span class='conid'>AdapterType</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>IO</span> <span class='conid'>()</span>
<a name="(line21)"></a><span class='varid'>generateModels</span> <span class='varid'>a</span> <span class='keyglyph'>=</span> <span class='keyword'>do</span> <span class='varid'>conn</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>fromJust</span> <span class='varid'>databaseConnection</span>
<a name="(line22)"></a>                      <span class='varid'>ts</span>   <span class='keyglyph'>&lt;-</span> <span class='varid'>getTables</span> <span class='varid'>conn</span>
<a name="(line23)"></a>                      <span class='comment'>-- TODO: Pull in indices</span>
<a name="(line24)"></a>                      <span class='varid'>putStr</span> <span class='str'>"Pulling schemas from the database: "</span>
<a name="(line25)"></a>                      <span class='varid'>tcs</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>foldM</span> <span class='layout'>(</span><span class='varid'>buildTable</span> <span class='varid'>a</span> <span class='varid'>conn</span><span class='layout'>)</span> <span class='layout'>(</span><span class='conid'>M</span><span class='varop'>.</span><span class='varid'>empty</span><span class='layout'>)</span> <span class='varid'>ts</span>
<a name="(line26)"></a>                      <span class='varid'>putStr</span>   <span class='str'>"\n\nWriting models: "</span>
<a name="(line27)"></a>                      <span class='varid'>writeModels</span> <span class='varid'>a</span> <span class='varid'>tcs</span>
<a name="(line28)"></a>                      <span class='varid'>putStrLn</span> <span class='str'>"\n"</span>
<a name="(line29)"></a>
<a name="(line30)"></a>                          
<a name="(line31)"></a><a name="buildTable"></a><span class='varid'>buildTable</span> <span class='varid'>a</span> <span class='varid'>conn</span> <span class='varid'>tcs</span> <span class='varid'>t</span> <span class='keyglyph'>=</span> <span class='keyword'>do</span> <span class='varid'>putStr</span> <span class='varop'>$</span> <span class='varid'>t</span> <span class='varop'>++</span> <span class='str'>", "</span>
<a name="(line32)"></a>                             <span class='varid'>ds</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>describeTable</span> <span class='varid'>conn</span> <span class='varid'>t</span>
<a name="(line33)"></a>                             <span class='keyword'>let</span> <span class='varid'>tcs'</span>  <span class='keyglyph'>=</span> <span class='varid'>combineDescription</span> <span class='varid'>t</span> <span class='varid'>ds</span> <span class='varid'>tcs</span>
<a name="(line34)"></a>                             <span class='varid'>pks</span> <span class='keyglyph'>&lt;-</span> <span class='layout'>(</span><span class='varid'>getPrimaryKeys</span> <span class='varid'>a</span><span class='layout'>)</span> <span class='varid'>conn</span> <span class='varid'>t</span>
<a name="(line35)"></a>                             <span class='keyword'>let</span> <span class='varid'>tcs''</span> <span class='keyglyph'>=</span> <span class='varid'>combinePrimaryKeys</span> <span class='varid'>t</span> <span class='varid'>pks</span> <span class='varid'>tcs'</span>
<a name="(line36)"></a>                             <span class='varid'>fks</span> <span class='keyglyph'>&lt;-</span> <span class='layout'>(</span><span class='varid'>getForeignKeyReferences</span> <span class='varid'>a</span><span class='layout'>)</span> <span class='varid'>conn</span> <span class='varid'>t</span>
<a name="(line37)"></a>                             <span class='keyword'>let</span> <span class='varid'>tcs'''</span> <span class='keyglyph'>=</span> <span class='varid'>combineForeignKeyReferences</span> <span class='varid'>t</span> <span class='varid'>fks</span> <span class='varid'>tcs''</span>
<a name="(line38)"></a>                             <span class='varid'>hds</span> <span class='keyglyph'>&lt;-</span> <span class='layout'>(</span><span class='varid'>getDefaultColumns</span> <span class='varid'>a</span><span class='layout'>)</span> <span class='varid'>conn</span> <span class='varid'>t</span>
<a name="(line39)"></a>                             <span class='varid'>return</span> <span class='varop'>$</span> <span class='varid'>combineDefaultColumns</span> <span class='varid'>t</span> <span class='varid'>hds</span> <span class='varid'>tcs'''</span>
<a name="(line40)"></a>
<a name="(line41)"></a><a name="writeModels"></a><span class='varid'>writeModels</span> <span class='varid'>a</span> <span class='varid'>ts</span> <span class='keyglyph'>=</span> 
<a name="(line42)"></a>  <span class='keyword'>do</span> <span class='varid'>writeFile</span> <span class='str'>"App/Models/Bases/Common.hs"</span> <span class='layout'>(</span><span class='varid'>generateCommon</span> <span class='varid'>a</span><span class='layout'>)</span>
<a name="(line43)"></a>     <span class='varid'>mapM_</span> <span class='layout'>(</span><span class='keyglyph'>\</span><span class='layout'>(</span><span class='varid'>t</span><span class='layout'>,</span> <span class='layout'>(</span><span class='varid'>cs</span><span class='layout'>,</span> <span class='varid'>pk</span><span class='layout'>)</span><span class='layout'>)</span> <span class='keyglyph'>-&gt;</span> 
<a name="(line44)"></a>                 <span class='keyword'>let</span> <span class='varid'>typeName</span> <span class='keyglyph'>=</span> <span class='layout'>(</span><span class='varid'>toType</span> <span class='varid'>t</span><span class='layout'>)</span> <span class='keyword'>in</span>
<a name="(line45)"></a>                 <span class='keyword'>do</span> <span class='varid'>putStr</span> <span class='varop'>$</span> <span class='varid'>t</span> <span class='varop'>++</span> <span class='str'>", "</span>
<a name="(line46)"></a>                    <span class='varid'>e</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>doesFileExist</span> <span class='layout'>(</span><span class='varid'>joinPath</span> <span class='keyglyph'>[</span><span class='str'>"App/Models"</span><span class='layout'>,</span> <span class='varid'>typeName</span> <span class='varop'>++</span> <span class='str'>".hs"</span><span class='keyglyph'>]</span><span class='layout'>)</span>
<a name="(line47)"></a>                    <span class='varid'>when</span> <span class='layout'>(</span><span class='varid'>not</span> <span class='varid'>e</span><span class='layout'>)</span> <span class='layout'>(</span><span class='varid'>writeFile</span> <span class='layout'>(</span><span class='varid'>joinPath</span> <span class='keyglyph'>[</span><span class='str'>"App/Models"</span><span class='layout'>,</span> <span class='varid'>typeName</span><span class='varop'>++</span><span class='str'>".hs"</span><span class='keyglyph'>]</span><span class='layout'>)</span> <span class='layout'>(</span><span class='layout'>(</span><span class='varid'>generateModelFile</span> <span class='varid'>a</span><span class='layout'>)</span> <span class='varid'>typeName</span><span class='layout'>)</span> <span class='layout'>)</span> 
<a name="(line48)"></a>                    <span class='varid'>writeFile</span> <span class='layout'>(</span><span class='varid'>joinPath</span> <span class='keyglyph'>[</span><span class='str'>"App/Models/Bases"</span><span class='layout'>,</span> <span class='varid'>typeName</span> <span class='varop'>++</span> <span class='str'>"Type.hs"</span><span class='keyglyph'>]</span><span class='layout'>)</span> <span class='layout'>(</span><span class='layout'>(</span><span class='varid'>generateType</span> <span class='varid'>a</span><span class='layout'>)</span> <span class='varid'>t</span> <span class='varid'>typeName</span> <span class='varid'>pk</span> <span class='varid'>ts</span> <span class='varid'>cs</span><span class='layout'>)</span>
<a name="(line49)"></a>                    <span class='varid'>writeFile</span> <span class='layout'>(</span><span class='varid'>joinPath</span> <span class='keyglyph'>[</span><span class='str'>"App/Models/Bases"</span><span class='layout'>,</span> <span class='varid'>typeName</span> <span class='varop'>++</span> <span class='str'>"Functions.hs"</span><span class='keyglyph'>]</span><span class='layout'>)</span> <span class='layout'>(</span><span class='layout'>(</span><span class='varid'>generateFunctions</span> <span class='varid'>a</span><span class='layout'>)</span> <span class='varid'>t</span> <span class='varid'>typeName</span> <span class='varid'>pk</span> <span class='varid'>ts</span> <span class='varid'>cs</span><span class='layout'>)</span>
<a name="(line50)"></a>                    <span class='varid'>writeFile</span> <span class='layout'>(</span><span class='varid'>joinPath</span> <span class='keyglyph'>[</span><span class='str'>"App/Models/Bases"</span><span class='layout'>,</span> <span class='varid'>typeName</span> <span class='varop'>++</span> <span class='str'>"Relations.hs"</span><span class='keyglyph'>]</span><span class='layout'>)</span> <span class='layout'>(</span><span class='layout'>(</span><span class='varid'>generateRelations</span> <span class='varid'>a</span><span class='layout'>)</span> <span class='varid'>t</span> <span class='varid'>typeName</span> <span class='varid'>pk</span> <span class='varid'>ts</span> <span class='varid'>cs</span><span class='layout'>)</span>
<a name="(line51)"></a>           <span class='layout'>)</span> <span class='varop'>$</span> <span class='conid'>M</span><span class='varop'>.</span><span class='varid'>toList</span> <span class='varid'>ts</span>
<a name="(line52)"></a>
<a name="(line53)"></a>
<a name="(line54)"></a><a name="combineDescription"></a><span class='comment'>--</span>
<a name="(line55)"></a><span class='comment'>-- * Functions to build the relational mappings</span>
<a name="(line56)"></a><span class='comment'>--</span>
<a name="(line57)"></a><span class='varid'>combineDescription</span> <span class='varid'>t</span> <span class='varid'>ds</span> <span class='varid'>tcs</span> <span class='keyglyph'>=</span> <span class='conid'>M</span><span class='varop'>.</span><span class='varid'>insert</span> <span class='varid'>t</span> <span class='layout'>(</span><span class='varid'>cols</span><span class='layout'>,</span> <span class='conid'>[]</span><span class='layout'>)</span> <span class='varid'>tcs</span>
<a name="(line58)"></a>  <span class='keyword'>where</span> <span class='varid'>cols</span> <span class='keyglyph'>=</span> <span class='conid'>M</span><span class='varop'>.</span><span class='varid'>fromList</span> <span class='varop'>$</span> 
<a name="(line59)"></a>                <span class='varid'>map</span> <span class='layout'>(</span><span class='keyglyph'>\</span><span class='layout'>(</span><span class='varid'>columnName</span><span class='layout'>,</span> <span class='varid'>columnDescription</span><span class='layout'>)</span> <span class='keyglyph'>-&gt;</span> <span class='layout'>(</span><span class='varid'>columnName</span><span class='layout'>,</span> <span class='layout'>(</span><span class='varid'>columnDescription</span><span class='layout'>,</span><span class='conid'>[]</span><span class='layout'>,</span> <span class='conid'>False</span><span class='layout'>)</span><span class='layout'>)</span><span class='layout'>)</span> <span class='varid'>ds</span>
<a name="(line60)"></a>
<a name="(line61)"></a><a name="combinePrimaryKeys"></a><span class='varid'>combinePrimaryKeys</span> <span class='keyglyph'>::</span> <span class='conid'>TableName</span> <span class='keyglyph'>-&gt;</span> <span class='keyglyph'>[</span><span class='conid'>ColumnName</span><span class='keyglyph'>]</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>Tables</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>Tables</span>
<a name="(line62)"></a><span class='varid'>combinePrimaryKeys</span> <span class='varid'>t</span> <span class='varid'>pks</span> <span class='varid'>tcs</span> <span class='keyglyph'>=</span> <span class='conid'>M</span><span class='varop'>.</span><span class='varid'>adjust</span> <span class='layout'>(</span><span class='keyglyph'>\</span><span class='layout'>(</span><span class='varid'>c</span><span class='layout'>,</span> <span class='keyword'>_</span><span class='layout'>)</span> <span class='keyglyph'>-&gt;</span> <span class='layout'>(</span><span class='varid'>c</span><span class='layout'>,</span><span class='varid'>pks</span><span class='layout'>)</span><span class='layout'>)</span> <span class='varid'>t</span> <span class='varid'>tcs</span>
<a name="(line63)"></a>
<a name="(line64)"></a><a name="combineForeignKeyReferences"></a><span class='varid'>combineForeignKeyReferences</span> <span class='keyglyph'>::</span> <span class='conid'>TableName</span> <span class='keyglyph'>-&gt;</span> <span class='keyglyph'>[</span><span class='layout'>(</span><span class='conid'>ColumnName</span><span class='layout'>,</span> <span class='conid'>TableName</span><span class='layout'>,</span> <span class='conid'>ColumnName</span><span class='layout'>)</span><span class='keyglyph'>]</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>Tables</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>Tables</span>
<a name="(line65)"></a><span class='varid'>combineForeignKeyReferences</span> <span class='varid'>t</span> <span class='varid'>fks</span> <span class='varid'>tcs</span> <span class='keyglyph'>=</span>
<a name="(line66)"></a>    <span class='conid'>M</span><span class='varop'>.</span><span class='varid'>adjust</span>
<a name="(line67)"></a>      <span class='layout'>(</span><span class='keyglyph'>\</span><span class='layout'>(</span><span class='varid'>cs</span><span class='layout'>,</span> <span class='varid'>pks</span><span class='layout'>)</span> <span class='keyglyph'>-&gt;</span> <span class='layout'>(</span><span class='varid'>foldl</span> <span class='layout'>(</span><span class='varid'>worker</span><span class='layout'>)</span> <span class='varid'>cs</span> <span class='varid'>fks</span><span class='layout'>,</span> <span class='varid'>pks</span><span class='layout'>)</span><span class='layout'>)</span>
<a name="(line68)"></a>        <span class='varid'>t</span> <span class='varid'>tcs</span>
<a name="(line69)"></a>  <span class='keyword'>where</span> <span class='varid'>worker</span> <span class='varid'>cs</span> <span class='layout'>(</span><span class='varid'>c</span><span class='layout'>,</span> <span class='varid'>tt</span><span class='layout'>,</span> <span class='varid'>tc</span><span class='layout'>)</span> <span class='keyglyph'>=</span> <span class='conid'>M</span><span class='varop'>.</span><span class='varid'>adjust</span> <span class='layout'>(</span><span class='keyglyph'>\</span><span class='layout'>(</span><span class='varid'>cd</span><span class='layout'>,</span> <span class='varid'>deps</span><span class='layout'>,</span> <span class='varid'>hd</span><span class='layout'>)</span> <span class='keyglyph'>-&gt;</span> <span class='layout'>(</span><span class='varid'>cd</span><span class='layout'>,</span> <span class='keyglyph'>[</span><span class='layout'>(</span><span class='varid'>tt</span><span class='layout'>,</span> <span class='varid'>tc</span><span class='layout'>)</span><span class='keyglyph'>]</span> <span class='varop'>`union`</span> <span class='varid'>deps</span><span class='layout'>,</span> <span class='varid'>hd</span><span class='layout'>)</span><span class='layout'>)</span> <span class='varid'>c</span> <span class='varid'>cs</span>
<a name="(line70)"></a>
<a name="(line71)"></a><a name="combineDefaultColumns"></a><span class='varid'>combineDefaultColumns</span> <span class='keyglyph'>::</span> <span class='conid'>TableName</span> <span class='keyglyph'>-&gt;</span> <span class='keyglyph'>[</span><span class='conid'>ColumnName</span><span class='keyglyph'>]</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>Tables</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>Tables</span>
<a name="(line72)"></a><span class='varid'>combineDefaultColumns</span> <span class='varid'>t</span> <span class='varid'>hds</span> <span class='varid'>tcs</span> <span class='keyglyph'>=</span>
<a name="(line73)"></a>    <span class='conid'>M</span><span class='varop'>.</span><span class='varid'>adjust</span>
<a name="(line74)"></a>      <span class='layout'>(</span><span class='keyglyph'>\</span><span class='layout'>(</span><span class='varid'>cs</span><span class='layout'>,</span> <span class='varid'>pks</span><span class='layout'>)</span> <span class='keyglyph'>-&gt;</span> <span class='layout'>(</span><span class='varid'>foldl</span> <span class='layout'>(</span><span class='varid'>worker</span><span class='layout'>)</span> <span class='varid'>cs</span> <span class='varid'>hds</span><span class='layout'>,</span> <span class='varid'>pks</span><span class='layout'>)</span><span class='layout'>)</span>
<a name="(line75)"></a>        <span class='varid'>t</span> <span class='varid'>tcs</span>
<a name="(line76)"></a>  <span class='keyword'>where</span> <span class='varid'>worker</span> <span class='varid'>cs</span> <span class='varid'>hd</span> <span class='keyglyph'>=</span> <span class='conid'>M</span><span class='varop'>.</span><span class='varid'>adjust</span> <span class='layout'>(</span><span class='keyglyph'>\</span><span class='layout'>(</span><span class='varid'>cd</span><span class='layout'>,</span> <span class='varid'>deps</span><span class='layout'>,</span> <span class='keyword'>_</span><span class='layout'>)</span> <span class='keyglyph'>-&gt;</span> <span class='layout'>(</span><span class='varid'>cd</span><span class='layout'>,</span> <span class='varid'>deps</span><span class='layout'>,</span> <span class='conid'>True</span><span class='layout'>)</span><span class='layout'>)</span> <span class='varid'>hd</span> <span class='varid'>cs</span>
<a name="(line77)"></a>
<a name="(line78)"></a>
</pre></body>
</html>
