<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://www.cs.york.ac.uk/fp/darcs/hscolour/ -->
<title>Haskell Code by HsColour</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="(line1)"></a><span class='keyword'>module</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Environment</span><span class='varop'>.</span><span class='conid'>Params</span><span class='layout'>(</span>
<a name="(line2)"></a><a name="getParam"></a><span class='varid'>getParam</span><span class='layout'>,</span>
<a name="(line3)"></a><a name="getParam_u"></a><span class='varid'>getParam_u</span><span class='layout'>,</span>
<a name="(line4)"></a><a name="populateParamsAndFiles"></a><span class='varid'>populateParamsAndFiles</span>
<a name="(line5)"></a><span class='layout'>)</span> <span class='keyword'>where</span>
<a name="(line6)"></a>
<a name="(line7)"></a><span class='keyword'>import</span> <span class='conid'>Control</span><span class='varop'>.</span><span class='conid'>Monad</span>
<a name="(line8)"></a><span class='keyword'>import</span> <span class='keyword'>qualified</span> <span class='conid'>Data</span><span class='varop'>.</span><span class='conid'>ByteString</span><span class='varop'>.</span><span class='conid'>Lazy</span><span class='varop'>.</span><span class='conid'>Char8</span> <span class='keyword'>as</span> <span class='conid'>BS</span>
<a name="(line9)"></a><span class='keyword'>import</span> <span class='conid'>Data</span><span class='varop'>.</span><span class='conid'>ByteString</span><span class='varop'>.</span><span class='conid'>Lazy</span><span class='varop'>.</span><span class='conid'>Char8</span> <span class='layout'>(</span><span class='conid'>ByteString</span><span class='layout'>)</span>
<a name="(line10)"></a><span class='keyword'>import</span> <span class='keyword'>qualified</span> <span class='conid'>Data</span><span class='varop'>.</span><span class='conid'>Map</span> <span class='keyword'>as</span> <span class='conid'>M</span>
<a name="(line11)"></a><span class='keyword'>import</span> <span class='conid'>Data</span><span class='varop'>.</span><span class='conid'>Int</span> <span class='layout'>(</span><span class='conid'>Int64</span><span class='layout'>)</span>
<a name="(line12)"></a><span class='keyword'>import</span> <span class='conid'>Data</span><span class='varop'>.</span><span class='conid'>List</span>
<a name="(line13)"></a><span class='keyword'>import</span> <span class='conid'>Data</span><span class='varop'>.</span><span class='conid'>Maybe</span>
<a name="(line14)"></a><span class='keyword'>import</span> <span class='conid'>Network</span><span class='varop'>.</span><span class='conid'>HTTP</span>
<a name="(line15)"></a><span class='keyword'>import</span> <span class='conid'>Network</span><span class='varop'>.</span><span class='conid'>HTTP</span><span class='varop'>.</span><span class='conid'>Headers</span>
<a name="(line16)"></a><span class='keyword'>import</span> <span class='conid'>Network</span><span class='varop'>.</span><span class='conid'>URI</span>
<a name="(line17)"></a>
<a name="(line18)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Environment</span><span class='varop'>.</span><span class='conid'>Header</span>
<a name="(line19)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Environment</span><span class='varop'>.</span><span class='conid'>Logger</span>
<a name="(line20)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Environment</span><span class='varop'>.</span><span class='conid'>Request</span>
<a name="(line21)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Environment</span><span class='varop'>.</span><span class='conid'>Types</span>
<a name="(line22)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Utility</span><span class='varop'>.</span><span class='conid'>Data</span>
<a name="(line23)"></a>
<a name="(line24)"></a><span class='keyword'>import</span> <span class='conid'>Codec</span><span class='varop'>.</span><span class='conid'>MIME</span><span class='varop'>.</span><span class='conid'>Parse</span>
<a name="(line25)"></a><span class='keyword'>import</span> <span class='conid'>Codec</span><span class='varop'>.</span><span class='conid'>MIME</span><span class='varop'>.</span><span class='conid'>Type</span>
<a name="(line26)"></a>
<a name="(line27)"></a><span class='comment'>-- | Attempt to get a Parameter from the Request query string</span>
<a name="(line28)"></a><span class='comment'>-- or POST body.</span>
<a name="(line29)"></a><span class='varid'>getParam</span> <span class='keyglyph'>::</span> <span class='layout'>(</span><span class='conid'>HasEnvironment</span> <span class='varid'>m</span><span class='layout'>)</span> <span class='keyglyph'>=&gt;</span> <span class='conid'>String</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>m</span> <span class='layout'>(</span><span class='conid'>Maybe</span> <span class='conid'>String</span><span class='layout'>)</span>
<a name="(line30)"></a><span class='varid'>getParam</span> <span class='varid'>p</span> <span class='keyglyph'>=</span> <span class='keyword'>do</span> <span class='layout'>(</span><span class='conid'>Params</span> <span class='varid'>ps</span><span class='layout'>)</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>populateParamsAndFiles</span> <span class='comment'>-- lazy population</span>
<a name="(line31)"></a>                <span class='varid'>return</span> <span class='varop'>$</span> <span class='conid'>M</span><span class='varop'>.</span><span class='varid'>lookup</span> <span class='varid'>p</span> <span class='varid'>ps</span>
<a name="(line32)"></a>
<a name="(line33)"></a><span class='comment'>-- | An unsafe version of getParam.  Errors if the key does not exist.</span>
<a name="(line34)"></a><span class='varid'>getParam_u</span> <span class='keyglyph'>::</span> <span class='layout'>(</span><span class='conid'>HasEnvironment</span> <span class='varid'>m</span><span class='layout'>)</span> <span class='keyglyph'>=&gt;</span> <span class='conid'>String</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>m</span> <span class='conid'>String</span>
<a name="(line35)"></a><span class='varid'>getParam_u</span> <span class='varid'>p</span> <span class='keyglyph'>=</span>  <span class='keyword'>do</span> <span class='varid'>r</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>getParam</span> <span class='varid'>p</span>
<a name="(line36)"></a>                   <span class='varid'>maybe</span> <span class='layout'>(</span><span class='varid'>error</span> <span class='varop'>$</span> <span class='str'>"getParam_u : key does not exist - \""</span> <span class='varop'>++</span> <span class='varid'>p</span> <span class='varop'>++</span> <span class='str'>"\""</span><span class='layout'>)</span>
<a name="(line37)"></a>                       <span class='varid'>return</span>
<a name="(line38)"></a>                       <span class='varid'>r</span>
<a name="(line39)"></a>
<a name="(line40)"></a><span class='varid'>populateParamsAndFiles</span> <span class='keyglyph'>::</span> <span class='layout'>(</span><span class='conid'>HasEnvironment</span> <span class='varid'>m</span><span class='layout'>)</span> <span class='keyglyph'>=&gt;</span> <span class='varid'>m</span> <span class='conid'>Params</span>
<a name="(line41)"></a><span class='varid'>populateParamsAndFiles</span> <span class='keyglyph'>=</span> <span class='keyword'>do</span> <span class='varid'>e</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>getEnvironment</span>
<a name="(line42)"></a>                            <span class='keyword'>case</span> <span class='layout'>(</span><span class='varid'>getParams</span> <span class='varid'>e</span><span class='layout'>)</span> <span class='keyword'>of</span>
<a name="(line43)"></a>                              <span class='conid'>Just</span> <span class='varid'>ps'</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>return</span> <span class='varid'>ps'</span>
<a name="(line44)"></a>                              <span class='conid'>Nothing</span> <span class='keyglyph'>-&gt;</span> <span class='keyword'>do</span> <span class='varid'>ct</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>getHeader</span> <span class='conid'>HdrContentType</span>
<a name="(line45)"></a>                                            <span class='keyword'>let</span> <span class='varid'>rm</span> <span class='keyglyph'>=</span> <span class='varid'>rqMethod</span> <span class='layout'>(</span><span class='varid'>fromJust'</span> <span class='str'>"Params : getParamsFromBody"</span> <span class='varop'>$</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Environment</span><span class='varop'>.</span><span class='conid'>Types</span><span class='varop'>.</span><span class='varid'>getRequest</span> <span class='varid'>e</span><span class='layout'>)</span>
<a name="(line46)"></a>                                                <span class='varid'>rb</span> <span class='keyglyph'>=</span> <span class='varid'>rqBody</span>   <span class='layout'>(</span><span class='varid'>fromJust'</span> <span class='str'>"Params : getParamsFromBody"</span> <span class='varop'>$</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Environment</span><span class='varop'>.</span><span class='conid'>Types</span><span class='varop'>.</span><span class='varid'>getRequest</span> <span class='varid'>e</span><span class='layout'>)</span>
<a name="(line47)"></a>                                            <span class='varid'>qsPs</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>setParamsFromQueryString</span> <span class='comment'>-- always process the query string</span>
<a name="(line48)"></a>                                            <span class='keyword'>case</span> <span class='varid'>rm</span> <span class='keyword'>of</span>
<a name="(line49)"></a>                                              <span class='conid'>POST</span> <span class='keyglyph'>-&gt;</span> <span class='keyword'>case</span> <span class='varid'>ct</span> <span class='keyword'>of</span>
<a name="(line50)"></a>                                                <span class='conid'>Just</span> <span class='str'>"application/x-www-form-urlencoded"</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>setParamsFromBody</span> <span class='varid'>rb</span> <span class='varid'>qsPs</span>
<a name="(line51)"></a>                                                <span class='keyword'>_</span>                                        <span class='keyglyph'>-&gt;</span> <span class='varid'>setParamsFromForm</span> <span class='varid'>rb</span> <span class='varid'>qsPs</span>
<a name="(line52)"></a>                                              <span class='keyword'>_</span>    <span class='keyglyph'>-&gt;</span> <span class='varid'>return</span> <span class='varid'>qsPs</span>
<a name="(line53)"></a>
<a name="(line54)"></a><a name="setParamsFromQueryString"></a><span class='comment'>-- Functions used by getParam.  Not exported.</span>
<a name="(line55)"></a><span class='varid'>setParamsFromQueryString</span> <span class='keyglyph'>::</span> <span class='layout'>(</span><span class='conid'>HasEnvironment</span> <span class='varid'>m</span><span class='layout'>)</span> <span class='keyglyph'>=&gt;</span> <span class='varid'>m</span> <span class='conid'>Params</span>
<a name="(line56)"></a><span class='varid'>setParamsFromQueryString</span> <span class='keyglyph'>=</span> <span class='keyword'>do</span> <span class='varid'>e</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>getEnvironment</span>
<a name="(line57)"></a>                              <span class='keyword'>let</span> <span class='varid'>qs</span> <span class='keyglyph'>=</span> <span class='varid'>dropWhile</span> <span class='layout'>(</span><span class='varop'>==</span><span class='chr'>'?'</span><span class='layout'>)</span> <span class='varop'>$</span> <span class='varid'>uriQuery</span> <span class='varop'>$</span> <span class='varid'>rqURI</span> <span class='layout'>(</span><span class='varid'>fromJust'</span> <span class='str'>"Params : getParamFromQueryString"</span> <span class='varop'>$</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Environment</span><span class='varop'>.</span><span class='conid'>Types</span><span class='varop'>.</span><span class='varid'>getRequest</span> <span class='varid'>e</span><span class='layout'>)</span>
<a name="(line58)"></a>                                  <span class='varid'>ps</span> <span class='keyglyph'>=</span> <span class='conid'>Params</span> <span class='varop'>$</span> <span class='conid'>M</span><span class='varop'>.</span><span class='varid'>fromList</span> <span class='varop'>$</span> <span class='varid'>qsDecode</span> <span class='varid'>qs</span>
<a name="(line59)"></a>                              <span class='varid'>setEnvironment</span> <span class='varop'>$</span> <span class='varid'>e</span> <span class='layout'>{</span><span class='varid'>getParams</span> <span class='keyglyph'>=</span> <span class='conid'>Just</span> <span class='varid'>ps</span><span class='layout'>}</span>
<a name="(line60)"></a>                              <span class='varid'>return</span> <span class='varid'>ps</span>
<a name="(line61)"></a>
<a name="(line62)"></a><a name="setParamsFromBody"></a><span class='varid'>setParamsFromBody</span> <span class='keyglyph'>::</span> <span class='layout'>(</span><span class='conid'>HasEnvironment</span> <span class='varid'>m</span><span class='layout'>)</span> <span class='keyglyph'>=&gt;</span> <span class='conid'>String</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>Params</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>m</span> <span class='conid'>Params</span>
<a name="(line63)"></a><span class='varid'>setParamsFromBody</span> <span class='varid'>s</span> <span class='layout'>(</span><span class='conid'>Params</span> <span class='varid'>qsps</span><span class='layout'>)</span> <span class='keyglyph'>=</span> <span class='keyword'>do</span> <span class='varid'>e</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>getEnvironment</span>
<a name="(line64)"></a>                                       <span class='keyword'>let</span> <span class='varid'>ps</span> <span class='keyglyph'>=</span> <span class='conid'>Params</span> <span class='varop'>$</span> <span class='conid'>M</span><span class='varop'>.</span><span class='varid'>union</span> <span class='layout'>(</span><span class='conid'>M</span><span class='varop'>.</span><span class='varid'>fromList</span> <span class='varop'>$</span> <span class='varid'>qsDecode</span> <span class='varid'>s</span><span class='layout'>)</span> <span class='varid'>qsps</span>
<a name="(line65)"></a>                                       <span class='varid'>setEnvironment</span> <span class='varop'>$</span> <span class='varid'>e</span> <span class='layout'>{</span><span class='varid'>getParams</span> <span class='keyglyph'>=</span> <span class='conid'>Just</span> <span class='varid'>ps</span><span class='layout'>}</span>
<a name="(line66)"></a>                                       <span class='varid'>return</span> <span class='varid'>ps</span>
<a name="(line67)"></a>
<a name="(line68)"></a><a name="setParamsFromForm"></a><span class='varid'>setParamsFromForm</span> <span class='keyglyph'>::</span> <span class='layout'>(</span><span class='conid'>HasEnvironment</span> <span class='varid'>m</span><span class='layout'>)</span> <span class='keyglyph'>=&gt;</span> <span class='conid'>String</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>Params</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>m</span> <span class='conid'>Params</span>
<a name="(line69)"></a><span class='varid'>setParamsFromForm</span> <span class='varid'>s</span> <span class='varid'>qsps</span> <span class='keyglyph'>=</span> <span class='varid'>multipartDecode</span> <span class='varid'>s</span> <span class='varid'>qsps</span>
<a name="(line70)"></a>
<a name="(line71)"></a><span class='comment'>-- LIFTED FROM THE CGI PACKAGE</span>
<a name="(line72)"></a>
<a name="(line73)"></a><a name="qsDecode"></a><span class='comment'>-- | Gets the name-value pairs from urlencoded data.</span>
<a name="(line74)"></a><span class='varid'>qsDecode</span> <span class='keyglyph'>::</span> <span class='conid'>String</span> <span class='keyglyph'>-&gt;</span> <span class='keyglyph'>[</span><span class='layout'>(</span><span class='conid'>String</span><span class='layout'>,</span><span class='conid'>String</span><span class='layout'>)</span><span class='keyglyph'>]</span>
<a name="(line75)"></a><span class='varid'>qsDecode</span> <span class='str'>""</span> <span class='keyglyph'>=</span> <span class='conid'>[]</span>
<a name="(line76)"></a><span class='varid'>qsDecode</span> <span class='varid'>s</span> <span class='keyglyph'>=</span> <span class='layout'>(</span><span class='varid'>urlDecode</span> <span class='varid'>n</span><span class='layout'>,</span> <span class='varid'>urlDecode</span> <span class='layout'>(</span><span class='varid'>drop</span> <span class='num'>1</span> <span class='varid'>v</span><span class='layout'>)</span><span class='layout'>)</span> <span class='conop'>:</span> <span class='varid'>qsDecode</span> <span class='layout'>(</span><span class='varid'>drop</span> <span class='num'>1</span> <span class='varid'>rs</span><span class='layout'>)</span>
<a name="(line77)"></a>      <span class='keyword'>where</span> <span class='layout'>(</span><span class='varid'>nv</span><span class='layout'>,</span><span class='varid'>rs</span><span class='layout'>)</span> <span class='keyglyph'>=</span> <span class='varid'>break</span> <span class='layout'>(</span><span class='varop'>==</span><span class='chr'>'&amp;'</span><span class='layout'>)</span> <span class='varid'>s</span>
<a name="(line78)"></a>            <span class='layout'>(</span><span class='varid'>n</span><span class='layout'>,</span><span class='varid'>v</span><span class='layout'>)</span> <span class='keyglyph'>=</span> <span class='varid'>break</span> <span class='layout'>(</span><span class='varop'>==</span><span class='chr'>'='</span><span class='layout'>)</span> <span class='varid'>nv</span>
<a name="(line79)"></a>
<a name="(line80)"></a><a name="multipartDecode"></a><span class='varid'>multipartDecode</span> <span class='keyglyph'>::</span> <span class='layout'>(</span><span class='conid'>HasEnvironment</span> <span class='varid'>m</span><span class='layout'>)</span> <span class='keyglyph'>=&gt;</span> <span class='conid'>String</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>Params</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>m</span> <span class='conid'>Params</span>
<a name="(line81)"></a><span class='varid'>multipartDecode</span> <span class='varid'>s</span> <span class='varid'>qsps</span> <span class='keyglyph'>=</span> <span class='keyword'>do</span> <span class='varid'>hd</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>getHeader_u</span> <span class='conid'>HdrContentType</span>
<a name="(line82)"></a>                            <span class='varid'>errorM</span> <span class='varop'>$</span> <span class='str'>"hd: "</span> <span class='varop'>++</span> <span class='varid'>hd</span>
<a name="(line83)"></a>                            <span class='keyword'>let</span> <span class='varid'>ms</span> <span class='keyglyph'>=</span> <span class='varid'>parseMIMEBody</span> <span class='keyglyph'>[</span><span class='layout'>(</span><span class='str'>"content-type"</span><span class='layout'>,</span> <span class='varid'>hd</span><span class='layout'>)</span><span class='keyglyph'>]</span> <span class='varid'>s</span>
<a name="(line84)"></a>                                <span class='layout'>(</span><span class='varid'>fs</span><span class='layout'>,</span> <span class='varid'>ps</span><span class='layout'>)</span> <span class='keyglyph'>=</span> <span class='varid'>extractParamsAndFiles</span> <span class='varid'>ms</span>
<a name="(line85)"></a>                                <span class='layout'>(</span><span class='conid'>Params</span> <span class='varid'>qsps'</span><span class='layout'>)</span> <span class='keyglyph'>=</span> <span class='varid'>qsps</span>
<a name="(line86)"></a>                                <span class='varid'>ps'</span> <span class='keyglyph'>=</span> <span class='conid'>Params</span> <span class='varop'>$</span> <span class='conid'>M</span><span class='varop'>.</span><span class='varid'>union</span> <span class='varid'>ps</span> <span class='varid'>qsps'</span>
<a name="(line87)"></a>                            <span class='varid'>errorM</span> <span class='varop'>$</span> <span class='str'>"qsps: "</span> <span class='varop'>++</span>  <span class='varid'>show</span> <span class='varid'>qsps'</span>
<a name="(line88)"></a>                            <span class='varid'>errorM</span> <span class='varop'>$</span> <span class='str'>"ps: "</span> <span class='varop'>++</span>   <span class='varid'>show</span> <span class='varid'>ps</span>
<a name="(line89)"></a>                            <span class='varid'>errorM</span> <span class='varop'>$</span> <span class='str'>"ps': "</span> <span class='varop'>++</span>  <span class='varid'>show</span> <span class='layout'>(</span><span class='conid'>M</span><span class='varop'>.</span><span class='varid'>union</span> <span class='varid'>ps</span> <span class='varid'>qsps'</span><span class='layout'>)</span>
<a name="(line90)"></a>                            <span class='varid'>e</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>getEnvironment</span>
<a name="(line91)"></a>                            <span class='varid'>setEnvironment</span> <span class='varop'>$</span> <span class='varid'>e</span> <span class='layout'>{</span> <span class='varid'>getFiles</span> <span class='keyglyph'>=</span> <span class='conid'>Just</span> <span class='varop'>$</span> <span class='conid'>Files</span> <span class='varid'>fs</span><span class='layout'>,</span> <span class='varid'>getParams</span> <span class='keyglyph'>=</span> <span class='conid'>Just</span> <span class='varid'>ps'</span><span class='layout'>}</span>
<a name="(line92)"></a>                            <span class='varid'>return</span> <span class='varid'>ps'</span>
<a name="(line93)"></a>
<a name="(line94)"></a>
<a name="(line95)"></a><a name="extractParamsAndFiles"></a><span class='comment'>{-
<a name="(line96)"></a>First draft:
<a name="(line97)"></a>
<a name="(line98)"></a>If there is a disposition we could have a file, and we look at the content, if there is one single content we add it into the Files Map.
<a name="(line99)"></a>If there are more than one Files we run the function for each file. 
<a name="(line100)"></a>-}</span>
<a name="(line101)"></a><span class='varid'>extractParamsAndFiles</span> <span class='keyglyph'>::</span> <span class='conid'>MIMEValue</span> <span class='keyglyph'>-&gt;</span> <span class='layout'>(</span><span class='conid'>M</span><span class='varop'>.</span><span class='conid'>Map</span> <span class='conid'>String</span> <span class='conid'>MIMEValue</span><span class='layout'>,</span> <span class='conid'>M</span><span class='varop'>.</span><span class='conid'>Map</span> <span class='conid'>String</span> <span class='conid'>String</span><span class='layout'>)</span>
<a name="(line102)"></a><span class='varid'>extractParamsAndFiles</span> <span class='varid'>mi</span> <span class='keyglyph'>=</span> <span class='varid'>worker</span> <span class='layout'>(</span><span class='conid'>M</span><span class='varop'>.</span><span class='varid'>empty</span><span class='layout'>,</span> <span class='conid'>M</span><span class='varop'>.</span><span class='varid'>empty</span><span class='layout'>)</span> <span class='varid'>mi</span>
<a name="(line103)"></a>  <span class='keyword'>where</span> <span class='varid'>worker</span> <span class='keyglyph'>::</span> <span class='layout'>(</span><span class='conid'>M</span><span class='varop'>.</span><span class='conid'>Map</span> <span class='conid'>String</span> <span class='conid'>MIMEValue</span><span class='layout'>,</span> <span class='conid'>M</span><span class='varop'>.</span><span class='conid'>Map</span> <span class='conid'>String</span> <span class='conid'>String</span><span class='layout'>)</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>MIMEValue</span> <span class='keyglyph'>-&gt;</span> <span class='layout'>(</span><span class='conid'>M</span><span class='varop'>.</span><span class='conid'>Map</span> <span class='conid'>String</span> <span class='conid'>MIMEValue</span><span class='layout'>,</span> <span class='conid'>M</span><span class='varop'>.</span><span class='conid'>Map</span> <span class='conid'>String</span> <span class='conid'>String</span><span class='layout'>)</span>
<a name="(line104)"></a>        <span class='varid'>worker</span> <span class='layout'>(</span><span class='varid'>fs</span><span class='layout'>,</span><span class='varid'>ps</span><span class='layout'>)</span> <span class='varid'>mv</span> <span class='keyglyph'>=</span> <span class='keyword'>if</span> <span class='layout'>(</span><span class='varid'>isSingle</span> <span class='varid'>mv</span><span class='layout'>)</span>
<a name="(line105)"></a>                              <span class='keyword'>then</span> <span class='keyword'>case</span> <span class='layout'>(</span><span class='varid'>getFileAndName</span> <span class='varop'>$</span> <span class='varid'>dispParams</span> <span class='varop'>$</span> <span class='varid'>fromJust'</span> <span class='str'>"MIMEValue has no Dispositions"</span> <span class='varop'>$</span> <span class='varid'>mime_val_disp</span> <span class='varid'>mv</span><span class='layout'>)</span> <span class='keyword'>of</span>
<a name="(line106)"></a>                                     <span class='layout'>(</span><span class='conid'>True</span><span class='layout'>,</span>  <span class='varid'>nm</span><span class='layout'>)</span> <span class='keyglyph'>-&gt;</span> <span class='layout'>(</span><span class='conid'>M</span><span class='varop'>.</span><span class='varid'>insert</span> <span class='varid'>nm</span> <span class='varid'>mv</span> <span class='varid'>fs</span><span class='layout'>,</span><span class='varid'>ps</span><span class='layout'>)</span>
<a name="(line107)"></a>                                     <span class='layout'>(</span><span class='conid'>False</span><span class='layout'>,</span> <span class='varid'>nm</span><span class='layout'>)</span> <span class='keyglyph'>-&gt;</span> <span class='layout'>(</span><span class='varid'>fs</span><span class='layout'>,</span> <span class='conid'>M</span><span class='varop'>.</span><span class='varid'>insert</span> <span class='varid'>nm</span> <span class='layout'>(</span><span class='sel'>_getContent</span> <span class='varid'>mv</span><span class='layout'>)</span> <span class='varid'>ps</span><span class='layout'>)</span>
<a name="(line108)"></a>                              <span class='keyword'>else</span> <span class='varid'>foldl</span> <span class='varid'>worker</span> <span class='layout'>(</span><span class='varid'>fs</span><span class='layout'>,</span> <span class='varid'>ps</span><span class='layout'>)</span> <span class='layout'>(</span><span class='sel'>_getContents</span> <span class='varid'>mv</span><span class='layout'>)</span>
<a name="(line109)"></a>
<a name="(line110)"></a><span class='sel'>_getContent</span> <span class='varid'>mv</span> <span class='keyglyph'>=</span> <span class='keyword'>case</span> <span class='layout'>(</span><span class='varid'>mime_val_content</span> <span class='varid'>mv</span><span class='layout'>)</span> <span class='keyword'>of</span>
<a name="(line111)"></a>                   <span class='conid'>Single</span> <span class='varid'>c</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>c</span>
<a name="(line112)"></a>                   <span class='keyword'>_</span>        <span class='keyglyph'>-&gt;</span> <span class='varid'>error</span> <span class='str'>"Turbinado.Environment.Params.getContent: called with a Multi Content"</span>
<a name="(line113)"></a>
<a name="(line114)"></a><span class='sel'>_getContents</span> <span class='varid'>mv</span> <span class='keyglyph'>=</span> <span class='keyword'>case</span> <span class='layout'>(</span><span class='varid'>mime_val_content</span> <span class='varid'>mv</span><span class='layout'>)</span> <span class='keyword'>of</span>
<a name="(line115)"></a>                    <span class='conid'>Multi</span> <span class='varid'>c</span>  <span class='keyglyph'>-&gt;</span> <span class='varid'>c</span>
<a name="(line116)"></a>                    <span class='keyword'>_</span>        <span class='keyglyph'>-&gt;</span> <span class='varid'>error</span> <span class='str'>"Turbinado.Environment.Params.getContents: called with a Single Content"</span>
<a name="(line117)"></a>
<a name="(line118)"></a><a name="isSingle"></a><span class='varid'>isSingle</span> <span class='keyglyph'>::</span> <span class='conid'>MIMEValue</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>Bool</span>
<a name="(line119)"></a><span class='varid'>isSingle</span> <span class='varid'>mv</span> <span class='keyglyph'>=</span> <span class='keyword'>case</span> <span class='layout'>(</span><span class='varid'>mime_val_content</span> <span class='varid'>mv</span><span class='layout'>)</span> <span class='keyword'>of</span>
<a name="(line120)"></a>               <span class='conid'>Single</span> <span class='keyword'>_</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>True</span>
<a name="(line121)"></a>               <span class='keyword'>_</span>        <span class='keyglyph'>-&gt;</span> <span class='conid'>False</span>
<a name="(line122)"></a>
<a name="(line123)"></a><a name="getFileAndName"></a><span class='varid'>getFileAndName</span> <span class='keyglyph'>::</span> <span class='keyglyph'>[</span><span class='conid'>DispParam</span><span class='keyglyph'>]</span> <span class='keyglyph'>-&gt;</span> <span class='layout'>(</span><span class='conid'>Bool</span><span class='layout'>,</span> <span class='conid'>String</span><span class='layout'>)</span>
<a name="(line124)"></a><span class='varid'>getFileAndName</span> <span class='varid'>ds</span> <span class='keyglyph'>=</span> <span class='varid'>worker</span> <span class='layout'>(</span><span class='conid'>False</span><span class='layout'>,</span> <span class='str'>"no-name-found"</span><span class='layout'>)</span> <span class='varid'>ds</span>
<a name="(line125)"></a>  <span class='keyword'>where</span> <span class='varid'>worker</span> <span class='layout'>(</span><span class='varid'>b</span><span class='layout'>,</span> <span class='varid'>n</span><span class='layout'>)</span> <span class='conid'>[]</span> <span class='keyglyph'>=</span> <span class='layout'>(</span><span class='varid'>b</span><span class='layout'>,</span> <span class='varid'>n</span><span class='layout'>)</span>
<a name="(line126)"></a>        <span class='varid'>worker</span> <span class='layout'>(</span><span class='keyword'>_</span><span class='layout'>,</span> <span class='varid'>n</span><span class='layout'>)</span> <span class='layout'>(</span><span class='layout'>(</span><span class='conid'>Filename</span> <span class='keyword'>_</span><span class='layout'>)</span><span class='conop'>:</span><span class='varid'>ds'</span><span class='layout'>)</span> <span class='keyglyph'>=</span> <span class='varid'>worker</span> <span class='layout'>(</span><span class='conid'>True</span><span class='layout'>,</span> <span class='varid'>n</span><span class='layout'>)</span> <span class='varid'>ds'</span>
<a name="(line127)"></a>        <span class='varid'>worker</span> <span class='layout'>(</span><span class='varid'>b</span><span class='layout'>,</span> <span class='keyword'>_</span><span class='layout'>)</span> <span class='layout'>(</span><span class='layout'>(</span><span class='conid'>Name</span> <span class='varid'>n'</span><span class='layout'>)</span><span class='conop'>:</span><span class='varid'>ds'</span><span class='layout'>)</span>    <span class='keyglyph'>=</span> <span class='varid'>worker</span> <span class='layout'>(</span><span class='varid'>b</span><span class='layout'>,</span>   <span class='varid'>n'</span><span class='layout'>)</span> <span class='varid'>ds'</span>
<a name="(line128)"></a>
</pre></body>
</html>
