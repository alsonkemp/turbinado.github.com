<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://www.cs.york.ac.uk/fp/darcs/hscolour/ -->
<title>Haskell Code by HsColour</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="(line1)"></a><span class='keyword'>module</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Controller</span><span class='varop'>.</span><span class='conid'>Monad</span> <span class='layout'>(</span>
<a name="(line2)"></a>        <span class='comment'>-- * The 'Controller' Monad</span>
<a name="(line3)"></a>        <span class='conid'>Controller</span><span class='layout'>,</span>
<a name="(line4)"></a>        <span class='varid'>runController</span><span class='layout'>,</span>
<a name="(line5)"></a>        <span class='varid'>withController</span><span class='layout'>,</span>
<a name="(line6)"></a>        <span class='varid'>get</span><span class='layout'>,</span>
<a name="(line7)"></a>        <span class='varid'>put</span><span class='layout'>,</span>
<a name="(line8)"></a>        <span class='comment'>-- * Functions</span>
<a name="(line9)"></a>        <span class='varid'>liftIO</span><span class='layout'>,</span> <span class='varid'>catch</span>
<a name="(line10)"></a>        <span class='layout'>)</span> <span class='keyword'>where</span>
<a name="(line11)"></a>
<a name="(line12)"></a><span class='keyword'>import</span> <span class='conid'>Control</span><span class='varop'>.</span><span class='conid'>OldException</span> <span class='layout'>(</span><span class='varid'>catchDyn</span><span class='layout'>)</span>
<a name="(line13)"></a>
<a name="(line14)"></a><span class='keyword'>import</span> <span class='conid'>Control</span><span class='varop'>.</span><span class='conid'>Monad</span><span class='varop'>.</span><span class='conid'>State</span>
<a name="(line15)"></a><span class='keyword'>import</span> <span class='conid'>Control</span><span class='varop'>.</span><span class='conid'>Monad</span><span class='varop'>.</span><span class='conid'>Trans</span> <span class='layout'>(</span><span class='conid'>MonadIO</span><span class='layout'>(</span><span class='keyglyph'>..</span><span class='layout'>)</span><span class='layout'>,</span> <span class='varid'>liftIO</span><span class='layout'>)</span>
<a name="(line16)"></a><span class='keyword'>import</span> <span class='conid'>Data</span><span class='varop'>.</span><span class='conid'>Maybe</span>
<a name="(line17)"></a><span class='keyword'>import</span> <span class='conid'>Prelude</span> <span class='varid'>hiding</span> <span class='layout'>(</span><span class='varid'>catch</span><span class='layout'>)</span>
<a name="(line18)"></a>
<a name="(line19)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Environment</span><span class='varop'>.</span><span class='conid'>Types</span>
<a name="(line20)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Controller</span><span class='varop'>.</span><span class='conid'>Exception</span>
<a name="(line21)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Utility</span><span class='varop'>.</span><span class='conid'>General</span>
<a name="(line22)"></a>
<a name="(line23)"></a>
<a name="(line24)"></a><span class='comment'>--------------------------------------------------------------</span>
<a name="(line25)"></a><span class='comment'>-- The Controller Monad</span>
<a name="(line26)"></a>
<a name="(line27)"></a><a name="Controller"></a><span class='comment'>-- | The Controller monad is a state wrapper around</span>
<a name="(line28)"></a><a name="Controller"></a><span class='comment'>-- the IO monad.</span>
<a name="(line29)"></a><a name="Controller"></a><span class='keyword'>type</span> <span class='conid'>Controller</span> <span class='keyglyph'>=</span> <span class='conid'>StateT</span> <span class='conid'>Environment</span> <span class='conid'>IO</span>
<a name="(line30)"></a>
<a name="(line31)"></a>
<a name="(line32)"></a><a name="runController"></a><span class='comment'>-- | Runs a Controller computation in a particular environment. Since Controller wraps the IO monad,</span>
<a name="(line33)"></a><span class='comment'>-- the result of running it will be an IO computation.</span>
<a name="(line34)"></a><span class='varid'>runController</span> <span class='keyglyph'>::</span> <span class='conid'>Controller</span> <span class='conid'>()</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>Environment</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>IO</span> <span class='conid'>Environment</span>
<a name="(line35)"></a><span class='varid'>runController</span> <span class='varid'>c</span> <span class='varid'>e</span> <span class='keyglyph'>=</span> <span class='layout'>(</span><span class='varid'>execStateT</span> <span class='varid'>c</span><span class='layout'>)</span> <span class='varid'>e</span>
<a name="(line36)"></a>
<a name="(line37)"></a><a name="withController"></a><span class='varid'>withController</span> <span class='keyglyph'>::</span> <span class='layout'>(</span><span class='conid'>Environment</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>Environment</span><span class='layout'>)</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>Controller</span> <span class='varid'>a</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>Controller</span> <span class='varid'>a</span>
<a name="(line38)"></a><span class='varid'>withController</span> <span class='keyglyph'>=</span> <span class='varid'>withStateT</span>
<a name="(line39)"></a>
<a name="(line40)"></a><span class='comment'>-----------------------------------------------------------------------</span>
<a name="(line41)"></a><span class='comment'>-- Exception handling</span>
<a name="(line42)"></a>
<a name="(line43)"></a><a name="catch"></a><span class='comment'>-- | Catch a user-caused exception.</span>
<a name="(line44)"></a><span class='varid'>catch</span> <span class='keyglyph'>::</span> <span class='conid'>Controller</span> <span class='varid'>a</span> <span class='keyglyph'>-&gt;</span> <span class='layout'>(</span><span class='conid'>Exception</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>Controller</span> <span class='varid'>a</span><span class='layout'>)</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>Controller</span> <span class='varid'>a</span>
<a name="(line45)"></a><span class='varid'>catch</span> <span class='layout'>(</span><span class='conid'>StateT</span> <span class='varid'>f</span><span class='layout'>)</span> <span class='varid'>handler</span> <span class='keyglyph'>=</span> <span class='conid'>StateT</span> <span class='varop'>$</span> <span class='keyglyph'>\</span><span class='varid'>e</span> <span class='keyglyph'>-&gt;</span>
<a name="(line46)"></a>        <span class='varid'>f</span> <span class='varid'>e</span> <span class='varop'>`catchDyn`</span> <span class='layout'>(</span><span class='keyglyph'>\</span><span class='varid'>ex</span> <span class='keyglyph'>-&gt;</span> <span class='layout'>(</span><span class='keyword'>let</span> <span class='layout'>(</span><span class='conid'>StateT</span> <span class='varid'>g</span><span class='layout'>)</span> <span class='keyglyph'>=</span> <span class='varid'>handler</span> <span class='varid'>ex</span>
<a name="(line47)"></a>                                   <span class='keyword'>in</span> <span class='varid'>g</span> <span class='varid'>e</span><span class='layout'>)</span><span class='layout'>)</span>
<a name="(line48)"></a>
</pre></body>
</html>
