<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://www.cs.york.ac.uk/fp/darcs/hscolour/ -->
<title>Haskell Code by HsColour</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="(line1)"></a><span class='keyword'>module</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Server</span><span class='varop'>.</span><span class='conid'>StaticContent</span> <span class='layout'>(</span>
<a name="(line2)"></a>    <span class='varid'>tryStaticContent</span>
<a name="(line3)"></a>    <span class='layout'>)</span> <span class='keyword'>where</span>
<a name="(line4)"></a>
<a name="(line5)"></a><span class='keyword'>import</span> <span class='conid'>Control</span><span class='varop'>.</span><span class='conid'>Concurrent</span>
<a name="(line6)"></a><span class='keyword'>import</span> <span class='conid'>Control</span><span class='varop'>.</span><span class='conid'>Monad</span>
<a name="(line7)"></a><span class='keyword'>import</span> <span class='conid'>Data</span><span class='varop'>.</span><span class='conid'>Maybe</span>
<a name="(line8)"></a><span class='keyword'>import</span> <span class='conid'>System</span><span class='varop'>.</span><span class='conid'>FilePath</span>
<a name="(line9)"></a><span class='keyword'>import</span> <span class='conid'>System</span><span class='varop'>.</span><span class='conid'>IO</span>
<a name="(line10)"></a><span class='keyword'>import</span> <span class='conid'>System</span><span class='varop'>.</span><span class='conid'>Directory</span>
<a name="(line11)"></a><span class='keyword'>import</span> <span class='conid'>Prelude</span> <span class='varid'>hiding</span> <span class='layout'>(</span><span class='varid'>catch</span><span class='layout'>)</span>
<a name="(line12)"></a>
<a name="(line13)"></a><span class='keyword'>import</span> <span class='conid'>Network</span><span class='varop'>.</span><span class='conid'>URI</span>
<a name="(line14)"></a><span class='keyword'>import</span> <span class='conid'>Network</span><span class='varop'>.</span><span class='conid'>HTTP</span>
<a name="(line15)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Controller</span><span class='varop'>.</span><span class='conid'>Monad</span>
<a name="(line16)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Server</span><span class='varop'>.</span><span class='conid'>StandardResponse</span>
<a name="(line17)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Environment</span><span class='varop'>.</span><span class='conid'>MimeTypes</span>
<a name="(line18)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Environment</span><span class='varop'>.</span><span class='conid'>Types</span>
<a name="(line19)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Environment</span><span class='varop'>.</span><span class='conid'>Logger</span>
<a name="(line20)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Environment</span><span class='varop'>.</span><span class='conid'>Request</span>
<a name="(line21)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Environment</span><span class='varop'>.</span><span class='conid'>Response</span>
<a name="(line22)"></a>
<a name="(line23)"></a><span class='keyword'>import</span> <span class='conid'>Config</span><span class='varop'>.</span><span class='conid'>Master</span>
<a name="(line24)"></a>
<a name="(line25)"></a><a name="tryStaticContent"></a><span class='varid'>tryStaticContent</span> <span class='keyglyph'>::</span> <span class='conid'>Controller</span> <span class='conid'>()</span>
<a name="(line26)"></a><span class='varid'>tryStaticContent</span> <span class='keyglyph'>=</span> 
<a name="(line27)"></a>  <span class='keyword'>do</span> <span class='varid'>e</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>get</span>
<a name="(line28)"></a>     <span class='varid'>cDir</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>liftIO</span> <span class='varop'>$</span> <span class='varid'>getCurrentDirectory</span>
<a name="(line29)"></a>     <span class='keyword'>let</span> <span class='varid'>mt</span>      <span class='keyglyph'>=</span> <span class='varid'>fromJust</span> <span class='varop'>$</span> <span class='varid'>getMimeTypes</span> <span class='varid'>e</span>
<a name="(line30)"></a>         <span class='varid'>rq</span>      <span class='keyglyph'>=</span> <span class='varid'>fromJust</span> <span class='varop'>$</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Environment</span><span class='varop'>.</span><span class='conid'>Types</span><span class='varop'>.</span><span class='varid'>getRequest</span> <span class='varid'>e</span>
<a name="(line31)"></a>         <span class='varid'>f</span>       <span class='keyglyph'>=</span> <span class='varid'>drop</span> <span class='num'>1</span> <span class='varop'>$</span> <span class='varid'>uriPath</span> <span class='varop'>$</span> <span class='varid'>rqURI</span> <span class='varid'>rq</span>
<a name="(line32)"></a>         <span class='varid'>trydirs</span> <span class='keyglyph'>=</span> <span class='keyword'>case</span> <span class='layout'>(</span><span class='varid'>length</span> <span class='varid'>f</span><span class='layout'>)</span> <span class='keyword'>of</span>
<a name="(line33)"></a>           <span class='num'>0</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>map</span> <span class='layout'>(</span><span class='keyglyph'>\</span><span class='varid'>s</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>joinPath</span> <span class='varop'>$</span> <span class='varid'>map</span> <span class='varid'>normalise</span> <span class='keyglyph'>[</span><span class='varid'>cDir</span><span class='layout'>,</span> <span class='varid'>s</span><span class='layout'>,</span> <span class='str'>"index.html"</span><span class='keyglyph'>]</span><span class='layout'>)</span> <span class='varid'>staticDirs</span>
<a name="(line34)"></a>           <span class='keyword'>_</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>map</span> <span class='layout'>(</span><span class='keyglyph'>\</span><span class='varid'>s</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>joinPath</span> <span class='varop'>$</span> <span class='varid'>map</span> <span class='varid'>normalise</span> <span class='keyglyph'>[</span><span class='varid'>cDir</span><span class='layout'>,</span> <span class='varid'>s</span><span class='layout'>,</span> <span class='varid'>f</span><span class='keyglyph'>]</span><span class='layout'>)</span> <span class='varid'>staticDirs</span>
<a name="(line35)"></a>     <span class='comment'>-- debugM e $ "  tryStaticContent over " ++ (show trydirs)</span>
<a name="(line36)"></a>     <span class='varid'>sequence_</span> <span class='varop'>$</span> <span class='varid'>map</span> <span class='layout'>(</span><span class='varid'>tryToGetStaticContent</span> <span class='varid'>mt</span><span class='layout'>)</span> <span class='varid'>trydirs</span>
<a name="(line37)"></a>
<a name="(line38)"></a><a name="tryToGetStaticContent"></a><span class='varid'>tryToGetStaticContent</span> <span class='keyglyph'>::</span> <span class='conid'>MimeTypes</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>FilePath</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>Controller</span> <span class='conid'>()</span>
<a name="(line39)"></a><span class='varid'>tryToGetStaticContent</span> <span class='varid'>mt</span> <span class='varid'>p</span> <span class='keyglyph'>=</span> <span class='keyword'>do</span> <span class='varid'>exist</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>liftIO</span> <span class='varop'>$</span> <span class='varid'>doesFileExist</span> <span class='varid'>p</span>
<a name="(line40)"></a>                                <span class='keyword'>case</span> <span class='varid'>exist</span> <span class='keyword'>of</span>
<a name="(line41)"></a>                                    <span class='conid'>False</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>return</span> <span class='conid'>()</span>
<a name="(line42)"></a>                                    <span class='conid'>True</span> <span class='keyglyph'>-&gt;</span> <span class='keyword'>do</span> <span class='varid'>f</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>liftIO</span> <span class='varop'>$</span> <span class='varid'>readFile</span> <span class='varid'>p</span>
<a name="(line43)"></a>                                               <span class='keyword'>let</span> <span class='varid'>ct</span> <span class='keyglyph'>=</span> <span class='varid'>maybe</span> <span class='str'>"text/html"</span> <span class='layout'>(</span><span class='varid'>show</span><span class='layout'>)</span> <span class='layout'>(</span><span class='varid'>mimeTypeOf</span> <span class='varid'>mt</span> <span class='varid'>p</span><span class='layout'>)</span>
<a name="(line44)"></a>                                               <span class='varid'>cachedContentResponse</span> <span class='num'>600</span> <span class='varid'>ct</span> <span class='varid'>f</span>
</pre></body>
</html>
