<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://www.cs.york.ac.uk/fp/darcs/hscolour/ -->
<title>Haskell Code by HsColour</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="(line1)"></a><span class='keyword'>module</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Server</span><span class='varop'>.</span><span class='conid'>Network</span> <span class='layout'>(</span>
<a name="(line2)"></a>          <span class='varid'>receiveRequest</span> 	<span class='comment'>-- :: Handle -&gt; IO Request</span>
<a name="(line3)"></a>        <span class='layout'>,</span> <span class='varid'>sendResponse</span>		<span class='comment'>-- :: Handle -&gt; Response -&gt; IO ()</span>
<a name="(line4)"></a>        <span class='layout'>)</span> <span class='keyword'>where</span>
<a name="(line5)"></a>
<a name="(line6)"></a><span class='keyword'>import</span> <span class='conid'>Data</span><span class='varop'>.</span><span class='conid'>Maybe</span>
<a name="(line7)"></a><span class='keyword'>import</span> <span class='conid'>Network</span><span class='varop'>.</span><span class='conid'>Socket</span>
<a name="(line8)"></a><span class='keyword'>import</span> <span class='conid'>Network</span><span class='varop'>.</span><span class='conid'>HTTP</span> <span class='varid'>hiding</span> <span class='layout'>(</span><span class='varid'>receiveHTTP</span><span class='layout'>,</span> <span class='varid'>respondHTTP</span><span class='layout'>)</span>
<a name="(line9)"></a><span class='keyword'>import</span> <span class='conid'>Network</span><span class='varop'>.</span><span class='conid'>HTTP</span><span class='varop'>.</span><span class='conid'>Stream</span>
<a name="(line10)"></a><span class='keyword'>import</span> <span class='conid'>Network</span><span class='varop'>.</span><span class='conid'>StreamSocket</span>
<a name="(line11)"></a><span class='keyword'>import</span> <span class='conid'>Network</span><span class='varop'>.</span><span class='conid'>URI</span>
<a name="(line12)"></a><span class='keyword'>import</span> <span class='keyword'>qualified</span> <span class='conid'>System</span><span class='varop'>.</span><span class='conid'>Environment</span> <span class='keyword'>as</span> <span class='conid'>Env</span>
<a name="(line13)"></a><span class='keyword'>import</span> <span class='conid'>System</span><span class='varop'>.</span><span class='conid'>IO</span>
<a name="(line14)"></a>
<a name="(line15)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Controller</span><span class='varop'>.</span><span class='conid'>Monad</span>
<a name="(line16)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Server</span><span class='varop'>.</span><span class='conid'>Exception</span>
<a name="(line17)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Environment</span><span class='varop'>.</span><span class='conid'>Logger</span>
<a name="(line18)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Environment</span><span class='varop'>.</span><span class='conid'>Types</span>
<a name="(line19)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Environment</span><span class='varop'>.</span><span class='conid'>Request</span>
<a name="(line20)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Environment</span><span class='varop'>.</span><span class='conid'>Response</span>
<a name="(line21)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Server</span><span class='varop'>.</span><span class='conid'>StandardResponse</span>
<a name="(line22)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Utility</span><span class='varop'>.</span><span class='conid'>Data</span>
<a name="(line23)"></a>
<a name="(line24)"></a>
<a name="(line25)"></a>
<a name="(line26)"></a><a name="receiveRequest"></a><span class='comment'>-- | Read the request from client.</span>
<a name="(line27)"></a><span class='varid'>receiveRequest</span> <span class='keyglyph'>::</span> <span class='conid'>Maybe</span> <span class='conid'>Socket</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>Controller</span> <span class='conid'>()</span>
<a name="(line28)"></a><span class='varid'>receiveRequest</span> <span class='conid'>Nothing</span>     <span class='keyglyph'>=</span> <span class='keyword'>do</span> <span class='varid'>e</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>getEnvironment</span>
<a name="(line29)"></a>                                <span class='varid'>acceptCGI</span>
<a name="(line30)"></a><span class='varid'>receiveRequest</span> <span class='layout'>(</span><span class='conid'>Just</span> <span class='varid'>sock</span><span class='layout'>)</span> <span class='keyglyph'>=</span> <span class='keyword'>do</span>
<a name="(line31)"></a>        <span class='varid'>req</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>liftIO</span> <span class='varop'>$</span> <span class='varid'>receiveHTTP</span> <span class='varid'>sock</span>
<a name="(line32)"></a>        <span class='keyword'>case</span> <span class='varid'>req</span> <span class='keyword'>of</span>
<a name="(line33)"></a>         <span class='conid'>Left</span> <span class='varid'>e</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>throwTurbinado</span> <span class='varop'>$</span> <span class='conid'>BadRequest</span> <span class='varop'>$</span> <span class='str'>"In receiveRequest : "</span> <span class='varop'>++</span> <span class='varid'>show</span> <span class='varid'>e</span>
<a name="(line34)"></a>         <span class='conid'>Right</span> <span class='varid'>r</span>  <span class='keyglyph'>-&gt;</span> <span class='keyword'>do</span> <span class='varid'>e</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>get</span>
<a name="(line35)"></a>                        <span class='varid'>put</span> <span class='varop'>$</span> <span class='varid'>e</span> <span class='layout'>{</span><span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Environment</span><span class='varop'>.</span><span class='conid'>Types</span><span class='varop'>.</span><span class='varid'>getRequest</span> <span class='keyglyph'>=</span> <span class='conid'>Just</span> <span class='varid'>r</span><span class='layout'>}</span>
<a name="(line36)"></a>
<a name="(line37)"></a><a name="sendResponse"></a><span class='comment'>-- | Get the 'Response' from the 'Environment' and send</span>
<a name="(line38)"></a><span class='comment'>-- it back to the client.</span>
<a name="(line39)"></a><span class='varid'>sendResponse</span> <span class='keyglyph'>::</span> <span class='conid'>Maybe</span> <span class='conid'>Socket</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>Environment</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>IO</span> <span class='conid'>()</span>
<a name="(line40)"></a><span class='varid'>sendResponse</span> <span class='conid'>Nothing</span> <span class='varid'>e</span> <span class='keyglyph'>=</span> <span class='varid'>respondCGI</span> <span class='varop'>$</span> <span class='varid'>fromJust'</span> <span class='str'>"Network : sendResponse"</span> <span class='varop'>$</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Environment</span><span class='varop'>.</span><span class='conid'>Types</span><span class='varop'>.</span><span class='varid'>getResponse</span> <span class='varid'>e</span>
<a name="(line41)"></a><span class='varid'>sendResponse</span> <span class='layout'>(</span><span class='conid'>Just</span> <span class='varid'>sock</span><span class='layout'>)</span> <span class='varid'>e</span> <span class='keyglyph'>=</span> <span class='keyword'>do</span>
<a name="(line42)"></a>  <span class='varid'>respondHTTP</span> <span class='varid'>sock</span> <span class='varop'>$</span> <span class='varid'>fromJust'</span> <span class='str'>"Network : sendResponse"</span> <span class='varop'>$</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Environment</span><span class='varop'>.</span><span class='conid'>Types</span><span class='varop'>.</span><span class='varid'>getResponse</span> <span class='varid'>e</span>
<a name="(line43)"></a>
<a name="(line44)"></a><a name="acceptCGI"></a><span class='comment'>-- | Pull a CGI request from stdin</span>
<a name="(line45)"></a><span class='varid'>acceptCGI</span> <span class='keyglyph'>::</span> <span class='conid'>Controller</span> <span class='conid'>()</span>
<a name="(line46)"></a><span class='varid'>acceptCGI</span> <span class='keyglyph'>=</span> <span class='keyword'>do</span> <span class='varid'>body</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>liftIO</span> <span class='varop'>$</span> <span class='varid'>hGetContents</span> <span class='varid'>stdin</span>
<a name="(line47)"></a>               <span class='varid'>hdrs</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>liftIO</span> <span class='varop'>$</span> <span class='conid'>Env</span><span class='varop'>.</span><span class='varid'>getEnvironment</span>
<a name="(line48)"></a>               <span class='keyword'>let</span> <span class='varid'>rqheaders</span> <span class='keyglyph'>=</span> <span class='varid'>parseHeaders</span> <span class='varop'>$</span> <span class='varid'>extractHTTPHeaders</span> <span class='varid'>hdrs</span>
<a name="(line49)"></a>                   <span class='varid'>rquri</span> <span class='keyglyph'>=</span> <span class='varid'>fromJust'</span> <span class='str'>"Network: acceptCGI: parseURI failed"</span> <span class='varop'>$</span> <span class='varid'>parseURI</span> <span class='varop'>$</span> 
<a name="(line50)"></a>                             <span class='varid'>fromJust'</span> <span class='str'>"Network: acceptCGI: No REQUEST_URI in hdrs"</span> <span class='varop'>$</span> <span class='varid'>lookup</span> <span class='str'>"SCRIPT_URI"</span> <span class='varid'>hdrs</span>
<a name="(line51)"></a>                   <span class='varid'>rqmethod</span> <span class='keyglyph'>=</span> <span class='varid'>fromJust'</span> <span class='str'>"Network: acceptCGI: REQUEST_METHOD invalid"</span> <span class='varop'>$</span> <span class='varid'>flip</span> <span class='varid'>lookup</span> <span class='varid'>rqMethodMap</span> <span class='varop'>$</span>
<a name="(line52)"></a>                                <span class='varid'>fromJust'</span> <span class='str'>"Network: acceptCGI: No REQUEST_METHOD in hdrs"</span> <span class='varop'>$</span> <span class='varid'>lookup</span> <span class='str'>"REQUEST_METHOD"</span> <span class='varid'>hdrs</span>
<a name="(line53)"></a>               <span class='keyword'>case</span> <span class='varid'>rqheaders</span> <span class='keyword'>of</span>
<a name="(line54)"></a>                <span class='conid'>Left</span> <span class='varid'>err</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>errorResponse</span> <span class='varop'>$</span> <span class='varid'>show</span> <span class='varid'>err</span>
<a name="(line55)"></a>                <span class='conid'>Right</span> <span class='varid'>r</span>  <span class='keyglyph'>-&gt;</span> <span class='keyword'>do</span> <span class='varid'>e'</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>getEnvironment</span>
<a name="(line56)"></a>                               <span class='varid'>setEnvironment</span> <span class='varop'>$</span> <span class='varid'>e'</span> <span class='layout'>{</span>
<a name="(line57)"></a>                                <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Environment</span><span class='varop'>.</span><span class='conid'>Types</span><span class='varop'>.</span><span class='varid'>getRequest</span> <span class='keyglyph'>=</span> 
<a name="(line58)"></a>                                             <span class='conid'>Just</span> <span class='conid'>Request</span> <span class='layout'>{</span> <span class='varid'>rqURI</span> <span class='keyglyph'>=</span> <span class='varid'>rquri</span>
<a name="(line59)"></a>                                                          <span class='layout'>,</span> <span class='varid'>rqMethod</span> <span class='keyglyph'>=</span> <span class='varid'>rqmethod</span>
<a name="(line60)"></a>                                                          <span class='layout'>,</span> <span class='varid'>rqHeaders</span> <span class='keyglyph'>=</span> <span class='varid'>r</span>
<a name="(line61)"></a>                                                          <span class='layout'>,</span> <span class='varid'>rqBody</span> <span class='keyglyph'>=</span> <span class='varid'>body</span>
<a name="(line62)"></a>                                                          <span class='layout'>}</span>
<a name="(line63)"></a>                                <span class='layout'>}</span>
<a name="(line64)"></a>
<a name="(line65)"></a><a name="matchRqMethod"></a><span class='varid'>matchRqMethod</span> <span class='keyglyph'>::</span> <span class='conid'>String</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>RequestMethod</span>
<a name="(line66)"></a><span class='varid'>matchRqMethod</span> <span class='varid'>m</span> <span class='keyglyph'>=</span> <span class='varid'>fromJust'</span> <span class='str'>"Turbinado.Server.Network:matchRqMethod"</span> <span class='varop'>$</span>
<a name="(line67)"></a>                    <span class='varid'>lookup</span> <span class='varid'>m</span> <span class='keyglyph'>[</span> <span class='layout'>(</span><span class='str'>"GET"</span><span class='layout'>,</span>    <span class='conid'>GET</span><span class='layout'>)</span>
<a name="(line68)"></a>                             <span class='layout'>,</span> <span class='layout'>(</span><span class='str'>"POST"</span><span class='layout'>,</span>   <span class='conid'>POST</span><span class='layout'>)</span>
<a name="(line69)"></a>                             <span class='layout'>,</span> <span class='layout'>(</span><span class='str'>"HEAD"</span><span class='layout'>,</span>   <span class='conid'>HEAD</span><span class='layout'>)</span>
<a name="(line70)"></a>                             <span class='layout'>,</span> <span class='layout'>(</span><span class='str'>"PUT"</span>  <span class='layout'>,</span>  <span class='conid'>PUT</span><span class='layout'>)</span>
<a name="(line71)"></a>                             <span class='layout'>,</span> <span class='layout'>(</span><span class='str'>"DELETE"</span><span class='layout'>,</span> <span class='conid'>DELETE</span><span class='layout'>)</span>
<a name="(line72)"></a>                             <span class='keyglyph'>]</span>
<a name="(line73)"></a>
<a name="(line74)"></a><a name="respondCGI"></a><span class='comment'>-- | Convert the HTTP.Response to a CGI response for stdout.</span>
<a name="(line75)"></a><span class='varid'>respondCGI</span> <span class='keyglyph'>::</span> <span class='conid'>Response</span> <span class='conid'>String</span> <span class='keyglyph'>-&gt;</span> <span class='conid'>IO</span> <span class='conid'>()</span>
<a name="(line76)"></a><span class='varid'>respondCGI</span> <span class='varid'>r</span> <span class='keyglyph'>=</span> <span class='keyword'>do</span> <span class='keyword'>let</span> <span class='varid'>message</span> <span class='keyglyph'>=</span> <span class='layout'>(</span><span class='varid'>unlines</span> <span class='varop'>$</span> <span class='varid'>drop</span> <span class='num'>1</span> <span class='varop'>$</span> <span class='varid'>lines</span> <span class='varop'>$</span> <span class='varid'>show</span> <span class='varid'>r</span><span class='layout'>)</span> <span class='varop'>++</span> <span class='str'>"\n\n"</span> <span class='varop'>++</span> <span class='varid'>rspBody</span> <span class='varid'>r</span>   <span class='comment'>-- need to drop the first line from the response for CGI</span>
<a name="(line77)"></a>                  <span class='varid'>hPutStr</span> <span class='varid'>stdout</span> <span class='varid'>message</span>
<a name="(line78)"></a>                  <span class='varid'>hFlush</span> <span class='varid'>stdout</span>
<a name="(line79)"></a>
<a name="(line80)"></a><a name="extractHTTPHeaders"></a><span class='comment'>-- | Convert from HTTP_SOME_FLAG to Some-Flag for HTTP.parseHeaders</span>
<a name="(line81)"></a><span class='varid'>extractHTTPHeaders</span> <span class='keyglyph'>::</span> <span class='keyglyph'>[</span><span class='layout'>(</span><span class='conid'>String</span><span class='layout'>,</span> <span class='conid'>String</span><span class='layout'>)</span><span class='keyglyph'>]</span> <span class='keyglyph'>-&gt;</span> <span class='keyglyph'>[</span><span class='conid'>String</span><span class='keyglyph'>]</span>
<a name="(line82)"></a><span class='varid'>extractHTTPHeaders</span> <span class='conid'>[]</span> <span class='keyglyph'>=</span> <span class='conid'>[]</span>
<a name="(line83)"></a><span class='varid'>extractHTTPHeaders</span> <span class='layout'>(</span><span class='layout'>(</span><span class='chr'>'H'</span><span class='conop'>:</span><span class='chr'>'T'</span><span class='conop'>:</span><span class='chr'>'T'</span><span class='conop'>:</span><span class='chr'>'P'</span><span class='conop'>:</span><span class='chr'>'_'</span><span class='conop'>:</span><span class='varid'>k</span><span class='layout'>,</span><span class='varid'>v</span><span class='layout'>)</span><span class='conop'>:</span><span class='varid'>hs</span><span class='layout'>)</span> <span class='keyglyph'>=</span> <span class='layout'>(</span><span class='varid'>convertUnderscores</span> <span class='varid'>k</span> <span class='varop'>++</span> <span class='str'>": "</span> <span class='varop'>++</span> <span class='varid'>v</span><span class='layout'>)</span> <span class='conop'>:</span> <span class='varid'>extractHTTPHeaders</span> <span class='varid'>hs</span>
<a name="(line84)"></a>  <span class='keyword'>where</span> <span class='varid'>convertUnderscores</span> <span class='conid'>[]</span>       <span class='keyglyph'>=</span> <span class='conid'>[]</span>
<a name="(line85)"></a>        <span class='varid'>convertUnderscores</span> <span class='layout'>(</span><span class='chr'>'_'</span><span class='conop'>:</span><span class='varid'>ss</span><span class='layout'>)</span> <span class='keyglyph'>=</span> <span class='chr'>'-'</span> <span class='conop'>:</span> <span class='varid'>convertUnderscores</span> <span class='varid'>ss</span>
<a name="(line86)"></a>        <span class='varid'>convertUnderscores</span> <span class='layout'>(</span><span class='varid'>s</span>  <span class='conop'>:</span><span class='varid'>ss</span><span class='layout'>)</span> <span class='keyglyph'>=</span>  <span class='varid'>s</span>  <span class='conop'>:</span> <span class='varid'>convertUnderscores</span> <span class='varid'>ss</span>
<a name="(line87)"></a><span class='varid'>extractHTTPHeaders</span> <span class='layout'>(</span><span class='layout'>(</span><span class='varid'>k</span><span class='layout'>,</span><span class='varid'>v</span><span class='layout'>)</span> <span class='conop'>:</span> <span class='varid'>hs</span><span class='layout'>)</span> <span class='keyglyph'>=</span> <span class='varid'>extractHTTPHeaders</span> <span class='varid'>hs</span>
<a name="(line88)"></a>
<a name="(line89)"></a>
<a name="(line90)"></a><a name="rqMethodMap"></a><span class='comment'>-- | Lifted from Network.HTTP</span>
<a name="(line91)"></a><span class='varid'>rqMethodMap</span> <span class='keyglyph'>::</span> <span class='keyglyph'>[</span><span class='layout'>(</span><span class='conid'>String</span><span class='layout'>,</span> <span class='conid'>RequestMethod</span><span class='layout'>)</span><span class='keyglyph'>]</span>
<a name="(line92)"></a><span class='varid'>rqMethodMap</span> <span class='keyglyph'>=</span> <span class='keyglyph'>[</span><span class='layout'>(</span><span class='str'>"HEAD"</span><span class='layout'>,</span>    <span class='conid'>HEAD</span><span class='layout'>)</span><span class='layout'>,</span>
<a name="(line93)"></a>               <span class='layout'>(</span><span class='str'>"PUT"</span><span class='layout'>,</span>     <span class='conid'>PUT</span><span class='layout'>)</span><span class='layout'>,</span>
<a name="(line94)"></a>               <span class='layout'>(</span><span class='str'>"GET"</span><span class='layout'>,</span>     <span class='conid'>GET</span><span class='layout'>)</span><span class='layout'>,</span>
<a name="(line95)"></a>               <span class='layout'>(</span><span class='str'>"POST"</span><span class='layout'>,</span>    <span class='conid'>POST</span><span class='layout'>)</span><span class='layout'>,</span>
<a name="(line96)"></a>               <span class='layout'>(</span><span class='str'>"DELETE"</span><span class='layout'>,</span>  <span class='conid'>DELETE</span><span class='layout'>)</span><span class='layout'>,</span>
<a name="(line97)"></a>               <span class='layout'>(</span><span class='str'>"OPTIONS"</span><span class='layout'>,</span> <span class='conid'>OPTIONS</span><span class='layout'>)</span><span class='layout'>,</span>
<a name="(line98)"></a>               <span class='layout'>(</span><span class='str'>"TRACE"</span><span class='layout'>,</span>   <span class='conid'>TRACE</span><span class='layout'>)</span><span class='keyglyph'>]</span>
<a name="(line99)"></a>
<a name="(line100)"></a>
</pre></body>
</html>
