<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://www.cs.york.ac.uk/fp/darcs/hscolour/ -->
<title>Haskell Code by HsColour</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="(line1)"></a><span class='keyword'>module</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Environment</span><span class='varop'>.</span><span class='conid'>ViewData</span> <span class='layout'>(</span>
<a name="(line2)"></a>        <span class='varid'>addViewDataToEnvironment</span><span class='layout'>,</span>
<a name="(line3)"></a>        <span class='varid'>getViewDataValue</span><span class='layout'>,</span>
<a name="(line4)"></a>        <span class='varid'>getViewDataValue_u</span><span class='layout'>,</span>
<a name="(line5)"></a>        <span class='varid'>setViewDataValue</span>
<a name="(line6)"></a>        <span class='layout'>)</span><span class='keyword'>where</span>
<a name="(line7)"></a>
<a name="(line8)"></a><span class='keyword'>import</span> <span class='keyword'>qualified</span> <span class='conid'>Data</span><span class='varop'>.</span><span class='conid'>Map</span> <span class='keyword'>as</span> <span class='conid'>M</span>
<a name="(line9)"></a><span class='keyword'>import</span> <span class='conid'>Control</span><span class='varop'>.</span><span class='conid'>Monad</span>
<a name="(line10)"></a><span class='keyword'>import</span> <span class='conid'>Control</span><span class='varop'>.</span><span class='conid'>Monad</span><span class='varop'>.</span><span class='conid'>Trans</span>
<a name="(line11)"></a><span class='keyword'>import</span> <span class='conid'>Data</span><span class='varop'>.</span><span class='conid'>Maybe</span>
<a name="(line12)"></a><span class='keyword'>import</span> <span class='conid'>Data</span><span class='varop'>.</span><span class='conid'>Typeable</span>
<a name="(line13)"></a><span class='keyword'>import</span> <span class='conid'>Data</span><span class='varop'>.</span><span class='conid'>Dynamic</span>
<a name="(line14)"></a>
<a name="(line15)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Environment</span><span class='varop'>.</span><span class='conid'>Logger</span>
<a name="(line16)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Environment</span><span class='varop'>.</span><span class='conid'>Types</span>
<a name="(line17)"></a><span class='keyword'>import</span> <span class='conid'>Turbinado</span><span class='varop'>.</span><span class='conid'>Utility</span><span class='varop'>.</span><span class='conid'>Data</span>
<a name="(line18)"></a>
<a name="(line19)"></a><a name="addViewDataToEnvironment"></a><span class='comment'>-- | Used during request initialization to add the 'ViewData' 'Map</span>
<a name="(line20)"></a><span class='comment'>-- to the 'Environment'.</span>
<a name="(line21)"></a><span class='varid'>addViewDataToEnvironment</span> <span class='keyglyph'>::</span> <span class='layout'>(</span><span class='conid'>HasEnvironment</span> <span class='varid'>m</span><span class='layout'>)</span> <span class='keyglyph'>=&gt;</span> <span class='varid'>m</span> <span class='conid'>()</span>
<a name="(line22)"></a><span class='varid'>addViewDataToEnvironment</span>  <span class='keyglyph'>=</span> <span class='keyword'>do</span> <span class='varid'>e</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>getEnvironment</span>
<a name="(line23)"></a>                               <span class='varid'>setEnvironment</span> <span class='varop'>$</span> <span class='varid'>e</span> <span class='layout'>{</span><span class='varid'>getViewData</span> <span class='keyglyph'>=</span> <span class='conid'>Just</span> <span class='layout'>(</span><span class='conid'>M</span><span class='varop'>.</span><span class='varid'>empty</span> <span class='keyglyph'>::</span> <span class='conid'>ViewData</span><span class='layout'>)</span><span class='layout'>}</span>
<a name="(line24)"></a>
<a name="(line25)"></a><a name="getViewDataValue"></a><span class='comment'>-- | Attempts to pull a dynamically typed value out of the 'ViewData 'Map'.</span>
<a name="(line26)"></a><span class='comment'>-- Returns Maybe a where a is the type inferred from usage.</span>
<a name="(line27)"></a><span class='comment'>-- </span>
<a name="(line28)"></a><span class='comment'>-- IMPORTANT: This function will return Nothing if the type inferred does not match</span>
<a name="(line29)"></a><span class='comment'>-- the type in the 'Map'.  So if @1 :: Int@ is stored in the 'Map' with a key "number",</span>
<a name="(line30)"></a><span class='comment'>-- then @getViewDataValue "number" :: 'Controller' Integer@ will return @'Controller' Nothing@.</span>
<a name="(line31)"></a><span class='varid'>getViewDataValue</span> <span class='keyglyph'>::</span> <span class='layout'>(</span><span class='conid'>HasEnvironment</span> <span class='varid'>m</span><span class='layout'>,</span> <span class='conid'>Typeable</span> <span class='varid'>a</span><span class='layout'>)</span> <span class='keyglyph'>=&gt;</span> <span class='conid'>String</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>m</span> <span class='layout'>(</span><span class='conid'>Maybe</span> <span class='varid'>a</span><span class='layout'>)</span>
<a name="(line32)"></a><span class='varid'>getViewDataValue</span> <span class='varid'>k</span> <span class='keyglyph'>=</span> <span class='keyword'>do</span> <span class='varid'>e</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>getEnvironment</span>
<a name="(line33)"></a>                        <span class='keyword'>case</span> <span class='layout'>(</span><span class='conid'>M</span><span class='varop'>.</span><span class='varid'>lookup</span> <span class='varid'>k</span> <span class='varop'>$</span> <span class='varid'>fromJust'</span> <span class='str'>"ViewData : getViewDataValue"</span> <span class='varop'>$</span> <span class='varid'>getViewData</span> <span class='varid'>e</span><span class='layout'>)</span> <span class='keyword'>of</span>
<a name="(line34)"></a>                          <span class='conid'>Nothing</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>return</span> <span class='varop'>$</span> <span class='conid'>Nothing</span>
<a name="(line35)"></a>                          <span class='conid'>Just</span> <span class='varid'>l</span>  <span class='keyglyph'>-&gt;</span> <span class='varid'>return</span> <span class='varop'>$</span> <span class='varid'>fromDynamic</span> <span class='varid'>l</span>
<a name="(line36)"></a>
<a name="(line37)"></a><a name="getViewDataValue_u"></a><span class='comment'>-- | This function is an "unsafe" version of 'getViewDataValue' in that this function assumes that the key</span>
<a name="(line38)"></a><span class='comment'>-- *does* exist in the map.  If no key exists or if the value type does not match the inferred</span>
<a name="(line39)"></a><span class='comment'>-- type, this function will throw an error.</span>
<a name="(line40)"></a><span class='varid'>getViewDataValue_u</span> <span class='keyglyph'>::</span> <span class='layout'>(</span><span class='conid'>HasEnvironment</span> <span class='varid'>m</span><span class='layout'>,</span> <span class='conid'>Typeable</span> <span class='varid'>a</span><span class='layout'>)</span> <span class='keyglyph'>=&gt;</span> <span class='conid'>String</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>m</span> <span class='varid'>a</span>
<a name="(line41)"></a><span class='varid'>getViewDataValue_u</span> <span class='varid'>k</span> <span class='keyglyph'>=</span> <span class='keyword'>do</span> <span class='varid'>v</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>getViewDataValue</span> <span class='varid'>k</span>
<a name="(line42)"></a>                          <span class='varid'>maybe</span> <span class='layout'>(</span><span class='varid'>error</span> <span class='varop'>$</span> <span class='str'>"getViewDataValue_u : key does not exist - \""</span> <span class='varop'>++</span> <span class='varid'>k</span> <span class='varop'>++</span> <span class='str'>"\""</span><span class='layout'>)</span>
<a name="(line43)"></a>                                <span class='varid'>return</span>
<a name="(line44)"></a>                                <span class='varid'>v</span>
<a name="(line45)"></a>
<a name="(line46)"></a><a name="setViewDataValue"></a><span class='comment'>-- | Sets a key/value pair in the 'ViewData' 'Map'.  </span>
<a name="(line47)"></a><span class='comment'>--</span>
<a name="(line48)"></a><span class='comment'>-- IMPORTANT: the value must be</span>
<a name="(line49)"></a><span class='comment'>-- Typeable.  If you cannot use a Typeable (e.g. you're using a type</span>
<a name="(line50)"></a><span class='comment'>-- from a library), then you can extract Typeable fields from your value</span>
<a name="(line51)"></a><span class='comment'>-- and set those or you can convert your type to a Typeable type (e.g. using</span>
<a name="(line52)"></a><span class='comment'>-- 'show' to convert to a String). </span>
<a name="(line53)"></a><span class='varid'>setViewDataValue</span> <span class='keyglyph'>::</span> <span class='layout'>(</span><span class='conid'>HasEnvironment</span> <span class='varid'>m</span><span class='layout'>,</span> <span class='conid'>Typeable</span> <span class='varid'>a</span><span class='layout'>)</span> <span class='keyglyph'>=&gt;</span> <span class='conid'>String</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>a</span> <span class='keyglyph'>-&gt;</span> <span class='varid'>m</span> <span class='conid'>()</span>
<a name="(line54)"></a><span class='varid'>setViewDataValue</span> <span class='varid'>k</span> <span class='varid'>v</span> <span class='keyglyph'>=</span> <span class='keyword'>do</span> <span class='varid'>e</span> <span class='keyglyph'>&lt;-</span> <span class='varid'>getEnvironment</span>
<a name="(line55)"></a>                          <span class='keyword'>let</span> <span class='varid'>vd</span>  <span class='keyglyph'>=</span> <span class='varid'>fromJust'</span> <span class='str'>"ViewData : setViewDataValue"</span> <span class='varop'>$</span> <span class='varid'>getViewData</span> <span class='varid'>e</span>
<a name="(line56)"></a>                              <span class='varid'>vd'</span> <span class='keyglyph'>=</span> <span class='conid'>M</span><span class='varop'>.</span><span class='varid'>insert</span> <span class='varid'>k</span> <span class='layout'>(</span><span class='varid'>toDyn</span> <span class='varid'>v</span><span class='layout'>)</span> <span class='varid'>vd</span>
<a name="(line57)"></a>                          <span class='varid'>setEnvironment</span> <span class='varop'>$</span> <span class='varid'>e</span> <span class='layout'>{</span><span class='varid'>getViewData</span> <span class='keyglyph'>=</span> <span class='conid'>Just</span> <span class='varid'>vd'</span><span class='layout'>}</span>
</pre></body>
</html>
